cscope 15 /opt/sm1725-1/jaeseon/sysbench/sysbench/src -q 0000002440 0000311254
	@db_driver.c

20 #ifde‡
HAVE_CONFIG_H


21 
	~"c⁄fig.h
"

23 #ifde‡
STDC_HEADERS


24 
	~<˘y≥.h
>

25 
	~<öây≥s.h
>

26 
	~<°dboﬁ.h
>

28 #ifde‡
HAVE_STRING_H


29 
	~<°rög.h
>

31 #ifde‡
HAVE_STRINGS_H


32 
	~<°rögs.h
>

35 
	~<±hªad.h
>

37 
	~"db_drivî.h
"

38 
	~"sb_li°.h
"

39 
	~"sb_hi°ogøm.h
"

40 
	~"sb_ck_¥.h
"

43 
	#BULK_PACKET_SIZE
 (512*1024)

	)

46 
	#ROWS_BEFORE_COMMIT
 1000

	)

49 
db_globÆs_t
 
db_globÆs
 
	gCK_CC_CACHELINE
;

51 
sb_li°_t
 
	gdrivîs
;

53 
uöt8_t
 
	g°©s_íabÀd
;

55 
boﬁ
 
	gdb_globÆ_öôülized
;

56 
±hªad_⁄˚_t
 
	gdb_globÆ_⁄˚
 = 
PTHREAD_ONCE_INIT
;

59 
sb_timî_t
 *
	gexec_timîs
;

60 
sb_timî_t
 *
	g„tch_timîs
;

64 
db_∑r£_¨gumíts
();

66 
db_‰ì_row
(
db_row_t
 *);

68 
db_bulk_do_ö£π
(
db_c⁄n_t
 *, );

69 
db_ª£t_°©s
();

70 
db_‰ì_ªsu…s_öt
(
db_c⁄n_t
 *
c⁄
);

74 
sb_¨g_t
 
	gdb_¨gs
[] =

76 
SB_OPT
("db-driver", "specifies database driverÅo use "

78 #ifde‡
USE_MYSQL


81 
NULL
,

83 
STRING
),

84 
SB_OPT
("db-ps-mode", "prepared statements usage mode {auto, disable}", "auto",

85 
STRING
),

86 
SB_OPT
("db-debug", "¥öàd©aba£-•ecifi¯debug inf‹m©i⁄", "off", 
BOOL
),

88 
SB_OPT_END


93 
	$db_ªgi°î
()

95 
sb_li°_ôem_t
 *
pos
;

96 
db_drivî_t
 *
drv
;

99 
	`SB_LIST_INIT
(&
drivîs
);

100 #ifde‡
USE_MYSQL


101 
	`ªgi°î_drivî_mysql
(&
drivîs
);

103 #ifde‡
USE_PGSQL


104 
	`ªgi°î_drivî_pgsql
(&
drivîs
);

108 
	`SB_LIST_FOR_EACH
(
pos
, &
drivîs
)

110 
drv
 = 
	`SB_LIST_ENTRY
(
pos
, 
db_drivî_t
, 
li°ôem
);

111 i‡(
drv
->
¨gs
 !
NULL
)

112 
	`sb_ªgi°î_¨g_£t
(
drv
->
¨gs
);

113 
drv
->
öôülized
 = 
Ál£
;

114 
	`±hªad_muãx_öô
(&
drv
->
muãx
, 
NULL
);

117 
	`sb_ªgi°î_¨g_£t
(
db_¨gs
);

120 
	}
}

126 
	$db_¥öt_hñp
()

128 
sb_li°_ôem_t
 *
pos
;

129 
db_drivî_t
 *
drv
;

131 
	`log_ãxt
(
LOG_NOTICE
, "General database options:\n");

132 
	`sb_¥öt_›ti⁄s
(
db_¨gs
);

133 
	`log_ãxt
(
LOG_NOTICE
, "");

135 
	`log_ãxt
(
LOG_NOTICE
, "Compiled-in database drivers:");

136 
	`SB_LIST_FOR_EACH
(
pos
, &
drivîs
)

138 
drv
 = 
	`SB_LIST_ENTRY
(
pos
, 
db_drivî_t
, 
li°ôem
);

139 
	`log_ãxt
(
LOG_NOTICE
, " %†- %s", 
drv
->
¢ame
, drv->
 ame
);

141 
	`log_ãxt
(
LOG_NOTICE
, "");

142 
	`SB_LIST_FOR_EACH
(
pos
, &
drivîs
)

144 
drv
 = 
	`SB_LIST_ENTRY
(
pos
, 
db_drivî_t
, 
li°ôem
);

145 
	`log_ãxt
(
LOG_NOTICE
, "%†›ti⁄s:", 
drv
->
¢ame
);

146 
	`sb_¥öt_›ti⁄s
(
drv
->
¨gs
);

148 
	}
}

151 
	$íabÀ_¥öt_°©s
()

153 
	`ck_¥_„n˚_°‹e
();

154 
	`ck_¥_°‹e_8
(&
°©s_íabÀd
, 1);

155 
	}
}

157 
	$dißbÀ_¥öt_°©s
()

159 
	`ck_¥_°‹e_8
(&
°©s_íabÀd
, 0);

160 
	`ck_¥_„n˚_°‹e
();

161 
	}
}

164 
boﬁ
 
	$check_¥öt_°©s
()

166 
boﬁ
 
rc
 = 
	`ck_¥_lﬂd_8
(&
°©s_íabÀd
) == 1;

167 
	`ck_¥_„n˚_lﬂd
();

169  
rc
;

170 
	}
}

172 
	$db_öô
()

174 i‡(
	`SB_LIST_IS_EMPTY
(&
drivîs
))

176 
	`log_ãxt
(
LOG_FATAL
, "No DB driversávailable");

180 i‡(
	`db_∑r£_¨gumíts
())

184 i‡(
db_globÆs
.
debug
)

186 
exec_timîs
 = 
	`sb_Æloc_≥r_thªad_¨øy
((
sb_timî_t
));

187 
„tch_timîs
 = 
	`sb_Æloc_≥r_thªad_¨øy
((
sb_timî_t
));

190 
	`db_ª£t_°©s
();

192 
	`íabÀ_¥öt_°©s
();

194 
db_globÆ_öôülized
 = 
åue
;

195 
	}
}

203 
db_drivî_t
 *
	$db_¸óã
(c⁄° *
«me
)

205 
db_drivî_t
 *
drv
 = 
NULL
;

206 
db_drivî_t
 *
tmp
;

207 
sb_li°_ôem_t
 *
pos
;

209 
	`±hªad_⁄˚
(&
db_globÆ_⁄˚
, 
db_öô
);

211 i‡(!
db_globÆ_öôülized
)

212 
îr
;

214 i‡(
«me
 =
NULL
 && 
db_globÆs
.
drivî
 == NULL)

216 
drv
 = 
	`SB_LIST_ENTRY
(
	`SB_LIST_ITEM_NEXT
(&
drivîs
), 
db_drivî_t
, 
li°ôem
);

218 i‡(
	`SB_LIST_ITEM_NEXT
(&(
drv
->
li°ôem
)) ==

219 
	`SB_LIST_ITEM_PREV
(&(
drv
->
li°ôem
)))

220 
	`log_ãxt
(
LOG_INFO
, "NÿDB drivî†•ecifõd, usög %s", 
drv
->
¢ame
);

223 
	`log_ãxt
(
LOG_FATAL
, "Multiple DB driversáreávailable. "

225 
îr
;

230 i‡(
«me
 =
NULL
)

231 
«me
 = 
db_globÆs
.
drivî
;

233 
	`SB_LIST_FOR_EACH
(
pos
, &
drivîs
)

235 
tmp
 = 
	`SB_LIST_ENTRY
(
pos
, 
db_drivî_t
, 
li°ôem
);

236 i‡(!
	`°rcmp
(
tmp
->
¢ame
, 
«me
))

238 
drv
 = 
tmp
;

244 i‡(
drv
 =
NULL
)

246 
	`log_ãxt
(
LOG_FATAL
, "övÆid d©aba£ drivîÇame: '%s'", 
«me
);

247 
îr
;

251 
	`±hªad_muãx_lock
(&
drv
->
muãx
);

252 i‡(!
drv
->
öôülized
)

254 i‡(
drv
->
›s
.
	`öô
())

256 
	`±hªad_muãx_u∆ock
(&
drv
->
muãx
);

257 
îr
;

259 
drv
->
öôülized
 = 
åue
;

261 
	`±hªad_muãx_u∆ock
(&
drv
->
muãx
);

263 i‡(
drv
->
›s
.
thªad_öô
 !
NULL
 && drv->›s.
	`thªad_öô
(
sb_és_thªad_id
))

265 
	`log_ãxt
(
LOG_FATAL
, "thread-local driver initialization failed.");

266  
NULL
;

269  
drv
;

271 
îr
:

272  
NULL
;

273 
	}
}

277 
	$db_de°roy
(
db_drivî_t
 *
drv
)

279 i‡(
drv
->
›s
.
thªad_d⁄e
 !
NULL
)

280  
drv
->
›s
.
	`thªad_d⁄e
(
sb_és_thªad_id
);

283 
	}
}

287 
	$db_des¸ibe
(
db_drivî_t
 *
drv
, 
drv_ˇps_t
 *
ˇps
)

289 i‡(
drv
->
›s
.
des¸ibe
 =
NULL
)

292  
drv
->
›s
.
	`des¸ibe
(
ˇps
);

293 
	}
}

299 
db_c⁄n_t
 *
	$db_c⁄√˘i⁄_¸óã
(
db_drivî_t
 *
drv
)

301 
db_c⁄n_t
 *
c⁄
;

303 
	`SB_COMPILE_TIME_ASSERT
((
db_c⁄n_t
Ë% 
CK_MD_CACHELINE
 == 0);

305 
c⁄
 = (
db_c⁄n_t
 *)
	`ˇŒoc
(1, (db_conn_t));

306 i‡(
c⁄
 =
NULL
)

307  
NULL
;

309 
c⁄
->
drivî
 = 
drv
;

310 
c⁄
->
°©e
 = 
DB_CONN_READY
;

312 
c⁄
->
thªad_id
 = 
sb_és_thªad_id
;

314 i‡(
drv
->
›s
.
	`c⁄√˘
(
c⁄
))

316 
	`‰ì
(
c⁄
);

317  
NULL
;

320  
c⁄
;

321 
	}
}

327 
	$db_c⁄√˘i⁄_˛o£
(
db_c⁄n_t
 *
c⁄
)

329 
rc
;

330 
db_drivî_t
 *
drv
 = 
c⁄
->
drivî
;

332 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

334 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo closeánálready closed connection");

337 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
)

339 
	`db_‰ì_ªsu…s_öt
(
c⁄
);

342 
rc
 = 
drv
->
›s
.
	`disc⁄√˘
(
c⁄
);

344 
c⁄
->
°©e
 = 
DB_CONN_INVALID
;

346  
rc
;

347 
	}
}

351 
	$db_c⁄√˘i⁄_ªc⁄√˘
(
db_c⁄n_t
 *
c⁄
)

353 
rc
;

354 
db_drivî_t
 *
drv
 = 
c⁄
->
drivî
;

356 i‡(
drv
->
›s
.
ªc⁄√˘
 =
NULL
)

358 
	`log_ãxt
(
LOG_ALERT
, "reconnect isÇot supported byÅhe current driver");

362 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

364 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo closeánálready closed connection");

367 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
)

369 
	`db_‰ì_ªsu…s_öt
(
c⁄
);

372 
rc
 = 
drv
->
›s
.
	`ªc⁄√˘
(
c⁄
);

374 i‡(
rc
 =
DB_ERROR_FATAL
)

376 
c⁄
->
°©e
 = 
DB_CONN_INVALID
;

377 
	`sb_cou¡î_öc
(
c⁄
->
thªad_id
, 
SB_CNT_ERROR
);

381 
c⁄
->
°©e
 = 
DB_CONN_READY
;

382 
	`sb_cou¡î_öc
(
c⁄
->
thªad_id
, 
SB_CNT_RECONNECT
);

385 
rc
 = 
DB_ERROR_NONE
;

388  
rc
;

389 
	}
}

393 
	$db_c⁄√˘i⁄_‰ì
(
db_c⁄n_t
 *
c⁄
)

395 i‡(
c⁄
->
°©e
 !
DB_CONN_INVALID
)

396 
	`db_c⁄√˘i⁄_˛o£
(
c⁄
);

398 
	`‰ì
(
c⁄
);

399 
	}
}

405 
db_°mt_t
 *
	$db_¥ï¨e
(
db_c⁄n_t
 *
c⁄
, c⁄° *
quîy
, 
size_t
 
Àn
)

407 
db_°mt_t
 *
°mt
;

409 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

411 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

412  
NULL
;

415 
°mt
 = (
db_°mt_t
 *)
	`ˇŒoc
(1, (db_stmt_t));

416 i‡(
°mt
 =
NULL
)

417  
NULL
;

419 
°mt
->
c⁄√˘i⁄
 = 
c⁄
;

421 i‡(
c⁄
->
drivî
->
›s
.
	`¥ï¨e
(
°mt
, 
quîy
, 
Àn
))

423 
c⁄
->
îr‹
 = 
DB_ERROR_FATAL
;

424 
	`‰ì
(
°mt
);

425  
NULL
;

428  
°mt
;

429 
	}
}

435 
	$db_böd_∑øm
(
db_°mt_t
 *
°mt
, 
db_böd_t
 *
∑øms
, 
size_t
 
Àn
)

437 
db_c⁄n_t
 *
c⁄
 = 
°mt
->
c⁄√˘i⁄
;

439 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

441 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

445  
c⁄
->
drivî
->
›s
.
	`böd_∑øm
(
°mt
, 
∑øms
, 
Àn
);

446 
	}
}

452 
	$db_böd_ªsu…
(
db_°mt_t
 *
°mt
, 
db_böd_t
 *
ªsu…s
, 
size_t
 
Àn
)

454 
db_c⁄n_t
 *
c⁄
 = 
°mt
->
c⁄√˘i⁄
;

456 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

458 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

462  
c⁄
->
drivî
->
›s
.
	`böd_ªsu…
(
°mt
, 
ªsu…s
, 
Àn
);

463 
	}
}

469 
db_ªsu…_t
 *
	$db_execuã
(
db_°mt_t
 *
°mt
)

471 
db_c⁄n_t
 *
c⁄
 = 
°mt
->
c⁄√˘i⁄
;

472 
db_ªsu…_t
 *
rs
 = &
c⁄
->rs;

473 
rc
;

475 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

477 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

478  
NULL
;

480 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
 &&

481 (
rc
 = 
	`db_‰ì_ªsu…s_öt
(
c⁄
)) != 0)

483  
NULL
;

486 
rs
->
°©emít
 = 
°mt
;

488 
c⁄
->
îr‹
 = c⁄->
drivî
->
›s
.
	`execuã
(
°mt
, 
rs
);

490 
	`sb_cou¡î_öc
(
c⁄
->
thªad_id
, 
rs
->
cou¡î
);

492 i‡(
	`SB_LIKELY
(
c⁄
->
îr‹
 =
DB_ERROR_NONE
))

494 i‡(
rs
->
cou¡î
 =
SB_CNT_READ
)

496 
c⁄
->
°©e
 = 
DB_CONN_RESULT_SET
;

497  
rs
;

499 
c⁄
->
°©e
 = 
DB_CONN_READY
;

501  
NULL
;

504  
NULL
;

505 
	}
}

511 
db_row_t
 *
	$db_„tch_row
(
db_ªsu…_t
 *
rs
)

513 
db_c⁄n_t
 *
c⁄
 = 
	`SB_CONTAINER_OF
(
rs
, db_conn_t,Ñs);

515 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

517 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

518  
NULL
;

520 i‡(
c⁄
->
°©e
 !
DB_CONN_RESULT_SET
)

522 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo fetchÑow fromán invalidÑesult set");

523  
NULL
;

526 i‡(
c⁄
->
drivî
->
›s
.
„tch_row
 =
NULL
)

528 
	`log_ãxt
(
LOG_ALERT
, "fetchingÑows isÇot supported byÅhe driver");

531 i‡(
rs
->
ƒows
 =0 ||Ñs->
nfõlds
 == 0)

533 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo fetchÑow frománÉmptyÑesult set");

534  
NULL
;

537 i‡(
rs
->
row
.
vÆues
 =
NULL
)

539 
rs
->
row
.
vÆues
 = 
	`mÆloc
‘s->
nfõlds
 * (
db_vÆue_t
));

542 i‡(
c⁄
->
drivî
->
›s
.
	`„tch_row
(
rs
, &rs->
row
))

544  
NULL
;

547  &
rs
->
row
;

548 
	}
}

554 
db_ªsu…_t
 *
	$db_quîy
(
db_c⁄n_t
 *
c⁄
, c⁄° *
quîy
, 
size_t
 
Àn
)

556 
db_ªsu…_t
 *
rs
 = &
c⁄
->rs;

557 
rc
;

559 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

561 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

562 
c⁄
->
îr‹
 = 
DB_ERROR_FATAL
;

563  
NULL
;

565 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
 &&

566 (
rc
 = 
	`db_‰ì_ªsu…s_öt
(
c⁄
)) != 0)

568 
c⁄
->
îr‹
 = 
DB_ERROR_FATAL
;

569  
NULL
;

572 
c⁄
->
îr‹
 = c⁄->
drivî
->
›s
.
	`quîy
(c⁄, 
quîy
, 
Àn
, 
rs
);

574 
	`sb_cou¡î_öc
(
c⁄
->
thªad_id
, 
rs
->
cou¡î
);

576 i‡(
	`SB_LIKELY
(
c⁄
->
îr‹
 =
DB_ERROR_NONE
))

578 i‡(
rs
->
cou¡î
 =
SB_CNT_READ
)

580 
c⁄
->
°©e
 = 
DB_CONN_RESULT_SET
;

581  
rs
;

583 
c⁄
->
°©e
 = 
DB_CONN_READY
;

585  
NULL
;

588  
NULL
;

589 
	}
}

595 
	$db_‰ì_ªsu…s_öt
(
db_c⁄n_t
 *
c⁄
)

597 
rc
;

599 
rc
 = 
c⁄
->
drivî
->
›s
.
	`‰ì_ªsu…s
(&c⁄->
rs
);

601 i‡(
c⁄
->
rs
.
row
.
vÆues
 !
NULL
)

603 
	`‰ì
(
c⁄
->
rs
.
row
.
vÆues
);

604 
c⁄
->
rs
.
row
.
vÆues
 = 
NULL
;

607 
c⁄
->
rs
.
ƒows
 = 0;

608 
c⁄
->
rs
.
nfõlds
 = 0;

610 
c⁄
->
rs
.
°©emít
 = 
NULL
;

612 
c⁄
->
°©e
 = 
DB_CONN_READY
;

614  
rc
;

615 
	}
}

617 
	$db_‰ì_ªsu…s
(
db_ªsu…_t
 *
rs
)

619 
db_c⁄n_t
 * c⁄° 
c⁄
 = 
	`SB_CONTAINER_OF
(
rs
, db_conn_t,Ñs);

621 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

623 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

626 i‡(
c⁄
->
°©e
 !
DB_CONN_RESULT_SET
)

628 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo freeán invalidÑesult set");

632  
	`db_‰ì_ªsu…s_öt
(
c⁄
);

633 
	}
}

638 
	$db_˛o£
(
db_°mt_t
 *
°mt
)

640 
rc
;

641 
db_c⁄n_t
 *
c⁄
 = 
°mt
->
c⁄√˘i⁄
;

643 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

645 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

648 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
 &&

649 (
rc
 = 
	`db_‰ì_ªsu…s_öt
(
c⁄
)) != 0)

651  
DB_ERROR_FATAL
;

654 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

656 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

659 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
 && c⁄->
rs
.
°©emít
 =
°mt
 &&

660 (
rc
 = 
	`db_‰ì_ªsu…s_öt
(
c⁄
)) != 0)

665 
rc
 = 
c⁄
->
drivî
->
›s
.
	`˛o£
(
°mt
);

667 i‡(
°mt
->
quîy
 !
NULL
)

669 
	`‰ì
(
°mt
->
quîy
);

670 
°mt
->
quîy
 = 
NULL
;

672 i‡(
°mt
->
bound_∑øm
 !
NULL
)

674 
	`‰ì
(
°mt
->
bound_∑øm
);

675 
°mt
->
bound_∑øm
 = 
NULL
;

677 
	`‰ì
(
°mt
);

679  
rc
;

680 
	}
}

684 
	$db_d⁄e
()

686 
sb_li°_ôem_t
 *
pos
;

687 
db_drivî_t
 *
drv
;

689 i‡(!
db_globÆ_öôülized
)

692 
	`dißbÀ_¥öt_°©s
();

694 i‡(
db_globÆs
.
debug
)

696 
	`‰ì
(
exec_timîs
);

697 
	`‰ì
(
„tch_timîs
);

699 
exec_timîs
 = 
„tch_timîs
 = 
NULL
;

702 
	`SB_LIST_FOR_EACH
(
pos
, &
drivîs
)

704 
drv
 = 
	`SB_LIST_ENTRY
(
pos
, 
db_drivî_t
, 
li°ôem
);

705 i‡(
drv
->
öôülized
)

707 
drv
->
›s
.
	`d⁄e
();

708 
	`±hªad_muãx_de°roy
(&
drv
->
muãx
);

713 
	}
}

719 
	$db_∑r£_¨gumíts
()

721 *
s
;

723 
s
 = 
	`sb_gë_vÆue_°rög
("db-ps-mode");

725 i‡(!
	`°rcmp
(
s
, "auto"))

726 
db_globÆs
.
ps_mode
 = 
DB_PS_MODE_AUTO
;

727 i‡(!
	`°rcmp
(
s
, "disable"))

728 
db_globÆs
.
ps_mode
 = 
DB_PS_MODE_DISABLE
;

731 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ db-ps-mode: %s", 
s
);

735 
db_globÆs
.
drivî
 = 
	`sb_gë_vÆue_°rög
("db-driver");

737 
db_globÆs
.
debug
 = 
	`sb_gë_vÆue_Êag
("db-debug");

740 
	}
}

746 
	$db_¥öt_vÆue
(
db_böd_t
 *
v¨
, *
buf
, 
buÊí
)

748 
n
;

749 
db_time_t
 *
tm
;

751 i‡(
v¨
->
is_nuŒ
 !
NULL
 && *var->is_null)

753 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "NULL");

754  (
n
 < 
buÊí
) ?Ç : -1;

757 
v¨
->
ty≥
) {

758 
DB_TYPE_TINYINT
:

759 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "%hhd", *(*)
v¨
->
buf„r
);

761 
DB_TYPE_SMALLINT
:

762 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "%hd", *(*)
v¨
->
buf„r
);

764 
DB_TYPE_INT
:

765 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "%d", *(*)
v¨
->
buf„r
);

767 
DB_TYPE_BIGINT
:

768 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "%Œd", *(*)
v¨
->
buf„r
);

770 
DB_TYPE_FLOAT
:

771 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "%f", *(*)
v¨
->
buf„r
);

773 
DB_TYPE_DOUBLE
:

774 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "%f", *(*)
v¨
->
buf„r
);

776 
DB_TYPE_CHAR
:

777 
DB_TYPE_VARCHAR
:

778 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "'%s'", (*)
v¨
->
buf„r
);

780 
DB_TYPE_DATE
:

781 
tm
 = (
db_time_t
 *)
v¨
->
buf„r
;

782 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "'%d-%d-%d'", 
tm
->
yór
,Åm->
m⁄th
,Åm->
day
);

784 
DB_TYPE_TIME
:

785 
tm
 = (
db_time_t
 *)
v¨
->
buf„r
;

786 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "'%d:%d:%d'", 
tm
->
hour
,Åm->
möuã
,

787 
tm
->
£c⁄d
);

789 
DB_TYPE_DATETIME
:

790 
DB_TYPE_TIMESTAMP
:

791 
tm
 = (
db_time_t
 *)
v¨
->
buf„r
;

792 
n
 = 
	`¢¥ötf
(
buf
, 
buÊí
, "'%d-%d-%d %d:%d:%d'", 
tm
->
yór
,Åm->
m⁄th
,

793 
tm
->
day
,Åm->
hour
,Åm->
möuã
,Åm->
£c⁄d
);

796 
n
 = 0;

800  (
n
 < 
buÊí
) ?Ç : -1;

801 
	}
}

808 
	$db_‰ì_row
(
db_row_t
 *
row
)

810 
	`‰ì
(
row
);

811 
	}
}

817 
	$db_bulk_ö£π_öô
(
db_c⁄n_t
 *
c⁄
, c⁄° *
quîy
, 
size_t
 
quîy_Àn
)

819 
drv_ˇps_t
 
drivî_ˇps
;

820 
rc
;

822 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

824 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

827 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
 &&

828 (
rc
 = 
	`db_‰ì_ªsu…s_öt
(
c⁄
)) != 0)

834 i‡(
	`db_des¸ibe
(
c⁄
->
drivî
, &
drivî_ˇps
))

836 
	`log_ãxt
(
LOG_FATAL
, "failedÅo get database capabilities!");

841 i‡(
quîy_Àn
 + 1 > 
BULK_PACKET_SIZE
)

843 
	`log_ãxt
(
LOG_FATAL
,

845 
BULK_PACKET_SIZE
);

848 
c⁄
->
bulk_buÊí
 = 
BULK_PACKET_SIZE
;

849 
c⁄
->
bulk_buf„r
 = (*)
	`mÆloc
(c⁄->
bulk_buÊí
);

850 i‡(
c⁄
->
bulk_buf„r
 =
NULL
)

853 
c⁄
->
bulk_commô_max
 = 
drivî_ˇps
.
√eds_commô
 ? 
ROWS_BEFORE_COMMIT
 : 0;

854 
c⁄
->
bulk_commô_˙t
 = 0;

855 
	`°r˝y
(
c⁄
->
bulk_buf„r
, 
quîy
);

856 
c⁄
->
bulk_±r
 = 
quîy_Àn
;

857 
c⁄
->
bulk_vÆues
 = 
quîy_Àn
;

858 
c⁄
->
bulk_˙t
 = 0;

861 
	}
}

865 
	$db_bulk_ö£π_√xt
(
db_c⁄n_t
 *
c⁄
, c⁄° *
quîy
, 
size_t
 
quîy_Àn
)

867 
rc
;

869 i‡(
c⁄
->
°©e
 =
DB_CONN_INVALID
)

871 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo useánálready closed connection");

874 i‡(
c⁄
->
°©e
 =
DB_CONN_RESULT_SET
 &&

875 (
rc
 = 
	`db_‰ì_ªsu…s_öt
(
c⁄
)) != 0)

880 i‡(
c⁄
->
bulk_buf„r
 =
NULL
)

882 
	`log_ãxt
(
LOG_ALERT
, "attemptÅo call bulk_insert_next() before bulk_insert_init()");

890 i‡(
c⁄
->
bulk_±r
 + 
quîy_Àn
 + 1 + (c⁄->
bulk_˙t
>0Ë> c⁄->
bulk_buÊí
)

893 i‡(!
c⁄
->
bulk_˙t
)

895 
	`log_ãxt
(
LOG_FATAL
,

897 
c⁄
->
bulk_buÊí
);

900 i‡(
	`db_bulk_do_ö£π
(
c⁄
, 0))

904 i‡(
c⁄
->
bulk_˙t
 > 0)

906 
c⁄
->
bulk_buf„r
[c⁄->
bulk_±r
] = ',';

907 
	`°r˝y
(
c⁄
->
bulk_buf„r
 + c⁄->
bulk_±r
 + 1, 
quîy
);

910 
	`°r˝y
(
c⁄
->
bulk_buf„r
 + c⁄->
bulk_±r
, 
quîy
);

911 
c⁄
->
bulk_±r
 +
quîy_Àn
 + (c⁄->
bulk_˙t
 > 0);

913 
c⁄
->
bulk_˙t
++;

916 
	}
}

920 
	$db_bulk_do_ö£π
(
db_c⁄n_t
 *
c⁄
, 
is_œ°
)

922 i‡(!
c⁄
->
bulk_˙t
)

925 i‡(
	`db_quîy
(
c⁄
, c⁄->
bulk_buf„r
, c⁄->
bulk_±r
Ë=
NULL
 &&

926 
c⁄
->
îr‹
 !
DB_ERROR_NONE
)

930 i‡(
c⁄
->
bulk_commô_max
 != 0)

932 
c⁄
->
bulk_commô_˙t
 +c⁄->
bulk_˙t
;

934 i‡(
is_œ°
 || 
c⁄
->
bulk_commô_˙t
 >c⁄->
bulk_commô_max
)

936 i‡(
	`db_quîy
(
c⁄
, "COMMIT", 6Ë=
NULL
 &&

937 
c⁄
->
îr‹
 !
DB_ERROR_NONE
)

939 
c⁄
->
bulk_commô_˙t
 = 0;

943 
c⁄
->
bulk_±r
 = c⁄->
bulk_vÆues
;

944 
c⁄
->
bulk_˙t
 = 0;

947 
	}
}

951 
	$db_bulk_ö£π_d⁄e
(
db_c⁄n_t
 *
c⁄
)

954 i‡(
	`db_bulk_do_ö£π
(
c⁄
, 1))

957 i‡(
c⁄
->
bulk_buf„r
 !
NULL
)

959 
	`‰ì
(
c⁄
->
bulk_buf„r
);

960 
c⁄
->
bulk_buf„r
 = 
NULL
;

964 
	}
}

966 
	$db_ªp‹t_öãrmedüã
(
sb_°©_t
 *
°©
)

969 i‡(!
	`check_¥öt_°©s
())

971 
	`sb_ªp‹t_öãrmedüã
(
°©
);

975 c⁄° 
£c⁄ds
 = 
°©
->
time_öãrvÆ
;

977 
	`log_time°amp
(
LOG_NOTICE
, 
°©
->
time_tŸÆ
,

982 
°©
->
thªads_ru¬ög
,

983 
°©
->
evíts
 / 
£c⁄ds
,

984 (
°©
->
ªads
 + sèt->
wrôes
 + sèt->
Ÿhî
Ë/ 
£c⁄ds
,

985 
°©
->
ªads
 / 
£c⁄ds
,

986 
°©
->
wrôes
 / 
£c⁄ds
,

987 
°©
->
Ÿhî
 / 
£c⁄ds
,

988 
sb_globÆs
.
≥r˚¡ûe
,

989 
	`SEC2MS
(
°©
->
œãncy_p˘
),

990 
°©
->
îr‹s
 / 
£c⁄ds
,

991 
°©
->
ªc⁄√˘s
 / 
£c⁄ds
);

993 i‡(
sb_globÆs
.
tx_øã
 > 0)

995 
	`log_time°amp
(
LOG_NOTICE
, 
°©
->
time_tŸÆ
,

996 "queuêÀngth: %" 
PRIu64
", concurrency: %" PRIu64,

997 
°©
->
queue_Àngth
, sèt->
c⁄cuºícy
);

999 
	}
}

1002 
	$db_ªp‹t_cumuœtive
(
sb_°©_t
 *
°©
)

1004 
sb_timî_t
 
exec_timî
;

1005 
sb_timî_t
 
„tch_timî
;

1008 i‡(!
	`check_¥öt_°©s
())

1010 
	`sb_ªp‹t_cumuœtive
(
°©
);

1014 c⁄° 
£c⁄ds
 = 
°©
->
time_öãrvÆ
;

1015 c⁄° 
uöt64_t
 
quîõs
 = 
°©
->
ªads
 + sèt->
wrôes
 + sèt->
Ÿhî
;

1017 
	`log_ãxt
(
LOG_NOTICE
, "SQL statistics:");

1018 
	`log_ãxt
(
LOG_NOTICE
, " queriesÖerformed:");

1019 
	`log_ãxt
(
LOG_NOTICE
, "Ñód: %" 
PRIu64
,

1020 
°©
->
ªads
);

1021 
	`log_ãxt
(
LOG_NOTICE
, " wrôe: %" 
PRIu64
,

1022 
°©
->
wrôes
);

1023 
	`log_ãxt
(
LOG_NOTICE
, " othî: %" 
PRIu64
,

1024 
°©
->
Ÿhî
);

1025 
	`log_ãxt
(
LOG_NOTICE
, "ÅŸÆ: %" 
PRIu64
,

1026 
quîõs
);

1027 
	`log_ãxt
(
LOG_NOTICE
, "Åønß˘i⁄s: %-6" 
PRIu64


1028 " (%.2‡≥∏£c.)", 
°©
->
evíts
, sèt->evít†/ 
£c⁄ds
);

1029 
	`log_ãxt
(
LOG_NOTICE
, " quîõs: %-6" 
PRIu64


1030 " (%.2‡≥∏£c.)", 
quîõs
,

1031 
quîõs
 / 
£c⁄ds
);

1032 
	`log_ãxt
(
LOG_NOTICE
, " ign‹edÉº‹s: %-6" 
PRIu64


1033 " (%.2‡≥∏£c.)", 
°©
->
îr‹s
, sèt->îr‹†/ 
£c⁄ds
);

1034 
	`log_ãxt
(
LOG_NOTICE
, "Ñec⁄√˘s: %-6" 
PRIu64


1035 " (%.2‡≥∏£c.)", 
°©
->
ªc⁄√˘s
, sèt->ªc⁄√˘†/ 
£c⁄ds
);

1037 i‡(
db_globÆs
.
debug
)

1039 
	`sb_timî_öô
(&
exec_timî
);

1040 
	`sb_timî_öô
(&
„tch_timî
);

1042 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

1044 
exec_timî
 = 
	`sb_timî_mîge
(&exec_timî, 
exec_timîs
 + 
i
);

1045 
„tch_timî
 = 
	`sb_timî_mîge
(&„tch_timî, 
„tch_timîs
 + 
i
);

1048 
	`log_ãxt
(
LOG_DEBUG
, "");

1049 
	`log_ãxt
(
LOG_DEBUG
, "QueryÉxecution statistics:");

1050 
	`log_ãxt
(
LOG_DEBUG
, " min: %.4fs",

1051 
	`NS2SEC
(
	`sb_timî_mö
(&
exec_timî
)));

1052 
	`log_ãxt
(
LOG_DEBUG
, "ávg: %.4fs",

1053 
	`NS2SEC
(
	`sb_timî_avg
(&
exec_timî
)));

1054 
	`log_ãxt
(
LOG_DEBUG
, " max: %.4fs",

1055 
	`NS2SEC
(
	`sb_timî_max
(&
exec_timî
)));

1056 
	`log_ãxt
(
LOG_DEBUG
, "Åotal: %.4fs",

1057 
	`NS2SEC
(
	`sb_timî_sum
(&
exec_timî
)));

1059 
	`log_ãxt
(
LOG_DEBUG
, "Results fetching statistics:");

1060 
	`log_ãxt
(
LOG_DEBUG
, " min: %.4fs",

1061 
	`NS2SEC
(
	`sb_timî_mö
(&
„tch_timî
)));

1062 
	`log_ãxt
(
LOG_DEBUG
, "ávg: %.4fs",

1063 
	`NS2SEC
(
	`sb_timî_avg
(&
„tch_timî
)));

1064 
	`log_ãxt
(
LOG_DEBUG
, " max: %.4fs",

1065 
	`NS2SEC
(
	`sb_timî_max
(&
„tch_timî
)));

1066 
	`log_ãxt
(
LOG_DEBUG
, "Åotal: %.4fs",

1067 
	`NS2SEC
(
	`sb_timî_sum
(&
„tch_timî
)));

1071 
	`sb_ªp‹t_cumuœtive
(
°©
);

1072 
	}
}

1075 
	$db_ª£t_°©s
()

1077 
i
;

1083 
	`sb_timî_cuºít
(&
sb_öãrmedüã_timî
);

1085 i‡(
db_globÆs
.
debug
)

1087 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

1089 
	`sb_timî_öô
(
exec_timîs
 + 
i
);

1090 
	`sb_timî_öô
(
„tch_timîs
 + 
i
);

1093 
	}
}

	@db_driver.h

19 #i‚de‡
DB_DRIVER_H


20 
	#DB_DRIVER_H


	)

22 #ifde‡
HAVE_CONFIG_H


23 
	~"c⁄fig.h
"

26 
	~"sysbích.h
"

27 
	~"sb_li°.h
"

28 
	~"sb_hi°ogøm.h
"

29 
	~"sb_cou¡î.h
"

35 
	mDB_PS_MODE_AUTO
,

36 
	mDB_PS_MODE_DISABLE
,

37 } 
	tdb_ps_mode_t
;

43 
db_ps_mode_t
 
	mps_mode
;

44 *
	mdrivî
;

45 
	mdebug
;

46 } 
	tdb_globÆs_t
;

52 
	mmu…i_rows_ö£π
;

53 
	m¥ï¨ed_°©emíts
;

54 
	mauto_ö¸emít
;

55 
	m√eds_commô
;

56 
	m£rül
;

57 
	munsig√d_öt
;

58 } 
	tdrv_ˇps_t
;

64 
	mDB_ERROR_NONE
,

65 
	mDB_ERROR_IGNORABLE
,

67 
	mDB_ERROR_FATAL


68 } 
	tdb_îr‹_t
;

75 
	mDB_TYPE_NONE
,

76 
	mDB_TYPE_TINYINT
,

77 
	mDB_TYPE_SMALLINT
,

78 
	mDB_TYPE_INT
,

79 
	mDB_TYPE_BIGINT
,

80 
	mDB_TYPE_FLOAT
,

81 
	mDB_TYPE_DOUBLE
,

82 
	mDB_TYPE_TIME
,

83 
	mDB_TYPE_DATE
,

84 
	mDB_TYPE_DATETIME
,

85 
	mDB_TYPE_TIMESTAMP
,

86 
	mDB_TYPE_CHAR
,

87 
	mDB_TYPE_VARCHAR


88 } 
	tdb_böd_ty≥_t
;

95 
	myór
;

96 
	mm⁄th
;

97 
	mday
;

98 
	mhour
;

99 
	mmöuã
;

100 
	m£c⁄d
;

101 } 
	tdb_time_t
;

108 
db_böd_ty≥_t
 
	mty≥
;

109 *
	mbuf„r
;

110 *
	md©a_Àn
;

111 
	mmax_Àn
;

112 *
	mis_nuŒ
;

113 } 
	tdb_böd_t
;

117 
	gdb_c⁄n
;

118 
	gdb_°mt
;

119 
	gdb_ªsu…
;

120 
	gdb_row
;

124 
	tdrv_›_öô
();

125 
	tdrv_›_thªad_öô
();

126 
	tdrv_›_des¸ibe
(
	tdrv_ˇps_t
 *);

127 
	tdrv_›_c⁄√˘
(
	tdb_c⁄n
 *);

128 
	tdrv_›_ªc⁄√˘
(
	tdb_c⁄n
 *);

129 
	tdrv_›_disc⁄√˘
(
	tdb_c⁄n
 *);

130 
	tdrv_›_¥ï¨e
(
	tdb_°mt
 *, c⁄° *, 
	tsize_t
);

131 
	tdrv_›_böd_∑øm
(
	tdb_°mt
 *, 
	tdb_böd_t
 *, 
	tsize_t
);

132 
	tdrv_›_böd_ªsu…
(
	tdb_°mt
 *, 
	tdb_böd_t
 *, 
	tsize_t
);

133 
db_îr‹_t
 
	tdrv_›_execuã
(
	tdb_°mt
 *, 
	tdb_ªsu…
 *);

134 
	tdrv_›_„tch
(
	tdb_ªsu…
 *);

135 
	tdrv_›_„tch_row
(
	tdb_ªsu…
 *, 
	tdb_row
 *);

136 
db_îr‹_t
 
	tdrv_›_quîy
(
	tdb_c⁄n
 *, c⁄° *, 
	tsize_t
,

137 
	tdb_ªsu…
 *);

138 
	tdrv_›_‰ì_ªsu…s
(
	tdb_ªsu…
 *);

139 
	tdrv_›_˛o£
(
	tdb_°mt
 *);

140 
	tdrv_›_thªad_d⁄e
();

141 
	tdrv_›_d⁄e
();

145 
drv_›_öô
 *
	möô
;

146 
drv_›_thªad_öô
 *
	mthªad_öô
;

147 
drv_›_des¸ibe
 *
	mdes¸ibe
;

148 
drv_›_c⁄√˘
 *
	mc⁄√˘
;

149 
drv_›_disc⁄√˘
 *
	mdisc⁄√˘
;

150 
drv_›_ªc⁄√˘
 *
	mªc⁄√˘
;

151 
drv_›_¥ï¨e
 *
	m¥ï¨e
;

152 
drv_›_böd_∑øm
 *
	mböd_∑øm
;

153 
drv_›_böd_ªsu…
 *
	mböd_ªsu…
;

154 
drv_›_execuã
 *
	mexecuã
;

155 
drv_›_„tch
 *
	m„tch
;

156 
drv_›_„tch_row
 *
	m„tch_row
;

157 
drv_›_‰ì_ªsu…s
 *
	m‰ì_ªsu…s
;

158 
drv_›_˛o£
 *
	m˛o£
;

159 
drv_›_quîy
 *
	mquîy
;

160 
drv_›_thªad_d⁄e
 *
	mthªad_d⁄e
;

161 
drv_›_d⁄e
 *
	md⁄e
;

162 } 
	tdrv_›s_t
;

168 c⁄° *
	m¢ame
;

169 c⁄° *
	m ame
;

170 
sb_¨g_t
 *
	m¨gs
;

171 
drv_›s_t
 
	m›s
;

173 
sb_li°_ôem_t
 
	mli°ôem
;

174 
boﬁ
 
	möôülized
;

175 
±hªad_muãx_t
 
	mmuãx
;

176 } 
	tdb_drivî_t
;

181 
uöt32_t
 
	mÀn
;

182 c⁄° *
	m±r
;

183 } 
	tdb_vÆue_t
;

187 
	sdb_row


189 *
	m±r
;

190 
db_vÆue_t
 *
	mvÆues
;

191 } 
	tdb_row_t
;

195 
	sdb_ªsu…


197 
sb_cou¡î_ty≥_t
 
	mcou¡î
;

198 
uöt32_t
 
	mƒows
;

199 
uöt32_t
 
	mnfõlds
;

200 
db_°mt
 *
	m°©emít
;

201 *
	m±r
;

202 
db_row_t
 
	mrow
;

203 } 
	tdb_ªsu…_t
;

206 
	mDB_CONN_READY
,

207 
	mDB_CONN_RESULT_SET
,

208 
	mDB_CONN_INVALID


209 } 
	tdb_c⁄n_°©e_t
;

213 
	sdb_c⁄n


215 
db_îr‹_t
 
	mîr‹
;

216 
	msql_î∫o
;

217 c⁄° *
	msql_°©e
;

218 c⁄° *
	msql_îrmsg
;

219 
db_drivî_t
 *
	mdrivî
;

220 *
	m±r
;

221 
db_ªsu…_t
 
	mrs
;

222 
db_c⁄n_°©e_t
 
	m°©e
;

223 
	mthªad_id
;

225 
	mbulk_˙t
;

226 
	mbulk_buÊí
;

227 *
	mbulk_buf„r
;

228 
	mbulk_±r
;

229 
	mbulk_vÆues
;

230 
	mbulk_commô_˙t
;

231 
	mbulk_commô_max
;

233 
	m∑d
[
SB_CACHELINE_PAD
((
db_îr‹_t
) +

239 (
db_ªsu…_t
) +

240 (
db_c⁄n_°©e_t
) +

246 } 
	tdb_c⁄n_t
;

250 
	sdb_°mt


252 
db_c⁄n_t
 *
	mc⁄√˘i⁄
;

253 *
	mquîy
;

254 
db_böd_t
 *
	mbound_∑øm
;

255 
	mbound_∑øm_Àn
;

256 
db_böd_t
 *
	mbound_ªs
;

257 
db_böd_t
 *
	mbound_ªs_Àn
;

258 
	memuœãd
;

259 
sb_cou¡î_ty≥_t
 
	mcou¡î
;

260 *
	m±r
;

261 } 
	tdb_°mt_t
;

263 
db_globÆs_t
 
db_globÆs
;

267 
db_ªgi°î
();

269 
db_¥öt_hñp
();

271 
db_drivî_t
 *
db_¸óã
(const *);

273 
db_de°roy
(
db_drivî_t
 *);

275 
db_des¸ibe
(
db_drivî_t
 *, 
drv_ˇps_t
 *);

277 
db_c⁄n_t
 *
db_c⁄√˘i⁄_¸óã
(
db_drivî_t
 *);

279 
db_c⁄√˘i⁄_˛o£
(
db_c⁄n_t
 *);

281 
db_c⁄√˘i⁄_ªc⁄√˘
(
db_c⁄n_t
 *
c⁄
);

283 
db_c⁄√˘i⁄_‰ì
(
db_c⁄n_t
 *
c⁄
);

285 
db_°mt_t
 *
db_¥ï¨e
(
db_c⁄n_t
 *, c⁄° *, 
size_t
);

287 
db_böd_∑øm
(
db_°mt_t
 *, 
db_böd_t
 *, 
size_t
);

289 
db_böd_ªsu…
(
db_°mt_t
 *, 
db_böd_t
 *, 
size_t
);

291 
db_ªsu…_t
 *
db_execuã
(
db_°mt_t
 *);

293 
db_row_t
 *
db_„tch_row
(
db_ªsu…_t
 *);

295 
db_ªsu…_t
 *
db_quîy
(
db_c⁄n_t
 *, c⁄° *, 
size_t
 
Àn
);

297 
db_‰ì_ªsu…s
(
db_ªsu…_t
 *);

299 
db_°‹e_ªsu…s
(
db_ªsu…_t
 *);

301 
db_˛o£
(
db_°mt_t
 *);

303 
db_d⁄e
();

305 
db_¥öt_vÆue
(
db_böd_t
 *, *, );

308 
db_bulk_ö£π_öô
(
db_c⁄n_t
 *, c⁄° *, 
size_t
);

311 
db_bulk_ö£π_√xt
(
db_c⁄n_t
 *, c⁄° *, 
size_t
);

314 
db_bulk_ö£π_d⁄e
(
db_c⁄n_t
 *);

317 
db_ªp‹t_öãrmedüã
(
sb_°©_t
 *);

318 
db_ªp‹t_cumuœtive
(
sb_°©_t
 *);

322 #ifde‡
USE_MYSQL


323 
ªgi°î_drivî_mysql
(
sb_li°_t
 *);

326 #ifde‡
USE_PGSQL


327 
ªgi°î_drivî_pgsql
(
sb_li°_t
 *);

	@drivers/mysql/drv_mysql.c

19 #ifde‡
STDC_HEADERS


20 
	~<°dio.h
>

22 #ifde‡
HAVE_CONFIG_H


23 
	~"c⁄fig.h
"

26 #ifde‡
HAVE_STRING_H


27 
	~<°rög.h
>

29 #ifde‡
HAVE_STRINGS_H


30 
	~<°rögs.h
>

32 
	~<°dio.h
>

34 
	~<mysql.h
>

35 
	~<mysqld_îr‹.h
>

36 
	~<îrmsg.h
>

38 
	~"sb_›ti⁄s.h
"

39 
	~"db_drivî.h
"

41 
	#DEBUG
(
f‹m©
, ...) \

43 i‡(
	`SB_UNLIKELY
(
¨gs
.
debug
 != 0)) \

44 
	`log_ãxt
(
LOG_DEBUG
, 
f‹m©
, 
__VA_ARGS__
); \

45 } 0)

	)

47 
ölöe
 c⁄° *
	$SAFESTR
(c⁄° *
s
)

49  
s
 ? s : "(null)";

50 
	}
}

52 #i‡!
deföed
(
MARIADB_BASE_VERSION
Ë&& !deföed(
MARIADB_VERSION_ID
) && \

53 
	gMYSQL_VERSION_ID
 >80001 && 
MYSQL_VERSION_ID
 != 80002

54 
boﬁ
 
	tmy_boﬁ
;

59 
sb_¨g_t
 
	gmysql_drv_¨gs
[] =

61 
SB_OPT
("mysql-ho°", "MySQL sîvî ho°", "loˇlho°", 
LIST
),

62 
SB_OPT
("mysql-p‹t", "MySQL sîvîÖ‹t", "3306", 
LIST
),

63 
SB_OPT
("mysql-sockë", "MySQL sockë", 
NULL
, 
LIST
),

64 
SB_OPT
("mysql-u£r", "MySQL u£r", "sbã°", 
STRING
),

65 
SB_OPT
("mysql-∑ssw‹d", "MySQLÖassw‹d", "", 
STRING
),

66 
SB_OPT
("mysql-db", "MySQL d©aba£Çame", "sbã°", 
STRING
),

67 #ifde‡
HAVE_MYSQL_OPT_SSL_MODE


68 
SB_OPT
("mysql-ssl", "SSL mode. ThisácceptsÅhe same valuesásÅhe "

70 "dißbÀd", 
STRING
),

72 
SB_OPT
("mysql-ssl", "use SSL connections, ifávailable inÅhe client "

73 "libøry", "off", 
BOOL
),

75 
SB_OPT
("mysql-s¶-key", "∑thÇamêo‡thê˛õ¡Öriv©êkey fûe", 
NULL
,

76 
STRING
),

77 
SB_OPT
("mysql-s¶-ˇ", "∑thÇamêo‡thêCA fûe", 
NULL
, 
STRING
),

78 
SB_OPT
("mysql-ssl-cert",

79 "∑thÇamêo‡thê˛õ¡Öubli¯key cîtifiˇã fûe", 
NULL
, 
STRING
),

80 
SB_OPT
("mysql-ssl-cipher", "use specific cipher for SSL connections", "",

81 
STRING
),

82 
SB_OPT
("mysql-compression", "use compression, ifávailable inÅhe "

83 "˛õ¡Üibøry", "off", 
BOOL
),

84 
SB_OPT
("mysql-debug", "åa˚áŒ clõ¡Üibøry cÆls", "off", 
BOOL
),

85 
SB_OPT
("mysql-ignore-errors", "list ofÉrrorsÅo ignore, or \"all\"",

86 "1213,1020,1205", 
LIST
),

87 
SB_OPT
("mysql-dry-run", "DryÑun,ÖretendÅhatáll MySQL client API "

88 "ˇŒ†¨êsuc˚ssfu»wôhouàexecutögÅhem", "off", 
BOOL
),

90 
SB_OPT_END


95 
sb_li°_t
 *
	mho°s
;

96 
sb_li°_t
 *
	mp‹ts
;

97 
sb_li°_t
 *
	msockës
;

98 c⁄° *
	mu£r
;

99 c⁄° *
	m∑ssw‹d
;

100 c⁄° *
	mdb
;

101 #ifde‡
HAVE_MYSQL_OPT_SSL_MODE


102 
	ms¶_mode
;

104 
boﬁ
 
	mu£_s¶
;

105 c⁄° *
	ms¶_key
;

106 c⁄° *
	ms¶_˚π
;

107 c⁄° *
	ms¶_ˇ
;

108 c⁄° *
	ms¶_cùhî
;

109 
	mu£_com¥essi⁄
;

110 
	mdebug
;

111 
sb_li°_t
 *
	mign‹ed_îr‹s
;

112 
	mdry_run
;

113 } 
	tmysql_drv_¨gs_t
;

117 
MYSQL
 *
	mmysql
;

118 c⁄° *
	mho°
;

119 c⁄° *
	mu£r
;

120 c⁄° *
	m∑ssw‹d
;

121 c⁄° *
	mdb
;

122 
	mp‹t
;

123 *
	msockë
;

124 } 
	tdb_mysql_c⁄n_t
;

126 #ifde‡
HAVE_MYSQL_OPT_SSL_MODE


128 c⁄° *
	m«me
;

129 
mysql_s¶_mode
 
	mmode
;

130 } 
	ts¶_mode_m≠_t
;

138 
db_böd_ty≥_t
 
	mdb_ty≥
;

139 
	mmy_ty≥
;

140 } 
	tdb_mysql_böd_m≠_t
;

143 
db_mysql_böd_m≠_t
 
	gdb_mysql_böd_m≠
[] =

145 {
DB_TYPE_TINYINT
, 
MYSQL_TYPE_TINY
},

146 {
DB_TYPE_SMALLINT
, 
MYSQL_TYPE_SHORT
},

147 {
DB_TYPE_INT
, 
MYSQL_TYPE_LONG
},

148 {
DB_TYPE_BIGINT
, 
MYSQL_TYPE_LONGLONG
},

149 {
DB_TYPE_FLOAT
, 
MYSQL_TYPE_FLOAT
},

150 {
DB_TYPE_DOUBLE
, 
MYSQL_TYPE_DOUBLE
},

151 {
DB_TYPE_DATETIME
, 
MYSQL_TYPE_DATETIME
},

152 {
DB_TYPE_TIMESTAMP
, 
MYSQL_TYPE_TIMESTAMP
},

153 {
DB_TYPE_CHAR
, 
MYSQL_TYPE_STRING
},

154 {
DB_TYPE_VARCHAR
, 
MYSQL_TYPE_VAR_STRING
},

155 {
DB_TYPE_NONE
, 0}

160 
drv_ˇps_t
 
	gmysql_drv_ˇps
 =

172 
mysql_drv_¨gs_t
 
	g¨gs
;

174 
	gu£_ps
;

177 
sb_li°_ôem_t
 *
	gho°s_pos
;

178 
sb_li°_ôem_t
 *
	gp‹ts_pos
;

179 
sb_li°_ôem_t
 *
	gsockës_pos
;

181 
±hªad_muãx_t
 
	gpos_muãx
;

183 #ifde‡
HAVE_MYSQL_OPT_SSL_MODE


185 #i‡
MYSQL_VERSION_ID
 < 50711

190 
	#SSL_MODE_DISABLED
 1

	)

193 
s¶_mode_m≠_t
 
	gs¶_mode_«mes
[] = {

194 {"DISABLED", 
SSL_MODE_DISABLED
},

195 #i‡
MYSQL_VERSION_ID
 >= 50711

196 {"PREFERRED", 
SSL_MODE_PREFERRED
},

198 {"REQUIRED", 
SSL_MODE_REQUIRED
},

199 #i‡
MYSQL_VERSION_ID
 >= 50711

200 {"VERIFY_CA", 
SSL_MODE_VERIFY_CA
},

201 {"VERIFY_IDENTITY", 
SSL_MODE_VERIFY_IDENTITY
},

203 {
NULL
, 0}

209 
mysql_drv_öô
();

210 
mysql_drv_thªad_öô
();

211 
mysql_drv_des¸ibe
(
drv_ˇps_t
 *);

212 
mysql_drv_c⁄√˘
(
db_c⁄n_t
 *);

213 
mysql_drv_ªc⁄√˘
(
db_c⁄n_t
 *);

214 
mysql_drv_disc⁄√˘
(
db_c⁄n_t
 *);

215 
mysql_drv_¥ï¨e
(
db_°mt_t
 *, c⁄° *, 
size_t
);

216 
mysql_drv_böd_∑øm
(
db_°mt_t
 *, 
db_böd_t
 *, 
size_t
);

217 
mysql_drv_böd_ªsu…
(
db_°mt_t
 *, 
db_böd_t
 *, 
size_t
);

218 
db_îr‹_t
 
mysql_drv_execuã
(
db_°mt_t
 *, 
db_ªsu…_t
 *);

219 
mysql_drv_„tch
(
db_ªsu…_t
 *);

220 
mysql_drv_„tch_row
(
db_ªsu…_t
 *, 
db_row_t
 *);

221 
db_îr‹_t
 
mysql_drv_quîy
(
db_c⁄n_t
 *, c⁄° *, 
size_t
,

222 
db_ªsu…_t
 *);

223 
mysql_drv_‰ì_ªsu…s
(
db_ªsu…_t
 *);

224 
mysql_drv_˛o£
(
db_°mt_t
 *);

225 
mysql_drv_thªad_d⁄e
();

226 
mysql_drv_d⁄e
();

230 
db_drivî_t
 
	gmysql_drivî
 =

232 .
¢ame
 = "mysql",

233 .
	g ame
 = "MySQL driver",

234 .
	g¨gs
 = 
mysql_drv_¨gs
,

235 .
	g›s
 = {

236 .
öô
 = 
mysql_drv_öô
,

237 .
	gthªad_öô
 = 
mysql_drv_thªad_öô
,

238 .
	gdes¸ibe
 = 
mysql_drv_des¸ibe
,

239 .
	gc⁄√˘
 = 
mysql_drv_c⁄√˘
,

240 .
	gdisc⁄√˘
 = 
mysql_drv_disc⁄√˘
,

241 .
	gªc⁄√˘
 = 
mysql_drv_ªc⁄√˘
,

242 .
	g¥ï¨e
 = 
mysql_drv_¥ï¨e
,

243 .
	gböd_∑øm
 = 
mysql_drv_böd_∑øm
,

244 .
	gböd_ªsu…
 = 
mysql_drv_böd_ªsu…
,

245 .
	gexecuã
 = 
mysql_drv_execuã
,

246 .
	g„tch
 = 
mysql_drv_„tch
,

247 .
	g„tch_row
 = 
mysql_drv_„tch_row
,

248 .
	g‰ì_ªsu…s
 = 
mysql_drv_‰ì_ªsu…s
,

249 .
	g˛o£
 = 
mysql_drv_˛o£
,

250 .
	gquîy
 = 
mysql_drv_quîy
,

251 .
	gthªad_d⁄e
 = 
mysql_drv_thªad_d⁄e
,

252 .
	gd⁄e
 = 
mysql_drv_d⁄e


259 
gë_mysql_böd_ty≥
(
db_böd_ty≥_t
);

264 
	$ªgi°î_drivî_mysql
(
sb_li°_t
 *
drivîs
)

266 
	`SB_LIST_ADD_TAIL
(&
mysql_drivî
.
li°ôem
, 
drivîs
);

269 
	}
}

275 
	$mysql_drv_öô
()

277 
	`±hªad_muãx_öô
(&
pos_muãx
, 
NULL
);

279 
¨gs
.
ho°s
 = 
	`sb_gë_vÆue_li°
("mysql-host");

280 i‡(
	`SB_LIST_IS_EMPTY
(
¨gs
.
ho°s
))

282 
	`log_ãxt
(
LOG_FATAL
, "No MySQL hosts specified,áborting");

285 
ho°s_pos
 = 
	`SB_LIST_ITEM_NEXT
(
¨gs
.
ho°s
);

287 
¨gs
.
p‹ts
 = 
	`sb_gë_vÆue_li°
("mysql-port");

288 i‡(
	`SB_LIST_IS_EMPTY
(
¨gs
.
p‹ts
))

290 
	`log_ãxt
(
LOG_FATAL
, "No MySQLÖorts specified,áborting");

293 
p‹ts_pos
 = 
	`SB_LIST_ITEM_NEXT
(
¨gs
.
p‹ts
);

295 
¨gs
.
sockës
 = 
	`sb_gë_vÆue_li°
("mysql-socket");

296 
sockës_pos
 = 
¨gs
.
sockës
;

298 
¨gs
.
u£r
 = 
	`sb_gë_vÆue_°rög
("mysql-user");

299 
¨gs
.
∑ssw‹d
 = 
	`sb_gë_vÆue_°rög
("mysql-password");

300 
¨gs
.
db
 = 
	`sb_gë_vÆue_°rög
("mysql-db");

302 
¨gs
.
s¶_cùhî
 = 
	`sb_gë_vÆue_°rög
("mysql-ssl-cipher");

303 
¨gs
.
s¶_key
 = 
	`sb_gë_vÆue_°rög
("mysql-ssl-key");

304 
¨gs
.
s¶_˚π
 = 
	`sb_gë_vÆue_°rög
("mysql-ssl-cert");

305 
¨gs
.
s¶_ˇ
 = 
	`sb_gë_vÆue_°rög
("mysql-ssl-ca");

307 #ifde‡
HAVE_MYSQL_OPT_SSL_MODE


308 c⁄° * c⁄° 
s¶_mode_°rög
 = 
	`sb_gë_vÆue_°rög
("mysql-ssl");

310 
¨gs
.
s¶_mode
 = 0;

312 
i
 = 0; 
s¶_mode_«mes
[i].
«me
 !
NULL
; i++) {

313 i‡(!
	`°rˇ£cmp
(
s¶_mode_°rög
, 
s¶_mode_«mes
[
i
].
«me
)) {

314 
¨gs
.
s¶_mode
 = 
s¶_mode_«mes
[
i
].
mode
;

319 i‡(
¨gs
.
s¶_mode
 == 0)

321 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ --mysql-s¶: '%s'", 
s¶_mode_°rög
);

325 
¨gs
.
u£_s¶
 = (¨gs.
s¶_mode
 !
SSL_MODE_DISABLED
);

327 
¨gs
.
u£_s¶
 = 
	`sb_gë_vÆue_Êag
("mysql-ssl");

330 
¨gs
.
u£_com¥essi⁄
 = 
	`sb_gë_vÆue_Êag
("mysql-compression");

331 
¨gs
.
debug
 = 
	`sb_gë_vÆue_Êag
("mysql-debug");

332 i‡(
¨gs
.
debug
)

333 
sb_globÆs
.
vîbosôy
 = 
LOG_DEBUG
;

335 
¨gs
.
ign‹ed_îr‹s
 = 
	`sb_gë_vÆue_li°
("mysql-ignore-errors");

337 
¨gs
.
dry_run
 = 
	`sb_gë_vÆue_Êag
("mysql-dry-run");

339 
u£_ps
 = 0;

340 
mysql_drv_ˇps
.
¥ï¨ed_°©emíts
 = 1;

341 i‡(
db_globÆs
.
ps_mode
 !
DB_PS_MODE_DISABLE
)

342 
u£_ps
 = 1;

344 
	`DEBUG
("mysql_libøry_öô(%d, %p, %p)", 0, 
NULL
, NULL);

345 
	`mysql_libøry_öô
(0, 
NULL
, NULL);

348 
	}
}

352 
	$mysql_drv_thªad_öô
(
thªad_id
)

354 (Ë
thªad_id
;

356 c⁄° 
my_boﬁ
 
rc
 = 
	`mysql_thªad_öô
();

357 
	`DEBUG
("mysql_thªad_öô(Ë%d", (Ë
rc
);

359  
rc
 != 0;

360 
	}
}

364 
	$mysql_drv_thªad_d⁄e
(
thªad_id
)

366 (Ë
thªad_id
;

368 
	`DEBUG
("mysql_thread_end(%s)", "");

369 
	`mysql_thªad_íd
();

372 
	}
}

376 
	$mysql_drv_des¸ibe
(
drv_ˇps_t
 *
ˇps
)

378 *
ˇps
 = 
mysql_drv_ˇps
;

381 
	}
}

384 
	$mysql_drv_ªÆ_c⁄√˘
(
db_mysql_c⁄n_t
 *
db_mysql_c⁄
)

386 
MYSQL
 *
c⁄
 = 
db_mysql_c⁄
->
mysql
;

388 #ifde‡
HAVE_MYSQL_OPT_SSL_MODE


389 
	`DEBUG
("mysql_›ti⁄s(%p,%s,%d)", 
c⁄
, "MYSQL_OPT_SSL_MODE", 
¨gs
.
s¶_mode
);

390 
	`mysql_›ti⁄s
(
c⁄
, 
MYSQL_OPT_SSL_MODE
, &
¨gs
.
s¶_mode
);

393 i‡(
¨gs
.
u£_s¶
)

395 
	`DEBUG
("mysql_s¶_£t(%p, \"%s\", \"%s\", \"%s\", NULL, \"%s\")", 
c⁄
,

396 
	`SAFESTR
(
¨gs
.
s¶_key
), SAFESTR◊rgs.
s¶_˚π
), SAFESTR◊rgs.
s¶_ˇ
),

397 
	`SAFESTR
(
¨gs
.
s¶_cùhî
));

399 
	`mysql_s¶_£t
(
c⁄
, 
¨gs
.
s¶_key
,árgs.
s¶_˚π
,árgs.
s¶_ˇ
, 
NULL
,

400 
¨gs
.
s¶_cùhî
);

403 i‡(
¨gs
.
u£_com¥essi⁄
)

405 
	`DEBUG
("mysql_›ti⁄s(%p, %s, %s)",
c⁄
, "MYSQL_OPT_COMPRESS", "NULL");

406 
	`mysql_›ti⁄s
(
c⁄
, 
MYSQL_OPT_COMPRESS
, 
NULL
);

409 
	`DEBUG
("mysql_real_connect(%p, \"%s\", \"%s\", \"%s\", \"%s\", %u, \"%s\", %s)",

410 
c⁄
,

411 
	`SAFESTR
(
db_mysql_c⁄
->
ho°
),

412 
	`SAFESTR
(
db_mysql_c⁄
->
u£r
),

413 
	`SAFESTR
(
db_mysql_c⁄
->
∑ssw‹d
),

414 
	`SAFESTR
(
db_mysql_c⁄
->
db
),

415 
db_mysql_c⁄
->
p‹t
,

416 
	`SAFESTR
(
db_mysql_c⁄
->
sockë
),

417 (
MYSQL_VERSION_ID
 >= 50000) ? "CLIENT_MULTI_STATEMENTS" : "0"

420  
	`mysql_ªÆ_c⁄√˘
(
c⁄
,

421 
db_mysql_c⁄
->
ho°
,

422 
db_mysql_c⁄
->
u£r
,

423 
db_mysql_c⁄
->
∑ssw‹d
,

424 
db_mysql_c⁄
->
db
,

425 
db_mysql_c⁄
->
p‹t
,

426 
db_mysql_c⁄
->
sockë
,

427 #i‡
MYSQL_VERSION_ID
 >= 50000

428 
CLIENT_MULTI_STATEMENTS


432 Ë=
NULL
;

433 
	}
}

439 
	$mysql_drv_c⁄√˘
(
db_c⁄n_t
 *
sb_c⁄n
)

441 
MYSQL
 *
c⁄
;

442 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
;

444 i‡(
¨gs
.
dry_run
)

447 
db_mysql_c⁄
 = (
db_mysql_c⁄n_t
 *Ë
	`ˇŒoc
(1, (db_mysql_conn_t));

449 i‡(
db_mysql_c⁄
 =
NULL
)

452 
c⁄
 = (
MYSQL
 *Ë
	`mÆloc
((MYSQL));

453 i‡(
c⁄
 =
NULL
)

456 
db_mysql_c⁄
->
mysql
 = 
c⁄
;

458 
	`DEBUG
("mysql_öô(%p)", 
c⁄
);

459 
	`mysql_öô
(
c⁄
);

461 
	`±hªad_muãx_lock
(&
pos_muãx
);

463 i‡(
	`SB_LIST_IS_EMPTY
(
¨gs
.
sockës
))

465 
db_mysql_c⁄
->
sockë
 = 
NULL
;

466 
db_mysql_c⁄
->
ho°
 = 
	`SB_LIST_ENTRY
(
ho°s_pos
, 
vÆue_t
, 
li°ôem
)->
d©a
;

467 
db_mysql_c⁄
->
p‹t
 =

468 
	`©oi
(
	`SB_LIST_ENTRY
(
p‹ts_pos
, 
vÆue_t
, 
li°ôem
)->
d©a
);

474 
p‹ts_pos
 = 
	`SB_LIST_ITEM_NEXT
(ports_pos);

475 i‡(
p‹ts_pos
 =
¨gs
.
p‹ts
) {

476 
ho°s_pos
 = 
	`SB_LIST_ITEM_NEXT
(hosts_pos);

477 i‡(
ho°s_pos
 =
¨gs
.
ho°s
)

478 
ho°s_pos
 = 
	`SB_LIST_ITEM_NEXT
(hosts_pos);

480 
p‹ts_pos
 = 
	`SB_LIST_ITEM_NEXT
(ports_pos);

485 
db_mysql_c⁄
->
ho°
 = "localhost";

492 
sockës_pos
 = 
	`SB_LIST_ITEM_NEXT
(sockets_pos);

493 i‡(
sockës_pos
 =
¨gs
.
sockës
)

494 
sockës_pos
 = 
	`SB_LIST_ITEM_NEXT
(sockets_pos);

496 
db_mysql_c⁄
->
sockë
 = 
	`SB_LIST_ENTRY
(
sockës_pos
, 
vÆue_t
, 
li°ôem
)->
d©a
;

498 
	`±hªad_muãx_u∆ock
(&
pos_muãx
);

500 
db_mysql_c⁄
->
u£r
 = 
¨gs
.user;

501 
db_mysql_c⁄
->
∑ssw‹d
 = 
¨gs
.password;

502 
db_mysql_c⁄
->
db
 = 
¨gs
.db;

504 i‡(
	`mysql_drv_ªÆ_c⁄√˘
(
db_mysql_c⁄
))

506 i‡(!
	`SB_LIST_IS_EMPTY
(
¨gs
.
sockës
))

507 
	`log_ãxt
(
LOG_FATAL
, "unableÅo connectÅo MySQL server on socket '%s', "

508 "ab‹tög...", 
db_mysql_c⁄
->
sockë
);

510 
	`log_ãxt
(
LOG_FATAL
, "unableÅo connectÅo MySQL server on host '%s', "

512 
db_mysql_c⁄
->
ho°
, db_mysql_c⁄->
p‹t
);

513 
	`log_ãxt
(
LOG_FATAL
, "îr‹ %d: %s", 
	`mysql_î∫o
(
c⁄
),

514 
	`mysql_îr‹
(
c⁄
));

515 
	`‰ì
(
db_mysql_c⁄
);

516 
	`‰ì
(
c⁄
);

520 i‡(
¨gs
.
u£_s¶
)

522 
	`DEBUG
("mysql_get_ssl_cipher(con): \"%s\"",

523 
	`SAFESTR
(
	`mysql_gë_s¶_cùhî
(
c⁄
)));

526 
sb_c⁄n
->
±r
 = 
db_mysql_c⁄
;

529 
	}
}

535 
	$mysql_drv_disc⁄√˘
(
db_c⁄n_t
 *
sb_c⁄n
)

537 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
 = 
sb_c⁄n
->
±r
;

539 i‡(
¨gs
.
dry_run
)

541 i‡(
db_mysql_c⁄
 !
NULL
 && db_mysql_c⁄->
mysql
 != NULL)

543 
	`DEBUG
("mysql_˛o£(%p)", 
db_mysql_c⁄
->
mysql
);

544 
	`mysql_˛o£
(
db_mysql_c⁄
->
mysql
);

545 
	`‰ì
(
db_mysql_c⁄
->
mysql
);

546 
	`‰ì
(
db_mysql_c⁄
);

550 
	}
}

556 
	$mysql_drv_¥ï¨e
(
db_°mt_t
 *
°mt
, c⁄° *
quîy
, 
size_t
 
Àn
)

558 
MYSQL_STMT
 *
my°mt
;

559 
rc
;

561 i‡(
¨gs
.
dry_run
)

564 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
 = (db_mysql_c⁄n_à*Ë
°mt
->
c⁄√˘i⁄
->
±r
;

565 
MYSQL
 *
c⁄
 = 
db_mysql_c⁄
->
mysql
;

567 i‡(
c⁄
 =
NULL
)

570 i‡(
u£_ps
)

572 
my°mt
 = 
	`mysql_°mt_öô
(
c⁄
);

573 
	`DEBUG
("mysql_°mt_öô(%pË%p", 
c⁄
, 
my°mt
);

574 i‡(
my°mt
 =
NULL
)

576 
	`log_ãxt
(
LOG_FATAL
, "mysql_stmt_init() failed");

579 
°mt
->
±r
 = (*)
my°mt
;

580 
	`DEBUG
("mysql_°mt_¥ï¨e(%p, \"%s\", %uË%p", 
my°mt
, 
quîy
,

581 (Ë
Àn
, 
°mt
->
±r
);

582 i‡(
	`mysql_°mt_¥ï¨e
(
my°mt
, 
quîy
, 
Àn
))

585 
rc
 = 
	`mysql_î∫o
(
c⁄
);

586 
	`DEBUG
("mysql_î∫o(%pË%u", 
c⁄
, 
rc
);

587 i‡(
rc
 =
ER_UNSUPPORTED_PS
)

589 
	`log_ãxt
(
LOG_INFO
,

591 
quîy
, 
rc
, 
	`mysql_îr‹
(
c⁄
));

592 
emuœã
;

596 
	`log_ãxt
(
LOG_FATAL
, "mysql_stmt_prepare() failed");

597 
	`log_ãxt
(
LOG_FATAL
, "MySQLÉº‹: %d \"%s\"", 
rc
,

598 
	`mysql_îr‹
(
c⁄
));

599 
	`DEBUG
("mysql_°mt_˛o£(%p)", 
my°mt
);

600 
	`mysql_°mt_˛o£
(
my°mt
);

605 
°mt
->
quîy
 = 
	`°rdup
(query);

606 
°mt
->
cou¡î
 = (
	`mysql_°mt_fõld_cou¡
(
my°mt
) > 0) ?

607 
SB_CNT_READ
 : 
SB_CNT_WRITE
;

612 
emuœã
:

615 
°mt
->
emuœãd
 = 1;

616 
°mt
->
quîy
 = 
	`°rdup
(query);

619 
	}
}

622 
	$c⁄vît_to_mysql_böd
(
MYSQL_BIND
 *
myböd
, 
db_böd_t
 *
böd
)

624 
myböd
->
buf„r_ty≥
 = 
	`gë_mysql_böd_ty≥
(
böd
->
ty≥
);

625 
myböd
->
buf„r
 = 
böd
->buffer;

626 
myböd
->
buf„r_Àngth
 = 
böd
->
max_Àn
;

627 
myböd
->
Àngth
 = 
böd
->
d©a_Àn
;

636 #i‡
SIZEOF_BOOL
 > 1

637 #îr‹ 
This
 
code
 
assumes
 (
boﬁ
) == 1!

639 
myböd
->
is_nuŒ
 = (
my_boﬁ
 *Ë
böd
->is_null;

640 
	}
}

646 
	$mysql_drv_böd_∑øm
(
db_°mt_t
 *
°mt
, 
db_böd_t
 *
∑øms
, 
size_t
 
Àn
)

648 
MYSQL_BIND
 *
böd
;

649 
i
;

650 
my_boﬁ
 
rc
;

651 
∑øm_cou¡
;

653 i‡(
¨gs
.
dry_run
)

656 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
 = (db_mysql_c⁄n_à*Ë
°mt
->
c⁄√˘i⁄
->
±r
;

657 
MYSQL
 *
c⁄
 = 
db_mysql_c⁄
->
mysql
;

659 i‡(
c⁄
 =
NULL
)

662 i‡(!
°mt
->
emuœãd
)

664 i‡(
°mt
->
±r
 =
NULL
)

667 
∑øm_cou¡
 = 
	`mysql_°mt_∑øm_cou¡
(
°mt
->
±r
);

668 
	`DEBUG
("mysql_°mt_∑øm_cou¡(%pË%lu", 
°mt
->
±r
, 
∑øm_cou¡
);

669 i‡(
∑øm_cou¡
 !
Àn
)

671 
	`log_ãxt
(
LOG_FATAL
, "WrongÇumber ofÖarametersÅo mysql_stmt_bind_param");

675 
böd
 = (
MYSQL_BIND
 *)
	`ˇŒoc
(
Àn
, (MYSQL_BIND));

676 i‡(
böd
 =
NULL
)

678 
i
 = 0; i < 
Àn
; i++)

679 
	`c⁄vît_to_mysql_böd
(&
böd
[
i
], &
∑øms
[i]);

681 
rc
 = 
	`mysql_°mt_böd_∑øm
(
°mt
->
±r
, 
böd
);

682 
	`DEBUG
("mysql_°mt_böd_∑øm(%p, %pË%d", 
°mt
->
±r
, 
böd
, 
rc
);

683 i‡(
rc
)

685 
	`log_ãxt
(
LOG_FATAL
, "mysql_stmt_bind_param() failed");

686 
	`log_ãxt
(
LOG_FATAL
, "MySQLÉº‹: %d \"%s\"", 
	`mysql_î∫o
(
c⁄
),

687 
	`mysql_îr‹
(
c⁄
));

688 
	`‰ì
(
böd
);

691 
	`‰ì
(
böd
);

697 i‡(
°mt
->
bound_∑øm
 !
NULL
)

698 
	`‰ì
(
°mt
->
bound_∑øm
);

699 
°mt
->
bound_∑øm
 = (
db_böd_t
 *)
	`mÆloc
(
Àn
 * (db_bind_t));

700 i‡(
°mt
->
bound_∑øm
 =
NULL
)

702 
	`mem˝y
(
°mt
->
bound_∑øm
, 
∑øms
, 
Àn
 * (
db_böd_t
));

703 
°mt
->
bound_∑øm_Àn
 = 
Àn
;

707 
	}
}

713 
	$mysql_drv_böd_ªsu…
(
db_°mt_t
 *
°mt
, 
db_böd_t
 *
∑øms
, 
size_t
 
Àn
)

715 
MYSQL_BIND
 *
böd
;

716 
i
;

717 
my_boﬁ
 
rc
;

719 i‡(
¨gs
.
dry_run
)

722 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
 =(db_mysql_c⁄n_à*Ë
°mt
->
c⁄√˘i⁄
->
±r
;

723 
MYSQL
 *
c⁄
 = 
db_mysql_c⁄
->
mysql
;

725 i‡(
c⁄
 =
NULL
 || 
°mt
->
±r
 == NULL)

729 
böd
 = (
MYSQL_BIND
 *)
	`ˇŒoc
(
Àn
, (MYSQL_BIND));

730 i‡(
böd
 =
NULL
)

732 
i
 = 0; i < 
Àn
; i++)

733 
	`c⁄vît_to_mysql_böd
(&
böd
[
i
], &
∑øms
[i]);

735 
rc
 = 
	`mysql_°mt_böd_ªsu…
(
°mt
->
±r
, 
böd
);

736 
	`DEBUG
("mysql_°mt_böd_ªsu…(%p, %pË%d", 
°mt
->
±r
, 
böd
, 
rc
);

737 i‡(
rc
)

739 
	`‰ì
(
böd
);

742 
	`‰ì
(
böd
);

745 
	}
}

749 
	$mysql_drv_ªc⁄√˘
(
db_c⁄n_t
 *
sb_c⁄
)

751 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
 = (db_mysql_c⁄n_à*Ë
sb_c⁄
->
±r
;

752 
MYSQL
 *
c⁄
 = 
db_mysql_c⁄
->
mysql
;

754 
	`log_ãxt
(
LOG_DEBUG
, "Reconnecting");

756 
	`DEBUG
("mysql_˛o£(%p)", 
c⁄
);

757 
	`mysql_˛o£
(
c⁄
);

759 
	`mysql_drv_ªÆ_c⁄√˘
(
db_mysql_c⁄
))

761 i‡(
sb_globÆs
.
îr‹
)

762  
DB_ERROR_FATAL
;

764 
	`u¶ìp
(1000);

767 
	`log_ãxt
(
LOG_DEBUG
, "Reconnected");

769  
DB_ERROR_IGNORABLE
;

770 
	}
}

779 
db_îr‹_t
 
	$check_îr‹
(
db_c⁄n_t
 *
sb_c⁄
, c⁄° *
func
,

780 c⁄° *
quîy
, 
sb_cou¡î_ty≥_t
 *
cou¡î
)

782 
sb_li°_ôem_t
 *
pos
;

783 
tmp
;

784 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
 = (db_mysql_c⁄n_à*Ë
sb_c⁄
->
±r
;

785 
MYSQL
 *
c⁄
 = 
db_mysql_c⁄
->
mysql
;

787 c⁄° 
îr‹
 = 
	`mysql_î∫o
(
c⁄
);

788 
	`DEBUG
("mysql_î∫o(%pË%u", 
c⁄
, 
sb_c⁄
->
sql_î∫o
);

790 
sb_c⁄
->
sql_î∫o
 = (Ë
îr‹
;

792 
sb_c⁄
->
sql_°©e
 = 
	`mysql_sql°©e
(
c⁄
);

793 
	`DEBUG
("mysql_°©e(%pË%s", 
c⁄
, 
	`SAFESTR
(
sb_c⁄
->
sql_°©e
));

795 
sb_c⁄
->
sql_îrmsg
 = 
	`mysql_îr‹
(
c⁄
);

796 
	`DEBUG
("mysql_îr‹(%pË%s", 
c⁄
, 
	`SAFESTR
(
sb_c⁄
->
sql_îrmsg
));

802 
	`SB_LIST_FOR_EACH
(
pos
, 
¨gs
.
ign‹ed_îr‹s
)

804 c⁄° *
vÆ
 = 
	`SB_LIST_ENTRY
(
pos
, 
vÆue_t
, 
li°ôem
)->
d©a
;

806 
tmp
 = (Ë
	`©oi
(
vÆ
);

808 i‡(
îr‹
 =
tmp
 || !
	`°rcmp
(
vÆ
, "all"))

810 
	`log_ãxt
(
LOG_DEBUG
, "Ign‹ögÉº‹ %u %s, ", 
îr‹
, 
sb_c⁄
->
sql_îrmsg
);

813 
îr‹
)

815 
CR_SERVER_LOST
:

816 
CR_SERVER_GONE_ERROR
:

817 
CR_TCP_CONNECTION
:

818 
CR_SERVER_LOST_EXTENDED
:

820 *
cou¡î
 = 
SB_CNT_RECONNECT
;

822  
	`mysql_drv_ªc⁄√˘
(
sb_c⁄
);

829 *
cou¡î
 = 
SB_CNT_ERROR
;

831  
DB_ERROR_IGNORABLE
;

835 i‡(
quîy
)

836 
	`log_ãxt
(
LOG_FATAL
, "%sÑeturnedÉrror %u (%s) for query '%s'",

837 
func
, 
îr‹
, 
sb_c⁄
->
sql_îrmsg
, 
quîy
);

839 
	`log_ãxt
(
LOG_FATAL
, "%sÑeturnedÉrror %u (%s)",

840 
func
, 
îr‹
, 
sb_c⁄
->
sql_îrmsg
);

842 *
cou¡î
 = 
SB_CNT_ERROR
;

844  
DB_ERROR_FATAL
;

845 
	}
}

850 
db_îr‹_t
 
	$mysql_drv_execuã
(
db_°mt_t
 *
°mt
, 
db_ªsu…_t
 *
rs
)

852 
db_c⁄n_t
 *
c⁄
 = 
°mt
->
c⁄√˘i⁄
;

853 *
buf
 = 
NULL
;

854 
buÊí
 = 0;

855 
i
, 
j
, 
v˙t
;

856 
√ed_ªÆloc
;

857 
n
;

859 i‡(
¨gs
.
dry_run
)

860  
DB_ERROR_NONE
;

862 
c⁄
->
sql_î∫o
 = 0;

863 
c⁄
->
sql_°©e
 = 
NULL
;

864 
c⁄
->
sql_îrmsg
 = 
NULL
;

866 i‡(!
°mt
->
emuœãd
)

868 i‡(
°mt
->
±r
 =
NULL
)

870 
	`log_ãxt
(
LOG_DEBUG
,

872  
DB_ERROR_FATAL
;

875 
îr
 = 
	`mysql_°mt_execuã
(
°mt
->
±r
);

876 
	`DEBUG
("mysql_°mt_execuã(%pË%d", 
°mt
->
±r
, 
îr
);

878 i‡(
îr
)

879  
	`check_îr‹
(
c⁄
, "mysql_°mt_execuã()", 
°mt
->
quîy
,

880 &
rs
->
cou¡î
);

882 i‡(
°mt
->
cou¡î
 !
SB_CNT_READ
)

884 
rs
->
ƒows
 = (
uöt32_t
Ë
	`mysql_°mt_af„˘ed_rows
(
°mt
->
±r
);

885 
	`DEBUG
("mysql_°mt_af„˘ed_rows(%pË%u", 
°mt
->
±r
,

886 (Ë
rs
->
ƒows
);

888 
rs
->
cou¡î
 = (rs->
ƒows
 > 0Ë? 
SB_CNT_WRITE
 : 
SB_CNT_OTHER
;

890  
DB_ERROR_NONE
;

893 
îr
 = 
	`mysql_°mt_°‹e_ªsu…
(
°mt
->
±r
);

894 
	`DEBUG
("mysql_°mt_°‹e_ªsu…(%pË%d", 
°mt
->
±r
, 
îr
);

895 i‡(
îr
)

897  
	`check_îr‹
(
c⁄
, "mysql_°mt_°‹e_ªsu…()", 
NULL
,

898 &
rs
->
cou¡î
);

901 
rs
->
cou¡î
 = 
°mt
->counter;

902 
rs
->
ƒows
 = (
uöt32_t
Ë
	`mysql_°mt_num_rows
(
°mt
->
±r
);

903 
	`DEBUG
("mysql_°mt_num_rows(%pË%u", 
rs
->
°©emít
->
±r
,

904 (Ë(
rs
->
ƒows
));

906  
DB_ERROR_NONE
;

911 
√ed_ªÆloc
 = 1;

912 
v˙t
 = 0;

913 
i
 = 0, 
j
 = 0; 
°mt
->
quîy
[i] != '\0'; i++)

915 
agaö
:

916 i‡(
j
+1 >
buÊí
 || 
√ed_ªÆloc
)

918 
buÊí
 = (buflen > 0) ? buflen * 2 : 256;

919 
buf
 = 
	`ªÆloc
(buf, 
buÊí
);

920 i‡(
buf
 =
NULL
)

922 
	`log_ãxt
(
LOG_DEBUG
, "ERROR:Éxiting mysql_drv_execute(), memoryállocation failure");

923  
DB_ERROR_FATAL
;

925 
√ed_ªÆloc
 = 0;

928 i‡(
°mt
->
quîy
[
i
] != '?')

930 
buf
[
j
++] = 
°mt
->
quîy
[
i
];

934 
n
 = 
	`db_¥öt_vÆue
(
°mt
->
bound_∑øm
 + 
v˙t
, 
buf
 + 
j
, ()(
buÊí
 - j));

935 i‡(
n
 < 0)

937 
√ed_ªÆloc
 = 1;

938 
agaö
;

940 
j
 +()
n
;

941 
v˙t
++;

943 
buf
[
j
] = '\0';

945 
db_îr‹_t
 
rc
 = 
	`mysql_drv_quîy
(
c⁄
, 
buf
, 
j
, 
rs
);

947 
	`‰ì
(
buf
);

949  
rc
;

950 
	}
}

956 
db_îr‹_t
 
	$mysql_drv_quîy
(
db_c⁄n_t
 *
sb_c⁄n
, c⁄° *
quîy
, 
size_t
 
Àn
,

957 
db_ªsu…_t
 *
rs
)

959 
db_mysql_c⁄n_t
 *
db_mysql_c⁄
;

960 
MYSQL
 *
c⁄
;

962 i‡(
¨gs
.
dry_run
)

963  
DB_ERROR_NONE
;

965 
sb_c⁄n
->
sql_î∫o
 = 0;

966 
sb_c⁄n
->
sql_°©e
 = 
NULL
;

967 
sb_c⁄n
->
sql_îrmsg
 = 
NULL
;

969 
db_mysql_c⁄
 = (
db_mysql_c⁄n_t
 *)
sb_c⁄n
->
±r
;

970 
c⁄
 = 
db_mysql_c⁄
->
mysql
;

972 
îr
 = 
	`mysql_ªÆ_quîy
(
c⁄
, 
quîy
, 
Àn
);

973 
	`DEBUG
("mysql_ªÆ_quîy(%p, \"%s\", %zdË%d", 
c⁄
, 
quîy
, 
Àn
, 
îr
);

975 i‡(
	`SB_UNLIKELY
(
îr
 != 0))

976  
	`check_îr‹
(
sb_c⁄n
, "mysql_drv_quîy()", 
quîy
, &
rs
->
cou¡î
);

979 
MYSQL_RES
 *
ªs
 = 
	`mysql_°‹e_ªsu…
(
c⁄
);

980 
	`DEBUG
("mysql_°‹e_ªsu…(%pË%p", 
c⁄
, 
ªs
);

982 i‡(
ªs
 =
NULL
)

984 i‡(
	`mysql_î∫o
(
c⁄
Ë=0 && 
	`mysql_fõld_cou¡
(con) == 0)

987 
uöt32_t
 
ƒows
 = (uöt32_tË
	`mysql_af„˘ed_rows
(
c⁄
);

988 i‡(
ƒows
 > 0)

990 
rs
->
cou¡î
 = 
SB_CNT_WRITE
;

991 
rs
->
ƒows
 =Çrows;

994 
rs
->
cou¡î
 = 
SB_CNT_OTHER
;

996  
DB_ERROR_NONE
;

999  
	`check_îr‹
(
sb_c⁄n
, "mysql_°‹e_ªsu…()", 
NULL
, &
rs
->
cou¡î
);

1002 
rs
->
cou¡î
 = 
SB_CNT_READ
;

1003 
rs
->
±r
 = (*)
ªs
;

1005 
rs
->
ƒows
 = 
	`mysql_num_rows
(
ªs
);

1006 
	`DEBUG
("mysql_num_rows(%pË%u", 
ªs
, (Ë
rs
->
ƒows
);

1008 
rs
->
nfõlds
 = 
	`mysql_num_fõlds
(
ªs
);

1009 
	`DEBUG
("mysql_num_fõlds(%pË%u", 
ªs
, (Ë
rs
->
nfõlds
);

1011  
DB_ERROR_NONE
;

1012 
	}
}

1018 
	$mysql_drv_„tch
(
db_ªsu…_t
 *
rs
)

1021 ()
rs
;

1023 i‡(
¨gs
.
dry_run
)

1024  
DB_ERROR_NONE
;

1027 
	}
}

1031 
	$mysql_drv_„tch_row
(
db_ªsu…_t
 *
rs
, 
db_row_t
 *
row
)

1033 
MYSQL_ROW
 
my_row
;

1035 i‡(
¨gs
.
dry_run
)

1036  
DB_ERROR_NONE
;

1038 
my_row
 = 
	`mysql_„tch_row
(
rs
->
±r
);

1039 
	`DEBUG
("mysql_„tch_row(%pË%p", 
rs
->
±r
, 
my_row
);

1041 *
Àngths
 = 
	`mysql_„tch_Àngths
(
rs
->
±r
);

1042 
	`DEBUG
("mysql_„tch_Àngths(%pË%p", 
rs
->
±r
, 
Àngths
);

1044 i‡(
Àngths
 =
NULL
)

1045  
DB_ERROR_IGNORABLE
;

1047 
size_t
 
i
 = 0; i < 
rs
->
nfõlds
; i++)

1049 
row
->
vÆues
[
i
].
Àn
 = 
Àngths
[i];

1050 
row
->
vÆues
[
i
].
±r
 = 
my_row
[i];

1053  
DB_ERROR_NONE
;

1054 
	}
}

1058 
	$mysql_drv_‰ì_ªsu…s
(
db_ªsu…_t
 *
rs
)

1060 i‡(
¨gs
.
dry_run
)

1064 i‡(
rs
->
°©emít
 !
NULL
 &&Ñs->°©emít->
emuœãd
 == 0)

1066 
	`DEBUG
("mysql_°mt_‰ì_ªsu…(%p)", 
rs
->
°©emít
->
±r
);

1067 
	`mysql_°mt_‰ì_ªsu…
(
rs
->
°©emít
->
±r
);

1068 
rs
->
±r
 = 
NULL
;

1071 i‡(
rs
->
±r
 !
NULL
)

1073 
	`DEBUG
("mysql_‰ì_ªsu…(%p)", 
rs
->
±r
);

1074 
	`mysql_‰ì_ªsu…
((
MYSQL_RES
 *)
rs
->
±r
);

1075 
rs
->
±r
 = 
NULL
;

1079 
	}
}

1085 
	$mysql_drv_˛o£
(
db_°mt_t
 *
°mt
)

1087 i‡(
¨gs
.
dry_run
)

1090 i‡(
°mt
->
quîy
)

1092 
	`‰ì
(
°mt
->
quîy
);

1093 
°mt
->
quîy
 = 
NULL
;

1096 i‡(
°mt
->
±r
 =
NULL
)

1099 
rc
 = 
	`mysql_°mt_˛o£
(
°mt
->
±r
);

1100 
	`DEBUG
("mysql_°mt_˛o£(%pË%d", 
°mt
->
±r
, 
rc
);

1102 
°mt
->
±r
 = 
NULL
;

1104  
rc
;

1105 
	}
}

1109 
	$mysql_drv_d⁄e
()

1111 i‡(
¨gs
.
dry_run
)

1114 
	`mysql_libøry_íd
();

1117 
	}
}

1121 
	$gë_mysql_böd_ty≥
(
db_böd_ty≥_t
 
ty≥
)

1123 
i
;

1125 
i
 = 0; 
db_mysql_böd_m≠
[i].
db_ty≥
 !
DB_TYPE_NONE
; i++)

1126 i‡(
db_mysql_böd_m≠
[
i
].
db_ty≥
 =
ty≥
)

1127  
db_mysql_böd_m≠
[
i
].
my_ty≥
;

1130 
	}
}

	@drivers/pgsql/drv_pgsql.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
HAVE_STRING_H


24 
	~<°rög.h
>

26 #ifde‡
HAVE_STRINGS_H


27 
	~<°rögs.h
>

30 
	~<libpq-„.h
>

32 
	~"sb_›ti⁄s.h
"

33 
	~"db_drivî.h
"

34 
	~"sb_ønd.h
"

36 
	#x‰ì
(
±r
Ë({ i‡’åË
	`‰ì
((*Ìå);Öå = 
NULL
; })

	)

39 
	#MAX_PARAM_LENGTH
 256UL

	)

43 
sb_¨g_t
 
	gpgsql_drv_¨gs
[] =

45 
SB_OPT
("pgsql-ho°", "Po°gªSQL sîvî ho°", "loˇlho°", 
STRING
),

46 
SB_OPT
("pgsql-p‹t", "Po°gªSQL sîvîÖ‹t", "5432", 
INT
),

47 
SB_OPT
("pgsql-u£r", "Po°gªSQL u£r", "sbã°", 
STRING
),

48 
SB_OPT
("pgsql-∑ssw‹d", "Po°gªSQLÖassw‹d", "", 
STRING
),

49 
SB_OPT
("pgsql-db", "Po°gªSQL d©aba£Çame", "sbã°", 
STRING
),

51 
SB_OPT_END


56 *
	mho°
;

57 *
	mp‹t
;

58 *
	mu£r
;

59 *
	m∑ssw‹d
;

60 *
	mdb
;

61 } 
	tpgsql_drv_¨gs_t
;

67 
db_böd_ty≥_t
 
	mdb_ty≥
;

68 
	mpg_ty≥
;

69 } 
	tdb_pgsql_böd_m≠_t
;

72 
db_pgsql_böd_m≠_t
 
	gdb_pgsql_böd_m≠
[] =

74 {
DB_TYPE_TINYINT
, 0},

75 {
DB_TYPE_SMALLINT
, 21},

76 {
DB_TYPE_INT
, 23},

77 {
DB_TYPE_BIGINT
, 20},

78 {
DB_TYPE_FLOAT
, 700},

79 {
DB_TYPE_DOUBLE
, 701},

80 {
DB_TYPE_DATETIME
, 0},

81 {
DB_TYPE_TIMESTAMP
, 1114},

82 {
DB_TYPE_CHAR
, 18},

83 {
DB_TYPE_VARCHAR
, 1043},

84 {
DB_TYPE_NONE
, 0}

89 
drv_ˇps_t
 
	gpgsql_drv_ˇps
 =

100 
	spg_°mt


102 *
	m«me
;

103 
	m¥ï¨ed
;

104 
	m≈¨ams
;

105 
Oid
 *
	m±y≥s
;

106 **
	mpvÆues
;

107 } 
	tpg_°mt_t
;

109 
pgsql_drv_¨gs_t
 
	g¨gs
;

111 
	gu£_ps
;

115 
pgsql_drv_öô
();

116 
pgsql_drv_des¸ibe
(
drv_ˇps_t
 *);

117 
pgsql_drv_c⁄√˘
(
db_c⁄n_t
 *);

118 
pgsql_drv_disc⁄√˘
(
db_c⁄n_t
 *);

119 
pgsql_drv_ªc⁄√˘
(
db_c⁄n_t
 *);

120 
pgsql_drv_¥ï¨e
(
db_°mt_t
 *, c⁄° *, 
size_t
);

121 
pgsql_drv_böd_∑øm
(
db_°mt_t
 *, 
db_böd_t
 *, 
size_t
);

122 
pgsql_drv_böd_ªsu…
(
db_°mt_t
 *, 
db_böd_t
 *, 
size_t
);

123 
db_îr‹_t
 
pgsql_drv_execuã
(
db_°mt_t
 *, 
db_ªsu…_t
 *);

124 
pgsql_drv_„tch
(
db_ªsu…_t
 *);

125 
pgsql_drv_„tch_row
(
db_ªsu…_t
 *, 
db_row_t
 *);

126 
db_îr‹_t
 
pgsql_drv_quîy
(
db_c⁄n_t
 *, c⁄° *, 
size_t
,

127 
db_ªsu…_t
 *);

128 
pgsql_drv_‰ì_ªsu…s
(
db_ªsu…_t
 *);

129 
pgsql_drv_˛o£
(
db_°mt_t
 *);

130 
pgsql_drv_d⁄e
();

134 
db_drivî_t
 
	gpgsql_drivî
 =

136 .
¢ame
 = "pgsql",

137 .
	g ame
 = "PostgreSQL driver",

138 .
	g¨gs
 = 
pgsql_drv_¨gs
,

139 .
	g›s
 =

141 .
öô
 = 
pgsql_drv_öô
,

142 .
	gdes¸ibe
 = 
pgsql_drv_des¸ibe
,

143 .
	gc⁄√˘
 = 
pgsql_drv_c⁄√˘
,

144 .
	gdisc⁄√˘
 = 
pgsql_drv_disc⁄√˘
,

145 .
	gªc⁄√˘
 = 
pgsql_drv_ªc⁄√˘
,

146 .
	g¥ï¨e
 = 
pgsql_drv_¥ï¨e
,

147 .
	gböd_∑øm
 = 
pgsql_drv_böd_∑øm
,

148 .
	gböd_ªsu…
 = 
pgsql_drv_böd_ªsu…
,

149 .
	gexecuã
 = 
pgsql_drv_execuã
,

150 .
	g„tch
 = 
pgsql_drv_„tch
,

151 .
	g„tch_row
 = 
pgsql_drv_„tch_row
,

152 .
	g‰ì_ªsu…s
 = 
pgsql_drv_‰ì_ªsu…s
,

153 .
	g˛o£
 = 
pgsql_drv_˛o£
,

154 .
	gquîy
 = 
pgsql_drv_quîy
,

155 .
	gd⁄e
 = 
pgsql_drv_d⁄e


162 
gë_pgsql_böd_ty≥
(
db_böd_ty≥_t
);

163 
gë_unique_°mt_«me
(*, );

168 
	$ªgi°î_drivî_pgsql
(
sb_li°_t
 *
drivîs
)

170 
	`SB_LIST_ADD_TAIL
(&
pgsql_drivî
.
li°ôem
, 
drivîs
);

173 
	}
}

177 
	$pgsql_drv_öô
()

179 
¨gs
.
ho°
 = 
	`sb_gë_vÆue_°rög
("pgsql-host");

180 
¨gs
.
p‹t
 = 
	`sb_gë_vÆue_°rög
("pgsql-port");

181 
¨gs
.
u£r
 = 
	`sb_gë_vÆue_°rög
("pgsql-user");

182 
¨gs
.
∑ssw‹d
 = 
	`sb_gë_vÆue_°rög
("pgsql-password");

183 
¨gs
.
db
 = 
	`sb_gë_vÆue_°rög
("pgsql-db");

185 
u£_ps
 = 0;

186 
pgsql_drv_ˇps
.
¥ï¨ed_°©emíts
 = 1;

187 i‡(
db_globÆs
.
ps_mode
 !
DB_PS_MODE_DISABLE
)

188 
u£_ps
 = 1;

191 
	}
}

197 
	$pgsql_drv_des¸ibe
(
drv_ˇps_t
 *
ˇps
)

199 
PGc⁄n
 *
c⁄
;

201 *
ˇps
 = 
pgsql_drv_ˇps
;

204 
c⁄
 = 
	`PQ£tdbLogö
(
¨gs
.
ho°
,

205 
¨gs
.
p‹t
,

206 
NULL
,

207 
NULL
,

208 
¨gs
.
db
,

209 
¨gs
.
u£r
,

210 
¨gs
.
∑ssw‹d
);

211 i‡(
	`PQ°©us
(
c⁄
Ë!
CONNECTION_OK
)

213 
	`log_ãxt
(
LOG_FATAL
, "ConnectionÅo database failed: %s",

214 
	`PQîr‹Mesßge
(
c⁄
));

215 
	`PQföish
(
c⁄
);

220 i‡(
	`PQ£rvîVîsi⁄
(
c⁄
) < 80200)

221 
ˇps
->
mu…i_rows_ö£π
 = 0;

223 
	`PQföish
(
c⁄
);

226 
	}
}

228 
	$em±y_nŸi˚_¥o˚ss‹
(*
¨g
, c⁄° *
msg
)

230 (Ë
¨g
;

231 (Ë
msg
;

232 
	}
}

236 
	$pgsql_drv_c⁄√˘
(
db_c⁄n_t
 *
sb_c⁄n
)

238 
PGc⁄n
 *
c⁄
;

240 
c⁄
 = 
	`PQ£tdbLogö
(
¨gs
.
ho°
,

241 
¨gs
.
p‹t
,

242 
NULL
,

243 
NULL
,

244 
¨gs
.
db
,

245 
¨gs
.
u£r
,

246 
¨gs
.
∑ssw‹d
);

247 i‡(
	`PQ°©us
(
c⁄
Ë!
CONNECTION_OK
)

249 
	`log_ãxt
(
LOG_FATAL
, "ConnectionÅo database failed: %s",

250 
	`PQîr‹Mesßge
(
c⁄
));

251 
	`PQföish
(
c⁄
);

256 
	`PQ£tNŸi˚Pro˚ss‹
(
c⁄
, 
em±y_nŸi˚_¥o˚ss‹
, 
NULL
);

257 
sb_c⁄n
->
±r
 = 
c⁄
;

260 
	}
}

264 
	$pgsql_drv_disc⁄√˘
(
db_c⁄n_t
 *
sb_c⁄n
)

266 
PGc⁄n
 *
c⁄
 = (PGc⁄¿*)
sb_c⁄n
->
±r
;

269 
	`x‰ì
(
sb_c⁄n
->
sql_°©e
);

270 
	`x‰ì
(
sb_c⁄n
->
sql_îrmsg
);

272 i‡(
c⁄
 !
NULL
)

273 
	`PQföish
(
c⁄
);

276 
	}
}

280 
	$pgsql_drv_ªc⁄√˘
(
db_c⁄n_t
 *
sb_c⁄n
)

282 i‡(
	`pgsql_drv_disc⁄√˘
(
sb_c⁄n
))

283  
DB_ERROR_FATAL
;

285 
	`pgsql_drv_c⁄√˘
(
sb_c⁄n
))

287 i‡(
sb_globÆs
.
îr‹
)

288  
DB_ERROR_FATAL
;

291  
DB_ERROR_IGNORABLE
;

292 
	}
}

298 
	$pgsql_drv_¥ï¨e
(
db_°mt_t
 *
°mt
, c⁄° *
quîy
, 
size_t
 
Àn
)

300 
PGc⁄n
 *
c⁄
 = (PGc⁄¿*)
°mt
->
c⁄√˘i⁄
->
±r
;

301 
PGªsu…
 *
pgªs
;

302 
pg_°mt_t
 *
pg°mt
;

303 *
buf
 = 
NULL
;

304 
v˙t
;

305 
√ed_ªÆloc
;

306 
i
,
j
;

307 
buÊí
;

308 
n
;

309 
«me
[32];

311 (Ë
Àn
;

313 i‡(
c⁄
 =
NULL
)

316 i‡(!
u£_ps
)

319 
°mt
->
emuœãd
 = 1;

320 
°mt
->
quîy
 = 
	`°rdup
(query);

326 
√ed_ªÆloc
 = 1;

327 
v˙t
 = 1;

328 
buÊí
 = 0;

329 
i
 = 0, 
j
 = 0; 
quîy
[i] != '\0'; i++)

331 
agaö
:

332 i‡(
j
+1 >
buÊí
 || 
√ed_ªÆloc
)

334 
buÊí
 = (buflen > 0) ? buflen * 2 : 256;

335 
buf
 = 
	`ªÆloc
(buf, 
buÊí
);

336 i‡(
buf
 =
NULL
)

337 
îr‹
;

338 
√ed_ªÆloc
 = 0;

341 i‡(
quîy
[
i
] != '?')

343 
buf
[
j
++] = 
quîy
[
i
];

347 
n
 = 
	`¢¥ötf
(
buf
 + 
j
, 
buÊí
 - j, "$%d", 
v˙t
);

348 i‡(
n
 < 0 ||Ç >()(
buÊí
 - 
j
))

350 
√ed_ªÆloc
 = 1;

351 
agaö
;

354 
j
 +
n
;

355 
v˙t
++;

357 
buf
[
j
] = '\0';

360 
°mt
->
quîy
 = 
	`°rdup
(
buf
);

361 
	`‰ì
(
buf
);

363 
pg°mt
 = (
pg_°mt_t
 *)
	`ˇŒoc
(1, (pg_stmt_t));

364 i‡(
pg°mt
 =
NULL
)

365 
îr‹
;

367 
	`gë_unique_°mt_«me
(
«me
, (name));

368 
pg°mt
->
«me
 = 
	`°rdup
(name);

369 
pg°mt
->
≈¨ams
 = 
v˙t
 - 1;

375 i‡(
pg°mt
->
≈¨ams
 == 0)

378 
pgªs
 = 
	`PQ¥ï¨e
(
c⁄
, 
pg°mt
->
«me
, 
°mt
->
quîy
,Ög°mt->
≈¨ams
,

379 
NULL
);

381 i‡(
	`PQªsu…Sètus
(
pgªs
Ë!
PGRES_COMMAND_OK
)

383 
	`log_ãxt
(
LOG_FATAL
, "PQ¥ï¨e(ËÁûed: %s", 
	`PQîr‹Mesßge
(
c⁄
));

385 
	`PQ˛ór
(
pgªs
);

387 
	`‰ì
(
°mt
->
quîy
);

388 
	`‰ì
(
pg°mt
->
«me
);

389 
	`‰ì
(
pg°mt
);

393 
	`PQ˛ór
(
pgªs
);

394 
pg°mt
->
¥ï¨ed
 = 1;

397 
°mt
->
±r
 = 
pg°mt
;

401 
îr‹
:

404 
	}
}

410 
	$pgsql_drv_böd_∑øm
(
db_°mt_t
 *
°mt
, 
db_böd_t
 *
∑øms
, 
size_t
 
Àn
)

412 
PGc⁄n
 *
c⁄
 = (PGc⁄¿*)
°mt
->
c⁄√˘i⁄
->
±r
;

413 
PGªsu…
 *
pgªs
;

414 
pg_°mt_t
 *
pg°mt
;

415 
i
;

417 i‡(
c⁄
 =
NULL
)

420 i‡(
°mt
->
bound_∑øm
 !
NULL
)

421 
	`‰ì
(
°mt
->
bound_∑øm
);

422 
°mt
->
bound_∑øm
 = (
db_böd_t
 *)
	`mÆloc
(
Àn
 * (db_bind_t));

423 i‡(
°mt
->
bound_∑øm
 =
NULL
)

425 
	`mem˝y
(
°mt
->
bound_∑øm
, 
∑øms
, 
Àn
 * (
db_böd_t
));

426 
°mt
->
bound_∑øm_Àn
 = 
Àn
;

428 i‡(
°mt
->
emuœãd
)

431 
pg°mt
 = 
°mt
->
±r
;

432 i‡(
pg°mt
->
¥ï¨ed
)

437 i‡(()
pg°mt
->
≈¨ams
 !
Àn
)

439 
	`log_ãxt
(
LOG_ALERT
, "wrongÇumber ofÖarameters inÖrepared statement");

440 
	`log_ãxt
(
LOG_DEBUG
, "counted: %d,ÖassedÅo bind_param(): %zd",

441 
pg°mt
->
≈¨ams
, 
Àn
);

445 
pg°mt
->
±y≥s
 = (
Oid
 *)
	`mÆloc
(
Àn
 * ());

446 i‡(
pg°mt
->
±y≥s
 =
NULL
)

450 
i
 = 0; i < 
Àn
; i++)

451 
pg°mt
->
±y≥s
[
i
] = 
	`gë_pgsql_böd_ty≥
(
∑øms
[i].
ty≥
);

454 
pgªs
 = 
	`PQ¥ï¨e
(
c⁄
, 
pg°mt
->
«me
, 
°mt
->
quîy
,Ög°mt->
≈¨ams
,

455 
pg°mt
->
±y≥s
);

457 i‡(
	`PQªsu…Sètus
(
pgªs
Ë!
PGRES_COMMAND_OK
)

459 
	`log_ãxt
(
LOG_FATAL
, "PQ¥ï¨e(ËÁûed: %s", 
	`PQîr‹Mesßge
(
c⁄
));

463 
	`PQ˛ór
(
pgªs
);

465 
pg°mt
->
pvÆues
 = (**)
	`ˇŒoc
(
Àn
, (*));

466 i‡(
pg°mt
->
pvÆues
 =
NULL
)

470 
i
 = 0; i < 
Àn
; i++)

472 i‡(
pg°mt
->
pvÆues
[
i
] !
NULL
)

474 
	`‰ì
(
pg°mt
->
pvÆues
[
i
]);

477 
pg°mt
->
pvÆues
[
i
] = (*)
	`mÆloc
(
MAX_PARAM_LENGTH
);

478 i‡(
pg°mt
->
pvÆues
[
i
] =
NULL
)

481 
pg°mt
->
¥ï¨ed
 = 1;

484 
	}
}

490 
	$pgsql_drv_böd_ªsu…
(
db_°mt_t
 *
°mt
, 
db_böd_t
 *
∑øms
, 
size_t
 
Àn
)

493 ()
°mt
;

494 ()
∑øms
;

495 ()
Àn
;

498 
	}
}

504 
db_îr‹_t
 
	$pgsql_check_°©us
(
db_c⁄n_t
 *
c⁄
, 
PGªsu…
 *
pgªs
,

505 c⁄° *
fun˙ame
, c⁄° *
quîy
,

506 
db_ªsu…_t
 *
rs
)

508 
ExecSètusTy≥
 
°©us
;

509 
db_îr‹_t
 
rc
;

510 
PGc⁄n
 * c⁄° 
pgc⁄
 = 
c⁄
->
±r
;

512 
°©us
 = 
	`PQªsu…Sètus
(
pgªs
);

513 
°©us
) {

514 
PGRES_TUPLES_OK
:

515 
rs
->
ƒows
 = 
	`PQ¡u∂es
(
pgªs
);

516 
rs
->
nfõlds
 = 
	`PQnfõlds
(
pgªs
);

517 
rs
->
cou¡î
 = 
SB_CNT_READ
;

519 
rc
 = 
DB_ERROR_NONE
;

523 
PGRES_COMMAND_OK
:

524 
rs
->
ƒows
 = 
	`°πoul
(
	`PQcmdTu∂es
(
pgªs
), 
NULL
, 10);;

525 
rs
->
cou¡î
 = (rs->
ƒows
 > 0Ë? 
SB_CNT_WRITE
 : 
SB_CNT_OTHER
;

526 
rc
 = 
DB_ERROR_NONE
;

532 
	`PQ˛ór
(
pgªs
);

536 
PGRES_FATAL_ERROR
:

537 
rs
->
ƒows
 = 0;

538 
rs
->
cou¡î
 = 
SB_CNT_ERROR
;

545 
	`x‰ì
(
c⁄
->
sql_°©e
);

546 
	`x‰ì
(
c⁄
->
sql_îrmsg
);

548 
c⁄
->
sql_°©e
 = 
	`°rdup
(
	`PQªsu…Eº‹Fõld
(
pgªs
, 
PG_DIAG_SQLSTATE
));

549 
c⁄
->
sql_îrmsg
 = 
	`°rdup
(
	`PQªsu…Eº‹Fõld
(
pgªs
, 
PG_DIAG_MESSAGE_PRIMARY
));

551 i‡(!
	`°rcmp
(
c⁄
->
sql_°©e
, "40P01") ||

552 !
	`°rcmp
(
c⁄
->
sql_°©e
, "23505") ||

553 !
	`°rcmp
(
c⁄
->
sql_°©e
, "40001"))

555 
PGªsu…
 *
tmp
;

556 
tmp
 = 
	`PQexec
(
pgc⁄
, "ROLLBACK");

557 
	`PQ˛ór
(
tmp
);

558 
rc
 = 
DB_ERROR_IGNORABLE
;

562 
	`log_ãxt
(
LOG_FATAL
, "%s(ËÁûed: %d %s", 
fun˙ame
, 
°©us
,

563 
c⁄
->
sql_îrmsg
);

565 i‡(
quîy
 !
NULL
)

566 
	`log_ãxt
(
LOG_FATAL
, "Áûed quîy was: %s", 
quîy
);

568 
rc
 = 
DB_ERROR_FATAL
;

571 
	`PQ˛ór
(
pgªs
);

576 
rs
->
ƒows
 = 0;

577 
rs
->
cou¡î
 = 
SB_CNT_ERROR
;

578 
rc
 = 
DB_ERROR_FATAL
;

581  
rc
;

582 
	}
}

588 
db_îr‹_t
 
	$pgsql_drv_execuã
(
db_°mt_t
 *
°mt
, 
db_ªsu…_t
 *
rs
)

590 
db_c⁄n_t
 *
c⁄
 = 
°mt
->
c⁄√˘i⁄
;

591 
PGc⁄n
 *
pgc⁄
 = (PGc⁄¿*)
c⁄
->
±r
;

592 
PGªsu…
 *
pgªs
;

593 
pg_°mt_t
 *
pg°mt
;

594 *
buf
 = 
NULL
;

595 
buÊí
 = 0;

596 
i
, 
j
, 
v˙t
;

597 
√ed_ªÆloc
;

598 
n
;

599 
db_îr‹_t
 
rc
;

600 
Àn
;

602 
c⁄
->
sql_î∫o
 = 0;

603 
	`x‰ì
(
c⁄
->
sql_°©e
);

604 
	`x‰ì
(
c⁄
->
sql_îrmsg
);

606 i‡(!
°mt
->
emuœãd
)

608 
pg°mt
 = 
°mt
->
±r
;

609 i‡(
pg°mt
 =
NULL
)

611 
	`log_ãxt
(
LOG_DEBUG
,

613  
DB_ERROR_FATAL
;

617 
i
 = 0; i < ()
pg°mt
->
≈¨ams
; i++)

619 i‡(
°mt
->
bound_∑øm
[
i
].
is_nuŒ
 && *(stmt->bound_param[i].is_null))

622 
°mt
->
bound_∑øm
[
i
].
ty≥
) {

623 
DB_TYPE_CHAR
:

624 
DB_TYPE_VARCHAR
:

626 
Àn
 = 
°mt
->
bound_∑øm
[
i
].
d©a_Àn
[0];

628 
	`mem˝y
(
pg°mt
->
pvÆues
[
i
], 
°mt
->
bound_∑øm
[i].
buf„r
,

629 
	`SB_MIN
(
MAX_PARAM_LENGTH
, 
Àn
));

631 
pg°mt
->
pvÆues
[
i
][
Àn
] = '\0';

635 
	`db_¥öt_vÆue
(
°mt
->
bound_∑øm
 + 
i
, 
pg°mt
->
pvÆues
[i],

636 
MAX_PARAM_LENGTH
);

640 
pgªs
 = 
	`PQexecPª∑ªd
(
pgc⁄
, 
pg°mt
->
«me
,Ög°mt->
≈¨ams
,

641 (c⁄° **)
pg°mt
->
pvÆues
, 
NULL
, NULL, 1);

643 
rc
 = 
	`pgsql_check_°©us
(
c⁄
, 
pgªs
, "PQexecPª∑ªd", 
NULL
, 
rs
);

645 
rs
->
±r
 = (rs->
cou¡î
 =
SB_CNT_READ
Ë? (*Ë
pgªs
 : 
NULL
;

647  
rc
;

652 
√ed_ªÆloc
 = 1;

653 
v˙t
 = 0;

654 
i
 = 0, 
j
 = 0; 
°mt
->
quîy
[i] != '\0'; i++)

656 
agaö
:

657 i‡(
j
+1 >
buÊí
 || 
√ed_ªÆloc
)

659 
buÊí
 = (buflen > 0) ? buflen * 2 : 256;

660 
buf
 = 
	`ªÆloc
(buf, 
buÊí
);

661 i‡(
buf
 =
NULL
)

662  
DB_ERROR_FATAL
;

663 
√ed_ªÆloc
 = 0;

666 i‡(
°mt
->
quîy
[
i
] != '?')

668 
buf
[
j
++] = 
°mt
->
quîy
[
i
];

672 
n
 = 
	`db_¥öt_vÆue
(
°mt
->
bound_∑øm
 + 
v˙t
, 
buf
 + 
j
, 
buÊí
 - j);

673 i‡(
n
 < 0)

675 
√ed_ªÆloc
 = 1;

676 
agaö
;

678 
j
 +
n
;

679 
v˙t
++;

681 
buf
[
j
] = '\0';

683 
rc
 = 
	`pgsql_drv_quîy
(
c⁄
, 
buf
, 
j
, 
rs
);

685 
	`‰ì
(
buf
);

687  
rc
;

688 
	}
}

694 
db_îr‹_t
 
	$pgsql_drv_quîy
(
db_c⁄n_t
 *
sb_c⁄n
, c⁄° *
quîy
, 
size_t
 
Àn
,

695 
db_ªsu…_t
 *
rs
)

697 
PGc⁄n
 *
pgc⁄
 = 
sb_c⁄n
->
±r
;

698 
PGªsu…
 *
pgªs
;

699 
db_îr‹_t
 
rc
;

701 ()
Àn
;

703 
sb_c⁄n
->
sql_î∫o
 = 0;

704 
	`x‰ì
(
sb_c⁄n
->
sql_°©e
);

705 
	`x‰ì
(
sb_c⁄n
->
sql_îrmsg
);

707 
pgªs
 = 
	`PQexec
(
pgc⁄
, 
quîy
);

708 
rc
 = 
	`pgsql_check_°©us
(
sb_c⁄n
, 
pgªs
, "PQexec", 
quîy
, 
rs
);

710 
rs
->
±r
 = (rs->
cou¡î
 =
SB_CNT_READ
Ë? (*Ë
pgªs
 : 
NULL
;

712  
rc
;

713 
	}
}

719 
	$pgsql_drv_„tch
(
db_ªsu…_t
 *
rs
)

722 ()
rs
;

725 
	}
}

731 
	$pgsql_drv_„tch_row
(
db_ªsu…_t
 *
rs
, 
db_row_t
 *
row
)

733 
öçå_t
 
rownum
;

734 
i
;

740 
rownum
 = (
öçå_t
Ë
row
->
±r
;

741 i‡(
rownum
 >(Ë
rs
->
ƒows
)

742  
DB_ERROR_IGNORABLE
;

744 
i
 = 0; i < (Ë
rs
->
nfõlds
; i++)

750 i‡(
	`PQgëi¢uŒ
(
rs
->
±r
, 
rownum
, 
i
))

751 
row
->
vÆues
[
i
].
±r
 = 
NULL
;

754 
row
->
vÆues
[
i
].
Àn
 = 
	`PQgëÀngth
(
rs
->
±r
, 
rownum
, i);

755 
row
->
vÆues
[
i
].
±r
 = 
	`PQgëvÆue
(
rs
->±r, 
rownum
, i);

759 
row
->
±r
 = (*Ë(
rownum
 + 1);

761  
DB_ERROR_NONE
;

762 
	}
}

768 
	$pgsql_drv_‰ì_ªsu…s
(
db_ªsu…_t
 *
rs
)

770 i‡(
rs
->
±r
 !
NULL
)

772 
	`PQ˛ór
((
PGªsu…
 *)
rs
->
±r
);

773 
rs
->
±r
 = 
NULL
;

775 
rs
->
row
.
±r
 = 0;

780 
	}
}

786 
	$pgsql_drv_˛o£
(
db_°mt_t
 *
°mt
)

788 
pg_°mt_t
 *
pg°mt
 = 
°mt
->
±r
;

789 
i
;

791 i‡(
pg°mt
 =
NULL
)

794 i‡(
pg°mt
->
«me
 !
NULL
)

795 
	`‰ì
(
pg°mt
->
«me
);

796 i‡(
pg°mt
->
±y≥s
 !
NULL
)

797 
	`‰ì
(
pg°mt
->
±y≥s
);

798 i‡(
pg°mt
->
pvÆues
 !
NULL
)

800 
i
 = 0; i < 
pg°mt
->
≈¨ams
; i++)

801 i‡(
pg°mt
->
pvÆues
[
i
] !
NULL
)

802 
	`‰ì
(
pg°mt
->
pvÆues
[
i
]);

803 
	`‰ì
(
pg°mt
->
pvÆues
);

806 
	`x‰ì
(
°mt
->
±r
);

809 
	}
}

813 
	$pgsql_drv_d⁄e
()

816 
	}
}

822 
	$gë_pgsql_böd_ty≥
(
db_böd_ty≥_t
 
ty≥
)

824 
i
;

826 
i
 = 0; 
db_pgsql_böd_m≠
[i].
db_ty≥
 !
DB_TYPE_NONE
; i++)

827 i‡(
db_pgsql_böd_m≠
[
i
].
db_ty≥
 =
ty≥
)

828  
db_pgsql_böd_m≠
[
i
].
pg_ty≥
;

831 
	}
}

834 
	$gë_unique_°mt_«me
(*
«me
, 
Àn
)

836  
	`¢¥ötf
(
«me
, 
Àn
, "sbstmt%d%d",

837 (Ë
	`sb_ønd_unif‹m_uöt64
(),

838 (Ë
	`sb_ønd_unif‹m_uöt64
());

839 
	}
}

	@lua/bulk_insert.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


3 -- 
Bulk
 
ö£π
 
	gbíchm¨k
: dÿ
mu…i
-
row
 
INSERTs
 
c⁄cuºíéy
 
ö
 --
thªads


4 -- 
thªads
 
wôh
 
óch
 
thªad
 
ö£πög
 
öto
 
ôs
 
own
 
èbÀ
. 
The
 
numbî
 
of
 
INSERTs


5 -- 
execuãd
 
by
 
óch
 
thªad
 
is
 
c⁄åﬁÀd
 by 
eôhî
 --
time
 
‹
 --
evíts
.

8 
cursize
=0

10 
fun˘i⁄
 
	$thªad_öô
()

11 
drv
 = 
sysbích
.
sql
.
	$drivî
()

12 
c⁄
 = 
drv
:
	$c⁄√˘
()

13 
íd


15 
fun˘i⁄
 
	$¥ï¨e
()

16 
loˇl
 
i


18 
loˇl
 
drv
 = 
sysbích
.
sql
.
	$drivî
()

19 
loˇl
 
c⁄
 = 
drv
:
	$c⁄√˘
()

21 
i
 = 1, 
sysbích
.
›t
.
thªads
 do

22 
	`¥öt
("Cª©ögÅabÀ 'sbã°" .. 
i
 .. "'...")

23 
c⁄
:
	`quîy
(
°rög
.
	`f‹m©
([[

24 
CREATE
 
TABLE
 
IF
 
NOT
 
EXISTS
 
sbã°
%
	`d
 (

25 
id
 
INTEGER
 
NOT
 
NULL
,

26 
k
 
INTEGER
 
DEFAULT
 '0' 
NOT
 
NULL
,

27 
PRIMARY
 
	`KEY
 (
id
))]], 
i
))

28 
íd


29 
íd


31 
fun˘i⁄
 
	$evít
()

32 i‡(
cursize
 =0Ë
thí


33 
c⁄
:
	`bulk_ö£π_öô
("INSERT INTO sbã°" .. 
sysbích
.
tid
+1 .. " VALUES")

34 
íd


36 
cursize
 = cursize + 1

38 
c⁄
:
	`bulk_ö£π_√xt
("(" .. 
cursize
 .. "," .. cursize .. ")")

39 
íd


41 
fun˘i⁄
 
	$thªad_d⁄e
()

42 
c⁄
:
	$bulk_ö£π_d⁄e
()

43 
c⁄
:
	$disc⁄√˘
()

44 
íd


46 
fun˘i⁄
 
	$˛ónup
()

47 
loˇl
 
i


49 
loˇl
 
drv
 = 
sysbích
.
sql
.
	$drivî
()

50 
loˇl
 
c⁄
 = 
drv
:
	$c⁄√˘
()

52 
i
 = 1, 
sysbích
.
›t
.
thªads
 do

53 
	`¥öt
("Dr›pögÅabÀ 'sbã°" .. 
i
 .. "'...")

54 
c⁄
:
	`quîy
("DROP TABLE IF EXISTS sbã°" .. 
i
 )

55 
íd


56 
íd


	@lua/empty-test.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


3 -- 
you
 
ˇn
 
run
 
this
 
s¸ùt
 
like
 
	gthis
:

4 -- 
$
 ./
em±y
-
ã°
.
lua
 --
˝u
-
max
-
¥ime
=20000 --
thªads
=8 --
hi°ogøm
 --
ªp‹t
-
öãrvÆ
=1 
run


6 
sysbích
.
cmdlöe
.
›ti⁄s
 = {

7 -- 
the
  
vÆues
 
buût
-
ö
 
›ti⁄s
 
¨e
 
cuºíéy
 
ign‹ed
, 
£e


8 -- 
hâps
:

15 
fun˘i⁄
 
	$evít
()

16 
íd


18 
fun˘i⁄
 
sysbích
.
hooks
.
	$ªp‹t_cumuœtive
(
°©
)

19 
loˇl
 
£c⁄ds
 = 
°©
.
time_öãrvÆ


20 
	`¥öt
(
°rög
.
	`f‹m©
([[

36 
	}
}

38 
	g°©
.
	gîr‹s
,

39 
	g°©
.
	gevíts
,

40 
	g°©
.
	gœãncy_avg
,

41 
	g°©
.
	gœãncy_max
,

42 
	g°©
.
	gœãncy_mö
,

43 
	g°©
.
	gœãncy_p˘
,

44 
	g°©
.
	gœãncy_sum
,

45 
	g°©
.
	gŸhî
,

46 
	g°©
.
	gªads
,

47 
	g°©
.
	gªc⁄√˘s
,

48 
	g°©
.
	gthªads_ru¬ög
,

49 
	g°©
.
	gtime_öãrvÆ
,

50 
	g°©
.
	gtime_tŸÆ
,

51 
	g°©
.
	gwrôes
))

52 
	gíd


	@lua/internal/sysbench.cmdline.lua

1 -- 
C›yright
 (
C
Ë2017-2018 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

3 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


4 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


5 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


6 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

8 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

9 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


10 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


11 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

13 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


14 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


15 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


18 -- 
Comm™d
 
löe
 
›ti⁄
 
	gh™dlög


21 
	gffi
 = 
ªquúe
("ffi")

23 
ffi
.
cdef
[[

28 
SB_ARG_TYPE_NULL
,

29 
SB_ARG_TYPE_BOOL
,

30 
SB_ARG_TYPE_INT
,

31 
SB_ARG_TYPE_SIZE
,

32 
SB_ARG_TYPE_DOUBLE
,

33 
SB_ARG_TYPE_STRING
,

34 
SB_ARG_TYPE_LIST
,

35 
SB_ARG_TYPE_FILE
,

36 
SB_ARG_TYPE_MAX


37 } 
sb_¨g_ty≥_t
;

40 
boﬁ
 
sb_›t_vÆid©e_t
(const *, const *);

45 c⁄° *
«me
;

46 c⁄° *
desc
;

47 c⁄° *
vÆue
;

48 
sb_¨g_ty≥_t
 
ty≥
;

49 
sb_›t_vÆid©e_t
 *
vÆid©e
;

50 } 
sb_¨g_t
;

52 
sb_lua_£t_ã°_¨gs
(
sb_¨g_t
 *
¨gs
, 
size_t
 
Àn
);

55 
	gsysbích
.
	gcmdlöe
.
	gARG_NULL
 = 
ffi
.
C
.
SB_ARG_TYPE_NULL


56 
sysbích
.
cmdlöe
.
ARG_BOOL
 = 
ffi
.
C
.
SB_ARG_TYPE_BOOL


57 
sysbích
.
cmdlöe
.
ARG_INT
 = 
ffi
.
C
.
SB_ARG_TYPE_INT


58 
sysbích
.
cmdlöe
.
ARG_SIZE
 = 
ffi
.
C
.
SB_ARG_TYPE_SIZE


59 
sysbích
.
cmdlöe
.
ARG_DOUBLE
 = 
ffi
.
C
.
SB_ARG_TYPE_DOUBLE


60 
sysbích
.
cmdlöe
.
ARG_STRING
 = 
ffi
.
C
.
SB_ARG_TYPE_STRING


61 
sysbích
.
cmdlöe
.
ARG_LIST
 = 
ffi
.
C
.
SB_ARG_TYPE_LIST


62 
sysbích
.
cmdlöe
.
ARG_FILE
 = 
ffi
.
C
.
SB_ARG_TYPE_FILE


63 
sysbích
.
cmdlöe
.
ARG_MAX
 = 
ffi
.
C
.
SB_ARG_TYPE_MAX


65 -- 
Aâribuã
 
ödiˇtög
 
th©
 
a
 
cu°om
 
comm™d
 
ˇn
 
be
 
execuãd
 
ö
 
∑øŒñ


66 
sysbích
.
cmdlöe
.
PARALLEL_COMMAND
 = 
åue


68 
loˇl
 
¨g_ty≥s
 = {

69 
boﬁón
 = 
sysbích
.
cmdlöe
.
ARG_BOOL
,

70 
	g°rög
 = 
sysbích
.
cmdlöe
.
ARG_STRING
,

71 
	gnumbî
 = 
sysbích
.
cmdlöe
.
ARG_DOUBLE
,

72 
	gèbÀ
 = 
sysbích
.
cmdlöe
.
ARG_LIST


75 
loˇl
 
fun˘i⁄
 
	$__gíOrdîedIndex
–
t
 )

76 
loˇl
 
‹dîedIndex
 = {
	}
}

77 
key
 
ö
 
	$∑ús
(
t
) do

78 
èbÀ
.
	$ö£π
–
‹dîedIndex
, 
key
 )

79 
íd


80 
èbÀ
.
	$s‹t
–
‹dîedIndex
 )

81  
‹dîedIndex


82 
íd


84 
loˇl
 
fun˘i⁄
 
	$‹dîedNext
(
t
, 
°©e
)

85 
loˇl
 
key
 = 
nû


86 
°©e
 =
nû
 
thí


87 
t
.
__‹dîedIndex
 = 
	$__gíOrdîedIndex
–
t
 )

88 
key
 = 
t
.
__‹dîedIndex
[1]

90 
i
 = 1,
èbÀ
.
	$gën
(
t
.
__‹dîedIndex
) do

91 
t
.
__‹dîedIndex
[
i
] =
°©e
 
thí


92 
key
 = 
t
.
__‹dîedIndex
[
i
+1]

93 
íd


94 
íd


95 
íd


97 
key
 
thí


98  
key
, 
t
[key]

99 
íd


101 
t
.
__‹dîedIndex
 = 
nû


103 
íd


105 
loˇl
 
fun˘i⁄
 
	$‹dîedPaús
(
t
)

106  
‹dîedNext
, 
t
, 
nû


107 
íd


109 -- 
P¨£
 
comm™d
 
löe
 
›ti⁄s
 
deföôi⁄s
, 
¥e£¡
 
ö
 
the
 
s¸ùt
 
as
 
a


110 -- 'sysbích.cmdlöe.›ti⁄s' 
èbÀ
. 
If
 
no
 
such
ÅabÀ 
exi°s
, 
‹
 
thîe
 
a


111 -- 
∑rsög
 
îr‹
,  
Ál£
. 
Rëu∫
 
åue
 
⁄
 
suc˚ss
. 
A·î
Ö¨sög 
the


112 -- 
comm™d
 
löe
 
¨gumíts
, 
›ti⁄
 
vÆues
 
¨e
 
avaûabÀ
 
as
 
the
 
sysbích
.
›t


113 -- 
èbÀ
.

114 
fun˘i⁄
 
sysbích
.
cmdlöe
.
	$ªad_cmdlöe_›ti⁄s
()

115 
sysbích
.
cmdlöe
.
›ti⁄s
 =
nû
 
thí


116  
åue


117 
íd


119 
loˇl
 
t
 = 
	$ty≥
(
sysbích
.
cmdlöe
.
›ti⁄s
)

120 
	`as£π
(
t
 == "table", "wrongÅype for sysbench.cmdline.options: " ..Å)

122 
loˇl
 
i
 = 0

123 
«me
, 
def
 
ö
 
	$∑ús
(
sysbích
.
cmdlöe
.
›ti⁄s
) do

124 
i
 = i+1

125 
íd


127 
loˇl
 
¨gs
 = 
ffi
.
	`√w
('sb_¨g_t[?]', 
i
)

128 
i
 = 0

130 
«me
, 
def
 
ö
 
	$‹dîedPaús
(
sysbích
.
cmdlöe
.
›ti⁄s
) do

131 -- 
«me


132 
	`as£π
(
	`ty≥
(
«me
Ë="°rög" 
™d
Åy≥(
def
) == "table",

134 
¨gs
[
i
].
«me
 =Çame

136 -- 
des¸ùti⁄


137 
	`as£π
(
def
[1] ~
nû
, "nû des¸ùti⁄ f‹ o±i⁄ " .. 
«me
)

138 
¨gs
[
i
].
desc
 = 
def
[1]

140 
	`ty≥
(
def
[2]Ë="èbÀ" 
thí


141 
	`as£π
(
	`ty≥
(
def
[3]Ë="nû" 
‹


142 
	`ty≥
(
def
[3]Ë=
sysbích
.
cmdlöe
.
ARG_LIST
,

143 "wr⁄gÅy≥ f‹Üi° o±i⁄ " .. 
«me
)

144 
¨gs
[
i
].
vÆue
 = 
èbÀ
.
	`c⁄ˇt
(
def
[2], ',')

146 
	`ty≥
(
def
[2]Ë="boﬁón" 
thí


147 
¨gs
[
i
].
vÆue
 = 
def
[2] 
™d
 '⁄' 
‹
 'off'

148 
ñ£if
 
	`ty≥
(
def
[2]Ë="numbî" 
thí


149 
¨gs
[
i
].
vÆue
 = 
	$to°rög
(
def
[2])

151 
¨gs
[
i
].
vÆue
 = 
def
[2]

152 
íd


153 
íd


155 -- 
ty≥


156 
loˇl
 
t
 = 
def
[3]

157 
t
 =
nû
 
thí


158 
def
[2] ~
nû
 
thí


159 -- 
Try
 
to
 
dëîmöe
 
the
 
ty≥
 
by
Åhê 
vÆue


160 
t
 = 
¨g_ty≥s
[
	`ty≥
(
def
[2])]

162 
t
 = 
sysbích
.
cmdlöe
.
ARG_STRING


163 
íd


164 
íd


166 
	`as£π
(
t
 ~
nû
, "ˇ¬Ÿ dëîmöêty≥ f‹ o±i⁄ " .. 
«me
)

167 
¨gs
[
i
].
ty≥
 = 
t


169 -- 
vÆid©i⁄
 
fun˘i⁄


170 
¨gs
[
i
].
vÆid©e
 = 
def
[4]

172 
i
 = i + 1

173 
íd


175  
ffi
.
C
.
	`sb_lua_£t_ã°_¨gs
(
¨gs
, 
i
) == 0

176 
íd


178 
fun˘i⁄
 
sysbích
.
cmdlöe
.
	$comm™d_deföed
(
«me
)

179  
	`ty≥
(
sysbích
.
cmdlöe
.
comm™ds
Ë="èbÀ" 
™d


180 
sysbích
.
cmdlöe
.
comm™ds
[
«me
] ~
nû
 
™d


181 
sysbích
.
cmdlöe
.
comm™ds
[
«me
][1] ~
nû


182 
íd


184 
fun˘i⁄
 
sysbích
.
cmdlöe
.
	$comm™d_∑øŒñ
(
«me
)

185  
sysbích
.
cmdlöe
.
	$comm™d_deföed
(
«me
Ë
™d


186 
sysbích
.
cmdlöe
.
comm™ds
[
«me
][2] =sysbích.cmdlöe.
PARALLEL_COMMAND


187 
íd


189 
fun˘i⁄
 
sysbích
.
cmdlöe
.
	$ˇŒ_comm™d
(
«me
)

190 
nŸ
 
sysbích
.
cmdlöe
.
	$comm™d_deföed
(
«me
Ë
thí


191  
Ál£


192 
íd


194 
loˇl
 
rc
 = 
sysbích
.
cmdlöe
.
comm™ds
[
«me
][1]()

196 
rc
 =
nû
 
thí


197 -- 
h™dÀ
 
the
 
whí
Åhê
comm™d
 
d€s
 
nŸ
  
™d
 
vÆue
 
as
 
suc˚ss


198  
åue


200 -- 
Ÿhîwi£
  
suc˚ss
 
™y
 
ªtu∫ed
 
vÆue
 
Ÿhî
 
th™
 
Ál£


201  
rc
 
™d
 
åue
 
‹
 
Ál£


202 
íd


203 
íd


205 
ffi
.
cdef
[[

206 
	`sb_¥öt_ã°_›ti⁄s
();

210 -- 
Pröt
 
des¸ùti⁄s
 
of
 
comm™d
 
löe
 
›ti⁄s
, 
deföed
 
by


211 -- 
sysbích
.
cmdlöe
.
›ti⁄s


213 
fun˘i⁄
 
sysbích
.
cmdlöe
.
	$¥öt_ã°_›ti⁄s
()

214 
ffi
.
C
.
	$sb_¥öt_ã°_›ti⁄s
()

215 
íd


	@lua/internal/sysbench.cmdline.lua.h

1 
	gsysbích_cmdlöe_lua
[] =

218 
size_t
 
	gsysbích_cmdlöe_lua_Àn
 = (
sysbích_cmdlöe_lua
) - 1;

	@lua/internal/sysbench.histogram.lua

1 -- 
C›yright
 (
C
Ë2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

3 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


4 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


5 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


6 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

8 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

9 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


10 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


11 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

13 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


14 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


15 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


18 -- 
Bounded
 
hi°ogøms
 
	gAPI


21 
	gffi
 = 
ªquúe
("ffi")

23 
sysbích
.
hi°ogøm
 = {}

25 
ffi
.
cdef
[[

26 
hi°ogøm
 
sb_hi°ogøm_t
;

31 
sb_hi°ogøm_t
 *
sb_hi°ogøm_√w
(
size_t
 
size
, 
ønge_mö
,

32 
ønge_max
);

37 
sb_hi°ogøm_dñëe
(
sb_hi°ogøm_t
 *
h
);

40 
sb_hi°ogøm_upd©e
(
sb_hi°ogøm_t
 *
h
, 
vÆue
);

45 
sb_hi°ogøm_¥öt
(
sb_hi°ogøm_t
 *
h
);

48 
loˇl
 
	ghi°ogøm
 = {}

50 
fun˘i⁄
 
hi°ogøm
:
	$upd©e
(
vÆue
)

51 
ffi
.
C
.
	$sb_hi°ogøm_upd©e
(
£lf
, 
vÆue
)

52 
íd


54 
fun˘i⁄
 
hi°ogøm
:
	$¥öt
()

55 
ffi
.
C
.
	$sb_hi°ogøm_¥öt
(
£lf
)

56 
íd


58 
loˇl
 
hi°ogøm_mt
 = {

59 
__ödex
 = 
hi°ogøm
,

60 
__to°rög
 = '<sb_histogram>'

61 
	}
}

62 
	gffi
.
më©y≥
('sb_hi°ogøm_t', 
hi°ogøm_mt
)

64 
fun˘i⁄
 
	gsysbích
.
	ghi°ogøm
.
	$√w
(
size
, 
ønge_mö
, 
ønge_max
)

65 
loˇl
 
h
 = 
ffi
.
C
.
	$sb_hi°ogøm_√w
(
size
, 
ønge_mö
, 
ønge_max
)

67  
ffi
.
	$gc
(
h
, 
ffi
.
C
.
sb_hi°ogøm_dñëe
)

68 
íd


	@lua/internal/sysbench.histogram.lua.h

1 
	gsysbích_hi°ogøm_lua
[] =

71 
size_t
 
	gsysbích_hi°ogøm_lua_Àn
 = (
sysbích_hi°ogøm_lua
) - 1;

	@lua/internal/sysbench.lua

1 -- 
C›yright
 (
C
Ë2016-2018 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

3 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


4 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


5 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


6 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

8 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

9 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


10 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


11 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

13 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


14 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


15 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
USA


17 
	gffi
 = 
ªquúe
("ffi")

19 
ffi
.
cdef
[[

20 
sb_evít_°¨t
(
thªad_id
);

21 
sb_evít_°›
(
thªad_id
);

22 
boﬁ
 
sb_m‹e_evíts
(
thªad_id
);

26 -- 
Maö
 
evít
 
	glo›
. 
This
 
is
 
a
 
Lua
 
vîsi⁄
 
of
 
	gsysbích
.
	gc
:
thªad_run
()

28 
fun˘i⁄
 
	$thªad_run
(
thªad_id
)

29 
ffi
.
C
.
	$sb_m‹e_evíts
(
thªad_id
) do

30 
ffi
.
C
.
	$sb_evít_°¨t
(
thªad_id
)

32 
loˇl
 
suc˚ss
, 
ªt


33 
ª≥©


34 
suc˚ss
, 
ªt
 = 
	$pˇŒ
(
evít
, 
thªad_id
)

36 
nŸ
 
suc˚ss
 
thí


37 
	`ty≥
(
ªt
Ë="èbÀ" 
™d


38 
ªt
.
îrcode
 =
sysbích
.
îr‹
.
RESTART_EVENT


39 
thí


40 
sysbích
.
hooks
.
bef‹e_ª°¨t_evít
 
thí


41 
sysbích
.
hooks
.
	$bef‹e_ª°¨t_evít
(
ªt
)

42 
íd


44 
	`îr‹
(
ªt
, 2Ë-- 
¥›ag©e
 
unknown
 
îr‹s


45 
íd


46 
íd


47 
u¡û
 
suc˚ss


49 -- 
St›
 
the
 
bíchm¨k
 
	$evít
(Ë
ªtu∫s
 
a
 
vÆue
 
Ÿhî
 
th™
 
nû
 
‹
 
Ál£


50 
ªt
 
thí


52 
íd


54 
ffi
.
C
.
	$sb_evít_°›
(
thªad_id
)

55 
íd


56 
íd


59 -- 
Hooks


62 
sysbích
.
hooks
 = {

63 -- 
sql_îr‹_ign‹abÀ
 = <
func
>,

64 -- 
ªp‹t_öãrmedüã
 = <
func
>,

65 -- 
ªp‹t_cumuœtive
 = <
func
>

66 
	}
}

68 -- 
Rï‹t
 
°©i°ics
 
ö
 
the
 
CSV
 
	gf‹m©
. 
Add
Åhê
fﬁlowög
 
to
 
	gyour


69 -- 
s¸ùt
 
to
 
ª∂a˚
 
the
  
	ghum™
-
ªadabÀ
 
	gªp‹ts


71 -- 
	gsysbích
.
	ghooks
.
	gªp‹t_öãrmedüã
 = 
sysbích
.
ªp‹t_csv


72 
fun˘i⁄
 
sysbích
.
	$ªp‹t_csv
(
°©
)

73 
loˇl
 
£c⁄ds
 = 
°©
.
time_öãrvÆ


74 
	`¥öt
(
°rög
.
	`f‹m©
("%.0f,%u,%4.2f," ..

78 
°©
.
time_tŸÆ
,

79 
°©
.
thªads_ru¬ög
,

80 
°©
.
evíts
 / 
£c⁄ds
,

81 (
°©
.
ªads
 + sèt.
wrôes
 + sèt.
Ÿhî
Ë/ 
£c⁄ds
,

82 
°©
.
ªads
 / 
£c⁄ds
,

83 
°©
.
wrôes
 / 
£c⁄ds
,

84 
°©
.
Ÿhî
 / 
£c⁄ds
,

85 
°©
.
œãncy_p˘
 * 1000,

86 
°©
.
îr‹s
 / 
£c⁄ds
,

87 
°©
.
ªc⁄√˘s
 / 
£c⁄ds


89 
íd


91 -- 
Rï‹t
 
°©i°ics
 
ö
 
the
 
JSON
 
f‹m©
. 
Add
Åhê
fﬁlowög
 
to
 
your


92 -- 
s¸ùt
 
to
 
ª∂a˚
 
the
  
hum™
-
ªadabÀ
 
ªp‹ts


94 -- 
sysbích
.
hooks
.
ªp‹t_öãrmedüã
 = sysbích.
ªp‹t_js⁄


95 
fun˘i⁄
 
sysbích
.
	$ªp‹t_js⁄
(
°©
)

96 
nŸ
 
gobj
 
thí


97 
io
.
	`wrôe
('[\n')

98 -- 
hack
 
to
 
¥öt
 
the
 
˛osög
 
bøckë
 
whí
Åhê
Lua
 
°©e
 
of
Åhê
ªp‹tög


99 -- 
thªad
 
is
 
˛o£d


100 
gobj
 = 
	$√w¥oxy
(
åue
)

101 
	`gëmë©abÀ
(
gobj
).
__gc
 = 
	$fun˘i⁄
 (Ë
io
.
	`wrôe
('\n]\n'Ë
íd


103 
io
.
	`wrôe
(',\n')

104 
íd


106 
loˇl
 
£c⁄ds
 = 
°©
.
time_öãrvÆ


107 
io
.
	`wrôe
(([[

110 "thªads": %
u
,

121 
	}
}]]):
f‹m©
(

122 
°©
.
time_tŸÆ
,

123 
°©
.
thªads_ru¬ög
,

124 
°©
.
evíts
 / 
£c⁄ds
,

125 (
°©
.
ªads
 + sèt.
wrôes
 + sèt.
Ÿhî
Ë/ 
£c⁄ds
,

126 
°©
.
ªads
 / 
£c⁄ds
,

127 
°©
.
wrôes
 / 
£c⁄ds
,

128 
°©
.
Ÿhî
 / 
£c⁄ds
,

129 
°©
.
œãncy_p˘
 * 1000,

130 
°©
.
îr‹s
 / 
£c⁄ds
,

131 
°©
.
ªc⁄√˘s
 / 
£c⁄ds


133 
	gíd


135 -- 
Rï‹t
 
°©i°ics
 
ö
 
the
  
	ghum™
-
ªadabÀ
 
	gf‹m©
. 
You
 
ˇn
 
u£
 
ô
 
	gyou


136 -- 
w™t
 
to
 
augmít
  
ªp‹ts
 
wôh
 
your
 
own
 
	g°©i°ics
. 
CÆl
 
ô
 
‰om
 
	gyour


137 -- 
own
 
ªp‹t
 
	ghook
, 
	ge
.
	gg
.:

139 -- 
fun˘i⁄
 
sysbích
.
hooks
.
ªp‹t_öãrmedüã
(
°©
)

140 -- 
¥öt
("my sèt: ", 
vÆ
)

141 -- 
	gsysbích
.
ªp‹t_deÁu…
(
°©
)

142 -- 
íd


143 
fun˘i⁄
 
	gsysbích
.
	$ªp‹t_deÁu…
(
°©
)

144 
loˇl
 
£c⁄ds
 = 
°©
.
time_öãrvÆ


145 
	`¥öt
(
°rög
.
	`f‹m©
("[ %.0fs ]Åhds: %uÅps: %4.2f qps: %4.2f " ..

148 
°©
.
time_tŸÆ
,

149 
°©
.
thªads_ru¬ög
,

150 
°©
.
evíts
 / 
£c⁄ds
,

151 (
°©
.
ªads
 + sèt.
wrôes
 + sèt.
Ÿhî
Ë/ 
£c⁄ds
,

152 
°©
.
ªads
 / 
£c⁄ds
,

153 
°©
.
wrôes
 / 
£c⁄ds
,

154 
°©
.
Ÿhî
 / 
£c⁄ds
,

155 
sysbích
.
›t
.
≥r˚¡ûe
,

156 
°©
.
œãncy_p˘
 * 1000,

157 
°©
.
îr‹s
 / 
£c⁄ds
,

158 
°©
.
ªc⁄√˘s
 / 
£c⁄ds


160 
íd


	@lua/internal/sysbench.lua.h

1 
	gsysbích_lua
[] =

163 
size_t
 
	gsysbích_lua_Àn
 = (
sysbích_lua
) - 1;

	@lua/internal/sysbench.rand.lua

1 -- 
C›yright
 (
C
Ë2016-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

3 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


4 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


5 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


6 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

8 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

9 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


10 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


11 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

13 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


14 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


15 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
USA


17 
	gffi
 = 
ªquúe
("ffi")

20 -- 
P£udo
-
øndom
 
numbî
 
gíî©i⁄
 
API


23 
sysbích
.
ønd
 = {}

25 
ffi
.
cdef
[[

26 
uöt64_t
 
sb_ønd_unif‹m_uöt64
();

27 
uöt32_t
 
sb_ønd_deÁu…
(uint32_t, uint32_t);

28 
uöt32_t
 
sb_ønd_unif‹m
(uint32_t, uint32_t);

29 
uöt32_t
 
sb_ønd_gaussün
(uint32_t, uint32_t);

30 
uöt32_t
 
sb_ønd_•ecül
(uint32_t, uint32_t);

31 
uöt32_t
 
sb_ønd_∑ªto
(uint32_t, uint32_t);

32 
uöt32_t
 
sb_ønd_zùfün
(uint32_t, uint32_t);

33 
uöt32_t
 
sb_ønd_unique
();

34 
sb_ønd_°r
(const *, *);

35 
uöt32_t
 
sb_ønd_v¨°r
(*, uint32_t, uint32_t);

36 
sb_ønd_unif‹m_doubÀ
();

39 
fun˘i⁄
 
	gsysbích
.
	gønd
.
	$unif‹m_uöt64
()

40  
ffi
.
C
.
	$sb_ønd_unif‹m_uöt64
()

41 
íd


43 
fun˘i⁄
 
sysbích
.
ønd
.(
a
, 
b
)

44  
ffi
.
C
.
	$sb_ønd_deÁu…
(
a
, 
b
)

45 
íd


47 
fun˘i⁄
 
sysbích
.
ønd
.
	$unif‹m
(
a
, 
b
)

48  
ffi
.
C
.
	$sb_ønd_unif‹m
(
a
, 
b
)

49 
íd


51 
fun˘i⁄
 
sysbích
.
ønd
.
	$gaussün
(
a
, 
b
)

52  
ffi
.
C
.
	$sb_ønd_gaussün
(
a
, 
b
)

53 
íd


55 
fun˘i⁄
 
sysbích
.
ønd
.
	$•ecül
(
a
, 
b
)

56  
ffi
.
C
.
	$sb_ønd_•ecül
(
a
, 
b
)

57 
íd


59 
fun˘i⁄
 
sysbích
.
ønd
.
	$∑ªto
(
a
, 
b
)

60  
ffi
.
C
.
	$sb_ønd_∑ªto
(
a
, 
b
)

61 
íd


63 
fun˘i⁄
 
sysbích
.
ønd
.
	$zùfün
(
a
, 
b
)

64  
ffi
.
C
.
	$sb_ønd_zùfün
(
a
, 
b
)

65 
íd


67 
fun˘i⁄
 
sysbích
.
ønd
.
	$unique
()

68  
ffi
.
C
.
	$sb_ønd_unique
()

69 
íd


71 
fun˘i⁄
 
sysbích
.
ønd
.
	$°rög
(
fmt
)

72 
loˇl
 
buÊí
 = #fmt

73 
loˇl
 
buf
 = 
ffi
.
	`√w
("uöt8_t[?]", 
buÊí
)

74 
ffi
.
C
.
	$sb_ønd_°r
(
fmt
, 
buf
)

75  
ffi
.
	$°rög
(
buf
, 
buÊí
)

76 
íd


78 
fun˘i⁄
 
sysbích
.
ønd
.
	$v¨°rög
(
mö_Àn
, 
max_Àn
)

79 
	`as£π
(
mö_Àn
 <
max_Àn
)

80 
	`as£π
(
max_Àn
 > 0)

81 
loˇl
 
buÊí
 = 
max_Àn


82 
loˇl
 
buf
 = 
ffi
.
	`√w
("uöt8_t[?]", 
buÊí
)

83 
loˇl
 
nch¨s
 = 
ffi
.
C
.
	$sb_ønd_v¨°r
(
buf
, 
mö_Àn
, 
max_Àn
)

84  
ffi
.
	$°rög
(
buf
, 
nch¨s
)

85 
íd


87 
fun˘i⁄
 
sysbích
.
ønd
.
	$unif‹m_doubÀ
()

88  
ffi
.
C
.
	$sb_ønd_unif‹m_doubÀ
()

89 
íd


	@lua/internal/sysbench.rand.lua.h

1 
	gsysbích_ønd_lua
[] =

92 
size_t
 
	gsysbích_ønd_lua_Àn
 = (
sysbích_ønd_lua
) - 1;

	@lua/internal/sysbench.sql.lua

1 -- 
C›yright
 (
C
Ë2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

3 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


4 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


5 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


6 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

8 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

9 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


10 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


11 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

13 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


14 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


15 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


18 -- 
SQL
 
	gAPI


21 
	gffi
 = 
ªquúe
("ffi")

23 
sysbích
.
sql
 = {}

25 
ffi
.
cdef
[[

32 
DB_ERROR_NONE
,

33 
DB_ERROR_IGNORABLE
,

35 
DB_ERROR_FATAL


36 } 
sql_îr‹_t
;

40 c⁄° *
¢ame
;

41 c⁄° *
 ame
;

43 c⁄° 
›aque
[?];

44 } 
	tsql_drivî
;

47 
uöt32_t
 
	mÀn
;

48 c⁄° *
	m±r
;

49 } 
	tsql_vÆue
;

55 *
	m±r
;

56 
sql_vÆue
 *
	mvÆues
;

57 } 
	tsql_row
;

63 
	mSB_CNT_OTHER
,

64 
	mSB_CNT_READ
,

65 
	mSB_CNT_WRITE
,

66 
	mSB_CNT_TRX
,

67 
	mSB_CNT_ERROR
,

68 
	mSB_CNT_RECONNECT
,

69 
	mSB_CNT_BYTES_READ
,

70 
	mSB_CNT_BYTES_WRITTEN
,

71 
	mSB_CNT_MAX


72 } 
	tsb_cou¡î_ty≥
;

76 
sql_îr‹_t
 
	mîr‹
;

77 
	msql_î∫o
;

78 c⁄° *
	msql_°©e
;

79 c⁄° *
	msql_îrmsg
;

80 
sql_drivî
 *
	mdrivî
;

82 c⁄° 
	m›aque
[?];

83 } 
	tsql_c⁄√˘i⁄
;

87 
sql_c⁄√˘i⁄
 *
	mc⁄√˘i⁄
;

89 c⁄° 
	m›aque
[?];

90 } 
	tsql_°©emít
;

96 
sb_cou¡î_ty≥
 
	mcou¡î
;

97 
uöt32_t
 
	mƒows
;

98 
uöt32_t
 
	mnfõlds
;

99 
sql_°©emít
 *
	m°©emít
;

100 *
	m±r
;

101 
sql_row
 
	mrow
;

102 } 
	tsql_ªsu…
;

106 
	mSQL_TYPE_NONE
,

107 
	mSQL_TYPE_TINYINT
,

108 
	mSQL_TYPE_SMALLINT
,

109 
	mSQL_TYPE_INT
,

110 
	mSQL_TYPE_BIGINT
,

111 
	mSQL_TYPE_FLOAT
,

112 
	mSQL_TYPE_DOUBLE
,

113 
	mSQL_TYPE_TIME
,

114 
	mSQL_TYPE_DATE
,

115 
	mSQL_TYPE_DATETIME
,

116 
	mSQL_TYPE_TIMESTAMP
,

117 
	mSQL_TYPE_CHAR
,

118 
	mSQL_TYPE_VARCHAR


119 } 
	tsql_böd_ty≥_t
;

123 
sql_böd_ty≥_t
 
	mty≥
;

124 *
	mbuf„r
;

125 *
	md©a_Àn
;

126 
	mmax_Àn
;

127 *
	mis_nuŒ
;

128 } 
	tsql_böd
;

130 
sql_drivî
 *
db_¸óã
(const *);

131 
db_de°roy
(
sql_drivî
 *
drv
);

133 
sql_c⁄√˘i⁄
 *
db_c⁄√˘i⁄_¸óã
(
sql_drivî
 * 
drv
);

134 
db_c⁄√˘i⁄_˛o£
(
sql_c⁄√˘i⁄
 *
c⁄
);

135 
db_c⁄√˘i⁄_ªc⁄√˘
(
sql_c⁄√˘i⁄
 *
c⁄
);

136 
db_c⁄√˘i⁄_‰ì
(
sql_c⁄√˘i⁄
 *
c⁄
);

138 
db_bulk_ö£π_öô
(
sql_c⁄√˘i⁄
 *, c⁄° *, 
size_t
);

139 
db_bulk_ö£π_√xt
(
sql_c⁄√˘i⁄
 *, c⁄° *, 
size_t
);

140 
db_bulk_ö£π_d⁄e
(
sql_c⁄√˘i⁄
 *);

142 
sql_ªsu…
 *
db_quîy
(
sql_c⁄√˘i⁄
 *
c⁄
, c⁄° *
quîy
, 
size_t
 
Àn
);

144 
sql_row
 *
db_„tch_row
(
sql_ªsu…
 *
rs
);

146 
sql_°©emít
 *
db_¥ï¨e
(
sql_c⁄√˘i⁄
 *
c⁄
, c⁄° *
quîy
, 
size_t
 
Àn
);

147 
db_böd_∑øm
(
sql_°©emít
 *
°mt
, 
sql_böd
 *
∑øms
, 
size_t
 
Àn
);

148 
db_böd_ªsu…
(
sql_°©emít
 *
°mt
, 
sql_böd
 *
ªsu…s
, 
size_t
 
Àn
);

149 
sql_ªsu…
 *
db_execuã
(
sql_°©emít
 *
°mt
);

150 
db_˛o£
(
sql_°©emít
 *
°mt
);

152 
db_‰ì_ªsu…s
(
sql_ªsu…
 *);

155 
loˇl
 
	gsql_drivî
 = 
ffi
.
ty≥of
('sql_driver *')

156 
loˇl
 
sql_c⁄√˘i⁄
 = 
ffi
.
ty≥of
('sql_connection *')

157 
loˇl
 
sql_°©emít
 = 
ffi
.
ty≥of
('sql_statement *')

158 
loˇl
 
sql_böd
 = 
ffi
.
ty≥of
('sql_bind');

159 
loˇl
 
	gsql_ªsu…
 = 
ffi
.
ty≥of
('sql_result');

160 
loˇl
 
	gsql_vÆue
 = 
ffi
.
ty≥of
('sql_value');

161 
loˇl
 
	gsql_row
 = 
ffi
.
ty≥of
('sql_row');

163 
	gsysbích
.
	gsql
.
	gty≥
 =

165 
NONE
 = 
ffi
.
C
.
SQL_TYPE_NONE
,

166 
	gTINYINT
 = 
ffi
.
C
.
SQL_TYPE_TINYINT
,

167 
	gSMALLINT
 = 
ffi
.
C
.
SQL_TYPE_SMALLINT
,

168 
	gINT
 = 
ffi
.
C
.
SQL_TYPE_INT
,

169 
	gBIGINT
 = 
ffi
.
C
.
SQL_TYPE_BIGINT
,

170 
	gFLOAT
 = 
ffi
.
C
.
SQL_TYPE_FLOAT
,

171 
	gDOUBLE
 = 
ffi
.
C
.
SQL_TYPE_DOUBLE
,

172 
	gTIME
 = 
ffi
.
C
.
SQL_TYPE_TIME
,

173 
	gDATE
 = 
ffi
.
C
.
SQL_TYPE_DATE
,

174 
	gDATETIME
 = 
ffi
.
C
.
SQL_TYPE_DATETIME
,

175 
	gTIMESTAMP
 = 
ffi
.
C
.
SQL_TYPE_TIMESTAMP
,

176 
	gCHAR
 = 
ffi
.
C
.
SQL_TYPE_CHAR
,

177 
	gVARCHAR
 = 
ffi
.
C
.
SQL_TYPE_VARCHAR


180 -- 
Inôülize
 
a
 
giví
 
SQL
 
drivî
 
™d
 á 
h™dÀ
 
to
 
ô
Åÿ
	g¸óã


181 -- 
	gc⁄√˘i⁄s
. 
A
 
nû
 
drivî
 
	$«me
 (
i
.
e
. 
no
 
fun˘i⁄
 
¨gumít
Ë
öôülizes
 
the


182 --  
drivî
, 
i
.
e
. 
the
 
⁄e
 
•ecifõd
 
wôh
 --
db
-drivî 
⁄
Åhê
comm™d
 
löe
.

183 
fun˘i⁄
 
sysbích
.
sql
.
	$drivî
(
drivî_«me
)

184 
loˇl
 
drv
 = 
ffi
.
C
.
	$db_¸óã
(
drivî_«me
)

185 i‡(
drv
 =
nû
Ë
thí


186 
	`îr‹
("failedÅo initializeÅhe DB driver", 2)

187 
íd


188  
ffi
.
	$gc
(
drv
, 
ffi
.
C
.
db_de°roy
)

189 
íd


191 -- 
sql_drivî
 
mëhods


192 
loˇl
 
drivî_mëhods
 = {
	}
}

194 
fun˘i⁄
 
drivî_mëhods
.
	$c⁄√˘
(
£lf
)

195 
loˇl
 
c⁄
 = 
ffi
.
C
.
	$db_c⁄√˘i⁄_¸óã
(
£lf
)

196 
c⁄
 =
nû
 
thí


197 
	`îr‹
("connection creation failed", 2)

198 
íd


199  
ffi
.
	$gc
(
c⁄
, 
ffi
.
C
.
db_c⁄√˘i⁄_‰ì
)

200 
íd


202 
fun˘i⁄
 
drivî_mëhods
.
	$«me
(
£lf
)

203  
ffi
.
	$°rög
(
£lf
.
¢ame
)

204 
íd


206 -- 
sql_drivî
 
më©abÀ


207 
loˇl
 
drivî_mt
 = {

208 
__ödex
 = 
drivî_mëhods
,

209 
__gc
 = 
ffi
.
C
.
db_de°roy
,

210 
__to°rög
 = 
	`fun˘i⁄
(Ë '<sql_drivî>' 
íd
,

211 
	}
}

212 
	gffi
.
më©y≥
("sql_drivî", 
drivî_mt
)

214 -- 
sql_c⁄√˘i⁄
 
mëhods


215 
loˇl
 
	gc⁄√˘i⁄_mëhods
 = {}

217 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$disc⁄√˘
(
£lf
)

218  
	`as£π
(
ffi
.
C
.
	`db_c⁄√˘i⁄_˛o£
(
£lf
) == 0)

219 
íd


221 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$ªc⁄√˘
(
£lf
)

222  
	`as£π
(
ffi
.
C
.
	`db_c⁄√˘i⁄_ªc⁄√˘
(
£lf
) == 0)

223 
íd


225 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$check_îr‹
(
£lf
, 
rs
, 
quîy
)

226 
rs
 ~
nû
 
‹
 
£lf
.
îr‹
 =
sysbích
.
sql
.îr‹.
NONE
 
thí


227  
rs


228 
íd


230 
£lf
.
sql_°©e
 =
nû
 
‹
 sñf.
sql_îrmsg
 =nû 
thí


231 -- 
It
 
mu°
 
be
 
™
 
API
 
îr‹
, 
d⁄
't botherÅryingÅo downgrade itán

232 -- 
ign‹abÀ
 
îr‹


233 
	`îr‹
("SQL APIÉrror", 3)

234 
íd


236 
loˇl
 
sql_°©e
 = 
ffi
.
	$°rög
(
£lf
.
sql_°©e
)

237 
loˇl
 
sql_îrmsg
 = 
ffi
.
	`°rög
(
£lf
.sql_errmsg)

239 -- 
Cª©e
 
™
 
îr‹
 
des¸ùt‹
 
c⁄èöög
 
c⁄√˘i⁄
, 
Áûed
 
quîy
, 
SQL
Érror

240 -- 
numbî
, 
°©e
 
™d
 
îr‹
 
mesßge
 
¥ovided
 
by
 
the
 
SQL
 
drivî


241 
îrdesc
 = {

242 
c⁄√˘i⁄
 = 
£lf
,

243 
quîy
 = query,

244 
sql_î∫o
 = 
£lf
.sql_errno,

245 
sql_°©e
 = sql_state,

246 
sql_îrmsg
 = sql_errmsg

247 
	}
}

249 -- 
Check
 
the
 
îr‹
 
has
 
Æªady
 
bìn
 
m¨ked
 
as
 
ign‹abÀ
 
by
Åhê
	gdrivî
, 
	g‹


250 -- 
thîe
 
is
 
™
 
îr‹
 
hook
 
th©
 
Ælows
 
downgødög
 
ô
 
to
 
IGNORABLE


251 i‡(
	g£lf
.
	gîr‹
 =
sysbích
.
sql
.
îr‹
.
FATAL
 
™d


252 
ty≥
(
sysbích
.
hooks
.
sql_îr‹_ign‹abÀ
Ë="fun˘i⁄" 
™d


253 
sysbích
.
hooks
.
	$sql_îr‹_ign‹abÀ
(
îrdesc
)Ë
‹


254 
£lf
.
îr‹
 =
sysbích
.
sql
.îr‹.
IGNORABLE


255 
thí


256 -- 
Throw
 
a
 'ª°¨àevít' 
ex˚±i⁄
 
th©
 
ˇn
 
be
 
ˇught
 
by
 
the
 
u£r
 
s¸ùt


257 -- 
to
 dÿ
some
 
exåa
 
°ïs
Åÿ
ª°¨t
 
a
 
	`å™ß˘i⁄
 (
e
.
g
. 
ª¥ï¨e


258 -- 
°©emíts
 
a·î
 
a
 
ªc⁄√˘
). 
Othîwi£
 
ô
 
wûl
 
be
 
ˇught
 
by


259 -- 
	$thªad_run
(Ë
ö
 
sysbích
.
lua
, i¿
which
 
the
 
ítúe
 
cuºít
 
evít


260 -- 
wûl
 
be
 
ª°¨ãd
 
wôhout
 
exåa
 
¥o˚ssög
.

261 
îrdesc
.
îrcode
 = 
sysbích
.
îr‹
.
RESTART_EVENT


262 
	$îr‹
(
îrdesc
, 3)

263 
íd


265 -- 
Ju°
 
throw
 
a
 
ªguœr
 
îr‹
 
mesßge
 
⁄
á 
Áèl
Érror

266 
	`îr‹
(
°rög
.
	`f‹m©
("SQLÉrror,Érrno = %d, state = '%s': %s",

267 
£lf
.
sql_î∫o
, 
sql_°©e
, 
sql_îrmsg
), 2)

268 
íd


270 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$quîy
(
£lf
, 
quîy
)

271 
loˇl
 
rs
 = 
ffi
.
C
.
	`db_quîy
(
£lf
, 
quîy
, #query)

272  
£lf
:
	$check_îr‹
(
rs
, 
quîy
)

273 
íd


275 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$bulk_ö£π_öô
(
£lf
, 
quîy
)

276  
	`as£π
(
ffi
.
C
.
	`db_bulk_ö£π_öô
(
£lf
, 
quîy
, #query) == 0,

278 
íd


280 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$bulk_ö£π_√xt
(
£lf
, 
vÆ
)

281  
	`as£π
(
ffi
.
C
.
	`db_bulk_ö£π_√xt
(
£lf
, 
vÆ
, #val) == 0,

283 
íd


285 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$bulk_ö£π_d⁄e
(
£lf
)

286  
	`as£π
(
ffi
.
C
.
	`db_bulk_ö£π_d⁄e
(
£lf
) == 0,

288 
íd


290 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$¥ï¨e
(
£lf
, 
quîy
)

291 
loˇl
 
°mt
 = 
ffi
.
C
.
	`db_¥ï¨e
(
£lf
, 
quîy
, #query)

292 
°mt
 =
nû
 
thí


293 
£lf
:
	$check_îr‹
(
nû
, 
quîy
)

294 
íd


295  
°mt


296 
íd


298 -- 
A
 
c⁄víõn˚
 
wøµî
 
¨ound
 
sql_c⁄√˘i⁄
:
	$quîy
(Ë
™d


299 -- 
sql_ªsu…
:
	`„tch_row
(). 
Execuãs
 
the
 
•ecifõd
 
quîy
 
™d
 
ªtu∫s
Åhê
fú°


300 -- 
row
 
‰om
 
the
 
ªsu…
 
£t
, 
avaûabÀ
, 
‹
 
nû
 
Ÿhîwi£


301 
fun˘i⁄
 
c⁄√˘i⁄_mëhods
.
	$quîy_row
(
£lf
, 
quîy
)

302 
loˇl
 
rs
 = 
£lf
:
	$quîy
(
quîy
)

304 
rs
 =
nû
 
‹
Ñs.
ƒows
 =0 
thí


305  
nû


306 
íd


308  
	`u≈ack
(
rs
:
	`„tch_row
(), 1,Ñs.
nfõlds
)

309 
íd


311 -- 
sql_c⁄√˘i⁄
 
më©abÀ


312 
loˇl
 
c⁄√˘i⁄_mt
 = {

313 
__ödex
 = 
c⁄√˘i⁄_mëhods
,

314 
__to°rög
 = 
	`fun˘i⁄
(Ë '<sql_c⁄√˘i⁄>' 
íd
,

315 
__gc
 = 
ffi
.
C
.
db_c⁄√˘i⁄_‰ì
,

316 
	}
}

317 
	gffi
.
më©y≥
("sql_c⁄√˘i⁄", 
c⁄√˘i⁄_mt
)

319 -- 
sql_∑øm


320 
loˇl
 
	gsql_∑øm
 = {}

321 
fun˘i⁄
 
sql_∑øm
.
	$£t
(
£lf
, 
vÆue
)

322 
loˇl
 
sql_ty≥
 = 
sysbích
.
sql
.
ty≥


323 
loˇl
 
bty≥
 = 
£lf
.
ty≥


325 i‡(
vÆue
 =
nû
Ë
thí


326 
£lf
.
is_nuŒ
[0] = 
åue


328 
íd


330 
£lf
.
is_nuŒ
[0] = 
Ál£


332 
bty≥
 =
sql_ty≥
.
TINYINT
 
‹


333 
bty≥
 =
sql_ty≥
.
SMALLINT
 
‹


334 
bty≥
 =
sql_ty≥
.
INT
 
‹


335 
bty≥
 =
sql_ty≥
.
BIGINT


336 
thí


337 
£lf
.
buf„r
[0] = 
vÆue


338 
ñ£if
 
bty≥
 =
sql_ty≥
.
FLOAT
 
‹


339 
bty≥
 =
sql_ty≥
.
DOUBLE


340 
thí


341 
£lf
.
buf„r
[1] = 
vÆue


342 
ñ£if
 
bty≥
 =
sql_ty≥
.
CHAR
 
‹


343 
bty≥
 =
sql_ty≥
.
VARCHAR


344 
thí


345 
loˇl
 
Àn
 = #value

346 
Àn
 = 
£lf
.
max_Àn
 <Üí 
™d
 sñf.max_À¿
‹
Üen

347 
ffi
.
	$c›y
(
£lf
.
buf„r
, 
vÆue
, 
Àn
)

348 
£lf
.
d©a_Àn
[0] = 
Àn


350 
	`îr‹
("Unsuµ‹ãdárgumíàty≥: " .. 
bty≥
, 2)

351 
íd


352 
íd


354 
fun˘i⁄
 
sql_∑øm
.
	$£t_ønd_°r
(
£lf
, 
fmt
)

355 
loˇl
 
sql_ty≥
 = 
sysbích
.
sql
.
ty≥


356 
loˇl
 
bty≥
 = 
£lf
.
ty≥


358 
£lf
.
is_nuŒ
[0] = 
Ál£


360 
bty≥
 =
sql_ty≥
.
CHAR
 
‹


361 
bty≥
 =
sql_ty≥
.
VARCHAR


362 
thí


363 
loˇl
 
Àn
 = #fmt

364 
Àn
 = 
£lf
.
max_Àn
 <Üí 
™d
 sñf.max_À¿
‹
Üen

365 
ffi
.
C
.
	$sb_ønd_°r
(
fmt
, 
£lf
.
buf„r
)

366 
£lf
.
d©a_Àn
[0] = 
Àn


368 
	`îr‹
("Unsuµ‹ãdárgumíàty≥: " .. 
bty≥
, 2)

369 
íd


370 
íd


372 
sql_∑øm
.
__ödex
 = sql_param

373 
sql_∑øm
.
__to°rög
 = 
	$fun˘i⁄
 (Ë '<sql_∑øm>' 
íd


375 -- 
sql_°©emít
 
mëhods


376 
loˇl
 
°©emít_mëhods
 = {
	}
}

378 
fun˘i⁄
 
°©emít_mëhods
.
	$böd_¸óã
(
£lf
, 
bty≥
, 
max_Àn
)

379 
loˇl
 
sql_ty≥
 = 
sysbích
.
sql
.
ty≥


381 
loˇl
 
∑øm
 = 
	`£tmë©abÀ
({
	}
}, 
	gsql_∑øm
)

383 
	gbty≥
 =
sql_ty≥
.
TINYINT
 
‹


384 
bty≥
 =
sql_ty≥
.
SMALLINT
 
‹


385 
bty≥
 =
sql_ty≥
.
INT
 
‹


386 
bty≥
 =
sql_ty≥
.
BIGINT


387 
thí


388 
∑øm
.
ty≥
 = 
sql_ty≥
.
BIGINT


389 
∑øm
.
buf„r
 = 
ffi
.
√w
('int64_t[1]')

390 
∑øm
.
max_Àn
 = 8

391 
ñ£if
 
bty≥
 =
sql_ty≥
.
FLOAT
 
‹


392 
bty≥
 =
sql_ty≥
.
DOUBLE


393 
thí


394 
∑øm
.
ty≥
 = 
sql_ty≥
.
DOUBLE


395 
∑øm
.
buf„r
 = 
ffi
.
√w
('double[1]')

396 
∑øm
.
max_Àn
 = 8

397 
ñ£if
 
bty≥
 =
sql_ty≥
.
CHAR
 
‹


398 
bty≥
 =
sql_ty≥
.
VARCHAR


399 
thí


400 
∑øm
.
ty≥
 = 
sql_ty≥
.
VARCHAR


401 
∑øm
.
buf„r
 = 
ffi
.
√w
('ch¨[?]', 
max_Àn
)

402 
	g∑øm
.
	gmax_Àn
 = 
max_Àn


404 
îr‹
("Unsuµ‹ãdárgumíàty≥: " .. 
bty≥
, 2)

405 
íd


407 
	g∑øm
.
	gd©a_Àn
 = 
ffi
.
√w
('unsignedÜong[1]')

408 
∑øm
.
is_nuŒ
 = 
ffi
.
√w
('char[1]')

410  
∑øm


411 
íd


413 
fun˘i⁄
 
°©emít_mëhods
.
	$böd_∑øm
(
£lf
, ...)

414 
loˇl
 
Àn
 = 
	`£À˘
('#', ...)

415 
Àn
 < 1 
thí
  
nû
 
íd


417 
loˇl
 
böds
 = 
ffi
.
	`√w
("sql_böd[?]", 
Àn
)

419 
loˇl
 
i
, 
∑øm


421 
i
, 
∑øm
 
ö
 
	`ùaús
({...
	}
}) do

422 
	gböds
[
i
-1].
	gty≥
 = 
∑øm
.
ty≥


423 
böds
[
i
-1].
buf„r
 = 
∑øm
.buffer

424 
böds
[
i
-1].
d©a_Àn
 = 
∑øm
.data_len

425 
böds
[
i
-1].
max_Àn
 = 
∑øm
.max_len

426 
böds
[
i
-1].
is_nuŒ
 = 
∑øm
.is_null

427 
íd


428  
ffi
.
C
.
	$db_böd_∑øm
(
£lf
, 
böds
, 
Àn
)

429 
íd


431 
fun˘i⁄
 
°©emít_mëhods
.
	$execuã
(
£lf
)

432 
loˇl
 
rs
 = 
ffi
.
C
.
	$db_execuã
(
£lf
)

433  
£lf
.
c⁄√˘i⁄
:
	`check_îr‹
(
rs
, '<prepared statement>')

434 
íd


436 
fun˘i⁄
 
°©emít_mëhods
.
	$˛o£
(
£lf
)

437  
ffi
.
C
.
	$db_˛o£
(
£lf
)

438 
íd


440 -- 
sql_°©emít
 
më©abÀ


441 
loˇl
 
°©emít_mt
 = {

442 
__ödex
 = 
°©emít_mëhods
,

443 
__to°rög
 = 
	`fun˘i⁄
(Ë '<sql_°©emít>' 
íd
,

444 
__gc
 = 
ffi
.
C
.
db_˛o£
,

445 
	}
}

446 
	gffi
.
më©y≥
("sql_°©emít", 
°©emít_mt
)

448 
loˇl
 
	gböd_mt
 = {

449 
__to°rög
 = 
fun˘i⁄
(Ë '<sql_böd>' 
íd
,

451 
	gffi
.
më©y≥
("sql_böd", 
böd_mt
)

453 -- 
sql_ªsu…
 
mëhods


454 
loˇl
 
	gªsu…_mëhods
 = {}

456 -- 
Rëu∫s
 
the
 
√xt
 
row
 
of
 
vÆues
 
‰om
 
a
 
ªsu…
 
£t
, 
‹
 
nû
 
thîe
 
¨e
 
no
 
	gm‹e


457 -- 
rows
 
to
 
	g„tch
. 
VÆues
 
¨e
 
ªtu∫ed
 
as
 
™
 
	g¨øy
, 
	gi
.
	ge
. 
a
 
èbÀ
 
wôh
 
	gnumîic


458 -- 
ödexes
 
°¨tög
 
	g‰om
 1. 
The
 
tŸÆ
 
numbî
 
of
 
vÆues
 (
i
.
e
. 
fõlds
 
ö
 
a
 
ªsu…


459 -- 
£t
Ë
ˇn
 
be
 
obèöed
 
‰om
 
	gsql_ªsu…
.
	gnfõlds
.

460 
fun˘i⁄
 
	gªsu…_mëhods
.
	$„tch_row
(
£lf
)

461 
loˇl
 
ªs
 = {
	}
}

462 
loˇl
 
row
 = 
ffi
.
C
.
	$db_„tch_row
(
£lf
)

464 
row
 =
nû
 
thí


465  
nû


466 
íd


468 
loˇl
 
i


469 
i
 = 0, 
£lf
.
nfõlds
-1 do

470 
row
.
vÆues
[
i
].
±r
 ~
nû
 
thí
 -- 
nŸ
 
a
 
NULL
 
vÆue


471 
ªs
[
i
+1] = 
ffi
.
	`°rög
(
row
.
vÆues
[i].
±r
, 
	$t⁄umbî
(
row
.
vÆues
[
i
].
Àn
))

472 
íd


473 
íd


475  
ªs


476 
íd


478 
fun˘i⁄
 
ªsu…_mëhods
.
	$‰ì
(
£lf
)

479  
	`as£π
(
ffi
.
C
.
	`db_‰ì_ªsu…s
(
£lf
) == 0, "db_free_results() failed")

480 
íd


482 -- 
sql_ªsu…s
 
më©abÀ


483 
loˇl
 
ªsu…_mt
 = {

484 
__ödex
 = 
ªsu…_mëhods
,

485 
__to°rög
 = 
	`fun˘i⁄
(Ë '<sql_ªsu…>' 
íd
,

486 
__gc
 = 
ffi
.
C
.
db_‰ì_ªsu…s


487 
	}
}

488 
	gffi
.
më©y≥
("sql_ªsu…", 
ªsu…_mt
)

490 -- 
îr‹
 
codes


491 
	gsysbích
.
	gsql
.
	gîr‹
 = {}

492 
sysbích
.
sql
.
îr‹
.
NONE
 = 
ffi
.
C
.
DB_ERROR_NONE


493 
sysbích
.
sql
.
îr‹
.
IGNORABLE
 = 
ffi
.
C
.
DB_ERROR_IGNORABLE


494 
sysbích
.
sql
.
îr‹
.
FATAL
 = 
ffi
.
C
.
DB_ERROR_FATAL


	@lua/internal/sysbench.sql.lua.h

1 
	gsysbích_sql_lua
[] =

497 
size_t
 
	gsysbích_sql_lua_Àn
 = (
sysbích_sql_lua
) - 1;

	@lua/oltp_common.lua

1 -- 
C›yright
 (
C
Ë2006-2018 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

3 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


4 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


5 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


6 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

8 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

9 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


10 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


11 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

13 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


14 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


15 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


18 -- 
Comm⁄
 
code
 
OLTP
 
	gbíchm¨ks
.

21 
fun˘i⁄
 
	$öô
()

22 
	`as£π
(
evít
 ~
nû
,

25 
íd


27 
sysbích
.
cmdlöe
.
comm™d
 =
nû
 
thí


28 
	`îr‹
("Command isÑequired. Supported commands:Örepare, warmup,Ñun, " ..

30 
íd


32 -- 
Comm™d
 
löe
 
›ti⁄s


33 
sysbích
.
cmdlöe
.
›ti⁄s
 = {

34 
èbÀ_size
 =

36 
ønge_size
 =

38 
èbÀs
 =

40 
poöt_£À˘s
 =

42 
sim∂e_ønges
 =

44 
sum_ønges
 =

46 
‹dî_ønges
 =

48 
di°ö˘_ønges
 =

50 
ödex_upd©es
 =

52 
n⁄_ödex_upd©es
 =

54 
dñëe_ö£πs
 =

56 
ønge_£À˘s
 =

57 {"E«bÀ/dißbÀáŒÑ™gêSELECT quîõs", 
åue
},

58 
auto_öc
 =

61 "˛õ¡-gíî©ed IDs", 
åue
},

62 
¸óã_èbÀ_›ti⁄s
 =

64 
skù_åx
 =

66 "öÅhêAUTOCOMMIT mode", 
Ál£
},

67 
£c⁄d¨y
 =

68 {"U£á sec⁄d¨y index i¿∂a˚ o‡thêPRIMARY KEY", 
Ál£
},

69 
¸óã_£c⁄d¨y
 =

70 {"Cª©ê®£c⁄d¨y index i¿addôi⁄ÅÿthêPRIMARY KEY", 
åue
},

71 
ªc⁄√˘
 =

74 
mysql_°‹age_ígöe
 =

76 
pgsql_v¨ü¡
 =

82 
	}
}

84 -- 
Pª∑ª
 
the
 
	gd©a£t
. 
This
 
comm™d
 
suµ‹ts
 
∑øŒñ
 
	gexecuti⁄
, 
	gi
.
	ge
. 
	gwûl


85 -- 
bíefô
 
‰om
 
executög
 
	gwôh
 --
	gthªads
 > 1 
as
 
	gas
 --
	gèbÀs
 > 1

86 
fun˘i⁄
 
	$cmd_¥ï¨e
()

87 
loˇl
 
drv
 = 
sysbích
.
sql
.
	$drivî
()

88 
loˇl
 
c⁄
 = 
drv
:
	$c⁄√˘
()

90 
i
 = 
sysbích
.
tid
 % sysbích.
›t
.
thªads
 + 1, sysbích.›t.
èbÀs
,

91 
sysbích
.
›t
.
thªads
 do

92 
	$¸óã_èbÀ
(
drv
, 
c⁄
, 
i
)

93 
íd


94 
íd


96 -- 
Pªlﬂd
 
the
 
d©a£t
 
öto
Åhê
£rvî
 
ˇche
. 
This
 
comm™d
 
suµ‹ts
 
∑øŒñ


97 -- 
executi⁄
, 
i
.
e
. 
wûl
 
bíefô
 
‰om
 
executög
 
wôh
 --
thªads
 > 1 
as
 as

98 -- --
èbÀs
 > 1

100 -- 
PS
. 
Cuºíéy
, 
this
 
comm™d
 
is
 
⁄ly
 
mónögful
 
MySQL
/
I¬oDB
 
bíchm¨ks


101 
fun˘i⁄
 
	$cmd_w¨mup
()

102 
loˇl
 
drv
 = 
sysbích
.
sql
.
	$drivî
()

103 
loˇl
 
c⁄
 = 
drv
:
	$c⁄√˘
()

105 
	`as£π
(
drv
:
	`«me
() == "mysql", "warmup is currently MySQL only")

107 -- 
Do
 
nŸ
 
¸óã
 
⁄
 
disk
 
èbÀs
 
sub£quít
 
quîõs


108 
c⁄
:
	`quîy
("SETÅmp_table_size=2*1024*1024*1024")

109 
c⁄
:
	`quîy
("SET max_heap_table_size=2*1024*1024*1024")

111 
i
 = 
sysbích
.
tid
 % sysbích.
›t
.
thªads
 + 1, sysbích.›t.
èbÀs
,

112 
sysbích
.
›t
.
thªads
 do

113 
loˇl
 
t
 = "sbã°" .. 
i


114 
	`¥öt
("PªlﬂdögÅabÀ " .. 
t
)

115 
c⁄
:
	`quîy
("ANALYZE TABLE sbã°" .. 
i
)

116 
c⁄
:
	`quîy
(
°rög
.
	`f‹m©
(

120 
t
, 
sysbích
.
›t
.
èbÀ_size
))

121 
c⁄
:
	`quîy
(
°rög
.
	`f‹m©
(

124 
t
, 
sysbích
.
›t
.
èbÀ_size
))

125 
íd


126 
íd


128 -- 
Im∂emít
 
∑øŒñ
 
¥ï¨e
 
™d
 
w¨mup
 
comm™ds
, 
deföe
 '¥ew¨m' 
as
 
™
 
Æüs


130 
sysbích
.
cmdlöe
.
comm™ds
 = {

131 
¥ï¨e
 = {
cmd_¥ï¨e
, 
sysbích
.
cmdlöe
.
PARALLEL_COMMAND
},

132 
w¨mup
 = {
cmd_w¨mup
, 
sysbích
.
cmdlöe
.
PARALLEL_COMMAND
},

133 
¥ew¨m
 = {
cmd_w¨mup
, 
sysbích
.
cmdlöe
.
PARALLEL_COMMAND
}

134 
	}
}

137 -- 
Tem∂©e
 
°rögs
 
of
 
øndom
 
digôs
 
	gwôh
 11-
digô
 
groups
 
£∑øãd
 
by
 
	gdashes


139 -- 10 
	ggroups
, 119 
ch¨a˘îs


140 
loˇl
 
	gc_vÆue_ãm∂©e
 = "###########-###########-###########-" ..

145 -- 5 
groups
, 59 
ch¨a˘îs


146 
loˇl
 
	g∑d_vÆue_ãm∂©e
 = "###########-###########-###########-" ..

149 
fun˘i⁄
 
	$gë_c_vÆue
()

150  
sysbích
.
ønd
.
	$°rög
(
c_vÆue_ãm∂©e
)

151 
íd


153 
fun˘i⁄
 
	$gë_∑d_vÆue
()

154  
sysbích
.
ønd
.
	$°rög
(
∑d_vÆue_ãm∂©e
)

155 
íd


157 
fun˘i⁄
 
	$¸óã_èbÀ
(
drv
, 
c⁄
, 
èbÀ_num
)

158 
loˇl
 
id_ödex_def
, 
id_def


159 
loˇl
 
ígöe_def
 = ""

160 
loˇl
 
exåa_èbÀ_›ti⁄s
 = ""

161 
loˇl
 
quîy


163 
sysbích
.
›t
.
£c⁄d¨y
 
thí


164 
id_ödex_def
 = "KEY xid"

166 
id_ödex_def
 = "PRIMARY KEY"

167 
íd


169 
drv
:
	`«me
() == "mysql"

170 
thí


171 
sysbích
.
›t
.
auto_öc
 
thí


172 
id_def
 = "INTEGER NOT NULL AUTO_INCREMENT"

174 
id_def
 = "INTEGER NOT NULL"

175 
íd


176 
ígöe_def
 = "/*! ENGINE = " .. 
sysbích
.
›t
.
mysql_°‹age_ígöe
 .. " */"

177 
ñ£if
 
drv
:
	`«me
() == "pgsql"

178 
thí


179 
nŸ
 
sysbích
.
›t
.
auto_öc
 
thí


180 
id_def
 = "INTEGER NOT NULL"

181 
ñ£if
 
pgsql_v¨ü¡
 ='ªdshi·' 
thí


182 
id_def
 = "INTEGER IDENTITY(1,1)"

184 
id_def
 = "SERIAL"

185 
íd


187 
	`îr‹
("Unsuµ‹ãd d©aba£ drivî:" .. 
drv
:
	$«me
())

188 
íd


190 
	`¥öt
(
°rög
.
	`f‹m©
("Cª©ögÅabÀ 'sbã°%d'...", 
èbÀ_num
))

192 
quîy
 = 
°rög
.
	`f‹m©
([[

193 
CREATE
 
TABLE
 
sbã°
%
	`d
(

194 
id
 %
s
,

195 
k
 
INTEGER
 
DEFAULT
 '0' 
NOT
 
NULL
,

196 
c
 
	$CHAR
(120Ë
DEFAULT
 '' 
NOT
 
NULL
,

197 
∑d
 
	$CHAR
(60Ë
DEFAULT
 '' 
NOT
 
NULL
,

198 %
	`s
 (
id
)

199 Ë%
s
 %s]],

200 
èbÀ_num
, 
id_def
, 
id_ödex_def
, 
ígöe_def
,

201 
sysbích
.
›t
.
¸óã_èbÀ_›ti⁄s
)

203 
c⁄
:
	$quîy
(
quîy
)

205 i‡(
sysbích
.
›t
.
èbÀ_size
 > 0Ë
thí


206 
	`¥öt
(
°rög
.
	`f‹m©
("Inserting %dÑecords into 'sbtest%d'",

207 
sysbích
.
›t
.
èbÀ_size
, 
èbÀ_num
))

208 
íd


210 
sysbích
.
›t
.
auto_öc
 
thí


211 
quîy
 = "INSERT INTO sbã°" .. 
èbÀ_num
 .. "(k, c,Öad) VALUES"

213 
quîy
 = "INSERT INTO sbã°" .. 
èbÀ_num
 .. "(id, k, c,Öad) VALUES"

214 
íd


216 
c⁄
:
	$bulk_ö£π_öô
(
quîy
)

218 
loˇl
 
c_vÆ


219 
loˇl
 
∑d_vÆ


221 
i
 = 1, 
sysbích
.
›t
.
èbÀ_size
 do

223 
c_vÆ
 = 
	$gë_c_vÆue
()

224 
∑d_vÆ
 = 
	$gë_∑d_vÆue
()

226 i‡(
sysbích
.
›t
.
auto_öc
Ë
thí


227 
quîy
 = 
°rög
.
	`f‹m©
("(%d, '%s', '%s')",

228 
sysbích
.
ønd
.(1, sysbích.
›t
.
èbÀ_size
),

229 
c_vÆ
, 
∑d_vÆ
)

231 
quîy
 = 
°rög
.
	`f‹m©
("(%d, %d, '%s', '%s')",

232 
i
,

233 
sysbích
.
ønd
.(1, sysbích.
›t
.
èbÀ_size
),

234 
c_vÆ
, 
∑d_vÆ
)

235 
íd


237 
c⁄
:
	$bulk_ö£π_√xt
(
quîy
)

238 
íd


240 
c⁄
:
	$bulk_ö£π_d⁄e
()

242 
sysbích
.
›t
.
¸óã_£c⁄d¨y
 
thí


243 
	`¥öt
(
°rög
.
	`f‹m©
("Creatingá secondary index on 'sbtest%d'...",

244 
èbÀ_num
))

245 
c⁄
:
	`quîy
(
°rög
.
	`f‹m©
("CREATE INDEX k_%d ON sbtest%d(k)",

246 
èbÀ_num
,Åable_num))

247 
íd


248 
íd


250 
loˇl
 
t
 = 
sysbích
.
sql
.
ty≥


251 
loˇl
 
°mt_defs
 = {

252 
poöt_£À˘s
 = {

254 
t
.
INT
},

255 
sim∂e_ønges
 = {

257 
t
.
INT
,Å.INT},

258 
sum_ønges
 = {

260 
t
.
INT
,Å.INT},

261 
‹dî_ønges
 = {

263 
t
.
INT
,Å.INT},

264 
di°ö˘_ønges
 = {

266 
t
.
INT
,Å.INT},

267 
ödex_upd©es
 = {

269 
t
.
INT
},

270 
n⁄_ödex_upd©es
 = {

272 {
t
.
CHAR
, 120},Å.
INT
},

273 
dñëes
 = {

275 
t
.
INT
},

276 
ö£πs
 = {

278 
t
.
INT
,Å.INT, {t.
CHAR
, 120}, {t.CHAR, 60}},

279 
	}
}

281 
fun˘i⁄
 
	$¥ï¨e_begö
()

282 
°mt
.
begö
 = 
c⁄
:
	`¥ï¨e
("BEGIN")

283 
íd


285 
fun˘i⁄
 
	$¥ï¨e_commô
()

286 
°mt
.
commô
 = 
c⁄
:
	`¥ï¨e
("COMMIT")

287 
íd


289 
fun˘i⁄
 
	$¥ï¨e_f‹_óch_èbÀ
(
key
)

290 
t
 = 1, 
sysbích
.
›t
.
èbÀs
 do

291 
°mt
[
t
][
key
] = 
c⁄
:
	`¥ï¨e
(
°rög
.
	$f‹m©
(
°mt_defs
[
key
][1], 
t
))

293 
loˇl
 
≈¨am
 = #°mt_defs[
key
] - 1

295 
≈¨am
 > 0 
thí


296 
∑øm
[
t
][
key
] = {
	}
}

297 
íd


299 
p
 = 1, 
≈¨am
 do

300 
loˇl
 
	gbty≥
 = 
°mt_defs
[
key
][
p
+1]

301 
loˇl
 
Àn


303 
ty≥
(
bty≥
Ë="èbÀ" 
thí


304 
Àn
 = 
bty≥
[2]

305 
bty≥
 = btype[1]

306 
íd


307 
bty≥
 =
sysbích
.
sql
.
ty≥
.
VARCHAR
 
‹


308 
bty≥
 =
sysbích
.
sql
.
ty≥
.
CHAR
 
thí


309 
∑øm
[
t
][
key
][
p
] = 
°mt
[t][key]:
	$böd_¸óã
(
bty≥
, 
Àn
)

311 
∑øm
[
t
][
key
][
p
] = 
°mt
[t][key]:
	$böd_¸óã
(
bty≥
)

312 
íd


313 
íd


315 
≈¨am
 > 0 
thí


316 
°mt
[
t
][
key
]:
	`böd_∑øm
(
	$u≈ack
(
∑øm
[
t
][
key
]))

317 
íd


318 
íd


319 
íd


321 
fun˘i⁄
 
	$¥ï¨e_poöt_£À˘s
()

322 
	`¥ï¨e_f‹_óch_èbÀ
("point_selects")

323 
íd


325 
fun˘i⁄
 
	$¥ï¨e_sim∂e_ønges
()

326 
	`¥ï¨e_f‹_óch_èbÀ
("simple_ranges")

327 
íd


329 
fun˘i⁄
 
	$¥ï¨e_sum_ønges
()

330 
	`¥ï¨e_f‹_óch_èbÀ
("sum_ranges")

331 
íd


333 
fun˘i⁄
 
	$¥ï¨e_‹dî_ønges
()

334 
	`¥ï¨e_f‹_óch_èbÀ
("order_ranges")

335 
íd


337 
fun˘i⁄
 
	$¥ï¨e_di°ö˘_ønges
()

338 
	`¥ï¨e_f‹_óch_èbÀ
("distinct_ranges")

339 
íd


341 
fun˘i⁄
 
	$¥ï¨e_ödex_upd©es
()

342 
	`¥ï¨e_f‹_óch_èbÀ
("index_updates")

343 
íd


345 
fun˘i⁄
 
	$¥ï¨e_n⁄_ödex_upd©es
()

346 
	`¥ï¨e_f‹_óch_èbÀ
("non_index_updates")

347 
íd


349 
fun˘i⁄
 
	$¥ï¨e_dñëe_ö£πs
()

350 
	`¥ï¨e_f‹_óch_èbÀ
("deletes")

351 
	`¥ï¨e_f‹_óch_èbÀ
("inserts")

352 
íd


354 
fun˘i⁄
 
	$thªad_öô
()

355 
drv
 = 
sysbích
.
sql
.
	$drivî
()

356 
c⁄
 = 
drv
:
	`c⁄√˘
()

358 -- 
Cª©e
 
globÆ
 
√°ed
 
èbÀs
 
¥ï¨ed
 
°©emíts
 
™d
 
theú


359 -- 
∑ømëîs
. 
We
 
√ed
 
a
 
°©emít
 
™d
á 
∑ømëî
 
£t
 
óch
 
combö©i⁄


360 -- 
of
 
c⁄√˘i⁄
/
èbÀ
/
quîy


361 
°mt
 = {
	}
}

362 
∑øm
 = {}

364 
t
 = 1, 
	gsysbích
.
	g›t
.
èbÀs
 do

365 
	g°mt
[
t
] = {}

366 
∑øm
[
t
] = {}

367 
íd


369 -- 
This
 
fun˘i⁄
 
is
 
a
 'ˇŒback' 
deföed
 
by
 
ödividuÆ
 
bíchm¨k
 
s¸ùts


370 
	$¥ï¨e_°©emíts
()

371 
íd


373 -- 
Clo£
 
¥ï¨ed
 
°©emíts


374 
fun˘i⁄
 
	$˛o£_°©emíts
()

375 
t
 = 1, 
sysbích
.
›t
.
èbÀs
 do

376 
k
, 
s
 
ö
 
	$∑ús
(
°mt
[
t
]) do

377 
°mt
[
t
][
k
]:
	$˛o£
()

378 
íd


379 
íd


380 i‡(
°mt
.
begö
 ~
nû
Ë
thí


381 
°mt
.
begö
:
	$˛o£
()

382 
íd


383 i‡(
°mt
.
commô
 ~
nû
Ë
thí


384 
°mt
.
commô
:
	$˛o£
()

385 
íd


386 
íd


388 
fun˘i⁄
 
	$thªad_d⁄e
()

389 
	$˛o£_°©emíts
()

390 
c⁄
:
	$disc⁄√˘
()

391 
íd


393 
fun˘i⁄
 
	$˛ónup
()

394 
loˇl
 
drv
 = 
sysbích
.
sql
.
	$drivî
()

395 
loˇl
 
c⁄
 = 
drv
:
	$c⁄√˘
()

397 
i
 = 1, 
sysbích
.
›t
.
èbÀs
 do

398 
	`¥öt
(
°rög
.
	`f‹m©
("Dr›pögÅabÀ 'sbã°%d'...", 
i
))

399 
c⁄
:
	`quîy
("DROP TABLE IF EXISTS sbã°" .. 
i
 )

400 
íd


401 
íd


403 
loˇl
 
fun˘i⁄
 
	$gë_èbÀ_num
()

404  
sysbích
.
ønd
.
	$unif‹m
(1, 
sysbích
.
›t
.
èbÀs
)

405 
íd


407 
loˇl
 
fun˘i⁄
 
	$gë_id
()

408  
sysbích
.
ønd
.(1, sysbích.
›t
.
èbÀ_size
)

409 
íd


411 
fun˘i⁄
 
	$begö
()

412 
°mt
.
begö
:
	$execuã
()

413 
íd


415 
fun˘i⁄
 
	$commô
()

416 
°mt
.
commô
:
	$execuã
()

417 
íd


419 
fun˘i⁄
 
	$execuã_poöt_£À˘s
()

420 
loˇl
 
äum
 = 
	$gë_èbÀ_num
()

421 
loˇl
 
i


423 
i
 = 1, 
sysbích
.
›t
.
poöt_£À˘s
 do

424 
∑øm
[
äum
].
poöt_£À˘s
[1]:
	`£t
(
	$gë_id
())

426 
°mt
[
äum
].
poöt_£À˘s
:
	$execuã
()

427 
íd


428 
íd


430 
loˇl
 
fun˘i⁄
 
	$execuã_ønge
(
key
)

431 
loˇl
 
äum
 = 
	$gë_èbÀ_num
()

433 
i
 = 1, 
sysbích
.
›t
[
key
] do

434 
loˇl
 
id
 = 
	$gë_id
()

436 
∑øm
[
äum
][
key
][1]:
	$£t
(
id
)

437 
∑øm
[
äum
][
key
][2]:
	`£t
(
id
 + 
sysbích
.
›t
.
ønge_size
 - 1)

439 
°mt
[
äum
][
key
]:
	$execuã
()

440 
íd


441 
íd


443 
fun˘i⁄
 
	$execuã_sim∂e_ønges
()

444 
	`execuã_ønge
("simple_ranges")

445 
íd


447 
fun˘i⁄
 
	$execuã_sum_ønges
()

448 
	`execuã_ønge
("sum_ranges")

449 
íd


451 
fun˘i⁄
 
	$execuã_‹dî_ønges
()

452 
	`execuã_ønge
("order_ranges")

453 
íd


455 
fun˘i⁄
 
	$execuã_di°ö˘_ønges
()

456 
	`execuã_ønge
("distinct_ranges")

457 
íd


459 
fun˘i⁄
 
	$execuã_ödex_upd©es
()

460 
loˇl
 
äum
 = 
	$gë_èbÀ_num
()

462 
i
 = 1, 
sysbích
.
›t
.
ödex_upd©es
 do

463 
∑øm
[
äum
].
ödex_upd©es
[1]:
	`£t
(
	$gë_id
())

465 
°mt
[
äum
].
ödex_upd©es
:
	$execuã
()

466 
íd


467 
íd


469 
fun˘i⁄
 
	$execuã_n⁄_ödex_upd©es
(
thªad_id
)

470 
loˇl
 
äum
 = 
thªad_id
 + 1

472 
i
 = 1, 
sysbích
.
›t
.
n⁄_ödex_upd©es
 do

473 
∑øm
[
äum
].
n⁄_ödex_upd©es
[1]:
	$£t_ønd_°r
(
c_vÆue_ãm∂©e
)

474 
∑øm
[
äum
].
n⁄_ödex_upd©es
[2]:
	`£t
(
	$gë_id
())

476 
°mt
[
äum
].
n⁄_ödex_upd©es
:
	$execuã
()

477 
íd


478 
íd


480 
fun˘i⁄
 
	$execuã_dñëe_ö£πs
()

481 
loˇl
 
äum
 = 
	$gë_èbÀ_num
()

483 
i
 = 1, 
sysbích
.
›t
.
dñëe_ö£πs
 do

484 
loˇl
 
id
 = 
	$gë_id
()

485 
loˇl
 
k
 = 
	$gë_id
()

487 
∑øm
[
äum
].
dñëes
[1]:
	$£t
(
id
)

489 
∑øm
[
äum
].
ö£πs
[1]:
	$£t
(
id
)

490 
∑øm
[
äum
].
ö£πs
[2]:
	$£t
(
k
)

491 
∑øm
[
äum
].
ö£πs
[3]:
	$£t_ønd_°r
(
c_vÆue_ãm∂©e
)

492 
∑øm
[
äum
].
ö£πs
[4]:
	$£t_ønd_°r
(
∑d_vÆue_ãm∂©e
)

494 
°mt
[
äum
].
dñëes
:
	$execuã
()

495 
°mt
[
äum
].
ö£πs
:
	$execuã
()

496 
íd


497 
íd


499 -- 
Re
-
¥ï¨e
 
°©emíts
 
we
 
have
 
ªc⁄√˘ed
, 
which
 
is
 
possibÀ
 
whí
 
some
 
of


500 -- 
the
 
li°ed
 
îr‹
 
codes
 
¨e
 
ö
Åhê--
mysql
-
ign‹e
-
îr‹s
 
li°


501 
fun˘i⁄
 
sysbích
.
hooks
.
	$bef‹e_ª°¨t_evít
(
îrdesc
)

502 
îrdesc
.
sql_î∫o
 =2013 
‹
 -- 
CR_SERVER_LOST


503 
îrdesc
.
sql_î∫o
 =2055 
‹
 -- 
CR_SERVER_LOST_EXTENDED


504 
îrdesc
.
sql_î∫o
 =2006 
‹
 -- 
CR_SERVER_GONE_ERROR


505 
îrdesc
.
sql_î∫o
 =2011 -- 
CR_TCP_CONNECTION


506 
thí


507 
	$˛o£_°©emíts
()

508 
	$¥ï¨e_°©emíts
()

509 
íd


510 
íd


512 
fun˘i⁄
 
	$check_ªc⁄√˘
()

513 
sysbích
.
›t
.
ªc⁄√˘
 > 0 
thí


514 
å™ß˘i⁄s
 = (å™ß˘i⁄†
‹
 0) + 1

515 
å™ß˘i⁄s
 % 
sysbích
.
›t
.
ªc⁄√˘
 =0 
thí


516 
	$˛o£_°©emíts
()

517 
c⁄
:
	$ªc⁄√˘
()

518 
	$¥ï¨e_°©emíts
()

519 
íd


520 
íd


521 
íd


	@lua/oltp_delete.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
	gDñëe
-
O∆y
 
OLTP
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
fun˘i⁄
 
	$¥ï¨e_°©emíts
()

25 
	`¥ï¨e_f‹_óch_èbÀ
("deletes")

26 
íd


28 
fun˘i⁄
 
	$evít
()

29 
loˇl
 
äum
 = 
sysbích
.
ønd
.
	$unif‹m
(1, 
sysbích
.
›t
.
èbÀs
)

30 
loˇl
 
id
 = 
sysbích
.
ønd
.(1, sysbích.
›t
.
èbÀ_size
)

32 
∑øm
[
äum
].
dñëes
[1]:
	$£t
(
id
)

33 
°mt
[
äum
].
dñëes
:
	$execuã
()

35 
	$check_ªc⁄√˘
()

36 
íd


	@lua/oltp_insert.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
	gIn£π
-
O∆y
 
OLTP
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
	gsysbích
.
	gcmdlöe
.
	gcomm™ds
.
	g¥ï¨e
 = {

25 
fun˘i⁄
 ()

26 i‡(
nŸ
 
sysbích
.
›t
.
auto_öc
Ë
thí


27 -- 
Cª©e
 
em±y
 
èbÀs
 
⁄
 
¥ï¨e
 
whí
 --auto-
öc
 
is
 
off
, 
sö˚
 
IDs


28 -- 
gíî©ed
 
⁄
 
¥ï¨e
 
may
 
cﬁlide
 
œãr
 
wôh
 
vÆues
 gíî©ed 
by


29 -- 
sysbích
.
ønd
.
unique
()

30 
sysbích
.
›t
.
èbÀ_size
=0

31 
íd


33 
cmd_¥ï¨e
()

34 
íd
,

35 
	gsysbích
.
	gcmdlöe
.
	gPARALLEL_COMMAND


38 
fun˘i⁄
 
¥ï¨e_°©emíts
()

39 -- 
We
 dÿ
nŸ
 
u£
 
¥ï¨ed
 
°©emíts
 
	ghîe
, 
but
 
	gﬁç_comm⁄
.
sh
 
ex≥˘s
 
	gthis


40 -- 
fun˘i⁄
 
to
 
be
 
deföed


41 
íd


43 
fun˘i⁄
 
	$evít
()

44 
loˇl
 
èbÀ_«me
 = "sbã°" .. 
sysbích
.
ønd
.
	$unif‹m
(1, 
sysbích
.
›t
.
èbÀs
)

45 
loˇl
 
k_vÆ
 = 
sysbích
.
ønd
.(1, sysbích.
›t
.
èbÀ_size
)

46 
loˇl
 
c_vÆ
 = 
	$gë_c_vÆue
()

47 
loˇl
 
∑d_vÆ
 = 
	$gë_∑d_vÆue
()

49 i‡(
drv
:
	`«me
(Ë="pgsql" 
™d
 
sysbích
.
›t
.
auto_öc
Ë
thí


50 
c⁄
:
	`quîy
(
°rög
.
	`f‹m©
("INSERT INTO %s (k, c,Öad) VALUES " ..

52 
èbÀ_«me
, 
k_vÆ
, 
c_vÆ
, 
∑d_vÆ
))

54 i‡(
sysbích
.
›t
.
auto_öc
Ë
thí


55 
i
 = 0

57 -- 
C⁄vît
 
a
 
uöt32_t
 
vÆue
 
to
 
SQL
 
INT


58 
i
 = 
sysbích
.
ønd
.
	`unique
() - 2147483648

59 
íd


61 
c⁄
:
	`quîy
(
°rög
.
	`f‹m©
("INSERT INTO %s (id, k, c,Öad) VALUES " ..

63 
èbÀ_«me
, 
i
, 
k_vÆ
, 
c_vÆ
, 
∑d_vÆ
))

64 
íd


66 
	$check_ªc⁄√˘
()

67 
íd


	@lua/oltp_point_select.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
OLTP
 
Poöt
 
Sñe˘
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
fun˘i⁄
 
¥ï¨e_°©emíts
()

25 -- 
	gu£
 1 
quîy
 
≥r
 
	gevít
, 
øthî
 
th™
 
	gsysbích
.
	g›t
.
poöt_£À˘s
 
	gwhich


26 -- 
deÁu…s
 
	gto
 10 
ö
 
Ÿhî
 
OLTP
 
s¸ùts


27 
	gsysbích
.
	g›t
.
	gpoöt_£À˘s
=1

29 
	$¥ï¨e_poöt_£À˘s
()

30 
íd


32 
fun˘i⁄
 
	$evít
()

33 
	$execuã_poöt_£À˘s
()

35 
	$check_ªc⁄√˘
()

36 
íd


	@lua/oltp_read_only.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
	gRód
-
O∆y
 
OLTP
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
fun˘i⁄
 
	$¥ï¨e_°©emíts
()

25 
	$¥ï¨e_poöt_£À˘s
()

27 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


28 
	$¥ï¨e_begö
()

29 
	$¥ï¨e_commô
()

30 
íd


32 
sysbích
.
›t
.
ønge_£À˘s
 
thí


33 
	$¥ï¨e_sim∂e_ønges
()

34 
	$¥ï¨e_sum_ønges
()

35 
	$¥ï¨e_‹dî_ønges
()

36 
	$¥ï¨e_di°ö˘_ønges
()

37 
íd


38 
íd


40 
fun˘i⁄
 
	$evít
()

41 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


42 
	$begö
()

43 
íd


45 
	$execuã_poöt_£À˘s
()

47 
sysbích
.
›t
.
ønge_£À˘s
 
thí


48 
	$execuã_sim∂e_ønges
()

49 
	$execuã_sum_ønges
()

50 
	$execuã_‹dî_ønges
()

51 
	$execuã_di°ö˘_ønges
()

52 
íd


54 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


55 
	$commô
()

56 
íd


58 
	$check_ªc⁄√˘
()

59 
íd


	@lua/oltp_read_write.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
	gRód
/
Wrôe
 
OLTP
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
fun˘i⁄
 
	$¥ï¨e_°©emíts
()

25 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


26 
	$¥ï¨e_begö
()

27 
	$¥ï¨e_commô
()

28 
íd


30 
	$¥ï¨e_poöt_£À˘s
()

32 
sysbích
.
›t
.
ønge_£À˘s
 
thí


33 
	$¥ï¨e_sim∂e_ønges
()

34 
	$¥ï¨e_sum_ønges
()

35 
	$¥ï¨e_‹dî_ønges
()

36 
	$¥ï¨e_di°ö˘_ønges
()

37 
íd


39 
	$¥ï¨e_ödex_upd©es
()

40 
	$¥ï¨e_n⁄_ödex_upd©es
()

41 
	$¥ï¨e_dñëe_ö£πs
()

42 
íd


44 
fun˘i⁄
 
	$evít
()

45 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


46 
	$begö
()

47 
íd


49 
	$execuã_poöt_£À˘s
()

51 
sysbích
.
›t
.
ønge_£À˘s
 
thí


52 
	$execuã_sim∂e_ønges
()

53 
	$execuã_sum_ønges
()

54 
	$execuã_‹dî_ønges
()

55 
	$execuã_di°ö˘_ønges
()

56 
íd


58 
	$execuã_ödex_upd©es
()

59 
	$execuã_n⁄_ödex_upd©es
()

60 
	$execuã_dñëe_ö£πs
()

62 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


63 
	$commô
()

64 
íd


66 
	$check_ªc⁄√˘
()

67 
íd


	@lua/oltp_update_index.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
	gUpd©e
-
Index
 
OLTP
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
fun˘i⁄
 
	$¥ï¨e_°©emíts
()

25 
	$¥ï¨e_ödex_upd©es
()

26 
íd


28 
fun˘i⁄
 
	$evít
()

29 
	$execuã_ödex_upd©es
(
c⁄
)

30 
	$check_ªc⁄√˘
()

31 
íd


	@lua/oltp_update_non_index.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
	gUpd©e
-
	gN⁄
-
Index
 
OLTP
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
fun˘i⁄
 
	$¥ï¨e_°©emíts
()

25 
	$¥ï¨e_n⁄_ödex_upd©es
()

26 
íd


28 
fun˘i⁄
 
	$evít
(
thªad_id
)

29 
	$execuã_n⁄_ödex_upd©es
(
thªad_id
)

31 
	$check_ªc⁄√˘
()

32 
íd


	@lua/oltp_write_only.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
C›yright
 (
C
Ë2006-2017 
AÀxey
 
	gK›ytov
 <
	gak›ytov
@
	ggmaû
.
	gcom
>

4 -- 
This
 
¥ogøm
 
is
 
‰ì
 
	gso·w¨e
; 
you
 
ˇn
 
ªdi°ribuã
 
ô
 
	g™d
/
‹
 
	gmodify


5 -- 
ô
 
undî
 
the
 
ãrms
 
of
Åhê
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
as
 
published
 
	gby


6 -- 
the
 
Fªe
 
So·w¨e
 
	gFound©i⁄
; 
eôhî
 
	gvîsi⁄
 2 
of
Åhê
	gLi˚n£
, 
	g‹


7 -- (
©
 
your
 
	g›ti⁄
Ë
™y
 
œãr
 
	gvîsi⁄
.

9 -- 
This
 
¥ogøm
 
is
 
di°ribuãd
 
ö
 
the
 
h›e
 
th©
 
ô
 
wûl
 
be
 
	gu£ful
,

10 -- 
but
 
WITHOUT
 
ANY
 
	gWARRANTY
; 
wôhout
 
eví
 
the
 
im∂õd
 
w¨ø¡y
 
	gof


11 -- 
MERCHANTABILITY
 
‹
 
FITNESS
 
FOR
 
A
 
PARTICULAR
 
	gPURPOSE
. 
Sì
 
	gthe


12 -- 
GNU
 
GíîÆ
 
Public
 
Li˚n£
 
m‹e
 
	gdëaûs
.

14 -- 
You
 
should
 
have
 
ª˚ived
 
a
 
c›y
 
of
 
the
 
GNU
 
GíîÆ
 
Public
 
	gLi˚n£


15 -- 
Æ⁄g
 
wôh
 
this
 
	g¥ogøm
; 
	gnŸ
, 
wrôe
 
to
 
the
 
Fªe
 
	gSo·w¨e


16 -- 
	gFound©i⁄
, 
	gInc
., 51 
Fønklö
 
	gSåìt
, 
Fi·h
 
	gFlo‹
, 
	gBo°⁄
, 
	gMA
 02110-1301 
	gUSA


19 -- 
	gWrôe
-
O∆y
 
OLTP
 
	gbíchm¨k


22 
ªquúe
("oltp_common")

24 
fun˘i⁄
 
	$¥ï¨e_°©emíts
()

25 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


26 
	$¥ï¨e_begö
()

27 
	$¥ï¨e_commô
()

28 
íd


30 
	$¥ï¨e_ödex_upd©es
()

31 
	$¥ï¨e_n⁄_ödex_upd©es
()

32 
	$¥ï¨e_dñëe_ö£πs
()

33 
íd


35 
fun˘i⁄
 
	$evít
()

36 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


37 
	$begö
()

38 
íd


40 
	$execuã_ödex_upd©es
()

41 
	$execuã_n⁄_ödex_upd©es
()

42 
	$execuã_dñëe_ö£πs
()

44 
nŸ
 
sysbích
.
›t
.
skù_åx
 
thí


45 
	$commô
()

46 
íd


48 
	$check_ªc⁄√˘
()

49 
íd


	@lua/prime-test.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


3 -- 
you
 
ˇn
 
run
 
this
 
s¸ùt
 
like
 
	gthis
:

4 -- 
$
 ./
¥ime
-
ã°
.
lua
 --
˝u
-
max
-¥ime=20000 --
thªads
=8 --
hi°ogøm
 --
ªp‹t
-
öãrvÆ
=1 
run


6 
sysbích
.
cmdlöe
.
›ti⁄s
 = {

7 -- 
the
  
vÆues
 
buût
-
ö
 
›ti⁄s
 
¨e
 
cuºíéy
 
ign‹ed
, 
£e


8 -- 
hâps
:

15 
fun˘i⁄
 
	$evít
()

16 
loˇl
 
n
 = 0

17 
c
 = 3, 
sysbích
.
›t
.
˝u_max_¥ime
 do

18 
loˇl
 
t
 = 
m©h
.
	$sqπ
(
c
)

19 
loˇl
 
i•rime
 = 
åue


20 
l
 = 2, 
t
 do

21 
c
 % 
l
 =0 
thí


22 
i•rime
 = 
Ál£


24 
íd


25 
íd


26 
i•rime
 
thí


27 
n
 =Ç + 1

28 
íd


29 
íd


30 
íd


32 
fun˘i⁄
 
sysbích
.
hooks
.
	$ªp‹t_cumuœtive
(
°©
)

33 
loˇl
 
£c⁄ds
 = 
°©
.
time_öãrvÆ


34 
	`¥öt
(
°rög
.
	`f‹m©
([[

50 
	}
}

52 
	g°©
.
	gîr‹s
,

53 
	g°©
.
	gevíts
,

54 
	g°©
.
	gœãncy_avg
,

55 
	g°©
.
	gœãncy_max
,

56 
	g°©
.
	gœãncy_mö
,

57 
	g°©
.
	gœãncy_p˘
,

58 
	g°©
.
	gœãncy_sum
,

59 
	g°©
.
	gŸhî
,

60 
	g°©
.
	gªads
,

61 
	g°©
.
	gªc⁄√˘s
,

62 
	g°©
.
	gthªads_ru¬ög
,

63 
	g°©
.
	gtime_öãrvÆ
,

64 
	g°©
.
	gtime_tŸÆ
,

65 
	g°©
.
	gwrôes
))

66 
	gíd


	@lua/select_random_points.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
This
 
ã°
 
is
 
desig√d
 
ã°ög
 
	gM¨üDB
's key_cache_segments for MyISAM,

3 -- 
™d
 
should
 
w‹k
 
wôh
 
Ÿhî
 
°‹age
 
ígöes
 
as
 
	gwñl
.

5 -- 
F‹
 
dëaûs
 
about
 
key_ˇche_£gmíts
 
∂ó£
 
ª„r
 
	gto
:

6 -- 
hâp
:

9 
ªquúe
("oltp_common")

11 -- 
Add
 
øndom_poöts
 
to
 
the
 
li°
 
of
 
°™d¨d
 
OLTP
 
›ti⁄s


12 
sysbích
.
cmdlöe
.
›ti⁄s
.
øndom_poöts
 =

15 -- 
Ovîride
 
°™d¨d
 
¥ï¨e
/
˛ónup
 
OLTP
 
fun˘i⁄s
, 
as
 
this
 
bíchm¨k
 
d€s
 
	gnŸ


16 -- 
suµ‹t
 
mu…ùÀ
 
èbÀs


17 
	gﬁç_¥ï¨e
 = 
¥ï¨e


18 
ﬁç_˛ónup
 = 
˛ónup


20 
fun˘i⁄
 
	$¥ï¨e
()

21 
	`as£π
(
sysbích
.
›t
.
èbÀs
 == 1, "this benchmark doesÇot support " ..

23 
	$ﬁç_¥ï¨e
()

24 
íd


26 
fun˘i⁄
 
	$˛ónup
()

27 
	`as£π
(
sysbích
.
›t
.
èbÀs
 == 1, "this benchmark doesÇot support " ..

29 
	$ﬁç_˛ónup
()

30 
íd


32 
fun˘i⁄
 
	$thªad_öô
()

33 
drv
 = 
sysbích
.
sql
.
	$drivî
()

34 
c⁄
 = 
drv
:
	$c⁄√˘
()

36 
loˇl
 
poöts
 = 
°rög
.
	`ªp
("?, ", 
sysbích
.
›t
.
øndom_poöts
 - 1) .. "?"

38 
°mt
 = 
c⁄
:
	`¥ï¨e
(
°rög
.
	`f‹m©
([[

39 
SELECT
 
id
, 
k
, 
c
, 
∑d


40 
FROM
 
sbã°1


41 
WHERE
 
k
 
	`IN
 (%
s
)

42 ]], 
poöts
))

44 
∑øms
 = {
	}
}

45 
j
 = 1, 
	gsysbích
.
	g›t
.
øndom_poöts
 do

46 
	g∑øms
[
j
] = 
°mt
:
	$böd_¸óã
(
sysbích
.
sql
.
ty≥
.
INT
)

47 
íd


49 
°mt
:
	`böd_∑øm
(
	$u≈ack
(
∑øms
))

51 
æí
 = 
sysbích
.
›t
.
èbÀ_size
 / sysbích.›t.
thªads


53 
thªad_id
 = 
sysbích
.
tid
 % sysbích.
›t
.
thªads


54 
íd


56 
fun˘i⁄
 
	$thªad_d⁄e
()

57 
°mt
:
	$˛o£
()

58 
c⁄
:
	$disc⁄√˘
()

59 
íd


61 
fun˘i⁄
 
	`evít
()

62 -- 
To
 
¥evít
 
ovîœµög
 
of
 
our
 
ønge
 
quîõs
 
we
 
√ed
 
to
 
∑πôi⁄
 
the
 
whﬁe


63 -- 
èbÀ
 
öto
 'thªads' 
£gmíts
 
™d
 
thí
 
make
 
óch
 
thªad
 
w‹k
 
wôh
 
ôs


64 -- 
own
 
£gmít
.

65 
i
 = 1, 
sysbích
.
›t
.
øndom_poöts
 do

66 
loˇl
 
rmö
 = 
æí
 * 
thªad_id


67 
loˇl
 
rmax
 = 
rmö
 + 
æí


68 
∑øms
[
i
]:
	`£t
(
sysbích
.
ønd
.(
rmö
, 
rmax
))

69 
íd


71 
°mt
:
	$execuã
()

73 
	$check_ªc⁄√˘
()

74 
íd


	@lua/select_random_ranges.lua

1 #!/
u§
/
bö
/
ív
 
sysbích


2 -- 
This
 
ã°
 
is
 
desig√d
 
ã°ög
 
	gM¨üDB
's key_cache_segments for MyISAM,

3 -- 
™d
 
should
 
w‹k
 
wôh
 
Ÿhî
 
°‹age
 
ígöes
 
as
 
	gwñl
.

5 -- 
F‹
 
dëaûs
 
about
 
key_ˇche_£gmíts
 
∂ó£
 
ª„r
 
	gto
:

6 -- 
hâp
:

9 
ªquúe
("oltp_common")

11 -- 
Add
 --
numbî
-
of
-
ønges
 
™d
 --
dñè
 
to
 
the
 
li°
 o‡
°™d¨d
 
OLTP
 
›ti⁄s


12 
sysbích
.
cmdlöe
.
›ti⁄s
.
numbî_of_ønges
 =

14 
sysbích
.
cmdlöe
.
›ti⁄s
.
dñè
 =

17 -- 
Ovîride
 
°™d¨d
 
¥ï¨e
/
˛ónup
 
OLTP
 
fun˘i⁄s
, 
as
 
this
 
bíchm¨k
 
d€s
 
	gnŸ


18 -- 
suµ‹t
 
mu…ùÀ
 
èbÀs


19 
	gﬁç_¥ï¨e
 = 
¥ï¨e


20 
ﬁç_˛ónup
 = 
˛ónup


22 
fun˘i⁄
 
	$¥ï¨e
()

23 
	`as£π
(
sysbích
.
›t
.
èbÀs
 == 1, "this benchmark doesÇot support " ..

25 
	$ﬁç_¥ï¨e
()

26 
íd


28 
fun˘i⁄
 
	$˛ónup
()

29 
	`as£π
(
sysbích
.
›t
.
èbÀs
 == 1, "this benchmark doesÇot support " ..

31 
	$ﬁç_˛ónup
()

32 
íd


34 
fun˘i⁄
 
	$thªad_öô
()

35 
drv
 = 
sysbích
.
sql
.
	$drivî
()

36 
c⁄
 = 
drv
:
	$c⁄√˘
()

38 
loˇl
 
ønges
 = 
°rög
.
	`ªp
("k BETWEEN ? AND ? OR ",

39 
sysbích
.
›t
.
numbî_of_ønges
 - 1) ..

42 
°mt
 = 
c⁄
:
	`¥ï¨e
(
°rög
.
	`f‹m©
([[

43 
SELECT
 
	$cou¡
(
k
)

44 
FROM
 
sbã°1


45 
WHERE
 %
s
]], 
ønges
))

47 
∑øms
 = {
	}
}

48 
j
 = 1, 
	gsysbích
.
	g›t
.
	gnumbî_of_ønges
*2 do

49 
	g∑øms
[
j
] = 
°mt
:
	$böd_¸óã
(
sysbích
.
sql
.
ty≥
.
INT
)

50 
íd


52 
°mt
:
	`böd_∑øm
(
	$u≈ack
(
∑øms
))

54 
æí
 = 
sysbích
.
›t
.
èbÀ_size
 / sysbích.›t.
thªads


56 
thªad_id
 = 
sysbích
.
tid
 % sysbích.
›t
.
thªads


57 
íd


59 
fun˘i⁄
 
	$thªad_d⁄e
()

60 
°mt
:
	$˛o£
()

61 
c⁄
:
	$disc⁄√˘
()

62 
íd


64 
fun˘i⁄
 
	`evít
()

65 -- 
To
 
¥evít
 
ovîœµög
 
of
 
our
 
ønge
 
quîõs
 
we
 
√ed
 
to
 
∑πôi⁄
 
the
 
whﬁe


66 -- 
èbÀ
 
öto
 'thªads' 
£gmíts
 
™d
 
thí
 
make
 
óch
 
thªad
 
w‹k
 
wôh
 
ôs


67 -- 
own
 
£gmít
.

68 
i
 = 1, 
sysbích
.
›t
.
numbî_of_ønges
*2, 2 do

69 
loˇl
 
rmö
 = 
æí
 * 
thªad_id


70 
loˇl
 
rmax
 = 
rmö
 + 
æí


71 
loˇl
 
vÆ
 = 
sysbích
.
ønd
.(
rmö
, 
rmax
)

72 
∑øms
[
i
]:
	$£t
(
vÆ
)

73 
∑øms
[
i
+1]:
	`£t
(
vÆ
 + 
sysbích
.
›t
.
dñè
)

74 
íd


76 
°mt
:
	$execuã
()

78 
	$check_ªc⁄√˘
()

79 
íd


	@sb_barrier.c

31 #ifde‡
HAVE_CONFIG_H


32 
	~"c⁄fig.h
"

35 
	~"sb_b¨rõr.h
"

37 
	$sb_b¨rõr_öô
(
sb_b¨rõr_t
 *
b¨rõr
, 
cou¡
,

38 
sb_b¨rõr_cb_t
 
ˇŒback
, *
¨g
)

40 i‡(
cou¡
 == 0)

43 i‡(
	`±hªad_muãx_öô
(&
b¨rõr
->
muãx
, 
NULL
) ||

44 
	`±hªad_c⁄d_öô
(&
b¨rõr
->
c⁄d
, 
NULL
))

47 
b¨rõr
->
öô_cou¡
 = 
cou¡
;

48 
b¨rõr
->
cou¡
 = count;

49 
b¨rõr
->
ˇŒback
 = callback;

50 
b¨rõr
->
¨g
 =árg;

51 
b¨rõr
->
£rül
 = 0;

52 
b¨rõr
->
îr‹
 = 0;

55 
	}
}

58 
	$sb_b¨rõr_waô
(
sb_b¨rõr_t
 *
b¨rõr
)

60 
ªs
;

62 
	`±hªad_muãx_lock
(&
b¨rõr
->
muãx
);

64 i‡(!--
b¨rõr
->
cou¡
)

66 
b¨rõr
->
£rül
++;

67 
b¨rõr
->
cou¡
 = b¨rõr->
öô_cou¡
;

69 
ªs
 = 
SB_BARRIER_SERIAL_THREAD
;

71 
	`±hªad_c⁄d_brﬂdˇ°
(&
b¨rõr
->
c⁄d
);

73 i‡(
b¨rõr
->
ˇŒback
 !
NULL
 && b¨rõr->
	`ˇŒback
(b¨rõr->
¨g
) != 0)

75 
b¨rõr
->
îr‹
 = 1;

76 
ªs
 = -1;

79 
	`±hªad_muãx_u∆ock
(&
b¨rõr
->
muãx
);

84 
£rül
 = 
b¨rõr
->serial;

87 
	`±hªad_c⁄d_waô
(&
b¨rõr
->
c⁄d
, &b¨rõr->
muãx
);

88 } 
£rül
 =
b¨rõr
->serial);

90 
ªs
 = 
b¨rõr
->
îr‹
 ? -1 : 0;

92 
	`±hªad_muãx_u∆ock
(&
b¨rõr
->
muãx
);

95  
ªs
;

96 
	}
}

99 
	$sb_b¨rõr_de°roy
(
sb_b¨rõr_t
 *
b¨rõr
)

101 
	`±hªad_muãx_de°roy
(&
b¨rõr
->
muãx
);

102 
	`±hªad_c⁄d_de°roy
(&
b¨rõr
->
c⁄d
);

103 
	}
}

	@sb_barrier.h

21 #i‚de‡
SB_BARRIER_H


22 
	#SB_BARRIER_H


	)

24 #ifde‡
HAVE_CONFIG_H


25 
	~"c⁄fig.h
"

28 #ifde‡
HAVE_PTHREAD_H


29 
	~<±hªad.h
>

32 
	#SB_BARRIER_SERIAL_THREAD
 1

	)

34 (*
	tsb_b¨rõr_cb_t
)(*);

37 
cou¡
;

38 
öô_cou¡
;

39 
£rül
;

40 
±hªad_muãx_t
 
muãx
;

41 
±hªad_c⁄d_t
 
c⁄d
;

42 
sb_b¨rõr_cb_t
 
ˇŒback
;

43 *
¨g
;

44 
îr‹
;

45 } 
	tsb_b¨rõr_t
;

47 
	`sb_b¨rõr_öô
(
sb_b¨rõr_t
 *
b¨rõr
, 
cou¡
,

48 
sb_b¨rõr_cb_t
 
ˇŒback
, *
¨g
);

50 
	`sb_b¨rõr_waô
(
sb_b¨rõr_t
 *
b¨rõr
);

52 
	`sb_b¨rõr_de°roy
(
sb_b¨rõr_t
 *
b¨rõr
);

	@sb_ck_pr.h

62 #i‚de‡
SB_CK_H


63 
	#SB_CK_H


	)

65 
	~"ck_¥.h
"

67 #i‡!
deföed
(
CK_F_PR_LOAD_64
)

69 #i‚de‡
__GNUC__


70 #îr‹ 
Unsuµ‹ãd
 
∂©f‹m


73 
	~<ck_cc.h
>

75 
	#CK_PR_ACCESS
(
x
Ë(*(vﬁ©ûê
	`__ty≥of__
(xË*)&(x))

	)

77 
	#CK_PR_LOAD
(
S
, 
M
, 
T
) \

78 
CK_CC_INLINE
 
T
 \

79 
ck_¥_md_lﬂd_
##
	`S
(c⁄° 
M
 *
èrgë
) \

81 
T
 
r
; \

82 
	`ck_¥_b¨rõr
(); \

83 
r
 = 
	`CK_PR_ACCESS
(*(c⁄° 
T
 *)
èrgë
); \

84 
	`ck_¥_b¨rõr
(); \

85  (
r
); \

87 
CK_CC_INLINE
 \

88 
ck_¥_md_°‹e_
##
	`S
(
M
 *
èrgë
, 
T
 
v
) \

90 
	`ck_¥_b¨rõr
(); \

91 
	`CK_PR_ACCESS
(*(
T
 *)
èrgë
Ë
v
; \

92 
	`ck_¥_b¨rõr
(); \

94 }

	)

96 
	#CK_PR_LOAD_S
(
S
, 
T
Ë
	`CK_PR_LOAD
(S, T, T)

	)

98 
	$CK_PR_LOAD_S
(64, 
uöt64_t
)

100 #unde‡
CK_PR_LOAD_S


101 #unde‡
CK_PR_LOAD


103 
	#CK_PR_LOAD_SAFE
(
SRC
, 
TYPE
Ë
ck_¥_md_lﬂd_
##
	`TYPE
((SRC))

	)

105 
	#CK_PR_STORE_SAFE
(
DST
, 
VAL
, 
TYPE
) \

106 
ck_¥_md_°‹e_
##
	`TYPE
( \

107 (()(*(
DST
Ë(
VAL
)), (DST)), \

108 (
VAL
))

	)

110 
	#ck_¥_lﬂd_64
(
SRC
Ë
	`CK_PR_LOAD_SAFE
((SRC), 64)

	)

111 
	#ck_¥_°‹e_64
(
DST
, 
VAL
Ë
	`CK_PR_STORE_SAFE
((DST), (VAL), 64)

	)

116 
	#CK_PR_CAS
(
S
, 
M
, 
T
) \

117 
CK_CC_INLINE
 
boﬁ
 \

118 
ck_¥_ˇs_
##
	`S
(
M
 *
èrgë
, 
T
 
com∑ª
, T 
£t
) \

120 
boﬁ
 
z
; \

121 
z
 = 
	`__sync_boﬁ_com∑ª_™d_sw≠
((
T
 *)
èrgë
, 
com∑ª
, 
£t
); \

122  
z
; \

123 
	}

	)
}

125 
	#CK_PR_CAS_S
(
S
, 
T
Ë
	`CK_PR_CAS
(S, T, T)

	)

127 
	$CK_PR_CAS_S
(64, 
uöt64_t
)

129 #unde‡
CK_PR_CAS_S


130 #unde‡
CK_PR_CAS


132 
	#CK_PR_CAS_O
(
S
, 
T
) \

133 
CK_CC_INLINE
 
boﬁ
 \

134 
ck_¥_ˇs_
##
S
##
	`_vÆue
(
T
 *
èrgë
, T 
com∑ª
, T 
£t
, T *
v
) \

136 
£t
 = 
	`__sync_vÆ_com∑ª_™d_sw≠
(
èrgë
, 
com∑ª
, set);\

137 *
v
 = 
£t
; \

138  (
£t
 =
com∑ª
); \

139 
	}

	)
}

141 
	$CK_PR_CAS_O
(64, 
uöt64_t
)

143 #unde‡
CK_PR_CAS_O


148 
	#CK_PR_BINARY
(
K
, 
S
, 
M
, 
T
) \

149 
CK_CC_INLINE
 \

150 
ck_¥_
##
K
##
_
##
	`S
(
M
 *
èrgë
, 
T
 
d
) \

152 
d
 = 
__sync_„tch_™d_
##
	`K
((
T
 *)
èrgë
, d); \

154 
	}

	)
}

156 
	#CK_PR_BINARY_S
(
K
, 
S
, 
T
Ë
	`CK_PR_BINARY
(K, S, T, T)

	)

158 
	#CK_PR_GENERATE
(
K
) \

159 
	`CK_PR_BINARY_S
(
K
, 64, 
uöt64_t
)

	)

161 
	$CK_PR_GENERATE
(
add
)

162 
	$CK_PR_GENERATE
(
sub
)

163 
	$CK_PR_GENERATE
(
™d
)

164 
	$CK_PR_GENERATE
(
‹
)

165 
	$CK_PR_GENERATE
(
x‹
)

167 #unde‡
CK_PR_GENERATE


168 #unde‡
CK_PR_BINARY_S


169 #unde‡
CK_PR_BINARY


171 
	#CK_PR_UNARY
(
S
, 
M
, 
T
) \

172 
CK_CC_INLINE
 \

173 
ck_¥_öc_
##
	`S
(
M
 *
èrgë
) \

175 
ck_¥_add_
##
	`S
(
èrgë
, (
T
)1); \

177 
	}
} \

178 
CK_CC_INLINE
 \

179 
ck_¥_dec_
##
	`S
(
M
 *
èrgë
) \

181 
ck_¥_sub_
##
	`S
(
èrgë
, (
T
)1); \

183 }

	)

185 
	#CK_PR_UNARY_S
(
S
, 
M
Ë
	`CK_PR_UNARY
(S, M, M)

	)

187 
	$CK_PR_UNARY_S
(64, 
uöt64_t
)

189 #unde‡
CK_PR_UNARY_S


190 #unde‡
CK_PR_UNARY


192 
	#CK_PR_FAA
(
S
, 
M
, 
T
, 
C
) \

193 
CK_CC_INLINE
 
C
 \

194 
ck_¥_Áa_
##
	`S
(
M
 *
èrgë
, 
T
 
dñè
) \

196 
T
 
¥evious
; \

197 
C
 
pu¡
; \

198 
pu¡
 = (
C
)
ck_¥_md_lﬂd_
##
	`S
(
èrgë
); \

199 
¥evious
 = (
T
)
pu¡
; \

200 
ck_¥_ˇs_
##
S
##
	`_vÆue
(
èrgë
, \

201 (
C
)
¥evious
, \

202 (
C
)(
¥evious
 + 
dñè
), \

203 &
¥evious
Ë=
Ál£
) \

204 
	`ck_¥_°Æl
(); \

206  ((
C
)
¥evious
); \

207 
	}

	)
}

209 
	#CK_PR_FAS
(
S
, 
M
, 
C
) \

210 
CK_CC_INLINE
 
C
 \

211 
ck_¥_Ás_
##
	`S
(
M
 *
èrgë
, 
C
 
upd©e
) \

213 
C
 
¥evious
; \

214 
¥evious
 = 
ck_¥_md_lﬂd_
##
	`S
(
èrgë
); \

215 
ck_¥_ˇs_
##
S
##
	`_vÆue
(
èrgë
, \

216 
¥evious
, \

217 
upd©e
, \

218 &
¥evious
Ë=
Ál£
) \

219 
	`ck_¥_°Æl
(); \

221  (
¥evious
); \

222 }

	)

224 
	#CK_PR_FAA_S
(
S
, 
M
Ë
	`CK_PR_FAA
(S, M, M, M)

	)

225 
	#CK_PR_FAS_S
(
S
, 
M
Ë
	`CK_PR_FAS
(S, M, M)

	)

227 
	$CK_PR_FAA_S
(64, 
uöt64_t
)

228 
	$CK_PR_FAS_S
(64, 
uöt64_t
)

230 #unde‡
CK_PR_FAA_S


231 #unde‡
CK_PR_FAA


232 #unde‡
CK_PR_FAS_S


233 #unde‡
CK_PR_FAS


	@sb_counter.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 
	~"sb_cou¡î.h
"

24 
	~"sysbích.h
"

25 
	~"sb_utû.h
"

26 
	~"sb_ck_¥.h
"

28 
sb_cou¡îs_t
 *
sb_cou¡îs
 
	gCK_CC_CACHELINE
;

30 
sb_cou¡îs_t
 
	gœ°_öãrmedüã_cou¡îs
;

31 
sb_cou¡îs_t
 
	gœ°_cumuœtive_cou¡îs
;

35 
	$sb_cou¡îs_öô
()

37 
	`SB_COMPILE_TIME_ASSERT
((
sb_cou¡îs_t
Ë% 
CK_MD_CACHELINE
 == 0);

39 
sb_cou¡îs
 = 
	`sb_Æloc_≥r_thªad_¨øy
((
sb_cou¡îs_t
));

41  
sb_cou¡îs
 =
NULL
;

42 
	}
}

44 
	$sb_cou¡îs_d⁄e
()

46 i‡(
sb_cou¡îs
 !
NULL
)

48 
	`‰ì
(
sb_cou¡îs
);

49 
sb_cou¡îs
 = 
NULL
;

51 
	}
}

53 
	$sb_cou¡îs_mîge
(
sb_cou¡îs_t
 
d°
)

55 
size_t
 
t
 = 0;Å < 
SB_CNT_MAX
;Å++)

56 
size_t
 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

57 
d°
[
t
] +
	`sb_cou¡î_vÆ
(
i
,Å);

58 
	}
}

60 
	$sb_cou¡îs_checkpoöt
(
sb_cou¡îs_t
 
d°
, sb_cou¡îs_à
˝
)

62 
size_t
 
i
 = 0; i < 
SB_CNT_MAX
; i++)

64 
uöt64_t
 
tmp
 = 
˝
[
i
];

65 
˝
[
i
] = 
d°
[i];

66 
d°
[
i
] = d°[i] - 
tmp
;

68 
	}
}

75 
	$sb_cou¡îs_agg_öãrmedüã
(
sb_cou¡îs_t
 
vÆ
)

77 
	`mem£t
(
vÆ
, 0, (
sb_cou¡îs_t
));

79 
	`sb_cou¡îs_mîge
(
vÆ
);

80 
	`sb_cou¡îs_checkpoöt
(
vÆ
, 
œ°_öãrmedüã_cou¡îs
);

81 
	}
}

88 
	$sb_cou¡îs_agg_cumuœtive
(
sb_cou¡îs_t
 
vÆ
)

90 
	`mem£t
(
vÆ
, 0, (
sb_cou¡îs_t
));

92 
	`sb_cou¡îs_mîge
(
vÆ
);

93 
	`sb_cou¡îs_checkpoöt
(
vÆ
, 
œ°_cumuœtive_cou¡îs
);

94 
	}
}

	@sb_counter.h

19 #i‚de‡
SB_COUNTER_H


20 
	#SB_COUNTER_H


	)

22 #ifde‡
HAVE_CONFIG_H


23 
	~"c⁄fig.h
"

26 #ifde‡
STDC_HEADERS


27 
	~<öây≥s.h
>

30 
	~"sb_utû.h
"

31 
	~"sb_ck_¥.h
"

36 
	mSB_CNT_OTHER
,

37 
	mSB_CNT_READ
,

38 
	mSB_CNT_WRITE
,

39 
	mSB_CNT_EVENT
,

40 
	mSB_CNT_ERROR
,

41 
	mSB_CNT_RECONNECT
,

42 
	mSB_CNT_BYTES_READ
,

43 
	mSB_CNT_BYTES_WRITTEN
,

44 
	mSB_CNT_MAX


45 } 
	tsb_cou¡î_ty≥_t
;

51 
uöt64_t


52 
	tsb_cou¡îs_t
[
SB_ALIGN
(
SB_CNT_MAX
 * (
uöt64_t
), 
CK_MD_CACHELINE
) /

53 (
uöt64_t
)];

55 
sb_cou¡îs_t
 *
sb_cou¡îs
;

57 
sb_cou¡îs_öô
();

59 
sb_cou¡îs_d⁄e
();

68 #i‚de‡
SB_LUA_EXPORT


69 
	#SB_LUA_INLINE
 
ölöe


	)

71 
	#SB_LUA_INLINE


	)

72 
uöt64_t
 
sb_cou¡î_vÆ
(
thªad_id
, 
sb_cou¡î_ty≥_t
 
ty≥
);

73 
sb_cou¡î_add
(
thªad_id
, 
sb_cou¡î_ty≥_t
 
ty≥
, 
uöt64_t
 
vÆ
);

74 
sb_cou¡î_öc
(
thªad_id
, 
sb_cou¡î_ty≥_t
 
ty≥
);

78 
SB_LUA_INLINE


79 
uöt64_t
 
	$sb_cou¡î_vÆ
(
thªad_id
, 
sb_cou¡î_ty≥_t
 
ty≥
)

81  
	`ck_¥_lﬂd_64
(&
sb_cou¡îs
[
thªad_id
][
ty≥
]);

82 
	}
}

85 
SB_LUA_INLINE


86 
	$sb_cou¡î_add
(
thªad_id
, 
sb_cou¡î_ty≥_t
 
ty≥
, 
uöt64_t
 
vÆ
)

88 
	`ck_¥_°‹e_64
(&
sb_cou¡îs
[
thªad_id
][
ty≥
],

89 
	`sb_cou¡î_vÆ
(
thªad_id
, 
ty≥
Ë+ 
vÆ
);

90 
	}
}

93 
SB_LUA_INLINE


94 
	$sb_cou¡î_öc
(
thªad_id
, 
sb_cou¡î_ty≥_t
 
ty≥
)

96 
	`sb_cou¡î_add
(
thªad_id
, 
ty≥
, 1);

97 
	}
}

99 #unde‡
SB_LUA_INLINE


106 
sb_cou¡îs_agg_öãrmedüã
(
sb_cou¡îs_t
 
vÆ
);

113 
sb_cou¡îs_agg_cumuœtive
(
sb_cou¡îs_t
 
vÆ
);

	@sb_global.h

20 #i‚de‡
SB_GLOBAL_H


21 
	#SB_GLOBAL_H


	)

23 #ifde‡
HAVE_CONFIG_H


24 
	~"c⁄fig.h
"

	@sb_histogram.c

18 #ifde‡
HAVE_CONFIG_H


19 
	~"c⁄fig.h
"

22 #ifde‡
STDC_HEADERS


23 
	~<°dio.h
>

24 
	~<°dlib.h
>

26 #ifde‡
HAVE_STRING_H


27 
	~<°rög.h
>

29 #ifde‡
HAVE_MATH_H


30 
	~<m©h.h
>

33 
	~"sysbích.h
"

34 
	~"sb_hi°ogøm.h
"

35 
	~"sb_loggî.h
"

36 
	~"sb_ønd.h
"

38 
	~"sb_ck_¥.h
"

39 
	~"ck_cc.h
"

41 
	~"sb_utû.h
"

48 
	#SB_HISTOGRAM_NSLOTS
 128

	)

51 
sb_hi°ogøm_t
 
sb_œãncy_hi°ogøm
 
	gCK_CC_CACHELINE
;

54 
	$sb_hi°ogøm_öô
(
sb_hi°ogøm_t
 *
h
, 
size_t
 
size
,

55 
ønge_mö
, 
ønge_max
)

57 
size_t
 
i
;

58 
uöt64_t
 *
tmp
;

61 
tmp
 = (
uöt64_t
 *Ë
	`ˇŒoc
(
size
 * (
SB_HISTOGRAM_NSLOTS
 + 2), (uint64_t));

62 
h
->
öãrm_¶Ÿs
 = (
uöt64_t
 **Ë
	`mÆloc
(
SB_HISTOGRAM_NSLOTS
 *

63 (
uöt64_t
 *));

65 i‡(
tmp
 =
NULL
 || 
h
->
öãrm_¶Ÿs
 == NULL)

67 
	`log_ãxt
(
LOG_FATAL
,

69 
size
);

73 
h
->
cumuœtive_¨øy
 = 
tmp
;

74 
tmp
 +
size
;

76 
h
->
ãmp_¨øy
 = 
tmp
;

77 
tmp
 +
size
;

79 
i
 = 0; i < 
SB_HISTOGRAM_NSLOTS
; i++)

81 
h
->
öãrm_¶Ÿs
[
i
] = 
tmp
;

82 
tmp
 +
size
;

85 
h
->
ønge_dedu˘
 = 
	`log
(
ønge_mö
);

86 
h
->
ønge_mu…
 = (
size
 - 1Ë/ (
	`log
(
ønge_max
Ë- h->
ønge_dedu˘
);

88 
h
->
ønge_mö
 =Ñange_min;

89 
h
->
ønge_max
 =Ñange_max;

91 
h
->
¨øy_size
 = 
size
;

93 
	`±hªad_rwlock_öô
(&
h
->
lock
, 
NULL
);

96 
	}
}

99 
	$sb_hi°ogøm_upd©e
(
sb_hi°ogøm_t
 *
h
, 
vÆue
)

101 
size_t
 
¶Ÿ
;

102 
ssize_t
 
i
;

104 
¶Ÿ
 = 
	`sb_ønd_unif‹m_uöt64
(Ë% 
SB_HISTOGRAM_NSLOTS
;

106 
i
 = 
	`Êo‹
((
	`log
(
vÆue
Ë- 
h
->
ønge_dedu˘
Ë* h->
ønge_mu…
 + 0.5);

107 i‡(
	`SB_UNLIKELY
(
i
 < 0))

108 
i
 = 0;

109 i‡(
	`SB_UNLIKELY
(
i
 >(
ssize_t
Ë(
h
->
¨øy_size
)))

110 
i
 = 
h
->
¨øy_size
 - 1;

112 
	`ck_¥_öc_64
(&
h
->
öãrm_¶Ÿs
[
¶Ÿ
][
i
]);

113 
	}
}

116 
	$sb_hi°ogøm_gë_p˘_öãrmedüã
(
sb_hi°ogøm_t
 *
h
,

117 
≥r˚¡ûe
)

119 
size_t
 
i
, 
s
;

120 
uöt64_t
 
√víts
, 
ncur
, 
nmax
;

121 
ªs
;

123 
√víts
 = 0;

132 
	`±hªad_rwlock_wæock
(&
h
->
lock
);

137 c⁄° 
size_t
 
size
 = 
h
->
¨øy_size
;

138 
uöt64_t
 * c⁄° 
¨øy
 = 
h
->
ãmp_¨øy
;

140 
i
 = 0; i < 
size
; i++)

142 
¨øy
[
i
] = 
	`ck_¥_Ás_64
(&
h
->
öãrm_¶Ÿs
[0][i], 0);

143 
√víts
 +
¨øy
[
i
];

146 
s
 = 1; s < 
SB_HISTOGRAM_NSLOTS
; s++)

148 
i
 = 0; i < 
size
; i++)

150 
uöt64_t
 
t
;

152 
t
 = 
	`ck_¥_Ás_64
(&
h
->
öãrm_¶Ÿs
[
s
][
i
], 0);

154 
¨øy
[
i
] +
t
;

155 
√víts
 +
t
;

164 
nmax
 = 
	`Êo‹
(
√víts
 * 
≥r˚¡ûe
 / 100 + 0.5);

166 
ncur
 = 0;

167 
i
 = 0; i < 
size
; i++)

169 
ncur
 +
¨øy
[
i
];

170 i‡(
ncur
 >
nmax
)

174 
ªs
 = 
	`exp
(
i
 / 
h
->
ønge_mu…
 + h->
ønge_dedu˘
);

177 
i
 = 0; i < 
size
; i++)

179 
h
->
cumuœtive_¨øy
[
i
] +
¨øy
[i];

182 
h
->
cumuœtive_√víts
 +
√víts
;

184 
	`±hªad_rwlock_u∆ock
(&
h
->
lock
);

186  
ªs
;

187 
	}
}

194 
	$mîge_öãrmedüã_öto_cumuœtive
(
sb_hi°ogøm_t
 *
h
)

196 
size_t
 
i
, 
s
;

197 
uöt64_t
 
√víts
;

199 
√víts
 = 
h
->
cumuœtive_√víts
;

201 c⁄° 
size_t
 
size
 = 
h
->
¨øy_size
;

202 
uöt64_t
 * c⁄° 
¨øy
 = 
h
->
cumuœtive_¨øy
;

204 
s
 = 0; s < 
SB_HISTOGRAM_NSLOTS
; s++)

206 
i
 = 0; i < 
size
; i++)

208 
uöt64_t
 
t
 = 
	`ck_¥_Ás_64
(&
h
->
öãrm_¶Ÿs
[
s
][
i
], 0);

209 
¨øy
[
i
] +
t
;

210 
√víts
 +
t
;

214 
h
->
cumuœtive_√víts
 = 
√víts
;

215 
	}
}

222 
	$gë_p˘_cumuœtive
(
sb_hi°ogøm_t
 *
h
, 
≥r˚¡ûe
)

224 
size_t
 
i
;

225 
uöt64_t
 
ncur
, 
nmax
;

227 
nmax
 = 
	`Êo‹
(
h
->
cumuœtive_√víts
 * 
≥r˚¡ûe
 / 100 + 0.5);

229 
ncur
 = 0;

230 
i
 = 0; i < 
h
->
¨øy_size
; i++)

232 
ncur
 +
h
->
cumuœtive_¨øy
[
i
];

233 i‡(
ncur
 >
nmax
)

237  
	`exp
(
i
 / 
h
->
ønge_mu…
 + h->
ønge_dedu˘
);

238 
	}
}

241 
	$sb_hi°ogøm_gë_p˘_cumuœtive
(
sb_hi°ogøm_t
 *
h
, 
≥r˚¡ûe
)

243 
ªs
;

252 
	`±hªad_rwlock_wæock
(&
h
->
lock
);

254 
	`mîge_öãrmedüã_öto_cumuœtive
(
h
);

256 
ªs
 = 
	`gë_p˘_cumuœtive
(
h
, 
≥r˚¡ûe
);

258 
	`±hªad_rwlock_u∆ock
(&
h
->
lock
);

260  
ªs
;

261 
	}
}

264 
	$sb_hi°ogøm_gë_p˘_checkpoöt
(
sb_hi°ogøm_t
 *
h
,

265 
≥r˚¡ûe
)

267 
ªs
;

276 
	`±hªad_rwlock_wæock
(&
h
->
lock
);

278 
	`mîge_öãrmedüã_öto_cumuœtive
(
h
);

280 
ªs
 = 
	`gë_p˘_cumuœtive
(
h
, 
≥r˚¡ûe
);

283 
	`mem£t
(
h
->
cumuœtive_¨øy
, 0, h->
¨øy_size
 * (
uöt64_t
));

284 
h
->
cumuœtive_√víts
 = 0;

286 
	`±hªad_rwlock_u∆ock
(&
h
->
lock
);

288  
ªs
;

289 
	}
}

292 
	$sb_hi°ogøm_¥öt
(
sb_hi°ogøm_t
 *
h
)

294 
uöt64_t
 
max˙t
;

295 
width
;

296 
size_t
 
i
;

298 
	`±hªad_rwlock_wæock
(&
h
->
lock
);

300 
	`mîge_öãrmedüã_öto_cumuœtive
(
h
);

302 
uöt64_t
 * c⁄° 
¨øy
 = 
h
->
cumuœtive_¨øy
;

304 
max˙t
 = 0;

305 
i
 = 0; i < 
h
->
¨øy_size
; i++)

307 i‡(
¨øy
[
i
] > 
max˙t
)

308 
max˙t
 = 
¨øy
[
i
];

311 i‡(
max˙t
 == 0)

314 
	`¥ötf
(" value ------------- distribution ------------- count\n");

316 
i
 = 0; i < 
h
->
¨øy_size
; i++)

318 i‡(
¨øy
[
i
] == 0)

321 
width
 = 
	`Êo‹
(
¨øy
[
i
] * (Ë40 / 
max˙t
 + 0.5);

323 
	`¥ötf
("%12.3f |%-40.*s %lu\n",

324 
	`exp
(
i
 / 
h
->
ønge_mu…
 + h->
ønge_dedu˘
),

325 
width
, "****************************************",

326 (Ë
¨øy
[
i
]);

329 
	`±hªad_rwlock_u∆ock
(&
h
->
lock
);

330 
	}
}

333 
	$sb_hi°ogøm_d⁄e
(
sb_hi°ogøm_t
 *
h
)

335 
	`±hªad_rwlock_de°roy
(&
h
->
lock
);

337 
	`‰ì
(
h
->
cumuœtive_¨øy
);

338 
	`‰ì
(
h
->
öãrm_¶Ÿs
);

339 
	}
}

345 
sb_hi°ogøm_t
 *
	$sb_hi°ogøm_√w
(
size_t
 
size
, 
ønge_mö
,

346 
ønge_max
)

348 
sb_hi°ogøm_t
 *
h
;

350 i‡((
h
 = 
	`mÆloc
((*h))Ë=
NULL
)

351  
NULL
;

353 i‡(
	`sb_hi°ogøm_öô
(
h
, 
size
, 
ønge_mö
, 
ønge_max
))

355 
	`‰ì
(
h
);

356  
NULL
;

359  
h
;

360 
	}
}

366 
	$sb_hi°ogøm_dñëe
(
sb_hi°ogøm_t
 *
h
)

368 
	`sb_hi°ogøm_d⁄e
(
h
);

369 
	`‰ì
(
h
);

370 
	}
}

	@sb_histogram.h

18 #i‚de‡
SB_HISTOGRAM_H


19 
	#SB_HISTOGRAM_H


	)

21 
	~<°döt.h
>

23 #ifde‡
HAVE_PTHREAD_H


24 
	~<±hªad.h
>

32 
uöt64_t
 *
	mcumuœtive_¨øy
;

37 
uöt64_t
 
	mcumuœtive_√víts
;

42 
uöt64_t
 *
	mãmp_¨øy
;

48 
uöt64_t
 **
	möãrm_¶Ÿs
;

50 
size_t
 
	m¨øy_size
;

52 
	mønge_mö
;

54 
	mønge_max
;

56 
	mønge_dedu˘
;

58 
	mønge_mu…
;

63 
±hªad_rwlock_t
 
	mlock
;

64 } 
	tsb_hi°ogøm_t
;

67 
sb_hi°ogøm_t
 
sb_œãncy_hi°ogøm
;

72 
sb_hi°ogøm_t
 *
sb_hi°ogøm_√w
(
size_t
 
size
, 
ønge_mö
,

73 
ønge_max
);

78 
sb_hi°ogøm_dñëe
(
sb_hi°ogøm_t
 *
h
);

83 
sb_hi°ogøm_öô
(
sb_hi°ogøm_t
 *
h
, 
size_t
 
size
,

84 
ønge_mö
, 
ønge_max
);

87 
sb_hi°ogøm_upd©e
(
sb_hi°ogøm_t
 *
h
, 
vÆue
);

95 
sb_hi°ogøm_gë_p˘_öãrmedüã
(
sb_hi°ogøm_t
 *
h
, 
≥r˚¡ûe
);

101 
sb_hi°ogøm_gë_p˘_cumuœtive
(
sb_hi°ogøm_t
 *
h
, 
≥r˚¡ûe
);

109 
sb_hi°ogøm_gë_p˘_checkpoöt
(
sb_hi°ogøm_t
 *
h
, 
≥r˚¡ûe
);

114 
sb_hi°ogøm_¥öt
(
sb_hi°ogøm_t
 *
h
);

117 
sb_hi°ogøm_d⁄e
(
sb_hi°ogøm_t
 *
h
);

	@sb_list.h

19 #i‚de‡
SB_LIST_H


21 
	#SB_LIST_H


	)

23 
	ssb_li°_ôem_t


25 
sb_li°_ôem_t
 *
	m√xt_p
;

26 
sb_li°_ôem_t
 *
	m¥ev_p
;

28 
	tsb_li°_ôem_t
;

30 
sb_li°_ôem_t
 
	tsb_li°_ôem
;

31 
sb_li°_ôem_t
 
	tsb_li°_t
 ;

33 #i‚de‡
off£tof


34 
	#off£tof
(
ty≥
, 
membî
Ë((
size_t
Ë&(—y≥ *)0)->membî)

	)

37 
	#SB_LIST_DECLARE
(
«me
) \

38 
SB_LIST_T
 
«me
 = { &“ame), &“ameË}

	)

40 
	#SB_LIST_INIT
(
hód_p
) \

42 (
hód_p
)->
√xt_p
 = (head_p); \

43 (
hód_p
)->
¥ev_p
 = (head_p); \

44 } 0)

	)

46 
	#SB_LIST_ITEM_INIT
(
ôem_p
) \

47 
	`SB_LIST_INIT
(
ôem_p
)

	)

49 
	#SB_LIST_ADD
(
ôem_p
, 
hód_p
) \

51 (
ôem_p
)->
√xt_p
 = (
hód_p
)->next_p; \

52 (
ôem_p
)->
¥ev_p
 = (
hód_p
); \

53 (
hód_p
)->
√xt_p
 = (
ôem_p
); \

54 (
ôem_p
)->
√xt_p
->
¥ev_p
 = (item_p); \

55 } 0)

	)

57 
	#SB_LIST_ADD_TAIL
(
ôem_p
, 
hód_p
) \

59 (
ôem_p
)->
¥ev_p
 = (
hód_p
)->prev_p; \

60 (
ôem_p
)->
√xt_p
 = (
hód_p
); \

61 (
hód_p
)->
¥ev_p
 = (
ôem_p
); \

62 (
ôem_p
)->
¥ev_p
->
√xt_p
 = (item_p); \

63 } 0);

	)

65 
	#SB_LIST_DELETE
(
ﬁd_ôem_p
) \

67 (
ﬁd_ôem_p
)->
√xt_p
->
¥ev_p
 = (old_item_p)->prev_p; \

68 (
ﬁd_ôem_p
)->
¥ev_p
->
√xt_p
 = (old_item_p)->next_p; \

69 } 0)

	)

71 
	#SB_LIST_REPLACE
(
ôem_p
, 
ﬁd_ôem_p
) \

73 (
ôem_p
)->
√xt_p
 = (
ﬁd_ôem_p
)->next_p; \

74 (
ôem_p
)->
¥ev_p
 = (
ﬁd_ôem_p
)->prev_p; \

75 (
ôem_p
)->
√xt_p
->
¥ev_p
 = (item_p); \

76 (
ôem_p
)->
¥ev_p
->
√xt_p
 = (item_p); \

77 } 0)

	)

79 
	#SB_LIST_IS_EMPTY
(
hód_p
) \

80 ((
hód_p
)->
√xt_p
 =(hód_p))

	)

82 
	#SB_LIST_ITEM_IN_LIST
(
ôem_p
) \

83 ((
ôem_p
)->
√xt_p
 !(ôem_p))

	)

85 
	#SB_LIST_ITEM_FIRST
(
ôem_p
, 
hód_p
) \

86 ((
ôem_p
)->
¥ev_p
 !(
hód_p
))

	)

88 
	#SB_LIST_ITEM_LAST
(
ôem_p
, 
hód_p
) \

89 ((
ôem_p
)->
√xt_p
 =(
hód_p
))

	)

91 
	#SB_LIST_ITEM_NEXT
(
ôem_p
) \

92 ((
ôem_p
)->
√xt_p
)

	)

94 
	#SB_LIST_ITEM_PREV
(
ôem_p
) \

95 ((
ôem_p
)->
¥ev_p
)

	)

97 
	#SB_LIST_ENTRY
(
±r
, 
ty≥
, 
membî
) \

98 ((
ty≥
 *)(*)(((*)(
±r
Ë- 
	`off£tof
—y≥, 
membî
))))

	)

100 
	#SB_LIST_ONCE
(
pos_p
, 
hód_p
) \

101 
pos_p
(
hód_p
)->
√xt_p
; i‡’os_∞!(hód_p))

	)

103 
	#SB_LIST_FOR_EACH
(
pos_p
, 
hód_p
) \

104 
pos_p
 = (
hód_p
)->
√xt_p
;Öos_∞!(hód_p);Öos_∞pos_p->√xt_p)

	)

106 
	#SB_LIST_ENUM_START
(
hód_p
) \

107 (
hód_p
)

	)

109 
	#SB_LIST_ENUM_NEXT
(
pos_p
, 
hód_p
) \

110 ((
pos_p
->
√xt_p
 !(
hód_p
)Ë? (pos_p->√xt_pË: 
NULL
)

	)

112 
	#SB_LIST_FOR_EACH_SAFE
(
pos_p
, 
ãmp_p
, 
hód_p
) \

113 
pos_p
 = (
hód_p
)->
√xt_p
, 
ãmp_p
 = (pos_p)->next_p;Öos_p != (head_p); \

114 
pos_p
 = 
ãmp_p
,Åemp_∞’os_p)->
√xt_p
)

	)

116 
	#SB_LIST_FOR_EACH_REV_SAFE
(
pos_p
, 
ãmp_p
, 
hód_p
) \

117 
pos_p
 = (
hód_p
)->
¥ev_p
, 
ãmp_p
 = (pos_p)->prev_p;Öos_p != (head_p); \

118 
pos_p
 = 
ãmp_p
,Åemp_∞’os_p)->
¥ev_p
)

	)

	@sb_logger.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
STDC_HEADERS


24 
	~<°dio.h
>

25 
	~<°d¨g.h
>

26 
	~<°rög.h
>

28 #ifde‡
HAVE_ERRNO_H


29 
	~<î∫o.h
>

31 #ifde‡
HAVE_MATH_H


32 
	~<m©h.h
>

35 
	~"sysbích.h
"

36 
	~"sb_li°.h
"

37 
	~"sb_loggî.h
"

38 
	~"sb_hi°ogøm.h
"

40 
	~"ck_cc.h
"

42 
	#TEXT_BUFFER_SIZE
 4096

	)

43 
	#ERROR_BUFFER_SIZE
 256

	)

49 
	#OPER_LOG_GRANULARITY
 1024

	)

50 
	#OPER_LOG_MIN_VALUE
 1e-3

	)

51 
	#OPER_LOG_MAX_VALUE
 1E5

	)

55 
sb_li°_t
 
	gh™dÀrs
[
LOG_MSG_TYPE_MAX
];

58 
	göôülized
;

60 
±hªad_muãx_t
 
	gãxt_muãx
;

61 
	gãxt_˙t
;

62 
	gãxt_buf
[
TEXT_BUFFER_SIZE
];

65 
ãxt_h™dÀr_öô
();

66 
ãxt_h™dÀr_¥o˚ss
(
log_msg_t
 *
msg
);

68 
›î_h™dÀr_öô
();

69 
›î_h™dÀr_d⁄e
();

75 
sb_¨g_t
 
	gãxt_h™dÀr_¨gs
[] =

77 
SB_OPT
("verbosity", "verbosityÜevel {5 - debug, 0 - only critical messages}",

78 "3", 
INT
),

80 
SB_OPT_END


83 
log_h™dÀr_t
 
	gãxt_h™dÀr
 = {

85 &
ãxt_h™dÀr_öô
,

86 &
ãxt_h™dÀr_¥o˚ss
,

87 
NULL
,

89 
ãxt_h™dÀr_¨gs
,

95 
sb_¨g_t
 
	g›î_h™dÀr_¨gs
[] =

97 
SB_OPT
("percentile", "percentileÅo calculate inÜatency statistics (1-100). "

99 "95", 
INT
),

100 
SB_OPT
("hi°ogøm", "¥öàœãncy hi°ogøm i¿ªp‹t", "off", 
BOOL
),

102 
SB_OPT_END


105 
log_h™dÀr_t
 
	g›î_h™dÀr
 = {

107 
›î_h™dÀr_öô
,

108 
NULL
,

109 
›î_h™dÀr_d⁄e
,

111 
›î_h™dÀr_¨gs
,

119 
	$log_ªgi°î
()

121 
i
;

123 
i
 = 0; i < 
LOG_MSG_TYPE_MAX
; i++)

124 
	`SB_LIST_INIT
(
h™dÀrs
 + 
i
);

126 
	`log_add_h™dÀr
(
LOG_MSG_TYPE_TEXT
, &
ãxt_h™dÀr
);

127 
	`log_add_h™dÀr
(
LOG_MSG_TYPE_OPER
, &
›î_h™dÀr
);

130 
	}
}

136 
	$log_¥öt_hñp
()

138 
i
;

139 
sb_li°_ôem_t
 *
pos
;

140 
log_h™dÀr_t
 *
h™dÀr
;

142 
	`¥ötf
("Log options:\n");

144 
i
 = 0; i < 
LOG_MSG_TYPE_MAX
; i++)

146 
	`SB_LIST_FOR_EACH
(
pos
, 
h™dÀrs
 + 
i
)

148 
h™dÀr
 = 
	`SB_LIST_ENTRY
(
pos
, 
log_h™dÀr_t
, 
li°ôem
);

149 i‡(
h™dÀr
->
¨gs
 !
NULL
)

150 
	`sb_¥öt_›ti⁄s
(
h™dÀr
->
¨gs
);

153 
	}
}

159 
	$log_öô
()

161 
i
;

162 
sb_li°_ôem_t
 *
pos
;

163 
log_h™dÀr_t
 *
h™dÀr
;

165 
i
 = 0; i < 
LOG_MSG_TYPE_MAX
; i++)

167 
	`SB_LIST_FOR_EACH
(
pos
, 
h™dÀrs
 + 
i
)

169 
h™dÀr
 = 
	`SB_LIST_ENTRY
(
pos
, 
log_h™dÀr_t
, 
li°ôem
);

170 i‡(
h™dÀr
->
›s
.
öô
 !
NULL
 && h™dÀr->›s.
	`öô
())

176 
öôülized
 = 1;

179 
	}
}

185 
	$log_d⁄e
()

187 
i
;

188 
sb_li°_ôem_t
 *
pos
;

189 
log_h™dÀr_t
 *
h™dÀr
;

191 
i
 = 0; i < 
LOG_MSG_TYPE_MAX
; i++)

193 
	`SB_LIST_FOR_EACH
(
pos
, 
h™dÀrs
 + 
i
)

195 
h™dÀr
 = 
	`SB_LIST_ENTRY
(
pos
, 
log_h™dÀr_t
, 
li°ôem
);

196 i‡(
h™dÀr
->
›s
.
d⁄e
 !
NULL
)

197 
h™dÀr
->
›s
.
	`d⁄e
();

201 
öôülized
 = 0;

202 
	}
}

208 
	$log_add_h™dÀr
(
log_msg_ty≥_t
 
ty≥
, 
log_h™dÀr_t
 *
h™dÀr
)

210 i‡(
ty≥
 <
LOG_MSG_TYPE_MIN
 ||Åy≥ >
LOG_MSG_TYPE_MAX
)

213 i‡(
h™dÀr
->
¨gs
 !
NULL
)

214 
	`sb_ªgi°î_¨g_£t
(
h™dÀr
->
¨gs
);

216 
	`SB_LIST_ADD_TAIL
(&
h™dÀr
->
li°ôem
, 
h™dÀrs
 + 
ty≥
);

219 
	}
}

225 
	$log_msg
(
log_msg_t
 *
msg
)

227 
sb_li°_ôem_t
 *
pos
;

228 
log_h™dÀr_t
 *
h™dÀr
;

230 
	`SB_LIST_FOR_EACH
(
pos
, 
h™dÀrs
 + 
msg
->
ty≥
)

232 
h™dÀr
 = 
	`SB_LIST_ENTRY
(
pos
, 
log_h™dÀr_t
, 
li°ôem
);

233 i‡(
h™dÀr
->
›s
.
¥o˚ss
 !
NULL
)

234 
h™dÀr
->
›s
.
	`¥o˚ss
(
msg
);

236 
	}
}

238 c⁄° *
	$gë_msg_¥efix
(
log_msg_¥i‹ôy_t
 
¥i‹ôy
)

240 c⁄° * 
¥efix
;

242 
¥i‹ôy
) {

243 
LOG_FATAL
:

244 
¥efix
 = "FATAL: ";

246 
LOG_ALERT
:

247 
¥efix
 = "ALERT: ";

249 
LOG_WARNING
:

250 
¥efix
 = "WARNING: ";

252 
LOG_DEBUG
:

253 
¥efix
 = "DEBUG: ";

256 
¥efix
 = "";

260  
¥efix
;

261 
	}
}

266 
	$log_ãxt
(
log_msg_¥i‹ôy_t
 
¥i‹ôy
, c⁄° *
fmt
, ...)

268 
log_msg_t
 
msg
;

269 
log_msg_ãxt_t
 
ãxt_msg
;

270 
buf
[
TEXT_BUFFER_SIZE
];

271 
va_li°
 
≠
;

272 
n
, 
˛í
, 
maxÀn
;

274 
maxÀn
 = 
TEXT_BUFFER_SIZE
;

275 
˛í
 = 0;

277 
	`va_°¨t
(
≠
, 
fmt
);

278 
n
 = 
	`v¢¥ötf
(
buf
 + 
˛í
, 
maxÀn
, 
fmt
, 
≠
);

279 
	`va_íd
(
≠
);

280 i‡(
n
 < 0 ||Ç >
maxÀn
)

281 
n
 = 
maxÀn
;

282 
˛í
 +
n
;

283 
maxÀn
 -
n
;

284 
	`¢¥ötf
(
buf
 + 
˛í
, 
maxÀn
, "\n");

290 i‡(!
öôülized
)

292 
	`¥ötf
("%s%s", 
	`gë_msg_¥efix
(
¥i‹ôy
), 
buf
);

297 
msg
.
ty≥
 = 
LOG_MSG_TYPE_TEXT
;

298 
msg
.
d©a
 = (*)&
ãxt_msg
;

299 
ãxt_msg
.
¥i‹ôy
 =Öriority;

300 
ãxt_msg
.
ãxt
 = 
buf
;

301 
ãxt_msg
.
Êags
 = 0;

303 
	`log_msg
(&
msg
);

304 
	}
}

313 
	$log_time°amp
(
log_msg_¥i‹ôy_t
 
¥i‹ôy
, 
£c⁄ds
,

314 c⁄° *
fmt
, ...)

316 
log_msg_t
 
msg
;

317 
log_msg_ãxt_t
 
ãxt_msg
;

318 
buf
[
TEXT_BUFFER_SIZE
];

319 
va_li°
 
≠
;

320 
n
, 
˛í
, 
maxÀn
;

322 
maxÀn
 = 
TEXT_BUFFER_SIZE
;

323 
˛í
 = 0;

325 
n
 = 
	`¢¥ötf
(
buf
, 
maxÀn
, "[ %.0f†] ", 
£c⁄ds
);

326 
˛í
 +
n
;

327 
maxÀn
 -
n
;

329 
	`va_°¨t
(
≠
, 
fmt
);

330 
n
 = 
	`v¢¥ötf
(
buf
 + 
˛í
, 
maxÀn
, 
fmt
, 
≠
);

331 
	`va_íd
(
≠
);

332 i‡(
n
 < 0 ||Ç >
maxÀn
)

333 
n
 = 
maxÀn
;

334 
˛í
 +
n
;

335 
maxÀn
 -
n
;

336 
	`¢¥ötf
(
buf
 + 
˛í
, 
maxÀn
, "\n");

342 i‡(!
öôülized
)

344 
	`¥ötf
("%s%s", 
	`gë_msg_¥efix
(
¥i‹ôy
), 
buf
);

349 
msg
.
ty≥
 = 
LOG_MSG_TYPE_TEXT
;

350 
msg
.
d©a
 = (*)&
ãxt_msg
;

351 
ãxt_msg
.
¥i‹ôy
 =Öriority;

352 
ãxt_msg
.
ãxt
 = 
buf
;

354 
ãxt_msg
.
Êags
 = 
LOG_MSG_TEXT_ALLOW_DUPLICATES
;

356 
	`log_msg
(&
msg
);

357 
	}
}

363 
	$log_î∫o
(
log_msg_¥i‹ôy_t
 
¥i‹ôy
, c⁄° *
fmt
, ...)

365 
buf
[
TEXT_BUFFER_SIZE
];

366 
îrbuf
[
ERROR_BUFFER_SIZE
];

367 
va_li°
 
≠
;

368 
n
;

369 
ﬁd_î∫o
;

370 *
tmp
;

372 
ﬁd_î∫o
 = 
î∫o
;

373 #ifde‡
HAVE_STRERROR_R


374 #ifde‡
STRERROR_R_CHAR_P


375 
tmp
 = 
	`°ªº‹_r
(
ﬁd_î∫o
, 
îrbuf
, (errbuf));

377 
	`°ªº‹_r
(
ﬁd_î∫o
, 
îrbuf
, (errbuf));

378 
tmp
 = 
îrbuf
;

381 
	`°∫˝y
(
îrbuf
, 
	`°ªº‹
(
ﬁd_î∫o
), (errbuf));

382 
tmp
 = 
îrbuf
;

385 
	`va_°¨t
(
≠
, 
fmt
);

386 
n
 = 
	`v¢¥ötf
(
buf
, 
TEXT_BUFFER_SIZE
, 
fmt
, 
≠
);

387 
	`va_íd
(
≠
);

388 i‡(
n
 < 0 ||Ç =
TEXT_BUFFER_SIZE
)

390 
	`¢¥ötf
(
buf
 + 
n
, 
TEXT_BUFFER_SIZE
 -Ç, "Éºnÿ%d (%s)", 
ﬁd_î∫o
,

391 
tmp
);

393 
	`log_ãxt
(
¥i‹ôy
, "%s", 
buf
);

394 
	}
}

401 
	$ãxt_h™dÀr_öô
()

403 #ifde‡
HAVE_SETVBUF


405 
	`£tvbuf
(
°dout
, 
NULL
, 
_IONBF
, 0);

408 
sb_globÆs
.
vîbosôy
 = 
	`sb_gë_vÆue_öt
("verbosity");

410 i‡(
sb_globÆs
.
vîbosôy
 > 
LOG_DEBUG
)

412 
	`¥ötf
("InvÆid vÆuêf‹ vîbosôy: %d\n", 
sb_globÆs
.
vîbosôy
);

416 
	`±hªad_muãx_öô
(&
ãxt_muãx
, 
NULL
);

417 
ãxt_˙t
 = 0;

418 
ãxt_buf
[0] = '\0';

421 
	}
}

427 
	$ãxt_h™dÀr_¥o˚ss
(
log_msg_t
 *
msg
)

429 
log_msg_ãxt_t
 *
ãxt_msg
 = (log_msg_ãxt_à*)
msg
->
d©a
;

431 i‡(
ãxt_msg
->
¥i‹ôy
 > 
sb_globÆs
.
vîbosôy
)

434 i‡(!(
ãxt_msg
->
Êags
 & 
LOG_MSG_TEXT_ALLOW_DUPLICATES
))

436 
	`±hªad_muãx_lock
(&
ãxt_muãx
);

437 i‡(!
	`°rcmp
(
ãxt_buf
, 
ãxt_msg
->
ãxt
))

439 
ãxt_˙t
++;

440 
	`±hªad_muãx_u∆ock
(&
ãxt_muãx
);

446 i‡(
ãxt_˙t
 > 0)

447 
	`¥ötf
("÷a° mesßgêª≥©ed %uÅimes)\n", 
ãxt_˙t
);

449 
ãxt_˙t
 = 0;

450 
	`°∫˝y
(
ãxt_buf
, 
ãxt_msg
->
ãxt
, 
TEXT_BUFFER_SIZE
);

452 
	`±hªad_muãx_u∆ock
(&
ãxt_muãx
);

455 
	`¥ötf
("%s%s", 
	`gë_msg_¥efix
(
ãxt_msg
->
¥i‹ôy
),Åext_msg->
ãxt
);

458 
	}
}

464 
	$›î_h™dÀr_öô
()

466 
tmp
;

468 
tmp
 = 
	`sb_gë_vÆue_öt
("percentile");

469 i‡(
tmp
 < 0 ||Åmp > 100)

471 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for --percentile: %d",

472 
tmp
);

475 
sb_globÆs
.
≥r˚¡ûe
 = 
tmp
;

477 
sb_globÆs
.
hi°ogøm
 = 
	`sb_gë_vÆue_Êag
("histogram");

478 i‡(
sb_globÆs
.
≥r˚¡ûe
 =0 && sb_globÆs.
hi°ogøm
 != 0)

480 
	`log_ãxt
(
LOG_FATAL
, "--histogram cannot be used with --percentile=0");

484 i‡(
	`sb_hi°ogøm_öô
(&
sb_œãncy_hi°ogøm
, 
OPER_LOG_GRANULARITY
,

485 
OPER_LOG_MIN_VALUE
, 
OPER_LOG_MAX_VALUE
))

489 
	}
}

494 
	$›î_h™dÀr_d⁄e
()

496 
	`sb_hi°ogøm_d⁄e
(&
sb_œãncy_hi°ogøm
);

499 
	}
}

	@sb_logger.h

19 #i‚de‡
SB_LOGGER_H


20 
	#SB_LOGGER_H


	)

22 #ifde‡
HAVE_CONFIG_H


23 
	~"c⁄fig.h
"

26 #ifde‡
HAVE_PTHREAD_H


27 
	~<±hªad.h
>

30 
	~"sb_utû.h
"

31 
	~"sb_›ti⁄s.h
"

32 
	~"sb_timî.h
"

33 
	~"sb_hi°ogøm.h
"

37 
	#LOG_MSG_TEXT_ALLOW_DUPLICATES
 1

	)

42 
	mLOG_MSG_TYPE_MIN
,

43 
	mLOG_MSG_TYPE_TEXT
,

44 
	mLOG_MSG_TYPE_OPER
,

45 
	mLOG_MSG_TYPE_MAX


46 } 
	tlog_msg_ty≥_t
;

51 
	mLOG_FATAL
,

52 
	mLOG_ALERT
,

53 
	mLOG_WARNING
,

54 
	mLOG_NOTICE
,

55 
	mLOG_INFO
,

56 
	mLOG_DEBUG
,

57 
	mLOG_MAX


58 } 
	tlog_msg_¥i‹ôy_t
;

63 
log_msg_¥i‹ôy_t
 
	m¥i‹ôy
;

64 *
	mãxt
;

65 
	mÊags
;

66 } 
	tlog_msg_ãxt_t
;

71 
	mLOG_MSG_OPER_START
,

72 
	mLOG_MSG_OPER_STOP


73 } 
	tlog_msg_›î_a˘i⁄_t
;

76 
log_msg_›î_a˘i⁄_t
 
	ma˘i⁄
;

77 
	mthªad_id
;

78 } 
	tlog_msg_›î_t
;

83 
log_msg_ty≥_t
 
	mty≥
;

84 *
	md©a
;

85 } 
	tlog_msg_t
;

89 
	tlog_›_ªgi°î
();

90 
	tlog_›_öô
();

91 
	tlog_›_¥o˚ss
(
	tlog_msg_t
 *
	tmsg
);

92 
	tlog_›_d⁄e
();

97 
log_›_öô
 *
	möô
;

98 
log_›_¥o˚ss
 *
	m¥o˚ss
;

99 
log_›_d⁄e
 *
	md⁄e
;

100 } 
	tlog_h™dÀr_›s_t
;

105 
log_h™dÀr_›s_t
 
	m›s
;

106 
sb_¨g_t
 *
	m¨gs
;

107 
sb_li°_ôem_t
 
	mli°ôem
;

108 } 
	tlog_h™dÀr_t
;

112 
log_ªgi°î
();

116 
log_¥öt_hñp
();

120 
log_öô
();

124 
log_add_h™dÀr
(
log_msg_ty≥_t
 
ty≥
, 
log_h™dÀr_t
 *
h™dÀr
);

128 
log_msg
(
log_msg_t
 *);

132 
	$log_ãxt
(
log_msg_¥i‹ôy_t
 
¥i‹ôy
, c⁄° *
fmt
, ...)

133 
	`SB_ATTRIBUTE_FORMAT
(
¥ötf
, 2, 3);

140 
	$log_time°amp
(
log_msg_¥i‹ôy_t
 
¥i‹ôy
, 
£c⁄ds
,

141 c⁄° *
fmt
, ...)

142 
	`SB_ATTRIBUTE_FORMAT
(
¥ötf
, 3, 4);

146 
	$log_î∫o
(
log_msg_¥i‹ôy_t
 
¥i‹ôy
, c⁄° *
fmt
, ...)

147 
	`SB_ATTRIBUTE_FORMAT
(
¥ötf
, 2, 3);

151 
	`log_d⁄e
();

	@sb_lua.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
HAVE_LIBGEN_H


24 
	~<libgí.h
>

27 
	~"sb_lua.h
"

28 
	~"lua.h
"

29 
	~"luÆib.h
"

30 
	~"œuxlib.h
"

32 
	#SB_LUA_EXPORT


	)

33 
	~"sb_cou¡î.h
"

34 #unde‡
SB_LUA_EXPORT


36 
	~"db_drivî.h
"

37 
	~"sb_ønd.h
"

38 
	~"sb_thªad.h
"

40 
	~"sb_ck_¥.h
"

46 
	~"lua/öã∫Æ/sysbích.lua.h
"

47 
	~"lua/öã∫Æ/sysbích.cmdlöe.lua.h
"

48 
	~"lua/öã∫Æ/sysbích.ønd.lua.h
"

49 
	~"lua/öã∫Æ/sysbích.sql.lua.h
"

50 
	~"lua/öã∫Æ/sysbích.hi°ogøm.lua.h
"

52 
	#EVENT_FUNC
 "evít"

	)

53 
	#PREPARE_FUNC
 "¥ï¨e"

	)

54 
	#CLEANUP_FUNC
 "˛ónup"

	)

55 
	#HELP_FUNC
 "hñp"

	)

56 
	#THREAD_INIT_FUNC
 "thªad_öô"

	)

57 
	#THREAD_DONE_FUNC
 "thªad_d⁄e"

	)

58 
	#THREAD_RUN_FUNC
 "thªad_run"

	)

59 
	#INIT_FUNC
 "öô"

	)

60 
	#DONE_FUNC
 "d⁄e"

	)

61 
	#REPORT_INTERMEDIATE_HOOK
 "ªp‹t_öãrmedüã"

	)

62 
	#REPORT_CUMULATIVE_HOOK
 "ªp‹t_cumuœtive"

	)

64 
	#x‰ì
(
±r
Ë({ i‡(’åË!
NULL
Ë
	`‰ì
((*Ë±r);Öå = NULL; })

	)

69 
db_c⁄n_t
 *
	mc⁄
;

70 
db_drivî_t
 *
	mdrivî
;

71 
lua_Sèã
 *
	mL
;

72 } 
	tsb_lua_˘xt_t
;

75 
	mid
;

76 
db_böd_ty≥_t
 
	mty≥
;

77 *
	mbuf
;

78 
	mbuÊí
;

79 
	mis_nuŒ
;

80 } 
	tsb_lua_böd_t
;

83 c⁄° *
	m«me
;

84 c⁄° *
	msour˚
;

86 
size_t
 *
	msour˚_Àn
;

87 } 
	töã∫Æ_s¸ùt_t
;

90 
	mSB_LUA_ERROR_NONE
,

91 
	mSB_LUA_ERROR_RESTART_EVENT


92 } 
	tsb_lua_îr‹_t
;

94 
boﬁ
 
sb_lua_m‹e_evíts
();

95 
sb_lua_£t_ã°_¨gs
(
sb_¨g_t
 *, 
size_t
);

99 
lua_Sèã
 **
°©es
 
	gCK_CC_CACHELINE
;

101 
sb_ã°_t
 
sbã°
 
	gCK_CC_CACHELINE
;

103 
TLS
 
sb_lua_˘xt_t
 
és_lua_˘xt
 
	gCK_CC_CACHELINE
;

106 
öã∫Æ_s¸ùt_t
 
	göã∫Æ_s¸ùts
[] = {

107 {"sysbích.ønd.lua", 
sysbích_ønd_lua
, &
sysbích_ønd_lua_Àn
},

108 {"sysbích.lua", 
sysbích_lua
, &
sysbích_lua_Àn
},

109 {"sysbích.cmdlöe.lua", 
sysbích_cmdlöe_lua
, &
sysbích_cmdlöe_lua_Àn
},

110 {"sysbích.sql.lua", 
sysbích_sql_lua
, &
sysbích_sql_lua_Àn
},

111 {"sysbích.hi°ogøm.lua", 
sysbích_hi°ogøm_lua
,

112 &
sysbích_hi°ogøm_lua_Àn
},

113 {
NULL
, NULL, 0}

117 
lua_Sèã
 *
	gg°©e
;

120 c⁄° * 
	gsb_lua_cu°om_comm™d
;

124 
sb_lua_›_öô
();

125 
sb_lua_›_d⁄e
();

126 
sb_lua_›_thªad_öô
();

127 
sb_lua_›_thªad_run
();

128 
sb_lua_›_thªad_d⁄e
();

130 
sb_›î©i⁄s_t
 
	glua_›s
 = {

131 .
öô
 = 
sb_lua_›_öô
,

132 .
	gthªad_öô
 = 
sb_lua_›_thªad_öô
,

133 .
	gthªad_d⁄e
 = 
sb_lua_›_thªad_d⁄e
,

134 .
	gªp‹t_öãrmedüã
 = 
db_ªp‹t_öãrmedüã
,

135 .
	gªp‹t_cumuœtive
 = 
db_ªp‹t_cumuœtive
,

136 .
	gd⁄e
 = 
sb_lua_›_d⁄e


140 
sb_lua_cmd_¥ï¨e
();

141 
sb_lua_cmd_˛ónup
();

142 
sb_lua_cmd_hñp
();

145 
lua_Sèã
 *
sb_lua_√w_°©e
();

148 
sb_lua_˛o£_°©e
(
lua_Sèã
 *);

150 
ªad_cmdlöe_›ti⁄s
(
lua_Sèã
 *
L
);

151 
boﬁ
 
sb_lua_hook_deföed
(
lua_Sèã
 *, const *);

152 
boﬁ
 
sb_lua_hook_push
(
lua_Sèã
 *, const *);

153 
sb_lua_ªp‹t_öãrmedüã
(
sb_°©_t
 *);

154 
sb_lua_ªp‹t_cumuœtive
(
sb_°©_t
 *);

156 
sb_lua_do_jôcmd
(
lua_Sèã
 *
L
, c⁄° *
cmd
);

158 
	$ˇŒ_îr‹
(
lua_Sèã
 *
L
, c⁄° *
«me
)

160 c⁄° * c⁄° 
îr
 = 
	`lua_to°rög
(
L
, -1);

161 
	`log_ãxt
(
LOG_FATAL
, "`%s' fun˘i⁄ faûed: %s", 
«me
,

162 
îr
 ?Érr : "(notá string)");

163 
	`lua_p›
(
L
, 1);

164 
	}
}

166 
	$ªp‹t_îr‹
(
lua_Sèã
 *
L
)

168 c⁄° * c⁄° 
îr
 = 
	`lua_to°rög
(
L
, -1);

169 
	`log_ãxt
(
LOG_FATAL
, "%s", 
îr
 ?Érr : "(notá string)");

170 
	`lua_p›
(
L
, 1);

171 
	}
}

173 
boﬁ
 
	$func_avaûabÀ
(
lua_Sèã
 *
L
, c⁄° *
func
)

175 
	`lua_gëglobÆ
(
L
, 
func
);

176 
boﬁ
 
rc
 = 
	`lua_isfun˘i⁄
(
L
, -1);

177 
	`lua_p›
(
L
, 1);

179  
rc
;

180 
	}
}

184 
	$do_exp‹t_›ti⁄s
(
lua_Sèã
 *
L
, 
boﬁ
 
globÆ
)

186 
sb_li°_ôem_t
 *
pos
;

187 
›ti⁄_t
 *
›t
;

188 *
tmp
;

190 i‡(!
globÆ
)

192 
	`lua_gëglobÆ
(
L
, "sysbench");

193 
	`lua_pushlôîÆ
(
L
, "opt");

194 
	`lua_√wèbÀ
(
L
);

197 
pos
 = 
	`sb_›ti⁄s_íum_°¨t
();

198 (
pos
 = 
	`sb_›ti⁄s_íum_√xt
’os, &
›t
)Ë!
NULL
)

206 i‡(
globÆ
)

208 
	`lua_gëglobÆ
(
L
, 
›t
->
«me
);

209 i‡(
	`lua_isfun˘i⁄
(
L
, -1))

211 
	`lua_p›
(
L
, 1);

214 
	`lua_p›
(
L
, 1);

218 
	`lua_push°rög
(
L
, 
›t
->
«me
);

221 
›t
->
ty≥
)

223 
SB_ARG_TYPE_BOOL
:

224 
	`lua_pushboﬁón
(
L
, 
	`sb_›t_to_Êag
(
›t
));

226 
SB_ARG_TYPE_INT
:

227 
	`lua_pushnumbî
(
L
, 
	`sb_›t_to_öt
(
›t
));

229 
SB_ARG_TYPE_DOUBLE
:

230 
	`lua_pushnumbî
(
L
, 
	`sb_›t_to_doubÀ
(
›t
));

232 
SB_ARG_TYPE_SIZE
:

233 
	`lua_pushnumbî
(
L
, 
	`sb_›t_to_size
(
›t
));

235 
SB_ARG_TYPE_STRING
:

236 
tmp
 = 
	`sb_›t_to_°rög
(
›t
);

237 
	`lua_push°rög
(
L
, 
tmp
 ?Åmp : "");

239 
SB_ARG_TYPE_LIST
:

240 
	`lua_√wèbÀ
(
L
);

242 
sb_li°_ôem_t
 *
vÆ
;

243 
cou¡
 = 1;

245 
	`SB_LIST_FOR_EACH
(
vÆ
, 
	`sb_›t_to_li°
(
›t
))

247 
	`lua_push°rög
(
L
, 
	`SB_LIST_ENTRY
(
vÆ
, 
vÆue_t
, 
li°ôem
)->
d©a
);

248 
	`lua_øw£ti
(
L
, -2, 
cou¡
++);

252 
SB_ARG_TYPE_FILE
:

254 
	`lua_pushnû
(
L
);

257 
	`log_ãxt
(
LOG_WARNING
, "Global option '%s' willÇot beÉxported, because"

258 "Åhêty≥ i†unknown", 
›t
->
«me
);

259 
	`lua_pushnû
(
L
);

264 i‡(
globÆ
)

265 
	`lua_£tglobÆ
(
L
, 
›t
->
«me
);

267 
	`lua_£âabÀ
(
L
, -3);

270 i‡(!
globÆ
)

271 
	`lua_£âabÀ
(
L
, -3);

274 
	}
}

280 
	$exp‹t_›ti⁄s
(
lua_Sèã
 *
L
)

282 i‡(
	`do_exp‹t_›ti⁄s
(
L
, 
Ál£
))

286 
	}
}

290 
sb_ã°_t
 *
	$sb_lﬂd_lua
(c⁄° *
ã°«me
)

292 i‡(
ã°«me
 !
NULL
)

294 *
tmp
 = 
	`°rdup
(
ã°«me
);

295 
sbã°
.
¢ame
 = 
	`°rdup
(
	`ba£«me
(
tmp
));

296 
sbã°
.
 ame
 = 
tmp
;

300 
sbã°
.
¢ame
 = 
	`°rdup
("<stdin>");

301 
sbã°
.
 ame
 = 
NULL
;

305 
g°©e
 = 
	`sb_lua_√w_°©e
();

306 i‡(
g°©e
 =
NULL
)

307 
îr‹
;

309 i‡(
	`ªad_cmdlöe_›ti⁄s
(
g°©e
))

310 
îr‹
;

313 i‡(
	`func_avaûabÀ
(
g°©e
, 
PREPARE_FUNC
))

314 
sbã°
.
buûtö_cmds
.
¥ï¨e
 = &
sb_lua_cmd_¥ï¨e
;

316 i‡(
	`func_avaûabÀ
(
g°©e
, 
CLEANUP_FUNC
))

317 
sbã°
.
buûtö_cmds
.
˛ónup
 = &
sb_lua_cmd_˛ónup
;

319 i‡(
	`func_avaûabÀ
(
g°©e
, 
HELP_FUNC
))

320 
sbã°
.
buûtö_cmds
.
hñp
 = &
sb_lua_cmd_hñp
;

323 
sbã°
.
›s
 = 
lua_›s
;

325 i‡(
	`func_avaûabÀ
(
g°©e
, 
THREAD_RUN_FUNC
))

326 
sbã°
.
›s
.
thªad_run
 = &
sb_lua_›_thªad_run
;

328 i‡(
	`sb_lua_hook_deföed
(
g°©e
, 
REPORT_INTERMEDIATE_HOOK
))

329 
sbã°
.
›s
.
ªp‹t_öãrmedüã
 = 
sb_lua_ªp‹t_öãrmedüã
;

331 i‡(
	`sb_lua_hook_deföed
(
g°©e
, 
REPORT_CUMULATIVE_HOOK
))

332 
sbã°
.
›s
.
ªp‹t_cumuœtive
 = 
sb_lua_ªp‹t_cumuœtive
;

335 
°©es
 = (
lua_Sèã
 **)
	`ˇŒoc
(
sb_globÆs
.
thªads
, (lua_State *));

336 i‡(
°©es
 =
NULL
)

337 
îr‹
;

339  &
sbã°
;

341 
îr‹
:

343 
	`sb_lua_d⁄e
();

345  
NULL
;

346 
	}
}

349 
	$sb_lua_d⁄e
()

351 
	`sb_lua_˛o£_°©e
(
g°©e
);

352 
g°©e
 = 
NULL
;

354 
	`x‰ì
(
°©es
);

356 i‡(
sbã°
.
¨gs
 !
NULL
)

358 
size_t
 
i
 = 0; 
sbã°
.
¨gs
[i].
«me
 !
NULL
; i++)

360 
	`x‰ì
(
sbã°
.
¨gs
[
i
].
«me
);

361 
	`x‰ì
(
sbã°
.
¨gs
[
i
].
desc
);

362 
	`x‰ì
(
sbã°
.
¨gs
[
i
].
vÆue
);

365 
	`x‰ì
(
sbã°
.
¨gs
);

368 
	`x‰ì
(
sbã°
.
¢ame
);

369 
	`x‰ì
(
sbã°
.
 ame
);

370 
	}
}

375 
	$sb_lua_›_öô
()

377 i‡(
	`exp‹t_›ti⁄s
(
g°©e
))

380 
	`lua_gëglobÆ
(
g°©e
, 
INIT_FUNC
);

381 i‡(!
	`lua_i¢û
(
g°©e
, -1))

383 i‡(
	`lua_pˇŒ
(
g°©e
, 0, 0, 0))

385 
	`ˇŒ_îr‹
(
g°©e
, 
INIT_FUNC
);

390 i‡(!
	`func_avaûabÀ
(
g°©e
, 
EVENT_FUNC
))

392 
	`log_ãxt
(
LOG_FATAL
, "cannot findÅheÉvent() function in %s",

393 
sbã°
.
¢ame
);

398 
	}
}

400 
	$sb_lua_›_thªad_öô
(
thªad_id
)

402 
lua_Sèã
 * 
L
;

404 
L
 = 
	`sb_lua_√w_°©e
();

405 i‡(
L
 =
NULL
)

408 
°©es
[
thªad_id
] = 
L
;

410 i‡(
	`exp‹t_›ti⁄s
(
L
))

413 
	`lua_gëglobÆ
(
L
, 
THREAD_INIT_FUNC
);

414 i‡(!
	`lua_i¢û
(
L
, -1))

416 
	`lua_pushnumbî
(
L
, 
thªad_id
);

418 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0))

420 
	`ˇŒ_îr‹
(
L
, 
THREAD_INIT_FUNC
);

426 
	}
}

428 
	$sb_lua_›_thªad_run
(
thªad_id
)

430 
lua_Sèã
 * c⁄° 
L
 = 
°©es
[
thªad_id
];

432 
	`lua_gëglobÆ
(
L
, 
THREAD_RUN_FUNC
);

433 
	`lua_pushnumbî
(
L
, 
thªad_id
);

435 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0))

437 
	`ˇŒ_îr‹
(
L
, 
THREAD_RUN_FUNC
);

442 
	}
}

444 
	$sb_lua_›_thªad_d⁄e
(
thªad_id
)

446 
lua_Sèã
 * c⁄° 
L
 = 
°©es
[
thªad_id
];

447 
rc
 = 0;

449 
	`lua_gëglobÆ
(
L
, 
THREAD_DONE_FUNC
);

450 i‡(!
	`lua_i¢û
(
L
, -1))

452 
	`lua_pushnumbî
(
L
, 
thªad_id
);

454 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0))

456 
	`ˇŒ_îr‹
(
L
, 
THREAD_DONE_FUNC
);

457 
rc
 = 1;

461 
	`sb_lua_˛o£_°©e
(
L
);

463  
rc
;

464 
	}
}

466 
	$sb_lua_›_d⁄e
()

468 
	`lua_gëglobÆ
(
g°©e
, 
DONE_FUNC
);

469 i‡(!
	`lua_i¢û
(
g°©e
, -1))

471 i‡(
	`lua_pˇŒ
(
g°©e
, 0, 0, 0))

473 
	`ˇŒ_îr‹
(
g°©e
, 
DONE_FUNC
);

478 
	`sb_lua_d⁄e
();

481 
	}
}

485 
	$lﬂd_öã∫Æ_s¸ùts
(
lua_Sèã
 *
L
)

487 
öã∫Æ_s¸ùt_t
 *
s
 = 
öã∫Æ_s¸ùts
; s->
«me
 !
NULL
; s++)

489 i‡(
	`luaL_lﬂdbuf„r
(
L
, (c⁄° *Ë
s
->
sour˚
, s->
sour˚_Àn
[0], s->
«me
))

491 
	`log_ãxt
(
LOG_FATAL
, "failedÅoÜoad internal module '%s': %s",

492 
s
->
«me
, 
	`lua_to°rög
(
L
, -1));

493 
	`lua_p›
(
L
, 1);

497 
	`lua_ˇŒ
(
L
, 0, 0);

501 
	}
}

503 
	$sb_lua_v¨_numbî
(
lua_Sèã
 *
L
, c⁄° *
«me
, 
lua_Numbî
 
n
)

505 
	`lua_push°rög
(
L
, 
«me
);

506 
	`lua_pushnumbî
(
L
, 
n
);

507 
	`lua_£âabÀ
(
L
, -3);

508 
	}
}

510 
	$sb_lua_v¨_°rög
(
lua_Sèã
 *
L
, c⁄° *
«me
, c⁄° *
s
)

512 
	`lua_push°rög
(
L
, 
«me
);

513 
	`lua_push°rög
(
L
, 
s
);

514 
	`lua_£âabÀ
(
L
, -3);

515 
	}
}

521 
	$sb_lua_£t_∑ths
(
lua_Sèã
 *
L
)

523 
	`lua_gëglobÆ
(
L
, "package");

525 
t›
 = 
	`lua_gët›
(
L
);

527 
	`lua_pushlôîÆ
(
L
, "./?.lua;");

528 
	`lua_pushlôîÆ
(
L
, "./?/init.lua;");

529 
	`lua_pushlôîÆ
(
L
, "./src/lua/?.lua;");

531 c⁄° *
home
 = 
	`gëív
("HOME");

532 i‡(
home
 !
NULL
)

534 
	`lua_push°rög
(
L
, 
home
);

535 
	`lua_pushlôîÆ
(
L
, "/.luarocks/share/lua/5.1/?.lua;");

536 
	`lua_push°rög
(
L
, 
home
);

537 
	`lua_pushlôîÆ
(
L
, "/.luarocks/share/lua/5.1/?/init.lua;");

538 
	`lua_push°rög
(
L
, 
home
);

539 
	`lua_pushlôîÆ
(
L
, "/.luarocks/share/lua/?.lua;");

540 
	`lua_push°rög
(
L
, 
home
);

541 
	`lua_pushlôîÆ
(
L
, "/.luarocks/share/lua/?/init.lua;");

544 
	`lua_pushlôîÆ
(
L
, "/usr/local/share/lua/5.1/?.lua;");

545 
	`lua_pushlôîÆ
(
L
, "/usr/share/lua/5.1/?.lua;");

546 
	`lua_pushlôîÆ
(
L
, 
DATADIR
 "/?.lua;");

548 
	`lua_c⁄ˇt
(
L
, 
	`lua_gët›
(LË- 
t›
);

551 c⁄° *
∑th
 = 
	`gëív
("LUA_PATH");

552 i‡(
∑th
 !
NULL
)

554 c⁄° *
def
 = 
	`lua_to°rög
(
L
, -1);

555 
∑th
 = 
	`luaL_gsub
(
L
,Öath, ";;", ";\1;");

556 
	`luaL_gsub
(
L
, 
∑th
, "\1", 
def
);

557 
	`lua_ªmove
(
L
, -2);

558 
	`lua_ªmove
(
L
, -2);

560 
	`lua_£tfõld
(
L
, 
t›
, "path");

562 
	`lua_pushlôîÆ
(
L
, "./?" 
DLEXT
 ";");

563 i‡(
home
 !
NULL
) {

564 
	`lua_push°rög
(
L
, 
home
);

565 
	`lua_pushlôîÆ
(
L
, "/.lu¨ocks/lib/lua/5.1/?" 
DLEXT
 ";");

566 
	`lua_push°rög
(
L
, 
home
);

567 
	`lua_pushlôîÆ
(
L
, "/.lu¨ocks/lib/lua/?" 
DLEXT
 ";");

570 
	`lua_pushlôîÆ
(
L
, "/u§/loˇl/lib/lua/5.1/?" 
DLEXT
 ";");

571 
	`lua_pushlôîÆ
(
L
, "/u§/lib/lua/5.1/?" 
DLEXT
 ";");

572 
	`lua_pushlôîÆ
(
L
, 
LIBDIR
 ";");

574 
	`lua_c⁄ˇt
(
L
, 
	`lua_gët›
(LË- 
t›
);

577 
∑th
 = 
	`gëív
("LUA_CPATH");

578 i‡(
∑th
 !
NULL
)

580 c⁄° *
def
 = 
	`lua_to°rög
(
L
, -1);

581 
∑th
 = 
	`luaL_gsub
(
L
,Öath, ";;", ";\1;");

582 
	`luaL_gsub
(
L
, 
∑th
, "\1", 
def
);

583 
	`lua_ªmove
(
L
, -2);

584 
	`lua_ªmove
(
L
, -2);

586 
	`lua_£tfõld
(
L
, 
t›
, "cpath");

588 
	`lua_p›
(
L
, 1);

589 
	}
}

593 
	$sb_lua_£t_ã°_¨gs
(
sb_¨g_t
 *
¨gs
, 
size_t
 
Àn
)

595 
sbã°
.
¨gs
 = 
	`mÆloc
((
Àn
 + 1Ë* (
sb_¨g_t
));

597 
size_t
 
i
 = 0; i < 
Àn
; i++)

599 
sbã°
.
¨gs
[
i
].
«me
 = 
	`°rdup
(args[i].name);

600 
sbã°
.
¨gs
[
i
].
desc
 = 
	`°rdup
(args[i].desc);

601 
sbã°
.
¨gs
[
i
].
ty≥
 =árgs[i].type;

603 
sbã°
.
¨gs
[
i
].
vÆue
 =árgs[i].vÆuê!
NULL
 ? 
	`°rdup
(args[i].value) : NULL;

604 
sbã°
.
¨gs
[
i
].
vÆid©e
 =árgs[i].validate;

607 
sbã°
.
¨gs
[
Àn
] = (
sb_¨g_t
Ë{.
«me
 = 
NULL
};

610 
	}
}

618 
	$ªad_cmdlöe_›ti⁄s
(
lua_Sèã
 *
L
)

620 
	`lua_gëglobÆ
(
L
, "sysbench");

621 
	`lua_gëfõld
(
L
, -1, "cmdline");

622 
	`lua_gëfõld
(
L
, -1, "read_cmdline_options");

624 i‡(!
	`lua_isfun˘i⁄
(
L
, -1))

626 
	`log_ãxt
(
LOG_WARNING
,

628 
	`lua_p›
(
L
, 3);

633 i‡(
	`lua_pˇŒ
(
L
, 0, 1, 0) != 0)

635 
	`ˇŒ_îr‹
(
L
, "sysbench.cmdline.read_cmdline_options");

636 
	`lua_p›
(
L
, 2);

640 
rc
 = 
	`lua_toboﬁón
(
L
, -1) == 0;

642 
	`lua_p›
(
L
, 3);

644  
rc
;

645 
	}
}

649 
lua_Sèã
 *
	$sb_lua_√w_°©e
()

651 
lua_Sèã
 *
L
;

653 
L
 = 
	`luaL_√w°©e
();

655 
	`luaL_›ílibs
(
L
);

657 i‡(
sb_globÆs
.
luajô_cmd
 && 
	`sb_lua_do_jôcmd
(
L
, sb_globals.luajit_cmd))

658  
NULL
;

660 
	`sb_lua_£t_∑ths
(
L
);

664 
	`lua_√wèbÀ
(
L
);

667 
	`sb_lua_v¨_numbî
(
L
, "tid", 
sb_és_thªad_id
);

669 
	`lua_pushlôîÆ
(
L
, "error");

670 
	`lua_√wèbÀ
(
L
);

672 
	`sb_lua_v¨_numbî
(
L
, "NONE", 
SB_LUA_ERROR_NONE
);

673 
	`sb_lua_v¨_numbî
(
L
, "RESTART_EVENT", 
SB_LUA_ERROR_RESTART_EVENT
);

675 
	`lua_£âabÀ
(
L
, -3);

678 
	`sb_lua_v¨_°rög
(
L
, "vîsi⁄", 
PACKAGE_VERSION
);

680 
	`sb_lua_v¨_°rög
(
L
, "version_string",

681 
PACKAGE_NAME
 " " 
PACKAGE_VERSION
 
SB_GIT_SHA
);

683 
	`lua_pushlôîÆ
(
L
, "cmdline");

684 
	`lua_√wèbÀ
(
L
);

686 
	`lua_pushlôîÆ
(
L
, "argv");

687 
	`lua_¸óãèbÀ
(
L
, 
sb_globÆs
.
¨gc
, 0);

689 
i
 = 0; i < 
sb_globÆs
.
¨gc
; i++)

691 
	`lua_push°rög
(
L
, 
sb_globÆs
.
¨gv
[
i
]);

692 
	`lua_øw£ti
(
L
, -2, 
i
);

695 
	`lua_£âabÀ
(
L
, -3);

698 i‡(
sb_globÆs
.
cmd«me
)

700 
	`lua_pushlôîÆ
(
L
, "command");

701 
	`lua_push°rög
(
L
, 
sb_globÆs
.
cmd«me
);

702 
	`lua_£âabÀ
(
L
, -3);

706 
	`sb_lua_v¨_°rög
(
L
, "s¸ùt_∑th", 
sbã°
.
 ame
);

708 
	`lua_£âabÀ
(
L
, -3);

710 
	`lua_£tglobÆ
(
L
, "sysbench");

712 
	`luaL_√wmë©abÀ
(
L
, "sysbench.stmt");

713 
	`luaL_√wmë©abÀ
(
L
, "sysbench.rs");

715 i‡(
	`lﬂd_öã∫Æ_s¸ùts
(
L
))

716  
NULL
;

718 
rc
;

720 i‡((
rc
 = 
	`luaL_lﬂdfûe
(
L
, 
sbã°
.
 ame
)) != 0)

722 i‡(
rc
 !
LUA_ERRFILE
)

723 
lﬂdîr
;

726 
	`lua_gëglobÆ
(
L
, "require");

727 
	`lua_push°rög
(
L
, 
sbã°
.
 ame
);

728 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0))

730 c⁄° *
msg
 = 
	`lua_to°rög
(
L
, -1);

731 i‡(
msg
 && 
	`°∫cmp
(msg, "module ", 7))

732 
lﬂdîr
;

734 
	`log_ãxt
(
LOG_FATAL
, "Cannot find benchmark '%s':Ço such built-inÅest, "

735 "fûê‹ moduÀ", 
sbã°
.
 ame
);

737  
NULL
;

740 i‡(
	`lua_pˇŒ
(
L
, 0, 0, 0))

741 
lﬂdîr
;

744 
és_lua_˘xt
.
L
 = L;

746  
L
;

748 
lﬂdîr
:

749 
	`ªp‹t_îr‹
(
L
);

751  
NULL
;

752 
	}
}

756 
	$sb_lua_˛o£_°©e
(
lua_Sèã
 *
°©e
)

758 
sb_lua_˘xt_t
 * c⁄° 
˘xt
 = &
és_lua_˘xt
;

760 i‡(
°©e
 !
NULL
)

761 
	`lua_˛o£
(
°©e
);

763 i‡(
˘xt
 !
NULL
)

764 
˘xt
->
L
 = 
NULL
;

767 
	}
}

770 
	$execuã_comm™d
(c⁄° *
cmd
)

772 i‡(
	`exp‹t_›ti⁄s
(
g°©e
))

775 
	`lua_gëglobÆ
(
g°©e
, 
cmd
);

777 i‡(
	`lua_pˇŒ
(
g°©e
, 0, 1, 0) != 0)

779 
	`ˇŒ_îr‹
(
g°©e
, 
cmd
);

783 
	`lua_p›
(
g°©e
, 1);

786 
	}
}

790 
	$sb_lua_cmd_¥ï¨e
()

792  
	`execuã_comm™d
(
PREPARE_FUNC
);

793 
	}
}

797 
	$sb_lua_cmd_˛ónup
()

799  
	`execuã_comm™d
(
CLEANUP_FUNC
);

800 
	}
}

804 
	$sb_lua_cmd_hñp
()

806  
	`execuã_comm™d
(
HELP_FUNC
);

807 
	}
}

811 
boﬁ
 
	$sb_lua_hook_deföed
(
lua_Sèã
 *
L
, c⁄° *
«me
)

813 i‡(
L
 =
NULL
)

814  
Ál£
;

816 
	`lua_gëglobÆ
(
L
, "sysbench");

817 
	`lua_gëfõld
(
L
, -1, "hooks");

818 
	`lua_gëfõld
(
L
, -1, 
«me
);

820 
boﬁ
 
rc
 = 
	`lua_isfun˘i⁄
(
L
, -1);

822 
	`lua_p›
(
L
, 3);

824  
rc
;

825 
	}
}

829 
boﬁ
 
	$sb_lua_hook_push
(
lua_Sèã
 *
L
, c⁄° *
«me
)

831 i‡(
L
 =
NULL
)

832  
Ál£
;

834 
	`lua_gëglobÆ
(
L
, "sysbench");

835 
	`lua_gëfõld
(
L
, -1, "hooks");

836 
	`lua_gëfõld
(
L
, -1, 
«me
);

838 i‡(!
	`lua_isfun˘i⁄
(
L
, -1))

840 
	`lua_p›
(
L
, 3);

841  
Ál£
;

844 
	`lua_ªmove
(
L
, -2);

845 
	`lua_ªmove
(
L
, -2);

847  
åue
;

848 
	}
}

851 
boﬁ
 
	$sb_lua_lﬂded
()

853  
g°©e
 !
NULL
;

854 
	}
}

858 
boﬁ
 
	$sb_lua_cu°om_comm™d_deföed
(c⁄° *
«me
)

860 
lua_Sèã
 * c⁄° 
L
 = 
g°©e
;

862 
	`lua_gëglobÆ
(
L
, "sysbench");

863 
	`lua_gëfõld
(
L
, -1, "cmdline");

864 
	`lua_gëfõld
(
L
, -1, "command_defined");

866 i‡(!
	`lua_isfun˘i⁄
(
L
, -1))

868 
	`log_ãxt
(
LOG_WARNING
,

870 
	`lua_p›
(
L
, 3);

875 
	`lua_push°rög
(
L
, 
«me
);

877 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0) != 0)

879 
	`ˇŒ_îr‹
(
L
, "sysbench.cmdline.command_defined");

880 
	`lua_p›
(
L
, 2);

884 
boﬁ
 
rc
 = 
	`lua_toboﬁón
(
L
, -1);

886 
	`lua_p›
(
L
, 3);

888  
rc
;

889 
	}
}

893 
boﬁ
 
	$sb_lua_cu°om_comm™d_∑øŒñ
(c⁄° *
«me
)

895 
lua_Sèã
 * c⁄° 
L
 = 
g°©e
;

897 
	`lua_gëglobÆ
(
L
, "sysbench");

898 
	`lua_gëfõld
(
L
, -1, "cmdline");

899 
	`lua_gëfõld
(
L
, -1, "command_parallel");

901 i‡(!
	`lua_isfun˘i⁄
(
L
, -1))

903 
	`log_ãxt
(
LOG_WARNING
,

905 
	`lua_p›
(
L
, 3);

910 
	`lua_push°rög
(
L
, 
«me
);

912 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0) != 0)

914 
	`ˇŒ_îr‹
(
L
, "sysbench.cmdline.command_parallel");

915 
	`lua_p›
(
L
, 2);

919 
boﬁ
 
rc
 = 
	`lua_toboﬁón
(
L
, -1);

921 
	`lua_p›
(
L
, 3);

923  
rc
;

924 
	}
}

926 
	$ˇŒ_cu°om_comm™d
(
lua_Sèã
 *
L
)

928 i‡(
	`exp‹t_›ti⁄s
(
L
))

931 
	`lua_gëglobÆ
(
L
, "sysbench");

932 
	`lua_gëfõld
(
L
, -1, "cmdline");

933 
	`lua_gëfõld
(
L
, -1, "call_command");

935 i‡(!
	`lua_isfun˘i⁄
(
L
, -1))

937 
	`log_ãxt
(
LOG_WARNING
,

939 
	`lua_p›
(
L
, 3);

944 
	`lua_push°rög
(
L
, 
sb_lua_cu°om_comm™d
);

946 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0) != 0)

948 
	`ˇŒ_îr‹
(
L
, "sysbench.cmdline.call_command");

949 
	`lua_p›
(
L
, 2);

953 
boﬁ
 
rc
 = 
	`lua_toboﬁón
(
L
, -1);

955 
	`lua_p›
(
L
, 3);

957  
rc
 ? 
EXIT_SUCCESS
 : 
EXIT_FAILURE
;

958 
	}
}

961 *
	$cmd_w‹kî_thªad
(*
¨g
)

963 
sb_thªad_˘xt_t
 *
˘xt
(sb_thªad_˘xt_à*)
¨g
;

965 
sb_és_thªad_id
 = 
˘xt
->
id
;

968 
	`sb_ønd_thªad_öô
();

970 
lua_Sèã
 * c⁄° 
L
 = 
	`sb_lua_√w_°©e
();

972 i‡(
L
 =
NULL
)

974 
	`log_ãxt
(
LOG_FATAL
, "failedÅo createáÅhreadÅoÉxecute command");

975  
NULL
;

978 
	`ˇŒ_cu°om_comm™d
(
L
);

980 
	`sb_lua_˛o£_°©e
(
L
);

982  
NULL
;

983 
	}
}

987 
	$sb_lua_ˇŒ_cu°om_comm™d
(c⁄° *
«me
)

989 
sb_lua_cu°om_comm™d
 = 
«me
;

991 i‡(
	`sb_lua_cu°om_comm™d_∑øŒñ
(
«me
Ë&& 
sb_globÆs
.
thªads
 > 1)

993 
îr
;

995 i‡((
îr
 = 
	`sb_thªad_¸óã_w‹kîs
(
cmd_w‹kî_thªad
)))

996  
îr
;

998  
	`sb_thªad_joö_w‹kîs
();

1001  
	`ˇŒ_cu°om_comm™d
(
g°©e
);

1002 
	}
}

1004 
	#°©_to_numbî
(
«me
Ë
	`sb_lua_v¨_numbî
(
L
, #«me, 
°©
->«me)

	)

1006 
	$°©_to_lua_èbÀ
(
lua_Sèã
 *
L
, 
sb_°©_t
 *
°©
)

1008 
	`lua_√wèbÀ
(
L
);

1009 
	`°©_to_numbî
(
thªads_ru¬ög
);

1010 
	`°©_to_numbî
(
time_öãrvÆ
);

1011 
	`°©_to_numbî
(
time_tŸÆ
);

1012 
	`°©_to_numbî
(
œãncy_p˘
);

1013 
	`°©_to_numbî
(
evíts
);

1014 
	`°©_to_numbî
(
ªads
);

1015 
	`°©_to_numbî
(
wrôes
);

1016 
	`°©_to_numbî
(
Ÿhî
);

1017 
	`°©_to_numbî
(
îr‹s
);

1018 
	`°©_to_numbî
(
ªc⁄√˘s
);

1019 
	}
}

1023 
	$sb_lua_ªp‹t_öãrmedüã
(
sb_°©_t
 *
°©
)

1025 
lua_Sèã
 * c⁄° 
L
 = 
és_lua_˘xt
.L;

1027 i‡(!
	`sb_lua_hook_push
(
L
, 
REPORT_INTERMEDIATE_HOOK
))

1030 
	`°©_to_lua_èbÀ
(
L
, 
°©
);

1035 
	`°©_to_numbî
(
queue_Àngth
);

1036 
	`°©_to_numbî
(
c⁄cuºícy
);

1038 i‡(
	`lua_pˇŒ
(
L
, 1, 0, 0))

1040 
	`ˇŒ_îr‹
(
L
, 
REPORT_INTERMEDIATE_HOOK
);

1042 
	}
}

1046 
	$sb_lua_ªp‹t_cumuœtive
(
sb_°©_t
 *
°©
)

1048 
lua_Sèã
 * c⁄° 
L
 = 
és_lua_˘xt
.L;

1056 i‡(
L
 =
g°©e
)

1057 
	`exp‹t_›ti⁄s
(
L
);

1059 i‡(!
	`sb_lua_hook_push
(
L
, 
REPORT_CUMULATIVE_HOOK
))

1062 
	`°©_to_lua_èbÀ
(
L
, 
°©
);

1065 
	`°©_to_numbî
(
œãncy_mö
);

1066 
	`°©_to_numbî
(
œãncy_max
);

1067 
	`°©_to_numbî
(
œãncy_avg
);

1068 
	`°©_to_numbî
(
œãncy_sum
);

1070 i‡(
	`lua_pˇŒ
(
L
, 1, 0, 0))

1072 
	`ˇŒ_îr‹
(
L
, 
REPORT_CUMULATIVE_HOOK
);

1074 
	}
}

1076 #unde‡
°©_to_numbî


1079 
	$sb_lua_ªp‹t_thªad_öô
()

1081 i‡(
és_lua_˘xt
.
L
 =
NULL
)

1083 
	`sb_lua_√w_°©e
();

1084 
	`exp‹t_›ti⁄s
(
és_lua_˘xt
.
L
);

1088 
	}
}

1090 
	$sb_lua_ªp‹t_thªad_d⁄e
(*
¨g
)

1092 (Ë
¨g
;

1094 i‡(
	`sb_lua_lﬂded
())

1095 
	`sb_lua_˛o£_°©e
(
és_lua_˘xt
.
L
);

1096 
	}
}

1103 
	$sb_lua_do_jôcmd
(
lua_Sèã
 *
L
, c⁄° *
cmd
)

1105 c⁄° *
›t
 = 
	`°rchr
(
cmd
, '=');

1107 
	`lua_pushl°rög
(
L
, 
cmd
, 
›t
 ? (
size_t
Ë(›à- cmdË: 
	`°æí
(cmd));

1108 
	`lua_gëfõld
(
L
, 
LUA_REGISTRYINDEX
, "_LOADED");

1109 
	`lua_gëfõld
(
L
, -1, "jit");

1110 
	`lua_ªmove
(
L
, -2);

1111 
	`lua_pushvÆue
(
L
, -2);

1112 
	`lua_gëèbÀ
(
L
, -2);

1114 i‡(!
	`lua_isfun˘i⁄
(
L
, -1))

1116 
	`lua_p›
(
L
, 2);

1119 
	`lua_gëglobÆ
(
L
, "require");

1120 
	`lua_pushlôîÆ
(
L
, "jit.");

1121 
	`lua_pushvÆue
(
L
, -3);

1122 
	`lua_c⁄ˇt
(
L
, 2);

1124 i‡(
	`lua_pˇŒ
(
L
, 1, 1, 0))

1126 c⁄° *
msg
 = 
	`lua_to°rög
(
L
, -1);

1127 i‡(
msg
 && !
	`°∫cmp
(msg, "module ", 7))

1128 
nomoduÀ
;

1129 
	`ˇŒ_îr‹
(
L
, "require");

1133 
	`lua_gëfõld
(
L
, -1, "start");

1134 i‡(
	`lua_i¢û
(
L
, -1)) {

1135 
nomoduÀ
:

1136 
	`log_ãxt
(
LOG_FATAL
,

1140 
	`lua_ªmove
(
L
, -2);

1144 
	`lua_ªmove
(
L
, -2);

1146 
	`lua_ªmove
(
L
, -2);

1148 
«rg
 = 0;

1150 i‡(
›t
 && *++opt)

1155 c⁄° *
p
 = 
	`°rchr
(
›t
, ',');

1156 
«rg
++;

1158 i‡(!
p
)

1161 i‡(
p
 =
›t
)

1162 
	`lua_pushnû
(
L
);

1164 
	`lua_pushl°rög
(
L
, 
›t
, (
size_t
Ë(
p
 - opt));

1166 
›t
 = 
p
 + 1;

1169 i‡(*
›t
)

1170 
	`lua_push°rög
(
L
, 
›t
);

1172 
	`lua_pushnû
(
L
);

1175 i‡(
	`lua_pˇŒ
(
L
, 
«rg
, 0, 0))

1177 
	`ˇŒ_îr‹
(
L
, "lua_pcall");

1182 
	}
}

	@sb_lua.h

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 
	~"sysbích.h
"

24 
	~"lua.h
"

28 
sb_ã°_t
 *
sb_lﬂd_lua
(c⁄° *
ã°«me
);

30 
sb_lua_d⁄e
();

32 
sb_lua_hook_ˇŒ
(
lua_Sèã
 *
L
, c⁄° *
«me
);

34 
boﬁ
 
sb_lua_cu°om_comm™d_deföed
(c⁄° *
«me
);

36 
sb_lua_ˇŒ_cu°om_comm™d
(c⁄° *
«me
);

38 
sb_lua_ªp‹t_thªad_öô
();

40 
sb_lua_ªp‹t_thªad_d⁄e
(*);

42 
boﬁ
 
sb_lua_lﬂded
();

	@sb_options.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
STDC_HEADERS


24 
	~<°dio.h
>

25 
	~<°dlib.h
>

26 
	~<°rög.h
>

27 
	~<˘y≥.h
>

30 #ifde‡
HAVE_LIMITS_H


31 
	~<limôs.h
>

34 
	~"sb_›ti⁄s.h
"

35 
	~"sysbích.h
"

37 
	#VALUE_DELIMITER
 '='

	)

38 
	#VALUE_SEPARATOR
 ','

	)

39 
	#COMMENT_CHAR
 '#'

	)

41 
	#MAXSTRLEN
 256

	)

44 
sb_li°_t
 
	g›ti⁄s
;

47 c⁄° 
	gsizemods
[] = "KMGT";

51 
c⁄vît_dashes
(*);

55 
›t_«me_cmp
(const *, const *);

61 *
	g›t_f‹m©s
[] = {

62 
NULL
,

75 
	$sb_›ti⁄s_öô
()

77 
	`SB_LIST_INIT
(&
›ti⁄s
);

80 
	}
}

84 
	$sb_›ti⁄s_d⁄e
()

86 
	`‰ì_›ti⁄s
(&
›ti⁄s
);

89 
	}
}

95 
	$sb_ªgi°î_¨g_£t
(
sb_¨g_t
 *
£t
)

97 
i
;

99 
i
=0; 
£t
[i].
«me
 !
NULL
; i++)

101 
›ti⁄_t
 * c⁄° 
›t
 = 
	`£t_›ti⁄
(
£t
[
i
].
«me
, së[i].
vÆue
, së[i].
ty≥
);

102 i‡(
›t
 =
NULL
)

104 
›t
->
vÆid©e
 = 
£t
->validate;

108 
	}
}

110 
›ti⁄_t
 *
	$sb_föd_›ti⁄
(c⁄° *
«me
)

112  
	`föd_›ti⁄
(&
›ti⁄s
, 
«me
);

113 
	}
}

115 
	$ªad_c⁄fig_fûe
(c⁄° *
fûíame
)

118 
FILE
 *
Â
 = 
	`f›í
(
fûíame
, "r");

119 i‡(!
Â
) {

120 
	`≥º‹
(
fûíame
);

122 
	`ªad_c⁄fig
(
Â
, &
›ti⁄s
);

123 
	`f˛o£
(
Â
);

125 
	}
}

127 
›ti⁄_t
 *
	$£t_›ti⁄
(c⁄° *
«me
, c⁄° *
vÆue
, 
sb_¨g_ty≥_t
 
ty≥
)

129 
›ti⁄_t
 *
›t
;

130 *
tmpbuf
;

131 *
tmp
;

133 
›t
 = 
	`add_›ti⁄
(&
›ti⁄s
, 
«me
);

134 i‡(
›t
 =
NULL
)

135  
NULL
;

136 
	`‰ì_vÆues
(&
›t
->
vÆues
);

137 
›t
->
ty≥
 =Åype;

139 i‡(
›t
->
vÆid©e
 !
NULL
 && !›t->
	`vÆid©e
(
«me
, 
vÆue
))

140  
NULL
;

142 i‡(
ty≥
 !
SB_ARG_TYPE_BOOL
 && (
vÆue
 =
NULL
 || value[0] == '\0'))

143  
›t
;

145 
ty≥
) {

146 
SB_ARG_TYPE_BOOL
:

147 i‡(
vÆue
 =
NULL
 || !
	`°rcmp
(value, "on") ||

148 !
	`°rcmp
(
vÆue
, "true") || !strcmp(value, "1"))

150 
	`add_vÆue
(&
›t
->
vÆues
, "on");

152 i‡(
	`°rcmp
(
vÆue
, "off") && strcmp(value, "false") &&

153 
	`°rcmp
(
vÆue
, "0"))

155  
NULL
;

158 
SB_ARG_TYPE_INT
:

159 
SB_ARG_TYPE_SIZE
:

160 
SB_ARG_TYPE_DOUBLE
:

161 
SB_ARG_TYPE_STRING
:

162 
	`add_vÆue
(&
›t
->
vÆues
, 
vÆue
);

164 
SB_ARG_TYPE_LIST
:

165 i‡(
vÆue
 =
NULL
)

168 
tmpbuf
 = 
	`°rdup
(
vÆue
);

169 
tmp
 = 
tmpbuf
;

171 
tmp
 = 
	`°πok
—mp, ",");Åm∞!
NULL
;Åmp = strtok(NULL, ","))

172 
	`add_vÆue
(&
›t
->
vÆues
, 
tmp
);

174 
	`‰ì
(
tmpbuf
);

177 
SB_ARG_TYPE_FILE
:

178 
	`ªad_c⁄fig_fûe
(
vÆue
);

181 
	`¥ötf
("Unknow¿¨gumíàty≥: %d", 
ty≥
);

182  
NULL
;

185  
›t
;

186 
	}
}

189 
	$sb_¥öt_›ti⁄s
(
sb_¨g_t
 *
›ts
)

191 
i
;

192 
Àn
;

193 
maxÀn
;

194 *
fmt
;

197 
i
 = 0, 
maxÀn
 = 0; 
›ts
[i].
«me
 !
NULL
; i++)

199 
Àn
 = 
	`°æí
(
›ts
[
i
].
«me
);

200 
Àn
 +(
›ts
[
i
].
ty≥
 < 
SB_ARG_TYPE_MAX
) ?

201 
	`°æí
(
›t_f‹m©s
[
›ts
[
i
].
ty≥
]) : 8 ;

202 i‡(
Àn
 > 
maxÀn
)

203 
maxÀn
 = 
Àn
;

206 
i
 = 0; 
›ts
[i].
«me
 !
NULL
; i++)

208 i‡(
›ts
[
i
].
ty≥
 < 
SB_ARG_TYPE_MAX
)

209 
fmt
 = 
›t_f‹m©s
[
›ts
[
i
].
ty≥
];

211 
fmt
 = "=UNKNOWN";

213 
	`¥ötf
(" --%s%-*s%s", 
›ts
[
i
].
«me
,

214 ()(
maxÀn
 - 
	`°æí
(
›ts
[
i
].
«me
Ë+ 1), 
fmt
,

215 
›ts
[
i
].
desc
);

216 i‡(
›ts
[
i
].
vÆue
 !
NULL
)

217 
	`¥ötf
(" [%s]", 
›ts
[
i
].
vÆue
);

218 
	`¥ötf
("\n");

220 
	`¥ötf
("\n");

221 
	}
}

224 
	$sb_›t_to_Êag
(
›ti⁄_t
 *
›t
)

226  !
	`SB_LIST_IS_EMPTY
(&
›t
->
vÆues
);

227 
	}
}

230 
	$sb_gë_vÆue_Êag
(c⁄° *
«me
)

232 
›ti⁄_t
 *
›t
;

234 
›t
 = 
	`föd_›ti⁄
(&
›ti⁄s
, 
«me
);

235 i‡(
›t
 =
NULL
)

238  
	`sb_›t_to_Êag
(
›t
);

239 
	}
}

242 
	$sb_›t_to_öt
(
›ti⁄_t
 *
›t
)

244 
vÆue_t
 *
vÆ
;

245 
sb_li°_ôem_t
 *
pos
;

246 
ªs
;

247 *
íd±r
;

249 
	`SB_LIST_ONCE
(
pos
, &
›t
->
vÆues
)

251 
vÆ
 = 
	`SB_LIST_ENTRY
(
pos
, 
vÆue_t
, 
li°ôem
);

252 
ªs
 = 
	`°πﬁ
(
vÆ
->
d©a
, &
íd±r
, 10);

253 i‡(*
íd±r
 !'\0' || 
ªs
 > 
INT_MAX
 ||Ñe†< 
INT_MIN
)

255 
	`Ârötf
(
°dîr
, "Invalid value forÅhe '%s' option: '%s'\n",

256 
›t
->
«me
, 
vÆ
->
d©a
);

257 
	`exô
(
EXIT_FAILURE
);

259  (Ë
ªs
;

263 
	}
}

266 
	$sb_gë_vÆue_öt
(c⁄° *
«me
)

268 
›ti⁄_t
 *
›t
;

270 
›t
 = 
	`föd_›ti⁄
(&
›ti⁄s
, 
«me
);

271 i‡(
›t
 =
NULL
)

274  
	`sb_›t_to_öt
(
›t
);;

275 
	}
}

278 
	$sb_›t_to_size
(
›ti⁄_t
 *
›t
)

280 
vÆue_t
 *
vÆ
;

281 
sb_li°_ôem_t
 *
pos
;

282 
ªs
 = 0;

283 
mu…
 = 0;

284 
rc
;

285 
i
, 
n
;

286 *
c
;

288 
	`SB_LIST_ONCE
(
pos
, &
›t
->
vÆues
)

290 
vÆ
 = 
	`SB_LIST_ENTRY
(
pos
, 
vÆue_t
, 
li°ôem
);

295 
ªs
 = 0;

296 
rc
 = 0, 
c
 = 
vÆ
->
d©a
; *c != '\0'; c++)

298 i‡(*
c
 < '0' || *c > '9')

300 i‡(
rc
 == 1)

302 
rc
 = 2;

303 
mu…
 = *
c
;

307 
rc
 = 1;

308 
ªs
 =Ñe†* 10 + *
c
 - '0';

311 i‡(
rc
 == 2)

313 
n
 = 0; 
sizemods
[n] != '\0';Ç++)

314 i‡(
	`touµî
(
mu…
Ë=
sizemods
[
n
])

316 i‡(
sizemods
[
n
] != '\0')

318 
i
 = 0; i <
n
; i++)

319 
ªs
 *= 1024;

322 
ªs
 = 0;

326  
ªs
;

327 
	}
}

330 
	$sb_gë_vÆue_size
(c⁄° *
«me
)

332 
›ti⁄_t
 *
›t
;

334 
›t
 = 
	`föd_›ti⁄
(&
›ti⁄s
, 
«me
);

335 i‡(
›t
 =
NULL
)

338  
	`sb_›t_to_size
(
›t
);

339 
	}
}

342 
	$sb_›t_to_doubÀ
(
›ti⁄_t
 *
›t
)

344 
vÆue_t
 *
vÆ
;

345 
sb_li°_ôem_t
 *
pos
;

346 
ªs
 = 0;

348 
	`SB_LIST_FOR_EACH
(
pos
, &
›t
->
vÆues
)

350 
vÆ
 = 
	`SB_LIST_ENTRY
(
pos
, 
vÆue_t
, 
li°ôem
);

351 
ªs
 = 
	`°πod
(
vÆ
->
d©a
, 
NULL
);

354  
ªs
;

355 
	}
}

358 
	$sb_gë_vÆue_doubÀ
(c⁄° *
«me
)

360 
›ti⁄_t
 *
›t
;

362 
›t
 = 
	`föd_›ti⁄
(&
›ti⁄s
, 
«me
);

363 i‡(
›t
 =
NULL
)

366  
	`sb_›t_to_doubÀ
(
›t
);

367 
	}
}

370 *
	$sb_›t_to_°rög
(
›ti⁄_t
 *
›t
)

372 
vÆue_t
 *
vÆ
;

373 
sb_li°_ôem_t
 *
pos
;

375 
	`SB_LIST_ONCE
(
pos
, &
›t
->
vÆues
)

377 
vÆ
 = 
	`SB_LIST_ENTRY
(
pos
, 
vÆue_t
, 
li°ôem
);

378  
vÆ
->
d©a
;

381  
NULL
;

382 
	}
}

385 *
	$sb_gë_vÆue_°rög
(c⁄° *
«me
)

387 
›ti⁄_t
 *
›t
;

389 
›t
 = 
	`föd_›ti⁄
(&
›ti⁄s
, 
«me
);

390 i‡(
›t
 =
NULL
)

391  
NULL
;

393  
	`sb_›t_to_°rög
(
›t
);

394 
	}
}

397 
boﬁ
 
	$sb_›t_c›y
(c⁄° *
to
, c⁄° *
‰om
)

399 
›ti⁄_t
 *
›t
 = 
	`föd_›ti⁄
(&
›ti⁄s
, 
‰om
);

401 i‡(
›t
 =
NULL
)

402  
Ál£
;

404 
	`£t_›ti⁄
(
to
, 
	`sb_›t_to_°rög
(
›t
), o±->
ty≥
);

406  
åue
;

407 
	}
}

410 
sb_li°_t
 *
	$sb_›t_to_li°
(
›ti⁄_t
 *
›t
)

412  &
›t
->
vÆues
;

413 
	}
}

416 
sb_li°_t
 *
	$sb_gë_vÆue_li°
(c⁄° *
«me
)

418 
›ti⁄_t
 *
›t
;

420 
›t
 = 
	`föd_›ti⁄
(&
›ti⁄s
, 
«me
);

421 i‡(
›t
 =
NULL
)

422  
NULL
;

424  
	`sb_›t_to_li°
(
›t
);

425 
	}
}

428 *
	$sb_¥öt_vÆue_size
(*
buf
, 
buÊí
, 
vÆue
)

430 
i
;

432 
i
 = 0; i < (
sizemods
Ë&& 
vÆue
 >= 1024; i++, value /= 1024)

435 i‡(
i
 > 0)

436 
	`¢¥ötf
(
buf
, 
buÊí
, "%.5g%ci", 
vÆue
, 
sizemods
[
i
-1]);

438 
	`¢¥ötf
(
buf
, 
buÊí
, "%.5g", 
vÆue
);

440  
buf
;

441 
	}
}

444 
vÆue_t
 *
	$√w_vÆue
()

446 
vÆue_t
 *
√wvÆ
;

448 
√wvÆ
 = (
vÆue_t
 *)
	`mÆloc
((value_t));

449 i‡(
√wvÆ
 !
NULL
)

450 
	`mem£t
(
√wvÆ
, 0, (
vÆue_t
));

452  
√wvÆ
;

453 
	}
}

456 
›ti⁄_t
 *
	$√w_›ti⁄
()

458 
›ti⁄_t
 *
√w›t
;

460 
√w›t
 = (
›ti⁄_t
 *)
	`mÆloc
((option_t));

461 i‡(
√w›t
 !
NULL
)

463 
	`mem£t
(
√w›t
, 0, (
›ti⁄_t
));

464 
	`SB_LIST_INIT
(&
√w›t
->
vÆues
);

467  
√w›t
;

468 
	}
}

471 
	$‰ì_vÆues
(
sb_li°_t
 *
vÆues
)

473 
sb_li°_ôem_t
 *
√xt
;

474 
sb_li°_ôem_t
 *
cur
;

475 
vÆue_t
 *
vÆ
;

477 i‡(
vÆues
 =
NULL
)

480 
	`SB_LIST_FOR_EACH_SAFE
(
cur
, 
√xt
, 
vÆues
)

482 
vÆ
 = 
	`SB_LIST_ENTRY
(
cur
, 
vÆue_t
, 
li°ôem
);

483 i‡(
vÆ
->
d©a
 !
NULL
)

484 
	`‰ì
(
vÆ
->
d©a
);

485 
	`SB_LIST_DELETE
(
cur
);

486 
	`‰ì
(
vÆ
);

488 
	}
}

491 
	$‰ì_›ti⁄s
(
sb_li°_t
 *
›ti⁄s
)

493 
sb_li°_ôem_t
 *
√xt
;

494 
sb_li°_ôem_t
 *
cur
;

495 
›ti⁄_t
 *
›t
;

497 i‡(
›ti⁄s
 =
NULL
)

500 
	`SB_LIST_FOR_EACH_SAFE
(
cur
, 
√xt
, 
›ti⁄s
)

502 
›t
 = 
	`SB_LIST_ENTRY
(
cur
, 
›ti⁄_t
, 
li°ôem
);

503 i‡(
›t
->
«me
 !
NULL
)

504 
	`‰ì
(
›t
->
«me
);

505 
	`‰ì_vÆues
(&
›t
->
vÆues
);

506 
	`‰ì
(
›t
);

508 
	}
}

511 
	$ªmove_vÆue
(
sb_li°_t
 *
vÆues
, *
vÆ«me
)

513 
vÆue_t
 * 
vÆue
;

515 i‡(
vÆues
 =
NULL
 || 
vÆ«me
 == NULL)

518 i‡((
vÆue
 = 
	`föd_vÆue
(
vÆues
, 
vÆ«me
)Ë=
NULL
)

520 i‡(
vÆue
->
d©a
 !
NULL
)

522 
	`‰ì
(
vÆue
->
d©a
);

524 
	`SB_LIST_DELETE
(&
vÆue
->
li°ôem
);

525 
	`‰ì
(
vÆue
);

528 
	}
}

531 
	$ªmove_›ti⁄
(
sb_li°_t
 * 
›ti⁄s
, * 
›äame
)

533 
›ti⁄_t
 * 
›ti⁄
;

535 i‡(
›ti⁄s
 =
NULL
 || 
›äame
 == NULL)

538 i‡((
›ti⁄
 = 
	`föd_›ti⁄
(
›ti⁄s
, 
›äame
)Ë=
NULL
)

540 
	`‰ì_vÆues
(&
›ti⁄
->
vÆues
);

541 i‡(
›ti⁄
->
«me
 !
NULL
)

542 
	`‰ì
(
›ti⁄
->
«me
);

543 
	`SB_LIST_DELETE
(&
›ti⁄
->
li°ôem
);

544 
	`‰ì
(
›ti⁄
);

547 
	}
}

550 
vÆue_t
 *
	$add_vÆue
(
sb_li°_t
 *
vÆues
, c⁄° *
d©a
)

552 
vÆue_t
 *
√wvÆ
;

554 i‡(
vÆues
 =
NULL
 || 
d©a
 == NULL)

555  
NULL
;

557 i‡((
√wvÆ
 = 
	`√w_vÆue
()Ë=
NULL
)

558  
NULL
;

559 i‡((
√wvÆ
->
d©a
 = 
	`°rdup
(d©a)Ë=
NULL
)

561 
	`‰ì
(
√wvÆ
);

562  
NULL
;

565 
	`SB_LIST_ADD_TAIL
(&
√wvÆ
->
li°ôem
, 
vÆues
);

567  
√wvÆ
;

568 
	}
}

571 
vÆue_t
 *
	$föd_vÆue
(
sb_li°_t
 *
vÆues
, c⁄° *
d©a
)

573 
sb_li°_ôem_t
 *
pos
;

574 
vÆue_t
 *
vÆue
;

576 i‡(
vÆues
 =
NULL
 || 
d©a
 == NULL)

577  
NULL
;

579 
	`SB_LIST_FOR_EACH
(
pos
, 
vÆues
)

581 
vÆue
 = 
	`SB_LIST_ENTRY
(
pos
, 
vÆue_t
, 
li°ôem
);

582 i‡(!
	`°rcmp
(
vÆue
->
d©a
, data))

583  
vÆue
;

586  
NULL
;

587 
	}
}

590 
›ti⁄_t
 *
	$add_›ti⁄
(
sb_li°_t
 *
›ti⁄s
, c⁄° *
«me
)

592 
›ti⁄_t
 *
›ti⁄
;

594 i‡(
›ti⁄s
 =
NULL
 || 
«me
 == NULL)

595  
NULL
;

597 i‡((
›ti⁄
 = 
	`föd_›ti⁄
(
›ti⁄s
, 
«me
)Ë!
NULL
)

598  
›ti⁄
;

600 i‡((
›ti⁄
 = 
	`√w_›ti⁄
()Ë=
NULL
)

601  
NULL
;

603 
›ti⁄
->
«me
 = 
	`°rdup
(name);

604 
	`c⁄vît_dashes
(
›ti⁄
->
«me
);

606 
	`SB_LIST_ADD_TAIL
(&
›ti⁄
->
li°ôem
, 
›ti⁄s
);

608  
›ti⁄
;

609 
	}
}

612 
	$c⁄vît_dashes
(*
s
)

614 *
s
 != '\0')

616 i‡(*
s
 == '-')

617 *
s
 = '_';

618 
s
++;

620 
	}
}

623 
	$›t_«me_cmp
(c⁄° *
s1
, c⁄° *
s2
)

625  ; *
s1
 !'\0'; s1++, 
s2
++)

627 i‡(*
s1
 =*
s2
)

630 i‡((*
s1
 !'-' && *s1 !'_'Ë|| (*
s2
 != '-' && *s2 != '_'))

634  *
s1
 - *
s2
;

635 
	}
}

638 
›ti⁄_t
 *
	$föd_›ti⁄
(
sb_li°_t
 *
›ti⁄s
, c⁄° *
«me
)

640 
sb_li°_ôem_t
 *
pos
;

641 
›ti⁄_t
 *
›t
;

643 i‡(
›ti⁄s
 =
NULL
 || 
«me
 == NULL)

644  
NULL
;

646 
	`SB_LIST_FOR_EACH
(
pos
, 
›ti⁄s
)

648 
›t
 = 
	`SB_LIST_ENTRY
(
pos
, 
›ti⁄_t
, 
li°ôem
);

649 i‡(!
	`›t_«me_cmp
(
›t
->
«me
,Çame))

650  
›t
;

653  
NULL
;

654 
	}
}

657 
sb_li°_ôem_t
 *
	$sb_›ti⁄s_íum_°¨t
()

659  
	`SB_LIST_ENUM_START
(&
›ti⁄s
);

660 
	}
}

662 
sb_li°_ôem_t
 *
	$sb_›ti⁄s_íum_√xt
(
sb_li°_ôem_t
 *
pos
, 
›ti⁄_t
 **
›t
)

664 
pos
 = 
	`SB_LIST_ENUM_NEXT
’os, &
›ti⁄s
);

665 i‡(
pos
 =
NULL
)

666  
NULL
;

668 *
›t
 = 
	`SB_LIST_ENTRY
(
pos
, 
›ti⁄_t
, 
li°ôem
);

670  
pos
;

671 
	}
}

674 
sb_li°_t
 *
	$ªad_c⁄fig
(
FILE
 *
Â
, 
sb_li°_t
 *
›ti⁄s
)

676 
buf
[
MAXSTRLEN
];

677 *
tmp
;

678 
qc
;

679 
›ti⁄_t
 *
√w›t
;

680 
›éí
;

681 
∆öe
;

683 i‡(
Â
 =
NULL
 || 
›ti⁄s
 == NULL)

684  
NULL
;

686 
∆öe
 = 0;

687 
	`fgës
(
buf
, 
MAXSTRLEN
, 
Â
Ë!
NULL
)

689 
∆öe
++;

691 
tmp
 = 
	`°rchr
(
buf
, 
VALUE_DELIMITER
);

692 i‡(
tmp
 =
NULL
)

694 i‡(*
tmp
 != '\0')

695 *
tmp
++ = '\0';

697 i‡((
√w›t
 = 
	`add_›ti⁄
(
›ti⁄s
, 
buf
)Ë=
NULL
)

698  
NULL
;

700 
	`‰ì_vÆues
(&
√w›t
->
vÆues
);

701 *
tmp
 != '\0')

703 i‡(
	`is•a˚
(()*
tmp
))

705 
tmp
++;

708 i‡(*
tmp
 =
COMMENT_CHAR
)

710 i‡(*
tmp
 == '\'' || *tmp == '\"')

712 
qc
 = *
tmp
;

713 
tmp
++, 
›éí
 = 0;Åmp[›éí] !'\0' &&Åmp[›éí] !
qc
;

714 
›éí
++)

718 i‡(
tmp
[
›éí
] == '\0') {

719 
	`Ârötf
(
°dîr
, "u√x≥˘ed EOL o¿löê%d\n", 
∆öe
);

720  
NULL
;

722 
tmp
[
›éí
++] = '\0';

723 
	`add_vÆue
(&
√w›t
->
vÆues
, 
tmp
);

724 
tmp
 =Åm∞+ 
›éí
; *tm∞!'\0' && *tm∞!
VALUE_SEPARATOR
;Åmp++)

728 i‡(*
tmp
 =
VALUE_SEPARATOR
)

729 
tmp
++;

731 
›éí
 = 0; 
tmp
[›éí] !'\0' &&Åmp[›éí] !
VALUE_SEPARATOR


732 && !
	`is•a˚
(
tmp
[
›éí
]);

733 
›éí
++)

738 i‡(
tmp
[
›éí
] != '\0')

739 
tmp
[
›éí
++] = '\0';

741 
	`add_vÆue
(&
√w›t
->
vÆues
, 
tmp
);

742 
tmp
 +
›éí
;

747  
›ti⁄s
;

748 
	}
}

751 
	$wrôe_c⁄fig
(
FILE
 *
Â
, 
sb_li°_t
 *
›ti⁄s
)

753 
›ti⁄_t
 *
›t
;

754 
vÆue_t
 *
vÆ
;

755 
sb_li°_ôem_t
 *
pos_›t
;

756 
sb_li°_ôem_t
 *
pos_vÆ
;

758 i‡(
Â
 =
NULL
 || 
›ti⁄s
 == NULL)

761 
	`SB_LIST_FOR_EACH
(
pos_›t
, 
›ti⁄s
)

763 
›t
 = 
	`SB_LIST_ENTRY
(
pos_›t
, 
›ti⁄_t
, 
li°ôem
);

764 i‡(
›t
->
ign‹e
 || o±->
«me
 =
NULL
)

766 
›t
->
ign‹e
 = 1;

767 
	`Ârötf
(
Â
, "%†%¯", 
›t
->
«me
, 
VALUE_DELIMITER
);

768 
	`SB_LIST_FOR_EACH
(
pos_vÆ
, &
›t
->
vÆues
)

770 
vÆ
 = 
	`SB_LIST_ENTRY
(
pos_vÆ
, 
vÆue_t
, 
li°ôem
);

771 i‡(!
vÆ
->
ign‹e
 && vÆ->
d©a
 !
NULL
)

772 
	`Ârötf
(
Â
, "%s", 
vÆ
->
d©a
);

773 i‡(!
	`SB_LIST_ITEM_LAST
(
pos_vÆ
, &
›t
->
vÆues
))

774 
	`Ârötf
(
Â
, "%¯", 
VALUE_SEPARATOR
);

776 
	`Âutc
('\n', 
Â
);

780 
	}
}

	@sb_options.h

19 #i‚de‡
OPTIONS_H


20 
	#OPTIONS_H


	)

22 
	~<°dio.h
>

23 
	~<°dboﬁ.h
>

25 
	~"sb_li°.h
"

28 
	#SB_OPT
(
n
, 
d
, 
v
, 
t
) \

29 { .
«me
 = (
n
), \

30 .
desc
 = (
d
), \

31 .
ty≥
 = 
SB_ARG_TYPE_
##
t
, \

32 .
vÆue
 = (
v
Ë}

	)

34 
	#SB_OPT_END
 { .
ty≥
 = 
SB_ARG_TYPE_NULL
 }

	)

40 
	mSB_ARG_TYPE_NULL
,

41 
	mSB_ARG_TYPE_BOOL
,

42 
	mSB_ARG_TYPE_INT
,

43 
	mSB_ARG_TYPE_SIZE
,

44 
	mSB_ARG_TYPE_DOUBLE
,

45 
	mSB_ARG_TYPE_STRING
,

46 
	mSB_ARG_TYPE_LIST
,

47 
	mSB_ARG_TYPE_FILE
,

48 
	mSB_ARG_TYPE_MAX


49 } 
	tsb_¨g_ty≥_t
;

52 
boﬁ
 
	tsb_›t_vÆid©e_t
(const *, const *);

57 c⁄° *
	m«me
;

58 c⁄° *
	mdesc
;

59 c⁄° *
	mvÆue
;

60 
sb_¨g_ty≥_t
 
	mty≥
;

61 
sb_›t_vÆid©e_t
 *
	mvÆid©e
;

62 } 
	tsb_¨g_t
;

66 *
	md©a
;

67 
	mign‹e
;

69 
sb_li°_ôem_t
 
	mli°ôem
;

70 } 
	tvÆue_t
;

74 *
	m«me
;

75 
sb_¨g_ty≥_t
 
	mty≥
;

76 
sb_li°_t
 
	mvÆues
;

77 
	mign‹e
;

79 
sb_›t_vÆid©e_t
 *
	mvÆid©e
;

81 
sb_li°_ôem_t
 
	mli°ôem
;

82 } 
	t›ti⁄_t
;

85 
sb_›ti⁄s_öô
();

88 
sb_›ti⁄s_d⁄e
();

91 
sb_ªgi°î_¨g_£t
(
sb_¨g_t
 *
£t
);

94 
›ti⁄_t
 *
£t_›ti⁄
(c⁄° *
«me
, c⁄° *
vÆue
, 
sb_¨g_ty≥_t
 
ty≥
);

97 
›ti⁄_t
 *
sb_föd_›ti⁄
(c⁄° *
«me
);

100 
sb_¥öt_›ti⁄s
(
sb_¨g_t
 *
›ts
);

102 
sb_gë_vÆue_Êag
(c⁄° *
«me
);

104 
sb_gë_vÆue_öt
(c⁄° *
«me
);

106 
sb_gë_vÆue_size
(c⁄° *
«me
);

108 
sb_gë_vÆue_doubÀ
(c⁄° *
«me
);

110 *
sb_gë_vÆue_°rög
(c⁄° *
«me
);

112 
sb_li°_t
 *
sb_gë_vÆue_li°
(c⁄° *
«me
);

114 *
sb_¥öt_vÆue_size
(*
buf
, 
buÊí
, 
vÆue
);

116 
sb_›t_to_Êag
(
›ti⁄_t
 *);

118 
sb_›t_to_öt
(
›ti⁄_t
 *);

120 
sb_›t_to_size
(
›ti⁄_t
 *);

122 
sb_›t_to_doubÀ
(
›ti⁄_t
 *);

124 *
sb_›t_to_°rög
(
›ti⁄_t
 *);

126 
sb_li°_t
 *
sb_›t_to_li°
(
›ti⁄_t
 *);

128 
boﬁ
 
sb_›t_c›y
(c⁄° *
to
, c⁄° *
‰om
);

130 
sb_li°_ôem_t
 *
sb_›ti⁄s_íum_°¨t
();

132 
sb_li°_ôem_t
 *
sb_›ti⁄s_íum_√xt
(sb_li°_ôem_à*, 
›ti⁄_t
 **);

134 
vÆue_t
 *
√w_vÆue
();

136 
›ti⁄_t
 *
√w_›ti⁄
();

138 
‰ì_vÆues
(
sb_li°_t
 *);

140 
‰ì_›ti⁄s
(
sb_li°_t
 *);

142 
vÆue_t
 *
add_vÆue
(
sb_li°_t
 *, const *);

144 
vÆue_t
 *
föd_vÆue
(
sb_li°_t
 *, const *);

146 
›ti⁄_t
 *
add_›ti⁄
(
sb_li°_t
 *, const *);

148 
›ti⁄_t
 *
föd_›ti⁄
(
sb_li°_t
 *, const *);

150 
ªmove_vÆue
(
sb_li°_t
 *, *);

152 
ªmove_›ti⁄
(
sb_li°_t
 *, *);

154 
sb_li°_t
 *
ªad_c⁄fig
(
FILE
 *, sb_list_t *);

156 
wrôe_c⁄fig
(
FILE
 *, 
sb_li°_t
 *);

	@sb_rand.c

38 #ifde‡
HAVE_CONFIG_H


39 
	~"c⁄fig.h
"

42 
	~<°dlib.h
>

43 #ifde‡
HAVE_STRING_H


44 
	~<°rög.h
>

46 #ifde‡
HAVE_STRINGS_H


47 
	~<°rögs.h
>

49 #ifde‡
HAVE_MATH_H


50 
	~<m©h.h
>

53 
	~"sb_›ti⁄s.h
"

54 
	~"sb_ønd.h
"

55 
	~"sb_loggî.h
"

57 
	~"sb_ck_¥.h
"

59 
TLS
 
sb_∫g_°©e_t
 
sb_∫g_°©e
 
	gCK_CC_CACHELINE
;

62 
	gsb_ønd_£ed
;

66 
sb_¨g_t
 
	gønd_¨gs
[] =

68 
SB_OPT
("rand-type",

70 "zùfün}Åÿu£ by deÁu…", "•ecül", 
STRING
),

71 
SB_OPT
("rand-seed",

73 "u£dá†™ RNG sìd.", "0", 
INT
),

74 
SB_OPT
("rand-spec-iter",

75 "numbî o‡ôî©i⁄†f‹Åhê•ecü»di°ributi⁄", "12", 
INT
),

76 
SB_OPT
("rand-spec-pct",

79 "1", 
INT
),

80 
SB_OPT
("rand-spec-res",

82 "75", 
INT
),

83 
SB_OPT
("rand-pareto-h", "shapeÖarameter forÅhe Pareto distribution",

84 "0.2", 
DOUBLE
),

85 
SB_OPT
("rand-zipfian-exp",

87 "0.8", 
DOUBLE
),

89 
SB_OPT_END


92 
ønd_di°_t
 
	gønd_ty≥
;

94 
	$uöt32_t
 (*
ønd_func
)(
uöt32_t
, uint32_t);

95 
ønd_ôî
;

96 
ønd_p˘
;

97 
ønd_ªs
;

103 
ønd_ôî_mu…
;

104 
ønd_p˘_mu…
;

105 
ønd_p˘_2_mu…
;

106 
ønd_ªs_mu…
;

109 
∑ªto_h
;

110 
∑ªto_powî
;

113 
zùf_exp
;

114 
zùf_s
;

115 
zùf_hI¡egølX1
;

118 
uöt32_t
 
ønd_unique_ödex
 
CK_CC_CACHELINE
;

119 
uöt32_t
 
ønd_unique_off£t
;

121 
ölöe
 
uöt64_t
 
	`sb_ønd_unif‹m_uöt64
();

122 
ölöe
 
	`sb_ønd_unif‹m_doubÀ
();

123 
ölöe
 
uöt64_t
 
	`x‹oshúo_rŸl
(const uint64_t, );

124 
ölöe
 
uöt64_t
 
	`x‹oshúo_√xt
(uöt64_à
s
[2]);

126 
	`ønd_unique_£ed
(
uöt32_t
 
ödex
, uöt32_à
off£t
);

129 
	`hI¡egøl
(
x
, 
e
);

130 
	`hI¡egølInvî£
(
x
, 
e
);

131 
	`h
(
x
, 
e
);

132 
	`hñ≥r1
(
x
);

133 
	`hñ≥r2
(
x
);

135 
	$sb_ønd_ªgi°î
()

137 
	`sb_ªgi°î_¨g_£t
(
ønd_¨gs
);

140 
	}
}

144 
	$sb_ønd_öô
()

146 *
s
;

148 
sb_ønd_£ed
 = 
	`sb_gë_vÆue_öt
("rand-seed");

150 
s
 = 
	`sb_gë_vÆue_°rög
("rand-type");

151 i‡(!
	`°rcmp
(
s
, "uniform"))

153 
ønd_ty≥
 = 
DIST_TYPE_UNIFORM
;

154 
ønd_func
 = &
sb_ønd_unif‹m
;

156 i‡(!
	`°rcmp
(
s
, "gaussian"))

158 
ønd_ty≥
 = 
DIST_TYPE_GAUSSIAN
;

159 
ønd_func
 = &
sb_ønd_gaussün
;

161 i‡(!
	`°rcmp
(
s
, "special"))

163 
ønd_ty≥
 = 
DIST_TYPE_SPECIAL
;

164 
ønd_func
 = &
sb_ønd_•ecül
;

166 i‡(!
	`°rcmp
(
s
, "pareto"))

168 
ønd_ty≥
 = 
DIST_TYPE_PARETO
;

169 
ønd_func
 = &
sb_ønd_∑ªto
;

171 i‡(!
	`°rcmp
(
s
, "zipfian"))

173 
ønd_ty≥
 = 
DIST_TYPE_ZIPFIAN
;

174 
ønd_func
 = &
sb_ønd_zùfün
;

178 
	`log_ãxt
(
LOG_FATAL
, "InvÆidÑ™domÇumbî†di°ributi⁄: %s.", 
s
);

182 
ønd_ôî
 = 
	`sb_gë_vÆue_öt
("rand-spec-iter");

183 
ønd_ôî_mu…
 = 1.0 / 
ønd_ôî
;

185 
ønd_p˘
 = 
	`sb_gë_vÆue_öt
("rand-spec-pct");

186 
ønd_p˘_mu…
 = 
ønd_p˘
 / 100.0;

187 
ønd_p˘_2_mu…
 = 
ønd_p˘
 / 200.0;

189 
ønd_ªs
 = 
	`sb_gë_vÆue_öt
("rand-spec-res");

190 
ønd_ªs_mu…
 = 100.0 / (100.0 - 
ønd_ªs
);

192 
∑ªto_h
 = 
	`sb_gë_vÆue_doubÀ
("rand-pareto-h");

193 
∑ªto_powî
 = 
	`log
(
∑ªto_h
) /Üog(1.0-pareto_h);

195 
zùf_exp
 = 
	`sb_gë_vÆue_doubÀ
("rand-zipfian-exp");

196 i‡(
zùf_exp
 < 0)

198 
	`log_ãxt
(
LOG_FATAL
, "--rand-zipfian-exp must be >= 0");

202 
zùf_s
 = 2 - 
	`hI¡egølInvî£
(
	`hI¡egøl
(2.5, 
zùf_exp
Ë- 
	`h
(2, zipf_exp),

203 
zùf_exp
);

204 
zùf_hI¡egølX1
 = 
	`hI¡egøl
(1.5, 
zùf_exp
) - 1;

207 
	`sb_ønd_thªad_öô
();

210 
	`ønd_unique_£ed
(
	`øndom
(),Ñandom());

213 
	}
}

216 
	$sb_ønd_¥öt_hñp
()

218 
	`¥ötf
("Pseudo-Random Numbers Generator options:\n");

220 
	`sb_¥öt_›ti⁄s
(
ønd_¨gs
);

221 
	}
}

224 
	$sb_ønd_d⁄e
()

226 
	}
}

230 
	$sb_ønd_thªad_öô
()

233 
sb_∫g_°©e
[0] = (((
uöt64_t
Ë
	`øndom
()) << 32) |

234 (((
uöt64_t
Ë
	`øndom
()Ë& 
UINT32_MAX
);

235 
sb_∫g_°©e
[1] = (((
uöt64_t
Ë
	`øndom
()) << 32) |

236 (((
uöt64_t
Ë
	`øndom
()Ë& 
UINT32_MAX
);

237 
	}
}

244 
uöt32_t
 
	$sb_ønd_deÁu…
(
uöt32_t
 
a
, uöt32_à
b
)

246  
	`ønd_func
(
a
,
b
);

247 
	}
}

251 
uöt32_t
 
	$sb_ønd_unif‹m
(
uöt32_t
 
a
, uöt32_à
b
)

253  
a
 + 
	`sb_ønd_unif‹m_doubÀ
(Ë* (
b
 -á + 1);

254 
	}
}

258 
uöt32_t
 
	$sb_ønd_gaussün
(
uöt32_t
 
a
, uöt32_à
b
)

260 
sum
;

261 
t
;

262 
i
;

264 
t
 = 
b
 - 
a
 + 1;

265 
i
=0, 
sum
=0; i < 
ønd_ôî
; i++)

266 
sum
 +
	`sb_ønd_unif‹m_doubÀ
(Ë* 
t
;

268  
a
 + (
uöt32_t
Ë(
sum
 * 
ønd_ôî_mu…
) ;

269 
	}
}

273 
uöt32_t
 
	$sb_ønd_•ecül
(
uöt32_t
 
a
, uöt32_à
b
)

275 
sum
;

276 
t
;

277 
ønge_size
;

278 
ªs
;

279 
d
;

280 
∫d
;

281 
i
;

283 
t
 = 
b
 - 
a
;

286 
ønge_size
 = 
t
 * 
ønd_ªs_mu…
;

289 
∫d
 = 
	`sb_ønd_unif‹m_doubÀ
();

291 
ªs
 = 
∫d
 * 
ønge_size
;

297 i‡(
ªs
 < 
t
)

299 
sum
 = 0.0;

301 
i
 = 0; i < 
ønd_ôî
; i++)

302 
sum
 +
	`sb_ønd_unif‹m_doubÀ
();

304  
a
 + 
sum
 * 
t
 * 
ønd_ôî_mu…
;

314 
d
 = 
t
 * 
ønd_p˘_mu…
;

315 
ªs
 = 
∫d
 * (
d
 + 1);

316 
ªs
 +
t
 / 2 -Å * 
ønd_p˘_2_mu…
;

318  
a
 + (
uöt32_t
Ë
ªs
;

319 
	}
}

323 
uöt32_t
 
	$sb_ønd_∑ªto
(
uöt32_t
 
a
, uöt32_à
b
)

325  
a
 + (
uöt32_t
Ë((
b
 -á + 1) *

326 
	`pow
(
	`sb_ønd_unif‹m_doubÀ
(), 
∑ªto_powî
));

327 
	}
}

331 
	$sb_ønd_°r
(c⁄° *
fmt
, *
buf
)

333 
i
;

335 
i
=0; 
fmt
[i] != '\0'; i++)

337 i‡(
fmt
[
i
] == '#')

338 
buf
[
i
] = 
	`sb_ønd_unif‹m
('0', '9');

339 i‡(
fmt
[
i
] == '@')

340 
buf
[
i
] = 
	`sb_ønd_unif‹m
('a', 'z');

342 
buf
[
i
] = 
fmt
[i];

344 
	}
}

352 
uöt32_t
 
	$sb_ønd_v¨°r
(*
buf
, 
uöt32_t
 
mö_Àn
, uöt32_à
max_Àn
)

354 
i
;

355 
uöt32_t
 
num_ch¨s
;

356 i‡(
max_Àn
 == 0) {

359 i‡(
mö_Àn
 > 
max_Àn
)

361 
mö_Àn
 = 1;

364 
num_ch¨s
 = 
	`sb_ønd_unif‹m
(
mö_Àn
, 
max_Àn
);

365 
i
=0; i < 
num_ch¨s
; i++)

367 
buf
[
i
] = 
	`sb_ønd_unif‹m
('0', 'z');

369  
num_ch¨s
;

370 
	}
}

377 
uöt32_t
 
	$ønd_unique_≥rmuã
(
uöt32_t
 
x
)

379 c⁄° 
uöt32_t
 
¥ime
 = 
	`UINT32_C
(4294967291);

381 i‡(
x
 >
¥ime
)

382  
x
;

384 
uöt32_t
 
ªsidue
 = ((
uöt64_t
Ë
x
 * xË% 
¥ime
;

385  (
x
 <
¥ime
 / 2Ë? 
ªsidue
 :Örime -Ñesidue;

386 
	}
}

389 
	$ønd_unique_£ed
(
uöt32_t
 
ödex
, uöt32_à
off£t
)

391 
ønd_unique_ödex
 = 
	`ønd_unique_≥rmuã
‘™d_unique_≥rmuã(
ödex
) +

393 
ønd_unique_off£t
 = 
	`ønd_unique_≥rmuã
‘™d_unique_≥rmuã(
off£t
) +

395 
	}
}

399 
uöt32_t
 
	$sb_ønd_unique
()

401 
uöt32_t
 
ödex
 = 
	`ck_¥_Áa_32
(&
ønd_unique_ödex
, 1);

403  
	`ønd_unique_≥rmuã
(‘™d_unique_≥rmuã(
ödex
Ë+ 
ønd_unique_off£t
) ^

405 
	}
}

419 
uöt32_t
 
	$sb_ønd_zùfün_öt
(
uöt32_t
 
n
, 
e
, 
s
,

420 
hI¡egølX1
)

443 c⁄° 
hI¡egølNumbîOfEÀmíts
 = 
	`hI¡egøl
(
n
 + 0.5, 
e
);

447 
u
 = 
hI¡egølNumbîOfEÀmíts
 + 
	`sb_ønd_unif‹m_doubÀ
() *

448 (
hI¡egølX1
 - 
hI¡egølNumbîOfEÀmíts
);

451 
x
 = 
	`hI¡egølInvî£
(
u
, 
e
);

452 
uöt32_t
 
k
 = (uöt32_tË(
x
 + 0.5);

458 i‡(
	`SB_UNLIKELY
(
k
 < 1))

459 
k
 = 1;

460 i‡(
	`SB_UNLIKELY
(
k
 > 
n
))

461 
k
 = 
n
;

472 i‡(
k
 - 
x
 <
s
 || 
u
 >
	`hI¡egøl
(k + 0.5, 
e
Ë- 
	`h
(k,É))

511  
k
;

514 
	}
}

516 
uöt32_t
 
	$sb_ønd_zùfün
(
uöt32_t
 
a
, uöt32_à
b
)

519  
a
 +

520 
	`sb_ønd_zùfün_öt
(
b
 - 
a
 + 1, 
zùf_exp
, 
zùf_s
, 
zùf_hI¡egølX1
) - 1;

521 
	}
}

532 
	$hI¡egøl
(
x
, 
e
)

534 c⁄° 
logX
 = 
	`log
(
x
);

535  
	`hñ≥r2
((1 - 
e
Ë* 
logX
) *ÜogX;

536 
	}
}

540 
	$h
(
x
, 
e
)

542  
	`exp
(-
e
 * 
	`log
(
x
));

543 
	}
}

547 
	$hI¡egølInvî£
(
x
, 
e
)

549 
t
 = 
x
 * (1 -
e
);

550 i‡(
t
 < -1)

556 
t
 = -1;

559  
	`exp
(
	`hñ≥r1
(
t
Ë* 
x
);

560 
	}
}

568 
	$hñ≥r1
(
x
)

570 i‡(
	`Ábs
(
x
) > 1e-8)

571  
	`log1p
(
x
) / x;

573  1 - 
x
 * (0.5 - x * (0.33333333333333333 - 0.25 * x));

574 
	}
}

582 
	$hñ≥r2
(
x
)

584 i‡(
	`Ábs
(
x
) > 1e-8)

585  
	`expm1
(
x
) / x;

587  1 + 
x
 * 0.5 * (1 + x * 0.33333333333333333 * (1 + 0.25 * x));

588 
	}
}

	@sb_rand.h

19 #i‚de‡
SB_RAND_H


20 
	#SB_RAND_H


	)

22 
	~<°dlib.h
>

24 
	~"x‹oshúo128∂us.h
"

29 
	mDIST_TYPE_UNIFORM
,

30 
	mDIST_TYPE_GAUSSIAN
,

31 
	mDIST_TYPE_SPECIAL
,

32 
	mDIST_TYPE_PARETO
,

33 
	mDIST_TYPE_ZIPFIAN


34 } 
	tønd_di°_t
;

36 
uöt64_t
 
	tsb_∫g_°©e_t
 [2];

39 
sb_ønd_£ed
;

42 
TLS
 
sb_∫g_°©e_t
 
sb_∫g_°©e
;

45 
ölöe
 
uöt64_t
 
	$sb_ønd_unif‹m_uöt64
()

47  
	`x‹oshúo_√xt
(
sb_∫g_°©e
);

48 
	}
}

51 
ölöe
 
	$sb_ønd_unif‹m_doubÀ
()

53 c⁄° 
uöt64_t
 
x
 = 
	`sb_ønd_unif‹m_uöt64
();

54 c⁄° uni⁄ { 
uöt64_t
 
i
; 
d
; } 
u
 = { .ò
	`UINT64_C
(0x3FFË<< 52 | 
x
 >> 12 };

56  
u
.
d
 - 1.0;

57 
	}
}

59 
sb_ønd_ªgi°î
();

60 
sb_ønd_¥öt_hñp
();

61 
sb_ønd_öô
();

62 
sb_ønd_d⁄e
();

63 
sb_ønd_thªad_öô
();

66 
uöt32_t
 
sb_ønd_deÁu…
(uint32_t, uint32_t);

67 
uöt32_t
 
sb_ønd_unif‹m
(uint32_t, uint32_t);

68 
uöt32_t
 
sb_ønd_gaussün
(uint32_t, uint32_t);

69 
uöt32_t
 
sb_ønd_•ecül
(uint32_t, uint32_t);

70 
uöt32_t
 
sb_ønd_∑ªto
(uint32_t, uint32_t);

71 
uöt32_t
 
sb_ønd_zùfün
(uint32_t, uint32_t);

72 
uöt32_t
 
sb_ønd_unique
();

73 
sb_ønd_°r
(const *, *);

74 
uöt32_t
 
sb_ønd_v¨°r
(*, uint32_t, uint32_t);

	@sb_thread.c

24 #ifde‡
HAVE_CONFIG_H


25 
	~"c⁄fig.h
"

28 #ifde‡
HAVE_PTHREAD_H


29 
	~<±hªad.h
>

32 #i‚de‡
HAVE_PTHREAD_CANCEL


33 
	~<sig«l.h
>

36 
	~"sb_thªad.h
"

37 
	~"sb_ønd.h
"

38 
	~"sb_loggî.h
"

39 
	~"sysbích.h
"

40 
	~"sb_ck_¥.h
"

42 
±hªad_©å_t
 
	gsb_thªad_©å
;

45 
sb_thªad_˘xt_t
 *
	gthªads
;

48 
	gthªad_°ack_size
;

50 
	$sb_thªad_öô
()

52 
thªad_°ack_size
 = 
	`sb_gë_vÆue_size
("thread-stack-size");

53 i‡(
thªad_°ack_size
 <= 0)

55 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹Åhªad-°ack-size: %d.\n", 
thªad_°ack_size
);

60 
	`±hªad_©å_öô
(&
sb_thªad_©å
);

61 #ifde‡
PTHREAD_SCOPE_SYSTEM


62 
	`±hªad_©å_£tsc›e
(&
sb_thªad_©å
,
PTHREAD_SCOPE_SYSTEM
);

64 
	`±hªad_©å_£t°acksize
(&
sb_thªad_©å
, 
thªad_°ack_size
);

66 #ifde‡
HAVE_THR_SETCONCURRENCY


68 
	`thr_£tc⁄cuºícy
(
sb_globÆs
.
thªads
);

71 
thªads
 = 
	`mÆloc
(
sb_globÆs
.thªad†* (
sb_thªad_˘xt_t
));

72 i‡(
thªads
 =
NULL
)

74 
	`log_ãxt
(
LOG_FATAL
, "Memoryállocation failure.\n");

75  
EXIT_FAILURE
;

78  
EXIT_SUCCESS
;

79 
	}
}

81 
	$sb_thªad_d⁄e
()

83 i‡(
thªads
 !
NULL
)

84 
	`‰ì
(
thªads
);

85 
	}
}

87 #i‚de‡
HAVE_PTHREAD_CANCEL


88 
	#PTHREAD_CANCELED
 ((*Ë-1)

	)

90 
	ssb_thªad_¥oxy
 {

91 *(*
	m°¨t_routöe
) (*);

92 *
	m¨g
;

95 
	gthªad_ˇn˚l_sig«l
 = 
SIGUSR1
;

97 
	$thªad_ˇn˚l_h™dÀr
(
sig
)

99 i‡(
sig
 =
thªad_ˇn˚l_sig«l
)

100 
	`±hªad_exô
(
PTHREAD_CANCELED
);

101 
	}
}

103 
	$ö°Æl_thªad_sig«l_h™dÀr
() {

104 
siga˘i⁄
 
a˘i⁄
;

105 
	`mem£t
(&
a˘i⁄
, 0, (action));

106 
	`sigem±y£t
(&
a˘i⁄
.
ß_mask
);

107 
a˘i⁄
.
ß_Êags
 = 0;

108 
a˘i⁄
.
ß_h™dÀr
 = 
thªad_ˇn˚l_h™dÀr
;

109  
	`siga˘i⁄
(
thªad_ˇn˚l_sig«l
, &
a˘i⁄
, 
NULL
);

110 
	}
}

112 * 
	$thªad_°¨t_routöe_¥oxy
(*
¨g
) {

113 
sb_thªad_¥oxy
 *
¥oxy
 = 
¨g
;

114 *(*
°¨t_routöe
Ë(*Ë
¥oxy
->start_routine;

115 *
ªÆ_¨g
 = 
¥oxy
->
¨g
;

116 
	`‰ì
(
¥oxy
);

117 
	`ö°Æl_thªad_sig«l_h™dÀr
();

118  
	`°¨t_routöe
(
ªÆ_¨g
);

119 
	}
}

122 
	$sb_thªad_¸óã
(
±hªad_t
 *
thªad
, c⁄° 
±hªad_©å_t
 *
©å
,

123 *(*
°¨t_routöe
Ë(*), *
¨g
)

125 #ifde‡
HAVE_PTHREAD_CANCEL


126  
	`±hªad_¸óã
(
thªad
, 
©å
, 
°¨t_routöe
, 
¨g
);

128 
sb_thªad_¥oxy
 *
¥oxy
 = 
	`mÆloc
((sb_thread_proxy));

129 i‡(!
¥oxy
)

131  
EXIT_FAILURE
;

133 
¥oxy
->
°¨t_routöe
 = start_routine;

134 
¥oxy
->
¨g
 =árg;

135 
rv
 = 
	`±hªad_¸óã
(
thªad
, 
©å
, 
thªad_°¨t_routöe_¥oxy
, 
¥oxy
);

136 i‡(
rv
)

138 
	`‰ì
(
¥oxy
);

140  
rv
;

142 
	}
}

144 
	$sb_thªad_joö
(
±hªad_t
 
thªad
, **
ªtvÆ
)

146  
	`±hªad_joö
(
thªad
, 
ªtvÆ
);

147 
	}
}

149 
	$sb_thªad_ˇn˚l
(
±hªad_t
 
thªad
)

151 #ifde‡
HAVE_PTHREAD_CANCEL


152  
	`±hªad_ˇn˚l
(
thªad
);

154  
	`±hªad_kûl
(
thªad
, 
thªad_ˇn˚l_sig«l
);

156 
	}
}

158 
	$sb_thªad_¸óã_w‹kîs
(*(*
w‹kî_routöe
)(*))

160 
i
;

162 
	`log_ãxt
(
LOG_NOTICE
, "Initializing workerÅhreads...\n");

164 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

166 
thªads
[
i
].
id
 = i;

170 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

172 
îr
;

174 i‡((
îr
 = 
	`sb_thªad_¸óã
(&(
thªads
[
i
].
thªad
), &
sb_thªad_©å
,

175 
w‹kî_routöe
, (*)(
thªads
 + 
i
))) != 0)

177 
	`log_î∫o
(
LOG_FATAL
, "sb_thªad_¸óã(Ëf‹Åhªad #%d faûed.", 
i
);

178  
EXIT_FAILURE
;

182  
EXIT_SUCCESS
;

183 
	}
}

186 
	$sb_thªad_joö_w‹kîs
()

188 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

190 
îr
;

192 if((
îr
 = 
	`sb_thªad_joö
(
thªads
[
i
].
thªad
, 
NULL
)) != 0)

193 
	`log_î∫o
(
LOG_FATAL
, "sb_thªad_joö(Ëf‹Åhªad #%d faûed.", 
i
);

195 
	`ck_¥_dec_uöt
(&
sb_globÆs
.
thªads_ru¬ög
);

198  
EXIT_SUCCESS
;

199 
	}
}

	@sb_thread.h

24 #i‚de‡
SB_THREAD_H


25 
	#SB_THREAD_H


	)

27 #ifde‡
HAVE_CONFIG_H


28 
	~"c⁄fig.h
"

31 #ifde‡
HAVE_PTHREAD_H


32 
	~<±hªad.h
>

39 
±hªad_t
 
	mthªad
;

40 
	mid
;

41 } 
	tsb_thªad_˘xt_t
;

43 
±hªad_©å_t
 
sb_thªad_©å
;

45 
sb_thªad_¸óã
(
±hªad_t
 *
thªad
, c⁄° 
±hªad_©å_t
 *
©å
,

46 *(*
°¨t_routöe
Ë(*), *
¨g
);

48 
sb_thªad_joö
(
±hªad_t
 
thªad
, **
ªtvÆ
);

50 
sb_thªad_ˇn˚l
(
±hªad_t
 
thªad
);

52 
sb_thªad_¸óã_w‹kîs
(*(*
w‹kî_routöe
)(*));

54 
sb_thªad_joö_w‹kîs
();

56 
sb_thªad_öô
();

58 
sb_thªad_d⁄e
();

	@sb_timer.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
STDC_HEADERS


24 
	~<°dlib.h
>

27 #ifde‡
HAVE_STRING_H


28 
	~<°rög.h
>

31 
	~"sb_loggî.h
"

32 
	~"sb_timî.h
"

33 
	~"sb_utû.h
"

39 
	$sb_timî_öô
(
sb_timî_t
 *
t
)

41 
	`SB_COMPILE_TIME_ASSERT
((
sb_timî_t
Ë% 
CK_MD_CACHELINE
 == 0);

43 
	`mem£t
(&
t
->
time_°¨t
, 0, (
time•ec
));

44 
	`mem£t
(&
t
->
time_íd
, 0, (
time•ec
));

46 
	`ck_•ölock_öô
(&
t
->
lock
);

48 
	`sb_timî_ª£t
(
t
);

49 
	}
}

53 
	$sb_timî_ª£t
(
sb_timî_t
 *
t
)

55 
t
->
mö_time
 = 
UINT64_MAX
;

56 
t
->
max_time
 = 0;

57 
t
->
sum_time
 = 0;

58 
t
->
evíts
 = 0;

59 
t
->
queue_time
 = 0;

60 
	}
}

64 
	$sb_timî_c›y
(
sb_timî_t
 *
to
, sb_timî_à*
‰om
)

66 
	`mem˝y
(
to
, 
‰om
, (
sb_timî_t
));

68 
	`ck_•ölock_öô
(&
to
->
lock
);

69 
	}
}

73 
boﬁ
 
	$sb_timî_ru¬ög
(
sb_timî_t
 *
t
)

75  
	`TIMESPEC_DIFF
(
t
->
time_°¨t
,Å->
time_íd
) > 0;

76 
	}
}

84 
uöt64_t
 
	$sb_timî_cuºít
(
sb_timî_t
 *
t
)

86 
time•ec
 
tmp
;

87 
uöt64_t
 
ªs
;

89 
	`SB_GETTIME
(&
tmp
);

90 
ªs
 = 
	`TIMESPEC_DIFF
(
tmp
, 
t
->
time_°¨t
);

91 
t
->
time_°¨t
 = 
tmp
;

93  
ªs
;

94 
	}
}

101 
	$sb_timî_checkpoöt
(
sb_timî_t
 *
t
, sb_timî_à*
ﬁd
)

103 
	`ck_•ölock_lock
(&
t
->
lock
);

105 
	`mem˝y
(
ﬁd
, 
t
, (*old));

106 
	`ck_•ölock_öô
(&
ﬁd
->
lock
);

108 
	`sb_timî_ª£t
(
t
);

110 
	`ck_•ölock_u∆ock
(&
t
->
lock
);

111 
	}
}

116 
uöt64_t
 
	$sb_timî_avg
(
sb_timî_t
 *
t
)

118 if(
t
->
evíts
 == 0)

120  (
t
->
sum_time
 /Å->
evíts
);

121 
	}
}

127 
uöt64_t
 
	$sb_timî_sum
(
sb_timî_t
 *
t
)

129  
t
->
sum_time
;

130 
	}
}

136 
uöt64_t
 
	$sb_timî_mö
(
sb_timî_t
 *
t
)

138 i‡(
t
->
evíts
 == 0)

140  
t
->
mö_time
;

141 
	}
}

147 
uöt64_t
 
	$sb_timî_max
(
sb_timî_t
 *
t
)

149  
t
->
max_time
;

150 
	}
}

156 
sb_timî_t
 
	$sb_timî_mîge
(
sb_timî_t
 *
t1
, sb_timî_à*
t2
)

158 
sb_timî_t
 
t
;

161 
	`mem£t
(&
t
, 0, (
sb_timî_t
));

163 
t
.
sum_time
 = 
t1
->sum_time+
t2
->sum_time;

164 
t
.
evíts
 = 
t1
->evíts+
t2
->events;

166 i‡(
t1
->
max_time
 > 
t2
->max_time)

167 
t
.
max_time
 = 
t1
->max_time;

169 
t
.
max_time
 = 
t2
->max_time;

171 i‡(
t1
->
mö_time
<
t2
->min_time)

172 
t
.
mö_time
 = 
t1
->min_time;

174 
t
.
mö_time
 = 
t2
->min_time;

176  
t
;

177 
	}
}

	@sb_timer.h

19 #i‚de‡
SB_TIMER_H


20 
	#SB_TIMER_H


	)

22 #ifde‡
HAVE_CONFIG_H


23 
	~"c⁄fig.h
"

26 #ifde‡
TIME_WITH_SYS_TIME


27 
	~<sys/time.h
>

28 
	~<time.h
>

30 #i‡
HAVE_SYS_TIME_H


31 
	~<sys/time.h
>

33 
	~<time.h
>

37 
	~<°döt.h
>

38 
	~<°dboﬁ.h
>

40 
	~"sb_utû.h
"

41 
	~"ck_•ölock.h
"

43 
	#NS_PER_SEC
 1000000000

	)

44 
	#US_PER_SEC
 1000000

	)

45 
	#MS_PER_SEC
 1000

	)

46 
	#NS_PER_MS
 (
NS_PER_SEC
 / 
MS_PER_SEC
)

	)

49 
	#NS2SEC
(
n£c
Ë(“£cË/ (Ë
NS_PER_SEC
)

	)

50 
	#SEC2NS
(
£c
Ë((
uöt64_t
Ë(£cË* 
NS_PER_SEC
)

	)

53 
	#NS2MS
(
n£c
Ë(“£cË/ (Ë
NS_PER_MS
)

	)

54 
	#MS2NS
(
£c
Ë((£cË* (
uöt64_t
Ë
NS_PER_MS
)

	)

57 
	#MS2SEC
(
m£c
Ë((m£cË/ (Ë
MS_PER_SEC
)

	)

58 
	#SEC2MS
(
£c
Ë((£cË* 
MS_PER_SEC
)

	)

61 
	#TIMESPEC_DIFF
(
a
,
b
Ë(
	`SEC2NS
◊.
tv_£c
 - b.tv_sec) + \

62 (
a
.
tv_n£c
 - 
b
.tv_n£c))

	)

65 #ifde‡
HAVE_CLOCK_GETTIME


66 
	#SB_GETTIME
(
t•
Ë
	`˛ock_gëtime
(
CLOCK_MONOTONIC
,Å•)

	)

68 
	#SB_GETTIME
(
t•
) \

70 
timevÆ
 
tv
; \

71 
	`gëtimeofday
(&
tv
, 
NULL
); \

72 (
t•
)->
tv_£c
 = 
tv
.tv_sec; \

73 (
t•
)->
tv_n£c
 = 
tv
.
tv_u£c
 * 1000; \

74 } 0)

	)

77 íum {
	mTIMER_UNINITIALIZED
, 
	mTIMER_INITIALIZED
, 
	mTIMER_STOPPED
, \

78 
	mTIMER_RUNNING
} 
	ttimî_°©e_t
;

84 
time•ec
 
	mtime_°¨t
;

85 
time•ec
 
	mtime_íd
;

86 
uöt64_t
 
	mevíts
;

87 
uöt64_t
 
	mqueue_time
;

88 
uöt64_t
 
	mmö_time
;

89 
uöt64_t
 
	mmax_time
;

90 
uöt64_t
 
	msum_time
;

92 
ck_•ölock_t
 
	mlock
;

94 
	m∑d
[
SB_CACHELINE_PAD
((
time•ec
)*2 + (
uöt64_t
)*5 +

95 (
ck_•ölock_t
))];

96 } 
	tsb_timî_t
;

99 
ölöe
 
	$sb_«no¶ìp
(
uöt64_t
 
ns
)

101 
time•ec
 
ts
 = { 
ns
 / 
NS_PER_SEC
,Çs % NS_PER_SEC };

102  
	`«no¶ìp
(&
ts
, 
NULL
);

103 
	}
}

108 
sb_timî_öô
(
sb_timî_t
 *);

111 
sb_timî_ª£t
(
sb_timî_t
 *
t
);

114 
boﬁ
 
sb_timî_ru¬ög
(
sb_timî_t
 *
t
);

117 
ölöe
 
	$sb_timî_°¨t
(
sb_timî_t
 *
t
)

119 
	`ck_•ölock_lock
(&
t
->
lock
);

121 
	`SB_GETTIME
(&
t
->
time_°¨t
);

123 
	`ck_•ölock_u∆ock
(&
t
->
lock
);

124 
	}
}

127 
ölöe
 
uöt64_t
 
	$sb_timî_°›
(
sb_timî_t
 *
t
)

129 
	`ck_•ölock_lock
(&
t
->
lock
);

131 
	`SB_GETTIME
(&
t
->
time_íd
);

133 
uöt64_t
 
ñ≠£d
 = 
	`TIMESPEC_DIFF
(
t
->
time_íd
,Å->
time_°¨t
Ë+Å->
queue_time
;

135 
t
->
evíts
++;

136 
t
->
sum_time
 +
ñ≠£d
;

138 i‡(
	`SB_UNLIKELY
(
ñ≠£d
 < 
t
->
mö_time
))

139 
t
->
mö_time
 = 
ñ≠£d
;

140 i‡(
	`SB_UNLIKELY
(
ñ≠£d
 > 
t
->
max_time
))

141 
t
->
max_time
 = 
ñ≠£d
;

143 
	`ck_•ölock_u∆ock
(&
t
->
lock
);

145  
ñ≠£d
;

146 
	}
}

152 
ölöe
 
uöt64_t
 
	$sb_timî_vÆue
(
sb_timî_t
 *
t
)

154 
time•ec
 
ts
;

156 
	`SB_GETTIME
(&
ts
);

157  
	`TIMESPEC_DIFF
(
ts
, 
t
->
time_°¨t
Ë+Å->
queue_time
;

158 
	}
}

161 
sb_timî_c›y
(
sb_timî_t
 *
to
, sb_timî_à*
‰om
);

168 
uöt64_t
 
sb_timî_cuºít
(
sb_timî_t
 *
t
);

174 
sb_timî_checkpoöt
(
sb_timî_t
 *
t
, sb_timî_à*
ﬁd
);

177 
uöt64_t
 
sb_timî_avg
(
sb_timî_t
 *);

180 
uöt64_t
 
sb_timî_sum
(
sb_timî_t
 *);

183 
uöt64_t
 
sb_timî_mö
(
sb_timî_t
 *);

186 
uöt64_t
 
sb_timî_max
(
sb_timî_t
 *);

189 
sb_timî_t
 
sb_timî_mîge
(sb_timer_t *, sb_timer_t *);

	@sb_util.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
STDC_HEADERS


24 
	~<°dlib.h
>

25 
	~<öây≥s.h
>

28 #ifde‡
HAVE_UNISTD_H


29 
	~<uni°d.h
>

32 
	~"sb_utû.h
"

33 
	~"sb_loggî.h
"

40 *
	$sb_memÆign
(
size_t
 
size
, size_à
Æignmít
)

42 *
buf
;

44 #ifde‡
HAVE_POSIX_MEMALIGN


45 
ªt

	`posix_memÆign
(&
buf
, 
Æignmít
, 
size
);

46 i‡(
ªt
 != 0)

47 
buf
 = 
NULL
;

48 #ñi‡
	`deföed
(
HAVE_MEMALIGN
)

49 
buf
 = 
	`memÆign
(
Æignmít
, 
size
);

50 #ñi‡
	`deföed
(
HAVE_VALLOC
)

52 (Ë
Æignmít
;

53 
buf„r
 = 
	`vÆloc
(
size
);

55 #îr‹ 
C™nŸ
 
föd
 
™
 
Æig√d
 
Æloˇti⁄
 
libøry
 
fun˘i⁄
!

58  
buf
;

59 
	}
}

63 
size_t
 
	$sb_gë∑gesize
()

65 #ifde‡
_SC_PAGESIZE


66  
	`sysc⁄f
(
_SC_PAGESIZE
);

68  
	`gë∑gesize
();

70 
	}
}

	@sb_util.h

19 #i‚de‡
SB_UTIL_H


20 
	#SB_UTIL_H


	)

26 #ifde‡
HAVE_CONFIG_H


27 
	~"c⁄fig.h
"

30 #ifde‡
HAVE_UNISTD_H


31 
	~<uni°d.h
>

34 
	~"ck_md.h
"

35 
	~"ck_cc.h
"

37 #ifde‡
HAVE_FUNC_ATTRIBUTE_FORMAT


38 
	#SB_ATTRIBUTE_FORMAT
(
°yÀ
, 
m
, 
n
Ë
	`__©åibuã__
((
	`f‹m©
(°yÀ, m,Ç)))

	)

40 
	#SB_ATTRIBUTE_FORMAT
(
°yÀ
, 
m
, 
n
)

	)

43 #ifde‡
HAVE_FUNC_ATTRIBUTE_UNUSED


44 
	#SB_ATTRIBUTE_UNUSED
 
	`__©åibuã__
((
unu£d
))

	)

46 
	#SB_ATTRIBUTE_UNUSED


	)

49 #i‡
deföed
(
__MACH__
)

50 
	#DLEXT
 ".dylib"

	)

52 
	#DLEXT
 ".so"

	)

59 
	#SB_ALIGN
(
n
, 
m
Ë((“Ë+ ((mË- 1)Ë& ~((mË- 1))

	)

65 
	#SB_PAD
(
n
, 
m
Ë(
	`SB_ALIGN
(“),(m)Ë- (n))

	)

68 
	#SB_CACHELINE_PAD
(
n
Ë(
	`SB_PAD
(“), 
CK_MD_CACHELINE
))

	)

71 #ifde‡
__GNUC__


72 
	#SB_MIN
(
a
,
b
) \

73 ({ 
	`__ty≥of__
 (
a
Ë
_a
 = (a); \

74 
	`__ty≥of__
 (
b
Ë
_b
 = (b); \

75 
_a
 < 
_b
 ? _®: _b; })

	)

76 
	#SB_MAX
(
a
,
b
) \

77 ({ 
	`__ty≥of__
 (
a
Ë
_a
 = (a); \

78 
	`__ty≥of__
 (
b
Ë
_b
 = (b); \

79 
_a
 > 
_b
 ? _®: _b; })

	)

81 
	#SB_MIN
(
a
,
b
Ë((◊Ë< (b)Ë? (aË: (b))

	)

82 
	#SB_MAX
(
a
,
b
Ë((◊Ë> (b)Ë? (aË: (b))

	)

85 
	#SB_LIKELY
(
x
Ë
	`CK_CC_LIKELY
(x)

	)

86 
	#SB_UNLIKELY
(
x
Ë
	`CK_CC_UNLIKELY
(x)

	)

89 #ifde‡
__GNUC__


90 
	#SB_MEMBER_TYPE
(
ty≥
, 
membî
Ë
	`__ty≥of__
 ((—y≥ *)0)->membî)

	)

92 
	#SB_MEMBER_TYPE
(
ty≥
, 
membî
Ëc⁄° 

	)

95 
	#SB_CONTAINER_OF
(
±r
, 
ty≥
, 
membî
) ((type *)(*)( \

96 (*)(
	`SB_MEMBER_TYPE
(
ty≥
, 
membî
Ë*){ 
±r
 } - 
	`off£tof
—y≥, membî)))

	)

99 
	#SB_COMPILE_TIME_ASSERT
(
ex¥
) \

101 
	t˘a
[(
ex¥
Ë? 1 : -1] 
	tSB_ATTRIBUTE_UNUSED
; \

102 } 0)

	)

104 #ifde‡
HAVE_ISATTY


105 
	#SB_ISATTY
(Ë
	`ißây
(0)

	)

107 #îr‹ 
No
 
ißây
(Ë
im∂emíèti⁄
 
this
 
∂©f‹m
!

114 *
sb_memÆign
(
size_t
 
size
, size_à
Æignmít
);

117 
size_t
 
sb_gë∑gesize
();

	@sysbench.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
STDC_HEADERS


24 
	~<°dio.h
>

25 
	~<°dlib.h
>

28 #ifde‡
HAVE_STRING_H


29 
	~<°rög.h
>

31 #ifde‡
HAVE_STRINGS_H


32 
	~<°rögs.h
>

35 #ifde‡
HAVE_UNISTD_H


36 
	~<uni°d.h
>

37 
	~<sys/ty≥s.h
>

39 #ifde‡
HAVE_SYS_STAT_H


40 
	~<sys/°©.h
>

42 #ifde‡
HAVE_ERRNO_H


43 
	~<î∫o.h
>

45 #ifde‡
HAVE_FCNTL_H


46 
	~<f˙é.h
>

48 #ifde‡
HAVE_PTHREAD_H


49 
	~<±hªad.h
>

51 #ifde‡
HAVE_THREAD_H


52 
	~<thªad.h
>

54 #ifde‡
HAVE_MATH_H


55 
	~<m©h.h
>

57 #ifde‡
HAVE_SCHED_H


58 
	~<sched.h
>

60 #ifde‡
HAVE_SIGNAL_H


61 
	~<sig«l.h
>

63 #ifde‡
HAVE_LIMITS_H


64 
	~<limôs.h
>

67 
	~<luajô.h
>

69 
	~"sysbích.h
"

70 
	~"sb_›ti⁄s.h
"

71 
	~"sb_lua.h
"

72 
	~"db_drivî.h
"

73 
	~"sb_ønd.h
"

74 
	~"sb_thªad.h
"

75 
	~"sb_b¨rõr.h
"

77 
	~"ck_cc.h
"

78 
	~"ck_rög.h
"

80 
	#VERSION_STRING
 
PACKAGE
" "
PACKAGE_VERSION
 
SB_GIT_SHA


	)

83 
	#MAX_QUEUE_LEN
 131072

	)

89 
	#SB_BACKGROUND_THREAD_ID
 
sb_globÆs
.
thªads


	)

92 
sb_¨g_t
 
	ggíîÆ_¨gs
[] =

94 
SB_OPT
("thªads", "numbî o‡thªad†tÿu£", "1", 
INT
),

95 
SB_OPT
("evíts", "limô f‹ÅŸÆÇumbî o‡evíts", "0", 
INT
),

96 
SB_OPT
("time", "limô f‹ÅŸÆÉxecuti⁄Åimêö sec⁄ds", "10", 
INT
),

97 
SB_OPT
("warmup-time", "executeÉvents forÅhis many seconds with statistics "

99 "0", 
INT
),

100 
SB_OPT
("forced-shutdown",

102 "shutdown, o∏'off'ÅÿdißbÀ", "off", 
STRING
),

103 
SB_OPT
("thªad-°ack-size", "sizêo‡°ackÖîÅhªad", "64K", 
SIZE
),

104 
SB_OPT
("thªad-öô-timeout", "waôÅimêö sec⁄d†f‹ w‹kîÅhªad†tÿöôülize", "30", 
INT
),

105 
SB_OPT
("øã", "avîagêå™ß˘i⁄†øã. 0 f‹ u∆imôedÑ©e", "0", 
INT
),

106 
SB_OPT
("report-interval", "periodicallyÑeport intermediate statistics with "

108 "0", 
INT
),

109 
SB_OPT
("report-checkpoints", "dump full statisticsándÑesetáll countersát "

113 "checkpoöt†¨êof‡by deÁu….", "", 
LIST
),

114 
SB_OPT
("debug", "¥öàm‹êdebuggög info", "off", 
BOOL
),

115 
SB_OPT
("vÆid©e", "≥rf‹m vÆid©i⁄ check†whîêpossibÀ", "off", 
BOOL
),

116 
SB_OPT
("hñp", "¥öàhñ∞™dÉxô", "off", 
BOOL
),

117 
SB_OPT
("vîsi⁄", "¥öàvîsi⁄ándÉxô", "off", 
BOOL
),

118 
SB_OPT
("c⁄fig-fûe", "Fûêc⁄èöög comm™dÜöê›ti⁄s", 
NULL
, 
FILE
),

119 
SB_OPT
("luajit-cmd", "perform LuaJIT control command. This option is "

121 "öf‹m©i⁄", 
NULL
, 
STRING
),

123 
SB_OPT_END


127 
sb_li°_t
 
	gã°s
;

130 
sb_globÆs_t
 
	gsb_globÆs
;

131 
sb_ã°_t
 *
	gcuºít_ã°
;

134 
sb_b¨rõr_t
 
	gw‹kî_b¨rõr
;

137 
	gthªad_öô_timeout
;

140 
sb_b¨rõr_t
 
	gªp‹t_b¨rõr
;

143 
±hªad_muãx_t
 
	gqueue_muãx
;

144 
±hªad_c⁄d_t
 
	gqueue_c⁄d
;

145 
uöt64_t
 
	gqueue_¨øy
[
MAX_QUEUE_LEN
] 
	gCK_CC_CACHELINE
;

146 
ck_rög_buf„r_t
 
	gqueue_rög_buf„r
[
MAX_QUEUE_LEN
] 
	gCK_CC_CACHELINE
;

147 
ck_rög_t
 
queue_rög
 
	gCK_CC_CACHELINE
;

149 
ªp‹t_thªad_¸óãd
 
	gCK_CC_CACHELINE
;

150 
	gcheckpoöts_thªad_¸óãd
;

151 
	gevítgí_thªad_¸óãd
;

154 
sb_timî_t
 *
	gtimîs
;

157 
sb_timî_t
 *
	gtimîs_c›y
;

160 
sb_timî_t
 
sb_exec_timî
 
	gCK_CC_CACHELINE
;

163 
sb_timî_t
 
sb_öãrmedüã_timî
 
	gCK_CC_CACHELINE
;

164 
sb_timî_t
 
sb_checkpoöt_timî
 
	gCK_CC_CACHELINE
;

166 
TLS
 
	gsb_és_thªad_id
;

168 
¥öt_hódî
();

169 
¥öt_hñp
();

170 
¥öt_run_mode
(
sb_ã°_t
 *);

172 #ifde‡
HAVE_ALARM


173 
	$sigÆrm_thªad_öô_timeout_h™dÀr
(
sig
)

175 i‡(
sig
 !
SIGALRM
)

178 
	`log_ãxt
(
LOG_FATAL
,

180 
thªad_öô_timeout
);

182 
	`exô
(2);

183 
	}
}

187 
	$sb_ªp‹t_öãrmedüã
(
sb_°©_t
 *
°©
)

189 
	`log_time°amp
(
LOG_NOTICE
, 
°©
->
time_tŸÆ
,

190 "thds: %" 
PRIu32
 "Éps: %4.2fÜat (ms,%u%%): %4.2f",

191 
°©
->
thªads_ru¬ög
,

192 
°©
->
evíts
 / sèt->
time_öãrvÆ
,

193 
sb_globÆs
.
≥r˚¡ûe
,

194 
	`SEC2MS
(
°©
->
œãncy_p˘
));

195 i‡(
sb_globÆs
.
tx_øã
 > 0)

196 
	`log_time°amp
(
LOG_NOTICE
, 
°©
->
time_tŸÆ
,

197 "queuêÀngth: %" 
PRIu64
 " concurrency: %" PRIu64,

198 
°©
->
queue_Àngth
, sèt->
c⁄cuºícy
);

199 
	}
}

202 
	$ªp‹t_gë_comm⁄_°©
(
sb_°©_t
 *
°©
, 
sb_cou¡îs_t
 
˙t
)

204 
	`mem£t
(
°©
, 0, (
sb_°©_t
));

206 
°©
->
thªads_ru¬ög
 = 
sb_globÆs
.threads_running;

208 
°©
->
evíts
 = 
˙t
[
SB_CNT_EVENT
];

209 
°©
->
ªads
 = 
˙t
[
SB_CNT_READ
];

210 
°©
->
wrôes
 = 
˙t
[
SB_CNT_WRITE
];

211 
°©
->
Ÿhî
 = 
˙t
[
SB_CNT_OTHER
];

212 
°©
->
îr‹s
 = 
˙t
[
SB_CNT_ERROR
];

213 
°©
->
ªc⁄√˘s
 = 
˙t
[
SB_CNT_RECONNECT
];

214 
°©
->
byãs_ªad
 = 
˙t
[
SB_CNT_BYTES_READ
];

215 
°©
->
byãs_wrôãn
 = 
˙t
[
SB_CNT_BYTES_WRITTEN
];

217 
°©
->
time_tŸÆ
 = 
	`NS2SEC
(
	`sb_timî_vÆue
(&
sb_exec_timî
)) -

218 
sb_globÆs
.
w¨mup_time
;

219 
	}
}

222 
	$ªp‹t_öãrmedüã
()

224 
sb_°©_t
 
°©
;

225 
sb_cou¡îs_t
 
˙t
;

231 i‡(
	`ck_¥_lﬂd_uöt
(&
sb_globÆs
.
ªp‹t_öãrvÆ
) == 0)

234 
	`sb_cou¡îs_agg_öãrmedüã
(
˙t
);

235 
	`ªp‹t_gë_comm⁄_°©
(&
°©
, 
˙t
);

237 
°©
.
œãncy_p˘
 =

238 
	`MS2SEC
(
	`sb_hi°ogøm_gë_p˘_öãrmedüã
(&
sb_œãncy_hi°ogøm
,

239 
sb_globÆs
.
≥r˚¡ûe
));

241 
°©
.
time_öãrvÆ
 = 
	`NS2SEC
(
	`sb_timî_cuºít
(&
sb_öãrmedüã_timî
));

243 i‡(
sb_globÆs
.
tx_øã
 > 0)

245 
°©
.
queue_Àngth
 = 
	`ck_rög_size
(&
queue_rög
);

246 
°©
.
c⁄cuºícy
 = 
	`ck_¥_lﬂd_öt
(&
sb_globÆs
.concurrency);

249 i‡(
cuºít_ã°
 && cuºít_ã°->
›s
.
ªp‹t_öãrmedüã
)

250 
cuºít_ã°
->
›s
.
	`ªp‹t_öãrmedüã
(&
°©
);

252 
	`sb_ªp‹t_öãrmedüã
(&
°©
);

253 
	}
}

257 
	$sb_ªp‹t_cumuœtive
(
sb_°©_t
 *
°©
)

259 c⁄° 
¡hªads
 = 
sb_globÆs
.
thªads
;

261 i‡(
sb_globÆs
.
f‹˚d_shutdown_ö_¥ogªss
)

271 
unföished
 = 0;

273 
i
 = 0; i < 
¡hªads
; i++)

275 i‡(
	`sb_timî_ru¬ög
(&
timîs_c›y
[
i
]))

277 
unföished
++;

278 
	`sb_timî_°›
(&
timîs_c›y
[
i
]);

282 i‡(
unföished
 > 0)

284 
	`log_ãxt
(
LOG_NOTICE
, "");

285 
	`log_ãxt
(
LOG_NOTICE
, "Number of unfinishedÅransactions on "

286 "f‹˚d shutdown: %u", 
unföished
);

290 
	`log_ãxt
(
LOG_NOTICE
, "");

291 
	`log_ãxt
(
LOG_NOTICE
, "Throughput:");

292 
	`log_ãxt
(
LOG_NOTICE
, "Évents/s (eps): %.4f",

293 
°©
->
evíts
 / sèt->
time_öãrvÆ
);

294 
	`log_ãxt
(
LOG_NOTICE
, "ÅimeÉlapsed: %.4fs",

295 
°©
->
time_tŸÆ
);

296 
	`log_ãxt
(
LOG_NOTICE
, "ÅŸÆÇumbî o‡evíts: %" 
PRIu64
,

297 
°©
->
evíts
);

299 
	`log_ãxt
(
LOG_NOTICE
, "");

301 
	`log_ãxt
(
LOG_NOTICE
, "Latency (ms):");

302 
	`log_ãxt
(
LOG_NOTICE
, " min: %39.2f",

303 
	`SEC2MS
(
°©
->
œãncy_mö
));

304 
	`log_ãxt
(
LOG_NOTICE
, "ávg: %39.2f",

305 
	`SEC2MS
(
°©
->
œãncy_avg
));

306 
	`log_ãxt
(
LOG_NOTICE
, " max: %39.2f",

307 
	`SEC2MS
(
°©
->
œãncy_max
));

309 i‡(
sb_globÆs
.
≥r˚¡ûe
 > 0)

310 
	`log_ãxt
(
LOG_NOTICE
, " %3dthÖercentile: %27.2f",

311 
sb_globÆs
.
≥r˚¡ûe
, 
	`SEC2MS
(
°©
->
œãncy_p˘
));

313 
	`log_ãxt
(
LOG_NOTICE
, "Öercentile stats: disabled");

315 
	`log_ãxt
(
LOG_NOTICE
, " sum: %39.2f",

316 
	`SEC2MS
(
°©
->
œãncy_sum
));

317 
	`log_ãxt
(
LOG_NOTICE
, "");

320 
sb_timî_t
 
t
;

321 
	`sb_timî_öô
(&
t
);

322 
i
 = 0; i < 
¡hªads
; i++)

323 
t
 = 
	`sb_timî_mîge
(&t, &
timîs_c›y
[
i
]);

326 c⁄° 
evíts_avg
 = (Ë
t
.
evíts
 / 
¡hªads
;

327 c⁄° 
time_avg
 = 
°©
->
œãncy_sum
 / 
¡hªads
;

329 
evíts_°ddev
 = 0;

330 
time_°ddev
 = 0;

332 
i
 = 0; i < 
¡hªads
; i++)

334 
diff
 = 
	`Ábs
(
evíts_avg
 - 
timîs_c›y
[
i
].
evíts
);

335 
evíts_°ddev
 +
diff
 * diff;

337 
diff
 = 
	`Ábs
(
time_avg
 - 
	`NS2SEC
(
	`sb_timî_sum
(&
timîs_c›y
[
i
])));

338 
time_°ddev
 +
diff
 * diff;

340 
evíts_°ddev
 = 
	`sqπ
”víts_°ddev / 
¡hªads
);

341 
time_°ddev
 = 
	`sqπ
—ime_°ddev / 
¡hªads
);

343 
	`log_ãxt
(
LOG_NOTICE
, "Threads fairness:");

344 
	`log_ãxt
(
LOG_NOTICE
, "Évents (avg/stddev): %.4f/%3.2f",

345 
evíts_avg
, 
evíts_°ddev
);

346 
	`log_ãxt
(
LOG_NOTICE
, "ÉxecutionÅime (avg/stddev): %.4f/%3.2f",

347 
time_avg
, 
time_°ddev
);

348 
	`log_ãxt
(
LOG_NOTICE
, "");

350 i‡(
sb_globÆs
.
debug
)

352 
	`log_ãxt
(
LOG_DEBUG
, "VerboseÖer-thread statistics:\n");

353 
i
 = 0; i < 
¡hªads
; i++)

355 
	`log_ãxt
(
LOG_DEBUG
, "Åhread #%3d: min: %.4fsávg: %.4fs max: %.4fs "

356 "evíts: %" 
PRIu64
,

357 
i
,

358 
	`NS2SEC
(
	`sb_timî_mö
(&
timîs_c›y
[
i
])),

359 
	`NS2SEC
(
	`sb_timî_avg
(&
timîs_c›y
[
i
])),

360 
	`NS2SEC
(
	`sb_timî_max
(&
timîs_c›y
[
i
])),

361 
timîs_c›y
[
i
].
evíts
);

362 
	`log_ãxt
(
LOG_DEBUG
, " "

364 
	`NS2SEC
(
	`sb_timî_sum
(&
timîs_c›y
[
i
])));

366 
	`log_ãxt
(
LOG_NOTICE
, "");

368 
	}
}

372 
	$checkpoöt
(
sb_°©_t
 *
°©
)

374 
sb_cou¡îs_t
 
˙t
;

376 
	`sb_cou¡îs_agg_cumuœtive
(
˙t
);

377 
	`ªp‹t_gë_comm⁄_°©
(
°©
, 
˙t
);

379 
°©
->
time_öãrvÆ
 = 
	`NS2SEC
(
	`sb_timî_cuºít
(&
sb_checkpoöt_timî
));

381 
°©
->
œãncy_p˘
 =

382 
	`MS2SEC
(
	`sb_hi°ogøm_gë_p˘_checkpoöt
(&
sb_œãncy_hi°ogøm
,

383 
sb_globÆs
.
≥r˚¡ûe
));

386 
size_t
 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

387 
	`sb_timî_checkpoöt
(&
timîs
[
i
], &
timîs_c›y
[i]);

389 
	}
}

391 
	$ªp‹t_cumuœtive
()

393 
sb_°©_t
 
°©
;

394 
sb_timî_t
 
t
;

396 
	`checkpoöt
(&
°©
);

398 
	`sb_timî_öô
(&
t
);

401 
size_t
 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

402 
t
 = 
	`sb_timî_mîge
(&t, &
timîs_c›y
[
i
]);

405 
°©
.
œãncy_mö
 = 
	`NS2SEC
(
	`sb_timî_mö
(&
t
));

406 
°©
.
œãncy_max
 = 
	`NS2SEC
(
	`sb_timî_max
(&
t
));

407 
°©
.
œãncy_avg
 = 
	`NS2SEC
(
	`sb_timî_avg
(&
t
));

408 
°©
.
œãncy_sum
 = 
	`NS2SEC
(
	`sb_timî_sum
(&
t
));

410 i‡(
cuºít_ã°
 && cuºít_ã°->
›s
.
ªp‹t_cumuœtive
)

411 
cuºít_ã°
->
›s
.
	`ªp‹t_cumuœtive
(&
°©
);

413 
	`sb_ªp‹t_cumuœtive
(&
°©
);

414 
	}
}

417 
	$sigÆrm_f‹˚d_shutdown_h™dÀr
(
sig
)

419 i‡(
sig
 !
SIGALRM
)

422 
sb_globÆs
.
f‹˚d_shutdown_ö_¥ogªss
 = 1;

424 
	`sb_timî_°›
(&
sb_exec_timî
);

425 
	`sb_timî_°›
(&
sb_öãrmedüã_timî
);

426 
	`sb_timî_°›
(&
sb_checkpoöt_timî
);

428 
	`log_ãxt
(
LOG_FATAL
,

431 
	`ªp‹t_cumuœtive
();

433 
	`log_d⁄e
();

435 
	`exô
(2);

436 
	}
}

440 
	$ªgi°î_ã°s
()

442 
	`SB_LIST_INIT
(&
ã°s
);

445  
	`ªgi°î_ã°_fûeio
(&
ã°s
)

446 + 
	`ªgi°î_ã°_˝u
(&
ã°s
)

447 + 
	`ªgi°î_ã°_mem‹y
(&
ã°s
)

448 + 
	`ªgi°î_ã°_thªads
(&
ã°s
)

449 + 
	`ªgi°î_ã°_muãx
(&
ã°s
)

450 + 
	`db_ªgi°î
()

451 + 
	`sb_ønd_ªgi°î
()

453 
	}
}

459 
	$¥öt_hódî
()

461 
	`log_ãxt
(
LOG_NOTICE
,

463 
VERSION_STRING
, 
SB_WITH_LUAJIT
, 
LUAJIT_VERSION
);

464 
	}
}

470 
	$¥öt_hñp
()

472 
sb_li°_ôem_t
 *
pos
;

473 
sb_ã°_t
 *
ã°
;

475 
	`¥ötf
("Usage:\n");

476 
	`¥ötf
(" sysbench [options]... [testname] [command]\n\n");

477 
	`¥ötf
("Commands implemented by mostÅests:ÖrepareÑun cleanup help\n\n");

478 
	`¥ötf
("General options:\n");

479 
	`sb_¥öt_›ti⁄s
(
gíîÆ_¨gs
);

481 
	`sb_ønd_¥öt_hñp
();

483 
	`log_¥öt_hñp
();

485 
	`db_¥öt_hñp
();

487 
	`¥ötf
("Compiled-inÅests:\n");

488 
	`SB_LIST_FOR_EACH
(
pos
, &
ã°s
)

490 
ã°
 = 
	`SB_LIST_ENTRY
(
pos
, 
sb_ã°_t
, 
li°ôem
);

491 
	`¥ötf
(" %†- %s\n", 
ã°
->
¢ame
,Åe°->
 ame
);

493 
	`¥ötf
("\n");

494 
	`¥ötf
("See 'sysbench <testname> help' foráÜist of options for "

496 
	}
}

504 
	$∑r£_›ti⁄
(*
«me
, 
boﬁ
 
ign‹e_unknown
)

506 c⁄° *
vÆue
;

507 *
tmp
;

508 
›ti⁄_t
 *
›t
;

509 
˘mp
 = 0;

510 
rc
;

512 
tmp
 = 
	`°rchr
(
«me
, '=');

513 i‡(
tmp
 !
NULL
)

515 
˘mp
 = *
tmp
;

516 *
tmp
 = '\0';

517 
vÆue
 = 
tmp
 + 1;

521 
vÆue
 = 
NULL
;

524 
›t
 = 
	`sb_föd_›ti⁄
(
«me
);

525 i‡(
›t
 !
NULL
 || 
ign‹e_unknown
)

526 
rc
 = 
	`£t_›ti⁄
(
«me
, 
vÆue
,

527 
›t
 !
NULL
 ? o±->
ty≥
 : 
SB_ARG_TYPE_STRING
) == NULL;

529 
rc
 = 1;

531 i‡(
tmp
 !
NULL
)

532 *
tmp
 = 
˘mp
;

534  
rc
;

535 
	}
}

543 
	$∑r£_gíîÆ_¨gumíts
(
¨gc
, *
¨gv
[])

545 c⁄° * 
ã°«me
;

546 c⁄° * 
cmd«me
;

549 i‡(
	`sb_ªgi°î_¨g_£t
(
gíîÆ_¨gs
))

553 
ã°«me
 = 
NULL
;

554 
cmd«me
 = 
NULL
;

556 
i
 = 1; i < 
¨gc
; i++)

558 i‡(
	`°∫cmp
(
¨gv
[
i
], "--", 2))

560 i‡(
ã°«me
 =
NULL
)

562 
ã°«me
 = 
¨gv
[
i
];

566 i‡(
cmd«me
 =
NULL
)

568 
cmd«me
 = 
¨gv
[
i
];

572 
	`Ârötf
(
°dîr
, "Uƒecognized comm™dÜöê¨gumít: %s\n", 
¨gv
[
i
]);

576 i‡(!
	`∑r£_›ti⁄
(
¨gv
[
i
]+2, 
Ál£
))

579 
¨gv
[
i
] = 
NULL
;

583 
sb_globÆs
.
ã°«me
 =Åestname;

584 
sb_globÆs
.
cmd«me
 = cmdname;

587 
	}
}

591 
	$∑r£_ã°_¨gumíts
(
sb_ã°_t
 *
ã°
, 
¨gc
, *
¨gv
[])

594 i‡(
ã°
->
¨gs
 !
NULL
 && 
	`sb_ªgi°î_¨g_£t
(test->args))

597 
i
 = 1; i < 
¨gc
; i++)

600 i‡(
¨gv
[
i
] =
NULL
 || 
	`°∫cmp
(argv[i], "--", 2))

604 i‡(
	`∑r£_›ti⁄
(
¨gv
[
i
]+2, 
Ál£
))

606 
	`Ârötf
(
°dîr
, "övÆid o±i⁄: %s\n", 
¨gv
[
i
]);

610 
¨gv
[
i
] = 
NULL
;

614 
	}
}

617 
	$¥öt_run_mode
(
sb_ã°_t
 *
ã°
)

619 
	`log_ãxt
(
LOG_NOTICE
, "RunningÅheÅest with following options:");

620 
	`log_ãxt
(
LOG_NOTICE
, "Numbî o‡thªads: %d", 
sb_globÆs
.
thªads
);

622 i‡(
sb_globÆs
.
w¨mup_time
 > 0)

623 
	`log_ãxt
(
LOG_NOTICE
, "W¨mu∞time: %ds", 
sb_globÆs
.
w¨mup_time
);

625 i‡(
sb_globÆs
.
tx_øã
 > 0)

627 
	`log_ãxt
(
LOG_NOTICE
,

628 "T¨gëÅønß˘i⁄Ñ©e: %d/£c", 
sb_globÆs
.
tx_øã
);

631 i‡(
sb_globÆs
.
ªp‹t_öãrvÆ
)

633 
	`log_ãxt
(
LOG_NOTICE
, "Report intermediateÑesultsÉvery %d second(s)",

634 
sb_globÆs
.
ªp‹t_öãrvÆ
);

637 i‡(
sb_globÆs
.
n_checkpoöts
 > 0)

639 
li°_°r
[
MAX_CHECKPOINTS
 * 12];

640 *
tmp
 = 
li°_°r
;

641 
i
;

642 
n
, 
size
 = (
li°_°r
);

644 
i
 = 0; i < 
sb_globÆs
.
n_checkpoöts
 - 1; i++)

646 
n
 = 
	`¢¥ötf
(
tmp
, 
size
, "%u, ", 
sb_globÆs
.
checkpoöts
[
i
]);

647 i‡(
n
 >
size
)

649 
tmp
 +
n
;

650 
size
 -
n
;

652 i‡(
i
 =
sb_globÆs
.
n_checkpoöts
 - 1)

653 
	`¢¥ötf
(
tmp
, 
size
, "%u", 
sb_globÆs
.
checkpoöts
[
i
]);

654 
	`log_ãxt
(
LOG_NOTICE
, "Report checkpoint(s)át %s seconds",

655 
li°_°r
);

658 i‡(
sb_globÆs
.
debug
)

659 
	`log_ãxt
(
LOG_NOTICE
, "Debug modeÉnabled.\n");

661 i‡(
sb_globÆs
.
vÆid©e
)

662 
	`log_ãxt
(
LOG_NOTICE
, "Validation checks: on.\n");

664 i‡(
sb_ønd_£ed
)

666 
	`log_ãxt
(
LOG_NOTICE
,

668 
sb_ønd_£ed
);

669 
	`§™dom
(
sb_ønd_£ed
);

673 
	`log_ãxt
(
LOG_NOTICE
,

675 
	`§™dom
(
	`time
(
NULL
));

678 i‡(
sb_globÆs
.
f‹˚_shutdown
)

679 
	`log_ãxt
(
LOG_NOTICE
, "Forcing shutdown in %u seconds",

680 (Ë
	`NS2SEC
(
sb_globÆs
.
max_time_ns
Ë+ sb_globÆs.
timeout
);

682 
	`log_ãxt
(
LOG_NOTICE
, "");

684 i‡(
ã°
->
›s
.
¥öt_mode
 !
NULL
)

685 
ã°
->
›s
.
	`¥öt_mode
();

686 
	}
}

688 
boﬁ
 
	$sb_m‹e_evíts
(
thªad_id
)

690 (Ë
thªad_id
;

692 i‡(
sb_globÆs
.
îr‹
)

693  
Ál£
;

696 i‡(
sb_globÆs
.
max_time_ns
 > 0 &&

697 
	`SB_UNLIKELY
(
	`sb_timî_vÆue
(&
sb_exec_timî
Ë>
sb_globÆs
.
max_time_ns
))

699 
	`log_ãxt
(
LOG_INFO
, "TimeÜimitÉxceeded,Éxiting...");

700  
Ál£
;

704 c⁄° 
uöt64_t
 
max_evíts
 = 
	`ck_¥_lﬂd_64
(&
sb_globÆs
.max_events);

705 i‡(
max_evíts
 > 0 &&

706 
	`SB_UNLIKELY
(
	`ck_¥_Áa_64
(&
sb_globÆs
.
√víts
, 1Ë>
max_evíts
))

708 
	`log_ãxt
(
LOG_INFO
, "EventÜimitÉxceeded,Éxiting...");

709  
Ál£
;

713 i‡(
sb_globÆs
.
tx_øã
 > 0)

715 *
±r
 = 
NULL
;

717 !
	`ck_rög_dequeue_•mc
(&
queue_rög
, 
queue_rög_buf„r
, &
±r
) &&

718 !
sb_globÆs
.
îr‹
)

720 
	`±hªad_muãx_lock
(&
queue_muãx
);

721 
	`±hªad_c⁄d_waô
(&
queue_c⁄d
, &
queue_muãx
);

722 
	`±hªad_muãx_u∆ock
(&
queue_muãx
);

726 i‡(
sb_globÆs
.
îr‹
)

727  
Ál£
;

729 i‡(
sb_globÆs
.
max_time_ns
 > 0 &&

730 
	`SB_UNLIKELY
(
	`sb_timî_vÆue
(&
sb_exec_timî
Ë>
sb_globÆs
.
max_time_ns
))

732 
	`log_ãxt
(
LOG_INFO
, "TimeÜimitÉxceeded,Éxiting...");

733  
Ál£
;

737 
	`ck_¥_öc_öt
(&
sb_globÆs
.
c⁄cuºícy
);

739 
timîs
[
thªad_id
].
queue_time
 = 
	`sb_timî_vÆue
(&
sb_exec_timî
) -

740 ((
uöt64_t
 *Ë
±r
)[0];

743  
åue
;

744 
	}
}

747 
	$sb_evít_°¨t
(
thªad_id
)

749 
	`sb_timî_°¨t
(&
timîs
[
thªad_id
]);

750 
	}
}

753 
	$sb_evít_°›
(
thªad_id
)

755 
sb_timî_t
 *
timî
 = &
timîs
[
thªad_id
];

756 
vÆue
;

758 
vÆue
 = 
	`sb_timî_°›
(
timî
);

760 i‡(
sb_globÆs
.
≥r˚¡ûe
 > 0)

761 
	`sb_hi°ogøm_upd©e
(&
sb_œãncy_hi°ogøm
, 
	`NS2MS
(
vÆue
));

763 
	`sb_cou¡î_öc
(
thªad_id
, 
SB_CNT_EVENT
);

765 i‡(
sb_globÆs
.
tx_øã
 > 0)

767 
	`ck_¥_dec_öt
(&
sb_globÆs
.
c⁄cuºícy
);

769 
	}
}

775 
	$thªad_run
(
sb_ã°_t
 *
ã°
, 
thªad_id
)

777 
sb_evít_t
 
evít
;

778 
rc
 = 0;

780 
	`sb_m‹e_evíts
(
thªad_id
Ë&& 
rc
 == 0)

782 
evít
 = 
ã°
->
›s
.
	`√xt_evít
(
thªad_id
);

783 i‡(
evít
.
ty≥
 =
SB_REQ_TYPE_NULL
)

786 
	`sb_evít_°¨t
(
thªad_id
);

788 
rc
 = 
ã°
->
›s
.
	`execuã_evít
(&
evít
, 
thªad_id
);

790 
	`sb_evít_°›
(
thªad_id
);

793  
rc
;

794 
	}
}

800 *
	$w‹kî_thªad
(*
¨g
)

802 
sb_thªad_˘xt_t
 *
˘xt
;

803 
thªad_id
;

804 
rc
;

806 
˘xt
 = (
sb_thªad_˘xt_t
 *)
¨g
;

807 
sb_ã°_t
 * c⁄° 
ã°
 = 
cuºít_ã°
;

809 
sb_és_thªad_id
 = 
thªad_id
 = 
˘xt
->
id
;

812 
	`sb_ønd_thªad_öô
();

814 
	`log_ãxt
(
LOG_DEBUG
, "W‹kîÅhªad (#%dË°¨ãd", 
thªad_id
);

816 i‡(
ã°
->
›s
.
thªad_öô
 !
NULL
 &&Åe°->›s.
	`thªad_öô
(
thªad_id
) != 0)

818 
	`log_ãxt
(
LOG_DEBUG
, "W‹kîÅhªad (#%dËÁûedÅÿöôülize!", 
thªad_id
);

819 
sb_globÆs
.
îr‹
 = 1;

821 
	`sb_b¨rõr_waô
(&
w‹kî_b¨rõr
);

822  
NULL
;

825 
	`log_ãxt
(
LOG_DEBUG
, "W‹kîÅhªad (#%dËöôülized", 
thªad_id
);

828 i‡(
	`sb_b¨rõr_waô
(&
w‹kî_b¨rõr
) < 0)

829  
NULL
;

831 i‡(
ã°
->
›s
.
thªad_run
 !
NULL
)

834 
rc
 = 
ã°
->
›s
.
	`thªad_run
(
thªad_id
);

839 
rc
 = 
	`thªad_run
(
ã°
, 
thªad_id
);

842 i‡(
rc
 != 0)

843 
sb_globÆs
.
îr‹
 = 1;

844 i‡(
ã°
->
›s
.
thªad_d⁄e
 !
NULL
)

845 
ã°
->
›s
.
	`thªad_d⁄e
(
thªad_id
);

847  
NULL
;

848 
	}
}

852 
ölöe
 
	$sb_ønd_exp
(
œmbda
)

854  -
œmbda
 * 
	`log
(1 - 
	`sb_ønd_unif‹m_doubÀ
());

855 
	}
}

857 *
	$evítgí_thªad_¥oc
(*
¨g
)

859 ()
¨g
;

861 
sb_és_thªad_id
 = 
SB_BACKGROUND_THREAD_ID
;

864 
	`sb_ønd_thªad_öô
();

866 
	`ck_rög_öô
(&
queue_rög
, 
MAX_QUEUE_LEN
);

868 i‡(
	`±hªad_muãx_öô
(&
queue_muãx
, 
NULL
) ||

869 
	`±hªad_c⁄d_öô
(&
queue_c⁄d
, 
NULL
))

871 
	`sb_b¨rõr_waô
(&
w‹kî_b¨rõr
);

872  
NULL
;

875 
	`log_ãxt
(
LOG_DEBUG
, "Event generatingÅhread started");

878 i‡(
	`sb_b¨rõr_waô
(&
w‹kî_b¨rõr
) < 0)

879  
NULL
;

881 
evítgí_thªad_¸óãd
 = 1;

887 c⁄° 
œmbda
 = 1e9 / 
sb_globÆs
.
tx_øã
;

889 
uöt64_t
 
cuº_ns
 = 
	`sb_timî_vÆue
(&
sb_exec_timî
);

890 
uöt64_t
 
öå_ns
 = 
	`sb_ønd_exp
(
œmbda
);

891 
uöt64_t
 
√xt_ns
 = 
cuº_ns
 + 
öå_ns
;

893 
i
 = 0; ; i = (i+1Ë% 
MAX_QUEUE_LEN
)

895 
cuº_ns
 = 
	`sb_timî_vÆue
(&
sb_exec_timî
);

896 
öå_ns
 = 
	`sb_ønd_exp
(
œmbda
);

897 
√xt_ns
 +
öå_ns
;

899 i‡(
sb_globÆs
.
max_time_ns
 > 0 &&

900 
	`SB_UNLIKELY
(
cuº_ns
 >
sb_globÆs
.
max_time_ns
))

903 
	`±hªad_c⁄d_brﬂdˇ°
(&
queue_c⁄d
);

904  
NULL
;

907 i‡(
√xt_ns
 > 
cuº_ns
)

908 
	`sb_«no¶ìp
(
√xt_ns
 - 
cuº_ns
);

911 
queue_¨øy
[
i
] = 
	`sb_timî_vÆue
(&
sb_exec_timî
);

912 i‡(
	`ck_rög_íqueue_•mc
(&
queue_rög
, 
queue_rög_buf„r
,

913 &
queue_¨øy
[
i
]Ë=
Ál£
)

915 
sb_globÆs
.
îr‹
 = 1;

916 
	`log_ãxt
(
LOG_FATAL
,

919 
	`±hªad_c⁄d_brﬂdˇ°
(&
queue_c⁄d
);

920  
NULL
;

924 
	`±hªad_c⁄d_sig«l
(&
queue_c⁄d
);

927  
NULL
;

928 
	}
}

932 *
	$ªp‹t_thªad_¥oc
(*
¨g
)

934 
∑u£_ns
;

935 
¥ev_ns
;

936 
√xt_ns
;

937 
cuº_ns
;

938 c⁄° 
öãrvÆ_ns
 = 
	`SEC2NS
(
sb_globÆs
.
ªp‹t_öãrvÆ
);

940 ()
¨g
;

942 
sb_és_thªad_id
 = 
SB_BACKGROUND_THREAD_ID
;

945 
	`sb_ønd_thªad_öô
();

947 i‡(
	`sb_lua_lﬂded
(Ë&& 
	`sb_lua_ªp‹t_thªad_öô
())

948  
NULL
;

950 
	`±hªad_˛ónup_push
(
sb_lua_ªp‹t_thªad_d⁄e
, 
NULL
);

952 
	`log_ãxt
(
LOG_DEBUG
, "ReportingÅhread started");

955 i‡(
	`sb_b¨rõr_waô
(&
ªp‹t_b¨rõr
) < 0)

956  
NULL
;

958 
ªp‹t_thªad_¸óãd
 = 1;

960 
∑u£_ns
 = 
öãrvÆ_ns
;

961 
¥ev_ns
 = 
	`sb_timî_vÆue
(&
sb_exec_timî
Ë+ 
öãrvÆ_ns
;

965 
	`sb_«no¶ìp
(
∑u£_ns
);

967 
	`ªp‹t_öãrmedüã
();

969 
cuº_ns
 = 
	`sb_timî_vÆue
(&
sb_exec_timî
);

972 
√xt_ns
 = 
¥ev_ns
 + 
öãrvÆ_ns
;

973 
¥ev_ns
 = 
√xt_ns
;

974 } 
cuº_ns
 >
√xt_ns
);

975 
∑u£_ns
 = 
√xt_ns
 - 
cuº_ns
;

978 
	`±hªad_˛ónup_p›
(1);

980  
NULL
;

981 
	}
}

985 *
	$checkpoöts_thªad_¥oc
(*
¨g
)

987 
√xt_ns
;

988 
cuº_ns
;

989 
i
;

991 ()
¨g
;

993 
sb_és_thªad_id
 = 
SB_BACKGROUND_THREAD_ID
;

996 
	`sb_ønd_thªad_öô
();

998 i‡(
	`sb_lua_lﬂded
(Ë&& 
	`sb_lua_ªp‹t_thªad_öô
())

999  
NULL
;

1001 
	`±hªad_˛ónup_push
(
sb_lua_ªp‹t_thªad_d⁄e
, 
NULL
);

1003 
	`log_ãxt
(
LOG_DEBUG
, "CheckpointsÑeportÅhread started");

1006 i‡(
	`sb_b¨rõr_waô
(&
ªp‹t_b¨rõr
) < 0)

1007  
NULL
;

1009 
checkpoöts_thªad_¸óãd
 = 1;

1011 
i
 = 0; i < 
sb_globÆs
.
n_checkpoöts
; i++)

1013 
√xt_ns
 = 
	`SEC2NS
(
sb_globÆs
.
checkpoöts
[
i
]);

1014 
cuº_ns
 = 
	`sb_timî_vÆue
(&
sb_exec_timî
);

1015 i‡(
√xt_ns
 <
cuº_ns
)

1018 
	`sb_«no¶ìp
(
√xt_ns
 - 
cuº_ns
);

1020 
	`log_time°amp
(
LOG_NOTICE
, 
	`NS2SEC
(
	`sb_timî_vÆue
(&
sb_exec_timî
)),

1023 
	`ªp‹t_cumuœtive
();

1026 
	`±hªad_˛ónup_p›
(1);

1028  
NULL
;

1029 
	}
}

1033 
	$thªads_°¨ãd_ˇŒback
(*
¨g
)

1035 (Ë
¨g
;

1038 i‡(
sb_globÆs
.
îr‹
)

1041 
sb_globÆs
.
thªads_ru¬ög
 = sb_globÆs.
thªads
;

1043 
	`sb_timî_°¨t
(&
sb_exec_timî
);

1044 
	`sb_timî_c›y
(&
sb_öãrmedüã_timî
, &
sb_exec_timî
);

1045 
	`sb_timî_c›y
(&
sb_checkpoöt_timî
, &
sb_exec_timî
);

1047 
	`log_ãxt
(
LOG_NOTICE
, "Threads started!\n");

1050 
	}
}

1057 
	$run_ã°
(
sb_ã°_t
 *
ã°
)

1059 
îr
;

1060 
±hªad_t
 
ªp‹t_thªad
;

1061 
±hªad_t
 
checkpoöts_thªad
;

1062 
±hªad_t
 
evítgí_thªad
;

1063 
b¨rõr_thªads
;

1064 
uöt64_t
 
ﬁd_max_evíts
 = 0;

1067 i‡(
ã°
->
›s
.
öô
 !
NULL
 &&Åe°->›s.
	`öô
() != 0)

1071 
	`¥öt_run_mode
(
ã°
);

1074 
	`sb_timî_öô
(&
sb_exec_timî
);

1075 
	`sb_timî_öô
(&
sb_öãrmedüã_timî
);

1076 
	`sb_timî_öô
(&
sb_checkpoöt_timî
);

1079 i‡(
ã°
->
›s
.
¥ï¨e
 !
NULL
 &&Åe°->›s.
	`¥ï¨e
() != 0)

1082 
	`±hªad_muãx_öô
(&
sb_globÆs
.
exec_muãx
, 
NULL
);

1084 
sb_globÆs
.
thªads_ru¬ög
 = 0;

1087 
b¨rõr_thªads
 = 1 + 
sb_globÆs
.
thªads
 +

1088 (
sb_globÆs
.
tx_øã
 > 0) ;

1090 i‡(
	`sb_b¨rõr_öô
(&
w‹kî_b¨rõr
, 
b¨rõr_thªads
,

1091 
thªads_°¨ãd_ˇŒback
, 
NULL
))

1093 
	`log_î∫o
(
LOG_FATAL
, "sb_barrier_init() failed");

1098 
b¨rõr_thªads
 = 1 +

1099 (
sb_globÆs
.
ªp‹t_öãrvÆ
 > 0) +

1100 (
sb_globÆs
.
n_checkpoöts
 > 0) ;

1102 i‡(
	`sb_b¨rõr_öô
(&
ªp‹t_b¨rõr
, 
b¨rõr_thªads
, 
NULL
, NULL))

1104 
	`log_î∫o
(
LOG_FATAL
, "sb_barrier_init() failed");

1109 i‡(
sb_globÆs
.
ªp‹t_öãrvÆ
 > 0)

1112 i‡((
îr
 = 
	`sb_thªad_¸óã
(&
ªp‹t_thªad
, &
sb_thªad_©å
,

1113 &
ªp‹t_thªad_¥oc
, 
NULL
)) != 0)

1115 
	`log_î∫o
(
LOG_FATAL
,

1121 i‡(
sb_globÆs
.
tx_øã
 > 0)

1123 i‡((
îr
 = 
	`sb_thªad_¸óã
(&
evítgí_thªad
, &
sb_thªad_©å
,

1124 &
evítgí_thªad_¥oc
, 
NULL
)) != 0)

1126 
	`log_î∫o
(
LOG_FATAL
,

1132 i‡(
sb_globÆs
.
n_checkpoöts
 > 0)

1135 i‡((
îr
 = 
	`sb_thªad_¸óã
(&
checkpoöts_thªad
, &
sb_thªad_©å
,

1136 &
checkpoöts_thªad_¥oc
, 
NULL
)) != 0)

1138 
	`log_î∫o
(
LOG_FATAL
,

1144 i‡((
îr
 = 
	`sb_thªad_¸óã_w‹kîs
(&
w‹kî_thªad
)))

1145  
îr
;

1147 #ifde‡
HAVE_ALARM


1149 
	`sig«l
(
SIGALRM
, 
sigÆrm_thªad_öô_timeout_h™dÀr
);

1151 
	`Æ¨m
(
thªad_öô_timeout
);

1154 i‡(
sb_globÆs
.
w¨mup_time
 > 0)

1157 
ﬁd_max_evíts
 = 
sb_globÆs
.
max_evíts
;

1158 
sb_globÆs
.
max_evíts
 = 0;

1161 i‡(
	`sb_b¨rõr_waô
(&
w‹kî_b¨rõr
) < 0)

1163 
	`log_ãxt
(
LOG_FATAL
, "Threads initialization failed!");

1167 #ifde‡
HAVE_ALARM


1168 
	`Æ¨m
(0);

1170 i‡(
sb_globÆs
.
f‹˚_shutdown
)

1173 
	`sig«l
(
SIGALRM
, 
sigÆrm_f‹˚d_shutdown_h™dÀr
);

1175 
	`Æ¨m
(
	`NS2SEC
(
sb_globÆs
.
max_time_ns
Ë+ sb_globÆs.
timeout
);

1179 i‡(
sb_globÆs
.
w¨mup_time
 > 0)

1181 
	`log_ãxt
(
LOG_NOTICE
, "Warming up for %d seconds...\n",

1182 
sb_globÆs
.
w¨mup_time
);

1184 
	`u¶ìp
(
sb_globÆs
.
w¨mup_time
 * 1000000);

1187 
	`ck_¥_°‹e_64
(&
sb_globÆs
.
max_evíts
, 
ﬁd_max_evíts
);

1190 
sb_°©_t
 
°©
;

1191 
	`checkpoöt
(&
°©
);

1195 i‡(
	`sb_b¨rõr_waô
(&
ªp‹t_b¨rõr
) < 0)

1197 
	`log_ãxt
(
LOG_FATAL
, "FailedÅo signalÑeportingÅhreads");

1201 i‡((
îr
 = 
	`sb_thªad_joö_w‹kîs
()))

1202  
îr
;

1204 
	`sb_timî_°›
(&
sb_exec_timî
);

1205 
	`sb_timî_°›
(&
sb_öãrmedüã_timî
);

1206 
	`sb_timî_°›
(&
sb_checkpoöt_timî
);

1209 
	`ck_¥_°‹e_uöt
(&
sb_globÆs
.
ªp‹t_öãrvÆ
, 0);

1211 #ifde‡
HAVE_ALARM


1212 
	`Æ¨m
(0);

1215 
	`log_ãxt
(
LOG_INFO
, "Done.\n");

1218 i‡(
ã°
->
›s
.
˛ónup
 !
NULL
 &&Åe°->›s.
	`˛ónup
() != 0)

1221 i‡(
ªp‹t_thªad_¸óãd
)

1223 i‡(
	`sb_thªad_ˇn˚l
(
ªp‹t_thªad
Ë|| 
	`sb_thªad_joö
‘ï‹t_thªad, 
NULL
))

1224 
	`log_î∫o
(
LOG_FATAL
, "TerminatingÅheÑeportingÅhread failed.");

1227 i‡(
evítgí_thªad_¸óãd
)

1233 i‡((
	`sb_thªad_ˇn˚l
(
evítgí_thªad
) ||

1234 
	`sb_thªad_joö
(
evítgí_thªad
, 
NULL
)Ë&& 
sb_globÆs
.
max_time_ns
 == 0)

1235 
	`log_ãxt
(
LOG_FATAL
, "TerminatingÅheÉvent generatorÅhread failed.");

1238 i‡(
checkpoöts_thªad_¸óãd
)

1240 i‡(
	`sb_thªad_ˇn˚l
(
checkpoöts_thªad
) ||

1241 
	`sb_thªad_joö
(
checkpoöts_thªad
, 
NULL
))

1242 
	`log_î∫o
(
LOG_FATAL
, "TerminatingÅhe checkpointÅhread failed.");

1246 i‡(!
sb_globÆs
.
îr‹
)

1248 i‡(
sb_globÆs
.
hi°ogøm
)

1250 
	`log_ãxt
(
LOG_NOTICE
, "Latency histogram (valuesáre in milliseconds)");

1251 
	`sb_hi°ogøm_¥öt
(&
sb_œãncy_hi°ogøm
);

1252 
	`log_ãxt
(
LOG_NOTICE
, " ");

1255 
	`ªp‹t_cumuœtive
();

1258 
	`±hªad_muãx_de°roy
(&
sb_globÆs
.
exec_muãx
);

1261 i‡(
ã°
->
›s
.
d⁄e
 !
NULL
)

1262 (*(
ã°
->
›s
.
d⁄e
))();

1264  
sb_globÆs
.
îr‹
 != 0;

1265 
	}
}

1268 
sb_ã°_t
 *
	$föd_ã°
(c⁄° *
«me
)

1270 
sb_li°_ôem_t
 *
pos
;

1271 
sb_ã°_t
 *
ã°
;

1273 
	`SB_LIST_FOR_EACH
(
pos
, &
ã°s
)

1275 
ã°
 = 
	`SB_LIST_ENTRY
(
pos
, 
sb_ã°_t
, 
li°ôem
);

1276 i‡(!
	`°rcmp
(
ã°
->
¢ame
, 
«me
))

1277  
ã°
;

1280  
NULL
;

1281 
	}
}

1284 
	$checkpoöt_cmp
(c⁄° *
a_±r
, c⁄° *
b_±r
)

1286 c⁄° 
a
 = *(c⁄° *Ë
a_±r
;

1287 c⁄° 
b
 = *(c⁄° *Ë
b_±r
;

1289  (Ë(
a
 - 
b
);

1290 
	}
}

1293 
	$öô
()

1295 
›ti⁄_t
 *
›t
;

1296 *
tmp
;

1297 
sb_li°_t
 *
checkpoöts_li°
;

1298 
sb_li°_ôem_t
 *
pos_vÆ
;

1299 
vÆue_t
 *
vÆ
;

1301 
sb_globÆs
.
thªads
 = 
	`sb_gë_vÆue_öt
("threads");

1303 
thªad_öô_timeout
 = 
	`sb_gë_vÆue_öt
("thread-init-timeout");

1305 i‡(
sb_globÆs
.
thªads
 <= 0)

1307 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for --threads: %d.\n",

1308 
sb_globÆs
.
thªads
);

1312 
sb_globÆs
.
max_evíts
 = 
	`sb_gë_vÆue_öt
("events");

1314 
sb_globÆs
.
w¨mup_time
 = 
	`sb_gë_vÆue_öt
("warmup-time");

1315 i‡(
sb_globÆs
.
w¨mup_time
 < 0)

1317 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for --warmup-time: %d.\n",

1318 
sb_globÆs
.
w¨mup_time
);

1322 
max_time
 = 
	`sb_gë_vÆue_öt
("time");

1324 
sb_globÆs
.
max_time_ns
 = 
	`SEC2NS
(
max_time
);

1326 i‡(!
sb_globÆs
.
max_evíts
 && !sb_globÆs.
max_time_ns
)

1327 
	`log_ãxt
(
LOG_WARNING
, "BothÉventándÅimeÜimitsáre disabled, "

1330 i‡(
sb_globÆs
.
max_time_ns
 > 0)

1333 i‡(
sb_globÆs
.
w¨mup_time
 > 0)

1335 
sb_globÆs
.
max_time_ns
 +
	`SEC2NS
(sb_globÆs.
w¨mup_time
);

1339 
tmp
 = 
	`sb_gë_vÆue_°rög
("forced-shutdown");

1340 i‡(
tmp
 =
NULL
)

1342 
sb_globÆs
.
f‹˚_shutdown
 = 1;

1343 
sb_globÆs
.
timeout
 = 
	`NS2SEC
(sb_globÆs.
max_time_ns
) / 20;

1345 i‡(
	`°rˇ£cmp
(
tmp
, "off"))

1347 *
íd±r
;

1349 
sb_globÆs
.
f‹˚_shutdown
 = 1;

1350 
sb_globÆs
.
timeout
 = (Ë
	`°πﬁ
(
tmp
, &
íd±r
, 10);

1351 i‡(*
íd±r
 == '%')

1352 
sb_globÆs
.
timeout
 = () (sb_globals.timeout *

1353 
	`NS2SEC
(
sb_globÆs
.
max_time_ns
) / 100);

1354 i‡(*
tmp
 ='\0' || *
íd±r
 != '\0')

1356 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ --f‹˚d-shutdown: '%s'", 
tmp
);

1361 
sb_globÆs
.
f‹˚_shutdown
 = 0;

1364 
îr
;

1365 i‡((
îr
 = 
	`sb_thªad_öô
()))

1366  
îr
;

1368 
sb_globÆs
.
debug
 = 
	`sb_gë_vÆue_Êag
("debug");

1370 i‡(
sb_globÆs
.
debug
)

1372 
›t
 = 
	`sb_föd_›ti⁄
("verbosity");

1373 i‡(
›t
 !
NULL
)

1374 
	`£t_›ti⁄
(
›t
->
«me
, "5", o±->
ty≥
);

1377 
sb_globÆs
.
vÆid©e
 = 
	`sb_gë_vÆue_Êag
("validate");

1379 i‡(
	`sb_ønd_öô
())

1384 
sb_globÆs
.
tx_øã
 = 
	`sb_gë_vÆue_öt
("rate");

1386 
sb_globÆs
.
ªp‹t_öãrvÆ
 = 
	`sb_gë_vÆue_öt
("report-interval");

1388 
sb_globÆs
.
n_checkpoöts
 = 0;

1389 
checkpoöts_li°
 = 
	`sb_gë_vÆue_li°
("report-checkpoints");

1390 
	`SB_LIST_FOR_EACH
(
pos_vÆ
, 
checkpoöts_li°
)

1392 *
íd±r
;

1393 
ªs
;

1395 
vÆ
 = 
	`SB_LIST_ENTRY
(
pos_vÆ
, 
vÆue_t
, 
li°ôem
);

1396 
ªs
 = 
	`°πﬁ
(
vÆ
->
d©a
, &
íd±r
, 10);

1397 i‡(*
íd±r
 !'\0' || 
ªs
 < 0 ||Ñe†> 
INT_MAX
)

1399 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for --report-checkpoints: '%s'",

1400 
vÆ
->
d©a
);

1403 i‡(++
sb_globÆs
.
n_checkpoöts
 > 
MAX_CHECKPOINTS
)

1405 
	`log_ãxt
(
LOG_FATAL
, "Too many checkpoints in --report-checkpoints "

1406 "(u∞tÿ%d c™ bêdeföed)", 
MAX_CHECKPOINTS
);

1409 
sb_globÆs
.
checkpoöts
[sb_globÆs.
n_checkpoöts
-1] = (Ë
ªs
;

1412 i‡(
sb_globÆs
.
n_checkpoöts
 > 0)

1414 
	`qs‹t
(
sb_globÆs
.
checkpoöts
, sb_globÆs.
n_checkpoöts
,

1415 (), 
checkpoöt_cmp
);

1419 
timîs
 = 
	`sb_Æloc_≥r_thªad_¨øy
((
sb_timî_t
));

1420 
timîs_c›y
 = 
	`sb_Æloc_≥r_thªad_¨øy
((
sb_timî_t
));

1422 i‡(
timîs
 =
NULL
 || 
timîs_c›y
 == NULL)

1424 
	`log_ãxt
(
LOG_FATAL
, "Memoryállocation failure");

1428 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

1429 
	`sb_timî_öô
(&
timîs
[
i
]);

1432 
sb_globÆs
.
luajô_cmd
 = 
	`sb_gë_vÆue_°rög
("luajit-cmd");

1435 
	}
}

1438 
	$maö
(
¨gc
, *
¨gv
[])

1440 
sb_ã°_t
 *
ã°
 = 
NULL
;

1441 
rc
;

1443 
sb_globÆs
.
¨gc
 =árgc;

1444 
sb_globÆs
.
¨gv
 = 
	`mÆloc
(
¨gc
 * (*));

1445 
	`mem˝y
(
sb_globÆs
.
¨gv
,árgv, 
¨gc
 * (*));

1448 
	`sb_›ti⁄s_öô
();

1451 i‡(
	`log_ªgi°î
())

1452  
EXIT_FAILURE
;

1455 i‡(
	`ªgi°î_ã°s
())

1457 
	`Ârötf
(
°dîr
, "FailedÅoÑegisterÅests.\n");

1458  
EXIT_FAILURE
;

1462 i‡(
	`∑r£_gíîÆ_¨gumíts
(
¨gc
, 
¨gv
))

1463  
EXIT_FAILURE
;

1465 i‡(
	`sb_gë_vÆue_Êag
("help"))

1467 
	`¥öt_hñp
();

1468  
EXIT_SUCCESS
;

1471 i‡(
	`sb_gë_vÆue_Êag
("version"))

1473 
	`¥ötf
("%s\n", 
VERSION_STRING
);

1474  
EXIT_SUCCESS
;

1478 i‡(
	`öô
(Ë|| 
	`log_öô
(Ë|| 
	`sb_cou¡îs_öô
())

1479  
EXIT_FAILURE
;

1481 
	`¥öt_hódî
();

1483 i‡(
sb_globÆs
.
ã°«me
 !
NULL
 && 
	`°rcmp
(sb_globals.testname, "-"))

1486 
ã°
 = 
	`föd_ã°
(
sb_globÆs
.
ã°«me
);

1488 i‡(
ã°
 !
NULL
 && 
sb_globÆs
.
cmd«me
 == NULL)

1491 
	`Ârötf
(
°dîr
, "The '%s'ÅestÑequiresá commandárgument. "

1492 "Sì 'sysbích %†hñp'\n", 
ã°
->
¢ame
,Åest->sname);

1493  
EXIT_FAILURE
;

1496 i‡(
ã°
 =
NULL
)

1498 i‡((
ã°
 = 
	`sb_lﬂd_lua
(
sb_globÆs
.
ã°«me
)Ë=
NULL
)

1499  
EXIT_FAILURE
;

1501 i‡(
sb_globÆs
.
cmd«me
 =
NULL
)

1504  
ã°
 !
NULL
 ? 
EXIT_SUCCESS
: 
EXIT_FAILURE
;

1510 
sb_globÆs
.
ã°«me
 = 
NULL
;

1512 i‡(
	`SB_ISATTY
())

1513 
	`log_ãxt
(
LOG_NOTICE
, "ReadingÅhe script fromÅhe standard input:\n");

1515 
ã°
 = 
	`sb_lﬂd_lua
(
NULL
);

1517  
ã°
 !
NULL
 ? 
EXIT_SUCCESS
 : 
EXIT_FAILURE
;

1520 
cuºít_ã°
 = 
ã°
;

1523 i‡(
	`∑r£_ã°_¨gumíts
(
ã°
, 
¨gc
, 
¨gv
))

1524  
EXIT_FAILURE
;

1526 i‡(
	`sb_lua_lﬂded
(Ë&& 
	`sb_lua_cu°om_comm™d_deföed
(
sb_globÆs
.
cmd«me
))

1528 
rc
 = 
	`sb_lua_ˇŒ_cu°om_comm™d
(
sb_globÆs
.
cmd«me
);

1530 i‡(!
	`°rcmp
(
sb_globÆs
.
cmd«me
, "help"))

1532 i‡(
ã°
->
buûtö_cmds
.
hñp
 !
NULL
)

1534 
ã°
->
buûtö_cmds
.
	`hñp
();

1535 
rc
 = 
EXIT_SUCCESS
;

1536 
íd
;

1538 i‡(
ã°
->
¨gs
 !
NULL
)

1540 
	`¥ötf
("%†›ti⁄s:\n", 
ã°
->
¢ame
);

1541 
	`sb_¥öt_ã°_›ti⁄s
();

1542 
rc
 = 
EXIT_SUCCESS
;

1543 
íd
;

1547 
	`Ârötf
(
°dîr
, "'%s'Åest doesÇot implementÅhe 'help' command.\n",

1548 
ã°
->
¢ame
);

1549  
EXIT_FAILURE
;

1551 i‡(!
	`°rcmp
(
sb_globÆs
.
cmd«me
, "prepare"))

1553 i‡(
ã°
->
buûtö_cmds
.
¥ï¨e
 =
NULL
)

1555 
	`Ârötf
(
°dîr
, "'%s'Åest doesÇot implementÅhe 'prepare' command.\n",

1556 
ã°
->
¢ame
);

1557 
rc
 = 
EXIT_FAILURE
;

1558 
íd
;

1561 
rc
 = 
ã°
->
buûtö_cmds
.
	`¥ï¨e
();

1563 i‡(!
	`°rcmp
(
sb_globÆs
.
cmd«me
, "cleanup"))

1565 i‡(
ã°
->
buûtö_cmds
.
˛ónup
 =
NULL
)

1567 
	`Ârötf
(
°dîr
, "'%s'Åest doesÇot implementÅhe 'cleanup' command.\n",

1568 
ã°
->
¢ame
);

1569 
rc
 = 
EXIT_FAILURE
;

1570 
íd
;

1573 
rc
 = 
ã°
->
buûtö_cmds
.
	`˛ónup
();

1575 i‡(!
	`°rcmp
(
sb_globÆs
.
cmd«me
, "run"))

1577 
rc
 = 
	`run_ã°
(
ã°
Ë? 
EXIT_FAILURE
 : 
EXIT_SUCCESS
;

1581 
	`Ârötf
(
°dîr
, "Unknow¿comm™d: %s\n", 
sb_globÆs
.
cmd«me
);

1582 
rc
 = 
EXIT_FAILURE
;

1585 
íd
:

1586 i‡(
	`sb_lua_lﬂded
())

1587 
	`sb_lua_d⁄e
();

1589 
	`db_d⁄e
();

1591 
	`sb_cou¡îs_d⁄e
();

1593 
	`log_d⁄e
();

1595 
	`sb_›ti⁄s_d⁄e
();

1597 
	`sb_ønd_d⁄e
();

1599 
	`sb_thªad_d⁄e
();

1601 
	`‰ì
(
timîs
);

1602 
	`‰ì
(
timîs_c›y
);

1604 
	`‰ì
(
sb_globÆs
.
¨gv
);

1606  
rc
;

1607 
	}
}

1611 
	$sb_¥öt_ã°_›ti⁄s
()

1613 i‡(
cuºít_ã°
 !
NULL
)

1614 
	`sb_¥öt_›ti⁄s
(
cuºít_ã°
->
¨gs
);

1615 
	}
}

1622 *
	$sb_Æloc_≥r_thªad_¨øy
(
size_t
 
size
)

1637 c⁄° 
size_t
 
bsize
 = (
sb_globÆs
.
thªads
 + 1Ë* 
size
;

1639 *
±r
 = 
	`sb_memÆign
(
bsize
, 
CK_MD_CACHELINE
);

1641 
	`mem£t
(
±r
, 0, 
bsize
);

1643  
±r
;

1644 
	}
}

	@sysbench.h

19 #i‚de‡
SYSBENCH_H


20 
	#SYSBENCH_H


	)

22 #ifde‡
STDC_HEADERS


23 
	~<°dio.h
>

24 
	~<°dlib.h
>

25 
	~<°rög.h
>

26 
	~<°dboﬁ.h
>

28 #ifde‡
HAVE_UNISTD_H


29 
	~<uni°d.h
>

30 
	~<sys/ty≥s.h
>

32 #ifde‡
HAVE_PTHREAD_H


33 
	~<±hªad.h
>

36 
	~"sb_li°.h
"

37 
	~"sb_›ti⁄s.h
"

38 
	~"sb_timî.h
"

39 
	~"sb_loggî.h
"

41 
	~"ã°s/sb_˝u.h
"

42 
	~"ã°s/sb_fûeio.h
"

43 
	~"ã°s/sb_mem‹y.h
"

44 
	~"ã°s/sb_thªads.h
"

45 
	~"ã°s/sb_muãx.h
"

48 
	#SB_THREAD_MUTEX_LOCK
(Ë
	`±hªad_muãx_lock
(&
sb_globÆs
.
exec_muãx
)

	)

49 
	#SB_THREAD_MUTEX_UNLOCK
(Ë
	`±hªad_muãx_u∆ock
(&
sb_globÆs
.
exec_muãx
)

	)

52 
	#MAX_CHECKPOINTS
 256

	)

58 
	mSB_REQ_TYPE_NULL
,

59 
	mSB_REQ_TYPE_CPU
,

60 
	mSB_REQ_TYPE_MEMORY
,

61 
	mSB_REQ_TYPE_FILE
,

62 
	mSB_REQ_TYPE_SQL
,

63 
	mSB_REQ_TYPE_THREADS
,

64 
	mSB_REQ_TYPE_MUTEX
,

65 
	mSB_REQ_TYPE_SCRIPT


66 } 
	tsb_evít_ty≥_t
;

70 
	gsb_ã°
;

74 
	mty≥
;

75 
sb_ã°_t
 *
	mã°
;

80 
sb_fûe_ªque°_t
 
	mfûe_ªque°
;

81 
sb_thªads_ªque°_t
 
	mthªads_ªque°
;

82 
sb_muãx_ªque°_t
 
	mmuãx_ªque°
;

83 } 
	mu
;

84 } 
	tsb_evít_t
;

89 
uöt32_t
 
	mthªads_ru¬ög
;

91 
	mtime_öãrvÆ
;

92 
	mtime_tŸÆ
;

94 
	mœãncy_p˘
;

96 
	mœãncy_mö
;

97 
	mœãncy_max
;

98 
	mœãncy_avg
;

99 
	mœãncy_sum
;

101 
uöt64_t
 
	mevíts
;

102 
uöt64_t
 
	mªads
;

103 
uöt64_t
 
	mwrôes
;

104 
uöt64_t
 
	mŸhî
;

105 
uöt64_t
 
	mîr‹s
;

106 
uöt64_t
 
	mªc⁄√˘s
;

108 
uöt64_t
 
	mbyãs_ªad
;

109 
uöt64_t
 
	mbyãs_wrôãn
;

111 
uöt64_t
 
	mqueue_Àngth
;

112 
uöt64_t
 
	mc⁄cuºícy
;

113 } 
	tsb_°©_t
;

117 
	tsb_buûtö_cmd_func_t
();

118 
	tsb_cu°om_cmd_func_t
();

122 
	tsb_›_öô
();

123 
	tsb_›_¥ï¨e
();

124 
	tsb_›_thªad_öô
();

125 
	tsb_›_thªad_run
();

126 
	tsb_›_¥öt_mode
();

127 
sb_evít_t
 
	tsb_›_√xt_evít
();

128 
	tsb_›_execuã_evít
(
	tsb_evít_t
 *, );

129 
	tsb_›_ªp‹t
(
	tsb_°©_t
 *);

130 
	tsb_›_thªad_d⁄e
();

131 
	tsb_›_˛ónup
();

132 
	tsb_›_d⁄e
();

138 
sb_buûtö_cmd_func_t
 *
	mhñp
;

139 
sb_buûtö_cmd_func_t
 *
	m¥ï¨e
;

140 
sb_buûtö_cmd_func_t
 *
	mrun
;

141 
sb_buûtö_cmd_func_t
 *
	m˛ónup
;

142 } 
	tsb_buûtö_cmds_t
;

148 
sb_›_öô
 *
	möô
;

149 
sb_›_¥ï¨e
 *
	m¥ï¨e
;

151 
sb_›_thªad_öô
 *
	mthªad_öô
;

153 
sb_›_¥öt_mode
 *
	m¥öt_mode
;

154 
sb_›_√xt_evít
 *
	m√xt_evít
;

155 
sb_›_execuã_evít
 *
	mexecuã_evít
;

156 
sb_›_ªp‹t
 *
	mªp‹t_öãrmedüã
;

157 
sb_›_ªp‹t
 *
	mªp‹t_cumuœtive
;

158 
sb_›_thªad_run
 *
	mthªad_run
;

159 
sb_›_thªad_d⁄e
 *
	mthªad_d⁄e
;

160 
sb_›_˛ónup
 *
	m˛ónup
;

162 
sb_›_d⁄e
 *
	md⁄e
;

163 } 
	tsb_›î©i⁄s_t
;

167 
	ssb_ã°


169 c⁄° *
	m¢ame
;

170 c⁄° *
	m ame
;

171 
sb_›î©i⁄s_t
 
	m›s
;

172 
sb_buûtö_cmds_t
 
	mbuûtö_cmds
;

173 
sb_¨g_t
 *
	m¨gs
;

175 
sb_li°_ôem_t
 
	mli°ôem
;

176 } 
	tsb_ã°_t
;

182 
îr‹
 
	mCK_CC_CACHELINE
;

183 
	m¨gc
;

184 **
	m¨gv
;

185 
	mtx_øã
;

186 
uöt64_t
 
	mmax_evíts
;

187 
uöt64_t
 
	mmax_time_ns
;

188 
±hªad_muãx_t
 
exec_muãx
 
	mCK_CC_CACHELINE
;

189 c⁄° *
	mã°«me
;

190 c⁄° *
	mcmd«me
;

191 
thªads
 
	mCK_CC_CACHELINE
;

192 
	mthªads_ru¬ög
;

193 
	mªp‹t_öãrvÆ
;

194 
	m≥r˚¡ûe
;

195 
	mhi°ogøm
;

197 
	mcheckpoöts
[
MAX_CHECKPOINTS
];

198 
	mn_checkpoöts
;

199 
	mdebug
;

200 
	mtimeout
;

201 
	mvÆid©e
;

202 
vîbosôy
 
	mCK_CC_CACHELINE
;

203 
c⁄cuºícy
 
	mCK_CC_CACHELINE
;

205 
f‹˚_shutdown
 
	mCK_CC_CACHELINE
;

207 
	mf‹˚d_shutdown_ö_¥ogªss
;

208 
	mw¨mup_time
;

209 
uöt64_t
 
√víts
 
	mCK_CC_CACHELINE
;

210 c⁄° *
	mluajô_cmd
;

211 } 
	tsb_globÆs_t
;

213 
sb_globÆs_t
 
sb_globÆs
 
CK_CC_CACHELINE
;

214 
±hªad_muãx_t
 
evít_queue_muãx
 
CK_CC_CACHELINE
;

217 
sb_timî_t
 
sb_exec_timî
 
CK_CC_CACHELINE
;

220 
sb_timî_t
 
sb_öãrmedüã_timî
;

221 
sb_timî_t
 
sb_checkpoöt_timî
;

223 
TLS
 
sb_és_thªad_id
;

225 
boﬁ
 
sb_m‹e_evíts
(
thªad_id
);

226 
sb_evít_t
 
sb_√xt_evít
(
sb_ã°_t
 *
ã°
, 
thªad_id
);

227 
sb_evít_°¨t
(
thªad_id
);

228 
sb_evít_°›
(
thªad_id
);

231 
sb_¥öt_ã°_›ti⁄s
();

234 
sb_ªp‹t_öãrmedüã
(
sb_°©_t
 *
°©
);

237 
sb_ªp‹t_cumuœtive
(
sb_°©_t
 *
°©
);

243 *
sb_Æloc_≥r_thªad_¨øy
(
size_t
 
size
);

	@tests/cpu/sb_cpu.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
HAVE_MATH_H


24 
	~<m©h.h
>

27 
	~<öây≥s.h
>

29 
	~"sysbích.h
"

32 
sb_¨g_t
 
	g˝u_¨gs
[] =

34 
SB_OPT
("˝u-max-¥ime", "uµîÜimô f‹Örime†gíî©‹", "10000", 
INT
),

36 
SB_OPT_END


40 
˝u_öô
();

41 
˝u_¥öt_mode
();

42 
sb_evít_t
 
˝u_√xt_evít
(
thªad_id
);

43 
˝u_execuã_evít
(
sb_evít_t
 *, );

44 
˝u_ªp‹t_cumuœtive
(
sb_°©_t
 *);

45 
˝u_d⁄e
();

47 
sb_ã°_t
 
	g˝u_ã°
 =

49 .
¢ame
 = "cpu",

50 .
	g ame
 = "CPUÖerformanceÅest",

51 .
	g›s
 = {

52 .
öô
 = 
˝u_öô
,

53 .
	g¥öt_mode
 = 
˝u_¥öt_mode
,

54 .
	g√xt_evít
 = 
˝u_√xt_evít
,

55 .
	gexecuã_evít
 = 
˝u_execuã_evít
,

56 .
	gªp‹t_cumuœtive
 = 
˝u_ªp‹t_cumuœtive
,

57 .
	gd⁄e
 = 
˝u_d⁄e


59 .
	g¨gs
 = 
˝u_¨gs


63 
	gmax_¥ime
;

65 
	$ªgi°î_ã°_˝u
(
sb_li°_t
 * 
ã°s
)

67 
	`SB_LIST_ADD_TAIL
(&
˝u_ã°
.
li°ôem
, 
ã°s
);

70 
	}
}

72 
	$˝u_öô
()

74 
¥ime_›ti⁄

	`sb_gë_vÆue_öt
("cpu-max-prime");

75 i‡(
¥ime_›ti⁄
 <= 0)

77 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêo‡˝u-max-¥ime: %d.", 
¥ime_›ti⁄
);

80 
max_¥ime
()
¥ime_›ti⁄
;

83 
	}
}

86 
sb_evít_t
 
	$˝u_√xt_evít
(
thªad_id
)

88 
sb_evít_t
 
ªq
;

90 (Ë
thªad_id
;

92 
ªq
.
ty≥
 = 
SB_REQ_TYPE_CPU
;

94  
ªq
;

95 
	}
}

97 
	$˝u_execuã_evít
(
sb_evít_t
 *
r
, 
thªad_id
)

99 
c
;

100 
l
;

101 
t
;

102 
n
=0;

104 ()
thªad_id
;

105 ()
r
;

109 
c
=3; c < 
max_¥ime
; c++)

111 
t
 = 
	`sqπ
(()
c
);

112 
l
 = 2;Ü <
t
;Ü++)

113 i‡(
c
 % 
l
 == 0)

115 i‡(
l
 > 
t
 )

116 
n
++;

120 
	}
}

122 
	$˝u_¥öt_mode
()

124 
	`log_ãxt
(
LOG_INFO
, "Doing CPUÖerformance benchmark\n");

125 
	`log_ãxt
(
LOG_NOTICE
, "Primênumbî†limô: %d\n", 
max_¥ime
);

126 
	}
}

130 
	$˝u_ªp‹t_cumuœtive
(
sb_°©_t
 *
°©
)

132 
	`log_ãxt
(
LOG_NOTICE
, "CPU speed:");

133 
	`log_ãxt
(
LOG_NOTICE
, "ÉventsÖer second: %8.2f",

134 
°©
->
evíts
 / sèt->
time_öãrvÆ
);

136 
	`sb_ªp‹t_cumuœtive
(
°©
);

137 
	}
}

140 
	$˝u_d⁄e
()

143 
	}
}

	@tests/fileio/crc32.c

14 #ifde‡
MAKECRCH


15 
	~<°dio.h
>

16 #i‚de‡
DYNAMIC_CRC_TABLE


17 
	#DYNAMIC_CRC_TABLE


	)

21 
	#loˇl
 

	)

22 
	#STDC


	)

23 
	#FAR


	)

24 
	#ZEXPORT


	)

25 
	#Z_NULL
 0

	)

26 
	#OF
(
¨gs
Ë
	)
args

27 
	~"¸c32.h
"

29 #i‚de‡
_WIN32


30 
	#±rdiff_t
 

	)

32 
	~<°dlib.h
>

36 #i‚de‡
NOBYFOUR


37 #ifde‡
STDC


38 
	~<limôs.h
>

39 
	#BYFOUR


	)

40 #i‡(
UINT_MAX
 == 0xffffffffUL)

41 
	tu4
;

43 #i‡(
ULONG_MAX
 == 0xffffffffUL)

44 
	tu4
;

46 #i‡(
USHRT_MAX
 == 0xffffffffUL)

47 
	tu4
;

49 #unde‡
BYFOUR


57 #ifde‡
BYFOUR


58 
	#REV
(
w
) (((w)>>24)+(((w)>>8)&0xff00)+ \

59 (((
w
)&0xff00)<<8)+(((w)&0xff)<<24))

	)

60 
loˇl
 
¸c32_lôée
 
OF
((,

61 c⁄° 
FAR
 *, ));

62 
loˇl
 
¸c32_big
 
OF
((,

63 c⁄° 
FAR
 *, ));

64 
	#TBLS
 8

	)

66 
	#TBLS
 1

	)

69 #ifde‡
DYNAMIC_CRC_TABLE


71 
loˇl
 
	g¸c_èbÀ_em±y
 = 1;

72 
loˇl
 
FAR
 
	g¸c_èbÀ
[
TBLS
][256];

73 
loˇl
 
make_¸c_èbÀ
 
OF
(());

74 #ifde‡
MAKECRCH


75 
loˇl
 
wrôe_èbÀ
 
OF
((
FILE
 *, c⁄° 
FAR
 *));

104 
loˇl
 
	$make_¸c_èbÀ
()

106 
c
;

107 
n
, 
k
;

108 
pﬁy
;

110 c⁄° 
p
[] = {0,1,2,4,5,7,8,10,11,12,16,22,23,26};

113 
pﬁy
 = 0UL;

114 
n
 = 0;Ç < (
p
)/();Ç++)

115 
pﬁy
 |1UL << (31 - 
p
[
n
]);

118 
n
 = 0;Ç < 256;Ç++) {

119 
c
 = ()
n
;

120 
k
 = 0; k < 8; k++)

121 
c
 = c & 1 ? 
pﬁy
 ^ (c >> 1) : c >> 1;

122 
¸c_èbÀ
[0][
n
] = 
c
;

125 #ifde‡
BYFOUR


128 
n
 = 0;Ç < 256;Ç++) {

129 
c
 = 
¸c_èbÀ
[0][
n
];

130 
¸c_èbÀ
[4][
n
] = 
	`REV
(
c
);

131 
k
 = 1; k < 4; k++) {

132 
c
 = 
¸c_èbÀ
[0][c & 0xff] ^ (c >> 8);

133 
¸c_èbÀ
[
k
][
n
] = 
c
;

134 
¸c_èbÀ
[
k
 + 4][
n
] = 
	`REV
(
c
);

139 
¸c_èbÀ_em±y
 = 0;

141 #ifde‡
MAKECRCH


144 
FILE
 *
out
;

146 
out
 = 
	`f›í
("crc32.h", "w");

147 i‡(
out
 =
NULL
) ;

148 
	`Ârötf
(
out
, "/* crc32.h --Åables forÑapid CRC calculation\n");

149 
	`Ârötf
(
out
, " * Generatedáutomatically by crc32.c\n */\n\n");

150 
	`Ârötf
(
out
, "local const unsignedÜong FAR ");

151 
	`Ârötf
(
out
, "crc_table[TBLS][256] =\n{\n {\n");

152 
	`wrôe_èbÀ
(
out
, 
¸c_èbÀ
[0]);

153 #ifde‡
BYFOUR


154 
	`Ârötf
(
out
, "#ifdef BYFOUR\n");

155 
k
 = 1; k < 8; k++) {

156 
	`Ârötf
(
out
, " },\n {\n");

157 
	`wrôe_èbÀ
(
out
, 
¸c_èbÀ
[
k
]);

159 
	`Ârötf
(
out
, "#endif\n");

161 
	`Ârötf
(
out
, " }\n};\n");

162 
	`f˛o£
(
out
);

165 
	}
}

167 #ifde‡
MAKECRCH


168 
loˇl
 
	$wrôe_èbÀ
(
out
, 
èbÀ
)

169 
FILE
 *
out
;

170 c⁄° 
FAR
 *
èbÀ
;

172 
n
;

174 
n
 = 0;Ç < 256;Ç++)

175 
	`Ârötf
(
out
, "%s0x%08lxUL%s", 
n
 % 5 ? "" : " ", 
èbÀ
[n],

176 
n
 == 255 ? "\n" : (n % 5 == 4 ? ",\n" : ", "));

177 
	}
}

184 
	~"¸c32tbl.h
"

188 
	#DO1
 
¸c
 = 
¸c_èbÀ
[0][(()¸¯^ (*
buf
++)Ë& 0xff] ^ (¸¯>> 8)

	)

189 
	#DO8
 
DO1
; DO1; DO1; DO1; DO1; DO1; DO1; 
	)
DO1

194 
ZEXPORT
 
	$¸c32
(
¸c
, 
buf
, 
Àn
)

195 
¸c
;

196 c⁄° 
FAR
 *
buf
;

197 
Àn
;

199 i‡(
buf
 =
Z_NULL
)  0UL;

201 #ifde‡
DYNAMIC_CRC_TABLE


202 i‡(
¸c_èbÀ_em±y
)

203 
	`make_¸c_èbÀ
();

206 #ifde‡
BYFOUR


207 i‡((*Ë=(
±rdiff_t
)) {

208 
u4
 
ídün
;

210 
ídün
 = 1;

211 i‡(*((*)(&
ídün
)))

212  
	`¸c32_lôée
(
¸c
, 
buf
, 
Àn
);

214  
	`¸c32_big
(
¸c
, 
buf
, 
Àn
);

217 
¸c
 = crc ^ 0xffffffffUL;

218 
Àn
 >= 8) {

219 
DO8
;

220 
Àn
 -= 8;

222 i‡(
Àn
) do {

223 
DO1
;

224 } --
Àn
);

225  
¸c
 ^ 0xffffffffUL;

226 
	}
}

228 #ifde‡
BYFOUR


231 
	#DOLIT4
 
c
 ^*
buf4
++; \

232 
c
 = 
¸c_èbÀ
[3][c & 0xff] ^ crc_table[2][(c >> 8) & 0xff] ^ \

233 
¸c_èbÀ
[1][(
c
 >> 16Ë& 0xff] ^ crc_èbÀ[0][¯>> 24]

	)

234 
	#DOLIT32
 
DOLIT4
; DOLIT4; DOLIT4; DOLIT4; DOLIT4; DOLIT4; DOLIT4; 
	)
DOLIT4

237 
loˇl
 
	$¸c32_lôée
(
¸c
, 
buf
, 
Àn
)

238 
¸c
;

239 c⁄° 
FAR
 *
buf
;

240 
Àn
;

242 
u4
 
c
;

243 c⁄° 
u4
 
FAR
 *
buf4
;

245 
c
 = (
u4
)
¸c
;

246 
c
 = ~c;

247 
Àn
 && ((
±rdiff_t
)
buf
 & 3)) {

248 
c
 = 
¸c_èbÀ
[0][(¯^ *
buf
++) & 0xff] ^ (c >> 8);

249 
Àn
--;

252 
buf4
 = (c⁄° 
u4
 
FAR
 *)(*)
buf
;

253 
Àn
 >= 32) {

254 
DOLIT32
;

255 
Àn
 -= 32;

257 
Àn
 >= 4) {

258 
DOLIT4
;

259 
Àn
 -= 4;

261 
buf
 = (c⁄° 
FAR
 *)
buf4
;

263 i‡(
Àn
) do {

264 
c
 = 
¸c_èbÀ
[0][(¯^ *
buf
++) & 0xff] ^ (c >> 8);

265 } --
Àn
);

266 
c
 = ~c;

267  ()
c
;

268 
	}
}

271 
	#DOBIG4
 
c
 ^*++
buf4
; \

272 
c
 = 
¸c_èbÀ
[4][c & 0xff] ^ crc_table[5][(c >> 8) & 0xff] ^ \

273 
¸c_èbÀ
[6][(
c
 >> 16Ë& 0xff] ^ crc_èbÀ[7][¯>> 24]

	)

274 
	#DOBIG32
 
DOBIG4
; DOBIG4; DOBIG4; DOBIG4; DOBIG4; DOBIG4; DOBIG4; 
	)
DOBIG4

277 
loˇl
 
	$¸c32_big
(
¸c
, 
buf
, 
Àn
)

278 
¸c
;

279 c⁄° 
FAR
 *
buf
;

280 
Àn
;

282 
u4
 
c
;

283 c⁄° 
u4
 
FAR
 *
buf4
;

285 
c
 = 
	`REV
((
u4
)
¸c
);

286 
c
 = ~c;

287 
Àn
 && ((
±rdiff_t
)
buf
 & 3)) {

288 
c
 = 
¸c_èbÀ
[4][(¯>> 24Ë^ *
buf
++] ^ (c << 8);

289 
Àn
--;

292 
buf4
 = (c⁄° 
u4
 
FAR
 *)(*)
buf
;

293 
buf4
--;

294 
Àn
 >= 32) {

295 
DOBIG32
;

296 
Àn
 -= 32;

298 
Àn
 >= 4) {

299 
DOBIG4
;

300 
Àn
 -= 4;

302 
buf4
++;

303 
buf
 = (c⁄° 
FAR
 *)
buf4
;

305 i‡(
Àn
) do {

306 
c
 = 
¸c_èbÀ
[4][(¯>> 24Ë^ *
buf
++] ^ (c << 8);

307 } --
Àn
);

308 
c
 = ~c;

309  ()(
	`REV
(
c
));

310 
	}
}

	@tests/fileio/crc32.h

1 #i‚de‡
CRC32_H


3 #ifde‡
HAVE_CONFIG_H


4 
	~<c⁄fig.h
>

7 
	#CRC32_H


	)

9 
¸c32
(
¸c
, c⁄° *
buf
, 
Àn
);

	@tests/fileio/crc32tbl.h

5 
loˇl
 c⁄° 
FAR
 
	g¸c_èbÀ
[
TBLS
][256] =

60 #ifde‡
BYFOUR


	@tests/fileio/sb_fileio.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
STDC_HEADERS


24 
	~<°dio.h
>

25 
	~<°dlib.h
>

26 
	~<öây≥s.h
>

29 #ifde‡
HAVE_UNISTD_H


30 
	~<uni°d.h
>

31 
	~<sys/ty≥s.h
>

33 #ifde‡
HAVE_SYS_STAT_H


34 
	~<sys/°©.h
>

36 #ifde‡
HAVE_FCNTL_H


37 
	~<f˙é.h
>

39 #ifde‡
HAVE_ERRNO_H


40 
	~<î∫o.h
>

42 #ifde‡
HAVE_LIBAIO


43 
	~<libaio.h
>

45 #ifde‡
HAVE_SYS_MMAN_H


46 
	~<sys/mm™.h
>

49 
	~"sysbích.h
"

50 
	~"¸c32.h
"

51 
	~"sb_hi°ogøm.h
"

52 
	~"sb_ønd.h
"

53 
	~"sb_utû.h
"

54 
	~"sb_cou¡î.h
"

57 
	#FILE_CHECKSUM_LENGTH
 ()

	)

58 
	#FILE_OFFSET_LENGTH
 ()

	)

60 
	tFILE_DESCRIPTOR
;

61 
	#VALID_FILE
(
fd
Ë(fd >0)

	)

62 
	#SB_INVALID_FILE
 (-1)

	)

63 
	#FD_FMT
 "%d"

	)

68 
	mMODE_READ
,

69 
	mMODE_WRITE
,

70 
	mMODE_REWRITE
,

71 
	mMODE_RND_READ
,

72 
	mMODE_RND_WRITE
,

73 
	mMODE_RND_RW
,

74 
	mMODE_MIXED


75 } 
	tfûe_ã°_mode_t
;

80 
	mFSYNC_ALL
,

81 
	mFSYNC_DATA


82 } 
	tfûe_fsync_mode_t
;

87 
	mFILE_IO_MODE_SYNC
,

88 
	mFILE_IO_MODE_ASYNC
,

89 
	mFILE_IO_MODE_MMAP


90 } 
	tfûe_io_mode_t
;

93 
	mSB_FILE_FLAG_SYNC
 = 1,

94 
	mSB_FILE_FLAG_DSYNC
 = 2,

95 
	mSB_FILE_FLAG_DIRECTIO
 = 4

96 } 
	tfûe_Êags_t
;

98 #ifde‡
HAVE_LIBAIO


102 
io_c⁄ãxt_t
 
	mio_˘xt
;

103 
	mƒeque°s
;

104 
io_evít
 *
	mevíts
;

105 } 
	tsb_aio_c⁄ãxt_t
;

110 
iocb
 
	miocb
;

111 
sb_fûe_›_t
 
	mty≥
;

112 
ssize_t
 
	mÀn
;

113 } 
	tsb_aio_›î_t
;

115 
sb_aio_c⁄ãxt_t
 *
	gaio_˘xts
;

120 *
	mbuf„r
;

121 
	mbuf„r_fûe_id
;

122 
	mbuf„r_pos
;

123 } 
	tsb_≥r_thªad_t
;

125 
sb_≥r_thªad_t
 *
	g≥r_thªad
;

128 
	gnum_fûes
;

129 
	gtŸÆ_size
;

130 
	gfûe_size
;

131 
	gfûe_block_size
;

132 
fûe_Êags_t
 
	gfûe_exåa_Êags
;

133 
	gfûe_fsync_‰eq
;

134 
	gfûe_fsync_Æl
;

135 
	gfûe_fsync_íd
;

136 
fûe_fsync_mode_t
 
	gfûe_fsync_mode
;

137 
	gfûe_rw_øtio
;

138 
	gfûe_mîged_ªque°s
;

139 
	gfûe_ªque°_size
;

140 
fûe_io_mode_t
 
	gfûe_io_mode
;

141 #ifde‡
HAVE_LIBAIO


142 
	gfûe_async_backlog
;

146 
	gposôi⁄
;

147 
	gcuºít_fûe
;

148 
	gfsyn˚d_fûe
;

150 
	gis_dúty
;

151 
	gªq_≥rf‹med
;

153 c⁄° 
	gmebibyã
 = 1024 * 1024;

154 c⁄° 
	gmegabyã
 = 1000 * 1000;

156 #ifde‡
HAVE_MMAP


158 **
	gmm≠s
;

159 
	gfûe_∑ge_mask
;

163 
FILE_DESCRIPTOR
 *
	gfûes
;

166 
fûe_ã°_mode_t
 
	gã°_mode
;

169 
sb_fûe_ªque°_t
 
	g¥ev_ªq
;

171 
sb_¨g_t
 
	gfûeio_¨gs
[] = {

172 
SB_OPT
("fûe-num", "numbî o‡fûe†tÿ¸óã", "128", 
INT
),

173 
SB_OPT
("file-block-size", "block sizeÅo use ináll IO operations", "16384",

174 
INT
),

175 
SB_OPT
("fûe-tŸÆ-size", "tŸÆ sizêo‡fûe†tÿ¸óã", "2G", 
SIZE
),

176 
SB_OPT
("file-test-mode",

177 "ã° modê{£qwr, seqªwr, seqrd,Ñndrd,Ñndwr,Ñndrw}", 
NULL
,

178 
STRING
),

179 
SB_OPT
("file-io-mode", "file operations mode {sync,async,mmap}", "sync",

180 
STRING
),

181 #ifde‡
HAVE_LIBAIO


182 
SB_OPT
("file-async-backlog",

183 "numbî o‡asynchr⁄ou†›î©⁄†tÿqueuê≥∏thªad", "128", 
INT
),

185 
SB_OPT
("file-extra-flags",

187 "", 
LIST
),

188 
SB_OPT
("file-fsync-freq", "do fsync()áfterÅhisÇumber ofÑequests "

189 "(0 - d⁄'àu£ fsync())", "100", 
INT
),

190 
SB_OPT
("file-fsync-all", "do fsync()áfterÉach write operation", "off",

191 
BOOL
),

192 
SB_OPT
("fûe-fsync-íd", "dÿfsync(Ë©Åhêíd o‡ã°", "⁄", 
BOOL
),

193 
SB_OPT
("file-fsync-mode",

195 "fsync", 
STRING
),

196 
SB_OPT
("file-merged-requests", "mergeát mostÅhisÇumber of IOÑequests "

197 "i‡possibÀ (0 - d⁄'àmîge)", "0", 
INT
),

198 
SB_OPT
("fûe-rw-øtio", "ªads/wrôe†øtiÿf‹ comböedÅe°", "1.5", 
DOUBLE
),

200 
SB_OPT_END


204 
fûe_cmd_¥ï¨e
();

205 
fûe_cmd_˛ónup
();

208 
fûe_öô
();

209 
fûe_¥öt_mode
();

210 
fûe_¥ï¨e
();

211 
sb_evít_t
 
fûe_√xt_evít
(
thªad_id
);

212 
fûe_execuã_evít
(
sb_evít_t
 *, );

213 
fûe_thªad_d⁄e
();

214 
fûe_d⁄e
();

215 
fûe_ªp‹t_öãrmedüã
(
sb_°©_t
 *);

216 
fûe_ªp‹t_cumuœtive
(
sb_°©_t
 *);

218 
sb_ã°_t
 
	gfûeio_ã°
 =

220 .
¢ame
 = "fileio",

221 .
	g ame
 = "File I/OÅest",

222 .
	g›s
 = {

223 .
öô
 = 
fûe_öô
,

224 .
	g¥ï¨e
 = 
fûe_¥ï¨e
,

225 .
	g¥öt_mode
 = 
fûe_¥öt_mode
,

226 .
	g√xt_evít
 = 
fûe_√xt_evít
,

227 .
	gexecuã_evít
 = 
fûe_execuã_evít
,

228 .
	gªp‹t_öãrmedüã
 = 
fûe_ªp‹t_öãrmedüã
,

229 .
	gªp‹t_cumuœtive
 = 
fûe_ªp‹t_cumuœtive
,

230 .
	gthªad_d⁄e
 = 
fûe_thªad_d⁄e
,

231 .
	gd⁄e
 = 
fûe_d⁄e


233 .
	gbuûtö_cmds
 = {

234 .
¥ï¨e
 = 
fûe_cmd_¥ï¨e
,

235 .
	g˛ónup
 = 
fûe_cmd_˛ónup


237 .
	g¨gs
 = 
fûeio_¨gs


241 
¸óã_fûes
();

242 
ªmove_fûes
();

243 
∑r£_¨gumíts
();

244 
öô_v¨s
();

245 
sb_evít_t
 
fûe_gë_£q_ªque°
();

246 
sb_evít_t
 
fûe_gë_∫d_ªque°
(
thªad_id
);

247 
check_£q_ªq
(
sb_fûe_ªque°_t
 *, sb_file_request_t *);

248 c⁄° *
gë_io_mode_°r
(
fûe_io_mode_t
 
mode
);

249 c⁄° *
gë_ã°_mode_°r
(
fûe_ã°_mode_t
 
mode
);

250 
fûe_fûl_buf„r
(*, , 
size_t
);

251 
fûe_vÆid©e_buf„r
(*, , 
size_t
);

254 
fûe_do_fsync
(, );

255 
fûe_fsync
(, );

256 
ssize_t
 
fûe_¥ód
(, *, ssize_t, , );

257 
ssize_t
 
fûe_pwrôe
(, *, ssize_t, , );

258 #ifde‡
HAVE_LIBAIO


259 
fûe_async_öô
();

260 
fûe_async_d⁄e
();

261 
fûe_submô_‹_waô
(
iocb
 *, 
sb_fûe_›_t
, 
ssize_t
, );

262 
fûe_waô
(, );

264 #ifde‡
HAVE_MMAP


265 
fûe_mm≠_¥ï¨e
();

266 
fûe_mm≠_d⁄e
();

270 
size_t
 
sb_gë_Æloˇti⁄_gønuœrôy
();

271 
sb_‰ì_memÆig√d
(*
buf
);

272 
FILE_DESCRIPTOR
 
sb_›í
(const *);

273 
sb_¸óã
(const *);

275 
	$ªgi°î_ã°_fûeio
(
sb_li°_t
 *
ã°s
)

277 
	`SB_LIST_ADD_TAIL
(&
fûeio_ã°
.
li°ôem
, 
ã°s
);

280 
	}
}

283 
	$fûe_öô
()

285 i‡(
	`∑r£_¨gumíts
())

288 
fûes
 = (
FILE_DESCRIPTOR
 *)
	`mÆloc
(
num_fûes
 * (FILE_DESCRIPTOR));

289 i‡(
fûes
 =
NULL
)

291 
	`log_ãxt
(
LOG_FATAL
, "Memoryállocation failure.");

295 #ifde‡
HAVE_LIBAIO


296 i‡(
	`fûe_async_öô
())

300 
	`öô_v¨s
();

303 
	}
}

306 
	$fûe_¥ï¨e
()

308 
i
;

309 
fûe_«me
[512];

311 
i
=0; i < 
num_fûes
; i++)

313 
	`¢¥ötf
(
fûe_«me
, (fûe_«me), "ã°_fûe.%d",
i
);

315 i‡(
ã°_mode
 =
MODE_WRITE
)

317 
	`u∆ök
(
fûe_«me
);

318 i‡(
	`sb_¸óã
(
fûe_«me
))

320 
	`log_î∫o
(
LOG_FATAL
, "C™nŸ cª©êfûê'%s'", 
fûe_«me
);

325 
	`log_ãxt
(
LOG_DEBUG
, "O≥nög fûe: %s", 
fûe_«me
);

326 
fûes
[
i
] = 
	`sb_›í
(
fûe_«me
);

327 i‡(!
	`VALID_FILE
(
fûes
[
i
]))

329 
	`log_î∫o
(
LOG_FATAL
, "C™nŸ o≥¿fûê'%s'", 
fûe_«me
);

330 
	`log_ãxt
(
LOG_WARNING
, "Did you forgetÅoÑunÅheÖrepare step?");

334 i‡(
ã°_mode
 =
MODE_WRITE
)

338 
°©
 
buf
;

339 i‡(
	`f°©
(
fûes
[
i
], &
buf
))

341 
	`log_î∫o
(
LOG_FATAL
, "f°©(ËÁûed o¿fûê'%s'", 
fûe_«me
);

344 i‡(
buf
.
°_size
 < 
fûe_size
)

346 
ss1
[16], 
ss2
[16];

347 
	`log_ãxt
(
LOG_FATAL
,

349 
fûe_«me
,

350 
	`sb_¥öt_vÆue_size
(
ss1
, (ss1), 
buf
.
°_size
),

351 
	`sb_¥öt_vÆue_size
(
ss2
, (ss2), 
fûe_size
));

352 
	`log_ãxt
(
LOG_WARNING
,

359 #ifde‡
HAVE_MMAP


360 i‡(
	`fûe_mm≠_¥ï¨e
())

365 
	}
}

368 
	$fûe_d⁄e
()

370 
i
;

372 
i
 = 0; i < 
num_fûes
; i++)

373 
	`˛o£
(
fûes
[
i
]);

375 #ifde‡
HAVE_LIBAIO


376 i‡(
	`fûe_async_d⁄e
())

380 #ifde‡
HAVE_MMAP


381 i‡(
	`fûe_mm≠_d⁄e
())

385 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

387 i‡(
≥r_thªad
[
i
].
buf„r
 !
NULL
)

388 
	`sb_‰ì_memÆig√d
(
≥r_thªad
[
i
].
buf„r
);

391 
	`‰ì
(
≥r_thªad
);

394 
	}
}

396 
sb_evít_t
 
	$fûe_√xt_evít
(
thªad_id
)

398 i‡(
ã°_mode
 =
MODE_WRITE
 ||Åe°_modê=
MODE_REWRITE
 ||

399 
ã°_mode
 =
MODE_READ
)

400  
	`fûe_gë_£q_ªque°
();

403  
	`fûe_gë_∫d_ªque°
(
thªad_id
);

404 
	}
}

410 
sb_evít_t
 
	$fûe_gë_£q_ªque°
()

412 
sb_evít_t
 
sb_ªq
;

413 
sb_fûe_ªque°_t
 *
fûe_ªq
 = &
sb_ªq
.
u
.
fûe_ªque°
;

415 
sb_ªq
.
ty≥
 = 
SB_REQ_TYPE_FILE
;

416 
	`SB_THREAD_MUTEX_LOCK
();

419 i‡(
ã°_mode
 =
MODE_WRITE
 ||Åe°_modê=
MODE_REWRITE
)

420 
fûe_ªq
->
›î©i⁄
 = 
FILE_OP_TYPE_WRITE
;

422 
fûe_ªq
->
›î©i⁄
 = 
FILE_OP_TYPE_READ
;

425 i‡(
fûe_fsync_‰eq
 !0 && 
fûe_ªq
->
›î©i⁄
 =
FILE_OP_TYPE_WRITE
 &&

426 
is_dúty
 && 
ªq_≥rf‹med
 % 
fûe_fsync_‰eq
 == 0)

428 
fûe_ªq
->
›î©i⁄
 = 
FILE_OP_TYPE_FSYNC
;

429 
fûe_ªq
->
fûe_id
 = 
fsyn˚d_fûe
;

430 
fûe_ªq
->
pos
 = 0;

431 
fûe_ªq
->
size
 = 0;

432 
fsyn˚d_fûe
++;

433 i‡(
fsyn˚d_fûe
 =
num_fûes
)

435 
fsyn˚d_fûe
 = 0;

436 
is_dúty
 = 0;

439 
	`SB_THREAD_MUTEX_UNLOCK
();

440  
sb_ªq
;

443 
ªq_≥rf‹med
++;

445 i‡(
fûe_ªq
->
›î©i⁄
 =
FILE_OP_TYPE_WRITE
)

446 
is_dúty
 = 1;

449 i‡(
cuºít_fûe
 =
num_fûes
)

451 
posôi⁄
= 0;

452 
cuºít_fûe
= 0;

455 
fûe_ªq
->
fûe_id
 = 
cuºít_fûe
;

456 
fûe_ªq
->
pos
 = 
posôi⁄
;

457 
fûe_ªq
->
size
 = 
	`SB_MIN
(
fûe_ªque°_size
, 
fûe_size
 - 
posôi⁄
);

459 
posôi⁄
 +
fûe_ªq
->
size
;

462 i‡(
posôi⁄
 =
fûe_size
)

464 
cuºít_fûe
++;

465 
posôi⁄
=0;

468 i‡(
sb_globÆs
.
vÆid©e
)

470 
	`check_£q_ªq
(&
¥ev_ªq
, 
fûe_ªq
);

471 
¥ev_ªq
 = *
fûe_ªq
;

474 
	`SB_THREAD_MUTEX_UNLOCK
();

476  
sb_ªq
;

477 
	}
}

483 
sb_evít_t
 
	$fûe_gë_∫d_ªque°
(
thªad_id
)

485 
sb_evít_t
 
sb_ªq
;

486 
sb_fûe_ªque°_t
 *
fûe_ªq
 = &
sb_ªq
.
u
.
fûe_ªque°
;

487 
tmµos
;

488 
mode
 = 
ã°_mode
;

489 
i
;

491 
sb_ªq
.
ty≥
 = 
SB_REQ_TYPE_FILE
;

493 i‡(
ã°_mode
 =
MODE_RND_RW
)

495 
mode
 = (
	`sb_cou¡î_vÆ
(
thªad_id
, 
SB_CNT_READ
) + 1.0) /

496 (
	`sb_cou¡î_vÆ
(
thªad_id
, 
SB_CNT_WRITE
Ë+ 1.0Ë< 
fûe_rw_øtio
 ?

497 
MODE_RND_READ
 : 
MODE_RND_WRITE
;

504 i‡(
fûe_fsync_‰eq
 !0 && 
is_dúty
)

506 i‡(
ªq_≥rf‹med
 % 
fûe_fsync_‰eq
 == 0)

508 
fûe_ªq
->
›î©i⁄
 = 
FILE_OP_TYPE_FSYNC
;

509 
fûe_ªq
->
fûe_id
 = 
fsyn˚d_fûe
;

510 
fûe_ªq
->
pos
 = 0;

511 
fûe_ªq
->
size
 = 0;

512 
fsyn˚d_fûe
++;

513 i‡(
fsyn˚d_fûe
 =
num_fûes
)

515 
fsyn˚d_fûe
 = 0;

516 
is_dúty
 = 0;

519 
	`SB_THREAD_MUTEX_UNLOCK
();

520  
sb_ªq
;

524 i‡(
mode
==
MODE_RND_WRITE
)

525 
fûe_ªq
->
›î©i⁄
 = 
FILE_OP_TYPE_WRITE
;

527 
fûe_ªq
->
›î©i⁄
 = 
FILE_OP_TYPE_READ
;

529 
ªåy
:

530 
tmµos
 = (Ë(
	`sb_ønd_unif‹m_doubÀ
(Ë* 
tŸÆ_size
);

531 
tmµos
 =Åmµo†- (tmµo†% (Ë
fûe_block_size
);

532 
fûe_ªq
->
fûe_id
 = (Ë(
tmµos
 / (Ë
fûe_size
);

533 
fûe_ªq
->
pos
 = (Ë(
tmµos
 % (Ë
fûe_size
);

534 
fûe_ªq
->
size
 = 
	`SB_MIN
(
fûe_block_size
, 
fûe_size
 - fûe_ªq->
pos
);

536 i‡(
sb_globÆs
.
vÆid©e
)

542 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

544 i‡(
i
 !(Ë
thªad_id
 && 
≥r_thªad
[i].
buf„r_fûe_id
 =
fûe_ªq
->
fûe_id
 &&

545 
≥r_thªad
[
i
].
buf„r_pos
 =
fûe_ªq
->
pos
)

546 
ªåy
;

550 
≥r_thªad
[
thªad_id
].
buf„r_fûe_id
 = 
fûe_ªq
->
fûe_id
;

551 
≥r_thªad
[
thªad_id
].
buf„r_pos
 = 
fûe_ªq
->
pos
;

553 
ªq_≥rf‹med
++;

554 i‡(
fûe_ªq
->
›î©i⁄
 =
FILE_OP_TYPE_WRITE
)

555 
is_dúty
 = 1;

557 
	`SB_THREAD_MUTEX_UNLOCK
();

558  
sb_ªq
;

559 
	}
}

562 
	$fûe_execuã_evít
(
sb_evít_t
 *
sb_ªq
, 
thªad_id
)

564 
FILE_DESCRIPTOR
 
fd
;

565 
sb_fûe_ªque°_t
 *
fûe_ªq
 = &
sb_ªq
->
u
.
fûe_ªque°
;

567 i‡(
sb_globÆs
.
debug
)

569 
	`log_ãxt
(
LOG_DEBUG
,

572 
fûe_ªq
->
›î©i⁄
,

573 
fûe_ªq
->
fûe_id
,

574 ()
fûe_ªq
->
pos
,

575 ()
fûe_ªq
->
size
);

579 i‡(
fûe_ªq
->
fûe_id
 > 
num_fûes
)

581 
	`log_ãxt
(
LOG_FATAL
, "Inc‹ª˘ fûêid i¿ªque°: %u", 
fûe_ªq
->
fûe_id
);

584 i‡(
fûe_ªq
->
pos
 + fûe_ªq->
size
 > 
fûe_size
)

586 
	`log_ãxt
(
LOG_FATAL
, "I/OÑequestÉxceeds file size. "

588 
fûe_ªq
->
fûe_id
, (Ë
fûe_size
,

589 (Ë
fûe_ªq
->
pos
, (Ëfûe_ªq->
size
);

592 
fd
 = 
fûes
[
fûe_ªq
->
fûe_id
];

594 
fûe_ªq
->
›î©i⁄
) {

595 
FILE_OP_TYPE_NULL
:

596 
	`log_ãxt
(
LOG_FATAL
, "Execute of NULLÑequest called !,áborting");

598 
FILE_OP_TYPE_WRITE
:

601 i‡(
sb_globÆs
.
vÆid©e
)

602 
	`fûe_fûl_buf„r
(
≥r_thªad
[
thªad_id
].
buf„r
, 
fûe_ªq
->
size
, fûe_ªq->
pos
);

604 if(
	`fûe_pwrôe
(
fûe_ªq
->
fûe_id
, 
≥r_thªad
[
thªad_id
].
buf„r
,

605 
fûe_ªq
->
size
, fûe_ªq->
pos
, 
thªad_id
)

606 !(
ssize_t
)
fûe_ªq
->
size
)

608 
	`log_î∫o
(
LOG_FATAL
, "FaûedÅÿwrôêfûe! fûe: " 
FD_FMT
 "Öos: %lld",

609 
fd
, ()
fûe_ªq
->
pos
);

614 i‡(
fûe_fsync_Æl
 && 
	`fûe_fsync
(
fûe_ªq
->
fûe_id
, 
thªad_id
))

618 i‡(
fûe_io_mode
 !
FILE_IO_MODE_ASYNC
)

620 
	`sb_cou¡î_öc
(
thªad_id
, 
SB_CNT_WRITE
);

621 
	`sb_cou¡î_add
(
thªad_id
, 
SB_CNT_BYTES_WRITTEN
, 
fûe_ªq
->
size
);

625 
FILE_OP_TYPE_READ
:

626 if(
	`fûe_¥ód
(
fûe_ªq
->
fûe_id
, 
≥r_thªad
[
thªad_id
].
buf„r
,

627 
fûe_ªq
->
size
, fûe_ªq->
pos
, 
thªad_id
)

628 !(
ssize_t
)
fûe_ªq
->
size
)

630 
	`log_î∫o
(
LOG_FATAL
, "FaûedÅÿªad fûe! fûe: " 
FD_FMT
 "Öos: %lld",

631 
fd
, ()
fûe_ªq
->
pos
);

636 i‡(
sb_globÆs
.
vÆid©e
 &&

637 
	`fûe_vÆid©e_buf„r
(
≥r_thªad
[
thªad_id
].
buf„r
, 
fûe_ªq
->
size
, fûe_ªq->
pos
))

639 
	`log_ãxt
(
LOG_FATAL
,

640 "VÆid©i⁄ faûed o¿fûê" 
FD_FMT
 ", block offset %lld,Éxiting...",

641 
fûe_ªq
->
fûe_id
, (Ëfûe_ªq->
pos
);

646 if(
fûe_io_mode
 !
FILE_IO_MODE_ASYNC
)

648 
	`sb_cou¡î_öc
(
thªad_id
, 
SB_CNT_READ
);

649 
	`sb_cou¡î_add
(
thªad_id
, 
SB_CNT_BYTES_READ
, 
fûe_ªq
->
size
);

653 
FILE_OP_TYPE_FSYNC
:

655 i‡(
fûe_fsync_Æl
)

657 if(
	`fûe_fsync
(
fûe_ªq
->
fûe_id
, 
thªad_id
))

662 
	`log_ãxt
(
LOG_FATAL
, "Execute of UNKNOWN fileÑequestÅype called (%d)!, "

663 "ab‹tög", 
fûe_ªq
->
›î©i⁄
);

668 
	}
}

670 
	$¥öt_fûe_exåa_Êags
()

672 
	`log_ãxt
(
LOG_NOTICE
, "Extra file open flags: %s%s%s%s",

673 
fûe_exåa_Êags
 == 0 ? "(none)" : "",

674 
fûe_exåa_Êags
 & 
SB_FILE_FLAG_SYNC
 ? "sync " : "",

675 
fûe_exåa_Êags
 & 
SB_FILE_FLAG_DSYNC
 ? "dsync ": "",

676 
fûe_exåa_Êags
 & 
SB_FILE_FLAG_DIRECTIO
 ? "directio" : ""

678 
	}
}

680 
	$fûe_¥öt_mode
()

682 
size°r
[16];

684 
	`¥öt_fûe_exåa_Êags
();

685 
	`log_ãxt
(
LOG_NOTICE
, "%d fûes, %sBÉach", 
num_fûes
,

686 
	`sb_¥öt_vÆue_size
(
size°r
, (size°r), 
fûe_size
));

687 
	`log_ãxt
(
LOG_NOTICE
, "%sBÅotal file size",

688 
	`sb_¥öt_vÆue_size
(
size°r
, (sizestr),

689 
fûe_size
 * 
num_fûes
));

690 
	`log_ãxt
(
LOG_NOTICE
, "Block size %sB",

691 
	`sb_¥öt_vÆue_size
(
size°r
, (size°r), 
fûe_block_size
));

692 i‡(
fûe_mîged_ªque°s
 > 0)

693 
	`log_ãxt
(
LOG_NOTICE
, "MergingÑequests upÅo %sB for sequential IO.",

694 
	`sb_¥öt_vÆue_size
(
size°r
, (sizestr),

695 
fûe_ªque°_size
));

697 
ã°_mode
)

699 
MODE_RND_WRITE
:

700 
MODE_RND_READ
:

701 
MODE_RND_RW
:

702 
	`log_ãxt
(
LOG_NOTICE
, "Numbî o‡IOÑeque°s: %" 
PRIu64
,

703 
sb_globÆs
.
max_evíts
);

704 
	`log_ãxt
(
LOG_NOTICE
,

706 
fûe_rw_øtio
);

712 i‡(
fûe_fsync_‰eq
 > 0)

713 
	`log_ãxt
(
LOG_NOTICE
,

715 
fûe_fsync_‰eq
);

717 i‡(
fûe_fsync_íd
)

718 
	`log_ãxt
(
LOG_NOTICE
, "Calling fsync()átÅheÉnd ofÅest, Enabled.");

720 i‡(
fûe_fsync_Æl
)

721 
	`log_ãxt
(
LOG_NOTICE
, "Calling fsync()áfterÉach write operation.");

723 
	`log_ãxt
(
LOG_NOTICE
, "Usög %†I/O mode", 
	`gë_io_mode_°r
(
fûe_io_mode
));

725 i‡(
sb_globÆs
.
vÆid©e
)

726 
	`log_ãxt
(
LOG_NOTICE
, "Using checksums validation.");

728 
	`log_ãxt
(
LOG_NOTICE
, "Doög %†ã°", 
	`gë_ã°_mode_°r
(
ã°_mode
));

729 
	}
}

733 
	$fûe_ªp‹t_öãrmedüã
(
sb_°©_t
 *
°©
)

735 c⁄° 
£c⁄ds
 = 
°©
->
time_öãrvÆ
;

737 
	`log_time°amp
(
LOG_NOTICE
, 
°©
->
time_tŸÆ
,

740 
°©
->
byãs_ªad
 / 
mebibyã
 / 
£c⁄ds
,

741 
°©
->
byãs_wrôãn
 / 
mebibyã
 / 
£c⁄ds
,

742 
°©
->
Ÿhî
 / 
£c⁄ds
,

743 
sb_globÆs
.
≥r˚¡ûe
,

744 
	`SEC2MS
(
°©
->
œãncy_p˘
));

745 
	}
}

749 
	$fûe_ªp‹t_cumuœtive
(
sb_°©_t
 *
°©
)

751 c⁄° 
£c⁄ds
 = 
°©
->
time_öãrvÆ
;

753 
	`log_ãxt
(
LOG_NOTICE
, "\n"

758 
°©
->
ªads
 / 
£c⁄ds
,

759 
°©
->
byãs_ªad
 / 
mebibyã
 / 
£c⁄ds
,

760 
°©
->
byãs_ªad
 / 
megabyã
 / 
£c⁄ds
,

761 
°©
->
wrôes
 / 
£c⁄ds
,

762 
°©
->
byãs_wrôãn
 / 
mebibyã
 / 
£c⁄ds
,

763 
°©
->
byãs_wrôãn
 / 
megabyã
 / 
£c⁄ds
,

764 
°©
->
Ÿhî
 / 
£c⁄ds


767 
	`log_ãxt
(
LOG_NOTICE
, "");

769 
	`log_ãxt
(
LOG_NOTICE
, "Latency (ms):");

770 
	`log_ãxt
(
LOG_NOTICE
, " min: %10.2f",

771 
	`SEC2MS
(
°©
->
œãncy_mö
));

772 
	`log_ãxt
(
LOG_NOTICE
, "ávg: %10.2f",

773 
	`SEC2MS
(
°©
->
œãncy_avg
));

774 
	`log_ãxt
(
LOG_NOTICE
, " max: %10.2f",

775 
	`SEC2MS
(
°©
->
œãncy_max
));

777 i‡(
sb_globÆs
.
≥r˚¡ûe
 > 0)

778 
	`log_ãxt
(
LOG_NOTICE
, " %3dthÖercentile: %10.2f",

779 
sb_globÆs
.
≥r˚¡ûe
, 
	`SEC2MS
(
°©
->
œãncy_p˘
));

781 
	`log_ãxt
(
LOG_NOTICE
, "Öercentile stats: disabled");

783 
	`log_ãxt
(
LOG_NOTICE
, " sum: %10.2f",

784 
	`SEC2MS
(
°©
->
œãncy_sum
));

785 
	`log_ãxt
(
LOG_NOTICE
, "");

786 
	}
}

790 c⁄° *
	$gë_io_mode_°r
(
fûe_io_mode_t
 
mode
)

792 
mode
) {

793 
FILE_IO_MODE_SYNC
:

795 
FILE_IO_MODE_ASYNC
:

797 
FILE_IO_MODE_MMAP
:

798 #i‡
SIZEOF_SIZE_T
 == 4

808 
	}
}

814 c⁄° *
	$gë_ã°_mode_°r
(
fûe_ã°_mode_t
 
mode
)

816 
mode
) {

817 
MODE_WRITE
:

819 
MODE_REWRITE
:

821 
MODE_READ
:

823 
MODE_RND_READ
:

825 
MODE_RND_WRITE
:

827 
MODE_RND_RW
:

829 
MODE_MIXED
:

836 
	}
}

844 
	$c⁄vît_exåa_Êags
(
fûe_Êags_t
 
exåa_Êags
, *
›í_Êags
)

846 i‡(
exåa_Êags
)

848 *
›í_Êags
 = 0;

850 i‡(
exåa_Êags
 & 
SB_FILE_FLAG_SYNC
)

852 *
›í_Êags
 |
O_SYNC
;

855 i‡(
exåa_Êags
 & 
SB_FILE_FLAG_DSYNC
)

857 #ifde‡
O_DSYNC


858 *
›í_Êags
 |
O_DSYNC
;

860 
	`log_ãxt
(
LOG_FATAL
,

866 i‡(
exåa_Êags
 & 
SB_FILE_FLAG_DIRECTIO
)

868 #ifde‡
HAVE_DIRECTIO


870 #ñi‡
	`deföed
(
O_DIRECT
)

871 *
›í_Êags
 |
O_DIRECT
;

873 
	`log_ãxt
(
LOG_FATAL
,

879 i‡(
exåa_Êags
 > 
SB_FILE_FLAG_DIRECTIO
)

881 
	`log_ãxt
(
LOG_FATAL
, "Unknow¿exå®Êag†vÆue: %d", (Ë
exåa_Êags
);

887 
	}
}

891 
	$¸óã_fûes
()

893 
i
;

894 
fd
;

895 
fûe_«me
[512];

896 
off£t
;

897 
wrôãn
 = 0;

898 
sb_timî_t
 
t
;

899 
£c⁄ds
;

900 
Êags
 = 0;

902 
	`log_ãxt
(
LOG_NOTICE
, "%d fûes, %ldKbÉach, %ldMbÅŸÆ", 
num_fûes
,

903 ()(
fûe_size
 / 1024),

904 ()((
fûe_size
 * 
num_fûes
) / (1024 * 1024)));

905 
	`log_ãxt
(
LOG_NOTICE
, "Creating files forÅheÅest...");

906 
	`¥öt_fûe_exåa_Êags
();

908 i‡(
	`c⁄vît_exåa_Êags
(
fûe_exåa_Êags
, &
Êags
))

911 
	`sb_timî_öô
(&
t
);

912 
	`sb_timî_°¨t
(&
t
);

914 
i
=0; i < 
num_fûes
; i++)

916 
	`¢¥ötf
(
fûe_«me
, (fûe_«me), "ã°_fûe.%d",
i
);

918 
fd
 = 
	`›í
(
fûe_«me
, 
O_CREAT
 | 
O_WRONLY
 | 
Êags
, 
S_IRUSR
 | 
S_IWUSR
);

919 i‡(
fd
 < 0)

921 
	`log_î∫o
(
LOG_FATAL
, "Can't open file");

925 
off£t
 = (Ë
	`l£ek
(
fd
, 0, 
SEEK_END
);

927 i‡(
off£t
 >
fûe_size
)

928 
	`log_ãxt
(
LOG_NOTICE
, "ReusögÉxi°ög fûê%s", 
fûe_«me
);

929 i‡(
off£t
 > 0)

930 
	`log_ãxt
(
LOG_NOTICE
, "ExãndögÉxi°ög fûê%s", 
fûe_«me
);

932 
	`log_ãxt
(
LOG_NOTICE
, "Cª©ög fûê%s", 
fûe_«me
);

934 ; 
off£t
 < 
fûe_size
;

935 
wrôãn
 +
fûe_block_size
, 
off£t
 += file_block_size)

941 i‡(
sb_globÆs
.
vÆid©e
)

942 
	`fûe_fûl_buf„r
(
≥r_thªad
[0].
buf„r
, 
fûe_block_size
, 
off£t
);

944 i‡(
	`wrôe
(
fd
, 
≥r_thªad
[0].
buf„r
, 
fûe_block_size
) < 0)

945 
îr‹
;

949 
	`fsync
(
fd
);

950 
	`˛o£
(
fd
);

953 
£c⁄ds
 = 
	`NS2SEC
(
	`sb_timî_°›
(&
t
));

955 i‡(
wrôãn
 > 0)

956 
	`log_ãxt
(
LOG_NOTICE
, "%llu bytes written in %.2f seconds (%.2f MiB/sec).",

957 
wrôãn
, 
£c⁄ds
,

958 (Ë(
wrôãn
 / 
mebibyã
Ë/ 
£c⁄ds
);

960 
	`log_ãxt
(
LOG_NOTICE
, "No bytes written.");

964 
îr‹
:

965 
	`log_î∫o
(
LOG_FATAL
, "FailedÅo write file!");

966 
	`˛o£
(
fd
);

968 
	}
}

974 
	$ªmove_fûes
()

976 
i
;

977 
fûe_«me
[512];

979 
	`log_ãxt
(
LOG_NOTICE
, "RemovingÅest files...");

981 
i
 = 0; i < 
num_fûes
; i++)

983 
	`¢¥ötf
(
fûe_«me
, (fûe_«me), "ã°_fûe.%d",
i
);

984 
	`u∆ök
(
fûe_«me
);

988 
	}
}

994 
	$fûe_cmd_¥ï¨e
()

996 i‡(
	`∑r£_¨gumíts
())

1003 i‡(
ã°_mode
 =
MODE_WRITE
)

1004  
	`ªmove_fûes
();

1006  
	`¸óã_fûes
();

1007 
	}
}

1013 
	$fûe_cmd_˛ónup
()

1015 i‡(
	`∑r£_¨gumíts
())

1018  
	`ªmove_fûes
();

1019 
	}
}

1021 
	$öô_v¨s
()

1023 
posôi⁄
 = 0;

1024 
cuºít_fûe
 = 0;

1025 
fsyn˚d_fûe
 = 0;

1026 
ªq_≥rf‹med
 = 0;

1027 
is_dúty
 = 0;

1028 i‡(
sb_globÆs
.
vÆid©e
)

1030 
¥ev_ªq
.
size
 = 0;

1031 
¥ev_ªq
.
›î©i⁄
 = 
FILE_OP_TYPE_NULL
;

1032 
¥ev_ªq
.
fûe_id
 = 0;

1033 
¥ev_ªq
.
pos
 = 0;

1035 
	}
}

1042 
	$fûe_thªad_d⁄e
(
thªad_id
)

1044 i‡(
fûe_fsync_íd
 && 
ã°_mode
 !
MODE_READ
 &&Åe°_modê!
MODE_RND_READ
)

1046 
i
 = 0; i < 
num_fûes
; i++)

1048 if(
	`fûe_fsync
(
i
, 
thªad_id
))

1053 #ifde‡
HAVE_LIBAIO


1054 i‡(
fûe_io_mode
 =
FILE_IO_MODE_ASYNC
 && 
aio_˘xts
[
thªad_id
].
ƒeque°s
 > 0)

1055  
	`fûe_waô
(
thªad_id
, 
aio_˘xts
[thªad_id].
ƒeque°s
);

1059 
	}
}

1061 #ifde‡
HAVE_LIBAIO


1065 
	$fûe_async_öô
()

1067 
i
;

1069 i‡(
fûe_io_mode
 !
FILE_IO_MODE_ASYNC
)

1072 
fûe_async_backlog
 = 
	`sb_gë_vÆue_öt
("file-async-backlog");

1073 i‡(
fûe_async_backlog
 <= 0) {

1074 
	`log_ãxt
(
LOG_FATAL
, "Invalid value of file-async-backlog: %d",

1075 
fûe_async_backlog
);

1079 
aio_˘xts
 = (
sb_aio_c⁄ãxt_t
 *)
	`ˇŒoc
(
sb_globÆs
.
thªads
,

1080 (
sb_aio_c⁄ãxt_t
));

1081 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

1083 i‡(
	`io_queue_öô
(
fûe_async_backlog
, &
aio_˘xts
[
i
].
io_˘xt
))

1085 
	`log_î∫o
(
LOG_FATAL
, "io_queue_init() failed!");

1089 
aio_˘xts
[
i
].
evíts
 = (
io_evít
 *)
	`mÆloc
(
fûe_async_backlog
 *

1090 (
io_evít
));

1091 i‡(
aio_˘xts
[
i
].
evíts
 =
NULL
)

1093 
	`log_î∫o
(
LOG_FATAL
, "FailedÅoállocateásync I/O context!");

1099 
	}
}

1105 
	$fûe_async_d⁄e
()

1107 
i
;

1109 i‡(
fûe_io_mode
 !
FILE_IO_MODE_ASYNC
)

1112 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

1114 
	`io_queue_ªÀa£
(
aio_˘xts
[
i
].
io_˘xt
);

1115 
	`‰ì
(
aio_˘xts
[
i
].
evíts
);

1118 
	`‰ì
(
aio_˘xts
);

1121 
	}
}

1129 
	$fûe_submô_‹_waô
(
iocb
 *iocb, 
sb_fûe_›_t
 
ty≥
, 
ssize_t
 
Àn
,

1130 
thªad_id
)

1132 
sb_aio_›î_t
 *
›î
;

1133 
iocb
 *
iocbp
;

1135 
›î
 = (
sb_aio_›î_t
 *)
	`mÆloc
((sb_aio_oper_t));

1136 i‡(
›î
 =
NULL
)

1138 
	`log_ãxt
(
LOG_FATAL
, "FailedÅoállocate AIO operation!");

1142 
	`mem˝y
(&
›î
->
iocb
, iocb, (*iocb));

1143 
›î
->
ty≥
 =Åype;

1144 
›î
->
Àn
 =Üen;

1145 
iocbp
 = &
›î
->
iocb
;

1147 i‡(
	`io_submô
(
aio_˘xts
[
thªad_id
].
io_˘xt
, 1, &
iocbp
) < 1)

1149 
	`log_î∫o
(
LOG_FATAL
, "io_submit() failed!");

1153 
aio_˘xts
[
thªad_id
].
ƒeque°s
++;

1154 i‡(
aio_˘xts
[
thªad_id
].
ƒeque°s
 < 
fûe_async_backlog
)

1157  
	`fûe_waô
(
thªad_id
, 1);

1158 
	}
}

1166 
	$fûe_waô
(
thªad_id
, 
ƒeq
)

1168 
i
;

1169 
ƒ
;

1170 
io_evít
 *
evít
;

1171 
sb_aio_›î_t
 *
›î
;

1172 
iocb
 *
iocbp
;

1175 #ifde‡
HAVE_OLD_GETEVENTS


1176 ()
ƒeq
;

1177 
ƒ
 = 
	`io_gëevíts
(
aio_˘xts
[
thªad_id
].
io_˘xt
, 
fûe_async_backlog
,

1178 
aio_˘xts
[
thªad_id
].
evíts
, 
NULL
);

1180 
ƒ
 = 
	`io_gëevíts
(
aio_˘xts
[
thªad_id
].
io_˘xt
, 
ƒeq
, 
fûe_async_backlog
,

1181 
aio_˘xts
[
thªad_id
].
evíts
, 
NULL
);

1183 i‡(
ƒ
 < 1)

1185 
	`log_î∫o
(
LOG_FATAL
, "io_getevents() failed!");

1190 
i
 = 0; i < 
ƒ
; i++)

1192 
evít
 = (
io_evít
 *)
aio_˘xts
[
thªad_id
].
evíts
 + 
i
;

1193 
iocbp
 = (
iocb
 *)()
evít
->
obj
;

1194 
›î
 = (
sb_aio_›î_t
 *)
iocbp
;

1195 
›î
->
ty≥
) {

1196 
FILE_OP_TYPE_FSYNC
:

1197 i‡(
evít
->
ªs
 != 0)

1199 
	`log_ãxt
(
LOG_FATAL
, "Asynchronous fsync failed!\n");

1203 
	`sb_cou¡î_öc
(
thªad_id
, 
SB_CNT_OTHER
);

1207 
FILE_OP_TYPE_READ
:

1208 i‡((
ssize_t
)
evít
->
ªs
 !
›î
->
Àn
)

1210 
	`log_ãxt
(
LOG_FATAL
, "AsynchronousÑead failed!\n");

1214 
	`sb_cou¡î_öc
(
thªad_id
, 
SB_CNT_READ
);

1215 
	`sb_cou¡î_add
(
thªad_id
, 
SB_CNT_BYTES_READ
, 
›î
->
Àn
);

1219 
FILE_OP_TYPE_WRITE
:

1220 i‡((
ssize_t
)
evít
->
ªs
 !
›î
->
Àn
)

1222 
	`log_ãxt
(
LOG_FATAL
, "Asynchronous write failed!\n");

1226 
	`sb_cou¡î_öc
(
thªad_id
, 
SB_CNT_WRITE
);

1227 
	`sb_cou¡î_add
(
thªad_id
, 
SB_CNT_BYTES_WRITTEN
, 
›î
->
Àn
);

1234 
	`‰ì
(
›î
);

1235 
aio_˘xts
[
thªad_id
].
ƒeque°s
--;

1239 
	}
}

1243 #ifde‡
HAVE_MMAP


1247 
	$fûe_mm≠_¥ï¨e
()

1249 
i
;

1251 i‡(
fûe_io_mode
 !
FILE_IO_MODE_MMAP
)

1254 
fûe_∑ge_mask
 = ~(
	`sb_gë_Æloˇti⁄_gønuœrôy
() - 1);

1257 i‡(
ã°_mode
 =
MODE_WRITE
)

1258 
i
 = 0; i < 
num_fûes
; i++)

1260 i‡(
	`·runˇã
(
fûes
[
i
], 
fûe_size
))

1262 
	`log_î∫o
(
LOG_FATAL
, "·runˇã(ËÁûed o¿fûê%d", 
i
);

1267 #i‡
SIZEOF_SIZE_T
 > 4

1268 
mm≠s
 = (**)
	`mÆloc
(
num_fûes
 * (*));

1269 
i
 = 0; i < 
num_fûes
; i++)

1271 
mm≠s
[
i
] = 
	`mm≠
(
NULL
, 
fûe_size
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
,

1272 
fûes
[
i
], 0);

1273 i‡(
mm≠s
[
i
] =
MAP_FAILED
)

1275 
	`log_î∫o
(
LOG_FATAL
, "mm≠(ËÁûed o¿fûê%d", 
i
);

1280 ()
i
;

1284 
	}
}

1290 
	$fûe_mm≠_d⁄e
()

1292 
i
;

1294 i‡(
fûe_io_mode
 !
FILE_IO_MODE_MMAP
)

1297 #i‡
SIZEOF_SIZE_T
 > 4

1298 
i
 = 0; i < 
num_fûes
; i++)

1299 
	`munm≠
(
mm≠s
[
i
], 
fûe_size
);

1301 
	`‰ì
(
mm≠s
);

1303 ()
i
;

1307 
	}
}

1310 
	$fûe_do_fsync
(
id
, 
thªad_id
)

1312 
FILE_DESCRIPTOR
 
fd
 = 
fûes
[
id
];

1313 #ifde‡
HAVE_LIBAIO


1314 
iocb
 iocb;

1316 ()
thªad_id
;

1323 i‡(
fûe_io_mode
 =
FILE_IO_MODE_SYNC


1324 || 
fûe_io_mode
 =
FILE_IO_MODE_ASYNC


1325 #i‡
	`deföed
(
HAVE_MMAP
Ë&& 
SIZEOF_SIZE_T
 == 4

1327 || 
fûe_io_mode
 =
FILE_IO_MODE_MMAP


1331 i‡(
fûe_fsync_mode
 =
FSYNC_ALL
)

1332  
	`fsync
(
fd
);

1334 #ifde‡
F_FULLFSYNC


1335  
	`f˙é
(
fd
, 
F_FULLFSYNC
) != -1;

1336 #ñi‡
	`deföed
(
HAVE_FDATASYNC
)

1337  
	`fd©async
(
fd
);

1339 
	`log_ãxt
(
LOG_ALERT
, "Unknow¿fsyn¯mode: %d", 
fûe_fsync_mode
);

1344 #ifde‡
HAVE_LIBAIO


1345 i‡(
fûe_io_mode
 =
FILE_IO_MODE_ASYNC
)

1348 i‡(
fûe_fsync_mode
 =
FSYNC_ALL
)

1349 
	`io_¥ï_fsync
(&
iocb
, 
fd
);

1351 
	`io_¥ï_fdsync
(&
iocb
, 
fd
);

1353  
	`fûe_submô_‹_waô
(&
iocb
, 
FILE_OP_TYPE_FSYNC
, 0, 
thªad_id
);

1356 #ifde‡
HAVE_MMAP


1358 i‡(
fûe_io_mode
 =
FILE_IO_MODE_MMAP
)

1360  
	`msync
(
mm≠s
[
id
], 
fûe_size
, 
MS_SYNC
 | 
MS_INVALIDATE
);

1365 
	}
}

1368 
	$fûe_fsync
(
id
, 
thªad_id
)

1370 i‡(
	`fûe_do_fsync
(
id
, 
thªad_id
))

1372 
	`log_î∫o
(
LOG_FATAL
, "FaûedÅÿfsyn¯fûe! fûe: " 
FD_FMT
, 
fûes
[
id
]);

1376 
	`sb_cou¡î_öc
(
thªad_id
, 
SB_CNT_OTHER
);

1379 
	}
}

1382 
ssize_t
 
	$fûe_¥ód
(
fûe_id
, *
buf
, 
ssize_t
 
cou¡
,

1383 
off£t
, 
thªad_id
)

1385 
FILE_DESCRIPTOR
 
fd
 = 
fûes
[
fûe_id
];

1386 #ifde‡
HAVE_MMAP


1387 *
°¨t
;

1388 
∑ge_addr
;

1389 
∑ge_off£t
;

1391 #ifde‡
HAVE_LIBAIO


1392 
iocb
 iocb;

1394 ()
thªad_id
;

1397 i‡(
fûe_io_mode
 =
FILE_IO_MODE_SYNC
)

1398  
	`¥ód
(
fd
, 
buf
, 
cou¡
, 
off£t
);

1399 #ifde‡
HAVE_LIBAIO


1400 i‡(
fûe_io_mode
 =
FILE_IO_MODE_ASYNC
)

1403 
	`io_¥ï_¥ód
(&
iocb
, 
fd
, 
buf
, 
cou¡
, 
off£t
);

1405 i‡(
	`fûe_submô_‹_waô
(&
iocb
, 
FILE_OP_TYPE_READ
, 
cou¡
, 
thªad_id
))

1408  
cou¡
;

1411 #ifde‡
HAVE_MMAP


1412 i‡(
fûe_io_mode
 =
FILE_IO_MODE_MMAP
)

1414 #i‡
SIZEOF_SIZE_T
 == 4

1416 
∑ge_addr
 = 
off£t
 & 
fûe_∑ge_mask
;

1417 
∑ge_off£t
 = 
off£t
 - 
∑ge_addr
;

1418 
°¨t
 = 
	`mm≠
(
NULL
, 
cou¡
 + 
∑ge_off£t
, 
PROT_READ
, 
MAP_SHARED
,

1419 
fd
, 
∑ge_addr
);

1420 i‡(
°¨t
 =
MAP_FAILED
)

1422 
	`mem˝y
(
buf
, (*)
°¨t
 + 
∑ge_off£t
, 
cou¡
);

1423 
	`munm≠
(
°¨t
, 
cou¡
 + 
∑ge_off£t
);

1424  
cou¡
;

1426 ()
°¨t
;

1427 ()
∑ge_addr
;

1428 ()
∑ge_off£t
;

1431 
	`mem˝y
(
buf
, (*)
mm≠s
[
fûe_id
] + 
off£t
, 
cou¡
);

1433  
cou¡
;

1439 
	}
}

1442 
ssize_t
 
	$fûe_pwrôe
(
fûe_id
, *
buf
, 
ssize_t
 
cou¡
,

1443 
off£t
, 
thªad_id
)

1445 
FILE_DESCRIPTOR
 
fd
 = 
fûes
[
fûe_id
];

1446 #ifde‡
HAVE_MMAP


1447 *
°¨t
;

1448 
size_t
 
∑ge_addr
;

1449 
size_t
 
∑ge_off£t
;

1451 #ifde‡
HAVE_LIBAIO


1452 
iocb
 iocb;

1454 ()
thªad_id
;

1457 i‡(
fûe_io_mode
 =
FILE_IO_MODE_SYNC
)

1458  
	`pwrôe
(
fd
, 
buf
, 
cou¡
, 
off£t
);

1459 #ifde‡
HAVE_LIBAIO


1460 i‡(
fûe_io_mode
 =
FILE_IO_MODE_ASYNC
)

1463 
	`io_¥ï_pwrôe
(&
iocb
, 
fd
, 
buf
, 
cou¡
, 
off£t
);

1465 i‡(
	`fûe_submô_‹_waô
(&
iocb
, 
FILE_OP_TYPE_WRITE
, 
cou¡
, 
thªad_id
))

1468  
cou¡
;

1471 #ifde‡
HAVE_MMAP


1472 i‡(
fûe_io_mode
 =
FILE_IO_MODE_MMAP
)

1474 #i‡
SIZEOF_SIZE_T
 == 4

1476 
∑ge_addr
 = 
off£t
 & 
fûe_∑ge_mask
;

1477 
∑ge_off£t
 = 
off£t
 - 
∑ge_addr
;

1478 
°¨t
 = 
	`mm≠
(
NULL
, 
cou¡
 + 
∑ge_off£t
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
,

1479 
fd
, 
∑ge_addr
);

1481 i‡(
°¨t
 =
MAP_FAILED
)

1483 
	`mem˝y
((*)
°¨t
 + 
∑ge_off£t
, 
buf
, 
cou¡
);

1484 
	`munm≠
(
°¨t
, 
cou¡
 + 
∑ge_off£t
);

1486  
cou¡
;

1488 ()
°¨t
;

1489 ()
∑ge_addr
;

1490 ()
∑ge_off£t
;

1493 
	`mem˝y
((*)
mm≠s
[
fûe_id
] + 
off£t
, 
buf
, 
cou¡
);

1495  
cou¡
;

1501 
	}
}

1507 
	$∑r£_¨gumíts
()

1509 *
mode
;

1510 
i
;

1512 
num_fûes
 = 
	`sb_gë_vÆue_öt
("file-num");

1514 i‡(
num_fûes
 <= 0)

1516 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ fûe-num: %d", 
num_fûes
);

1519 
tŸÆ_size
 = 
	`sb_gë_vÆue_size
("file-total-size");

1520 i‡(
tŸÆ_size
 <= 0)

1522 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for file-total-size: %lld",

1523 ()
tŸÆ_size
);

1526 
fûe_size
 = 
tŸÆ_size
 / 
num_fûes
;

1528 
mode
 = 
	`sb_gë_vÆue_°rög
("file-test-mode");

1531 i‡(!
	`°rcmp
(
sb_globÆs
.
cmd«me
, "run"))

1533 i‡(
mode
 =
NULL
)

1535 
	`log_ãxt
(
LOG_FATAL
, "MissingÑequiredárgument: --file-test-mode\n");

1537 
	`log_ãxt
(
LOG_NOTICE
, "fileio options:");

1538 
	`sb_¥öt_›ti⁄s
(
fûeio_¨gs
);

1542 i‡(!
	`°rcmp
(
mode
, "seqwr"))

1543 
ã°_mode
 = 
MODE_WRITE
;

1544 i‡(!
	`°rcmp
(
mode
, "seqrewr"))

1545 
ã°_mode
 = 
MODE_REWRITE
;

1546 i‡(!
	`°rcmp
(
mode
, "seqrd"))

1547 
ã°_mode
 = 
MODE_READ
;

1548 i‡(!
	`°rcmp
(
mode
, "rndrd"))

1549 
ã°_mode
 = 
MODE_RND_READ
;

1550 i‡(!
	`°rcmp
(
mode
, "rndwr"))

1551 
ã°_mode
 = 
MODE_RND_WRITE
;

1552 i‡(!
	`°rcmp
(
mode
, "rndrw"))

1553 
ã°_mode
 = 
MODE_RND_RW
;

1556 
	`log_ãxt
(
LOG_FATAL
, "InvÆid IO o≥øti⁄†mode: %s.", 
mode
);

1561 
mode
 = 
	`sb_gë_vÆue_°rög
("file-io-mode");

1562 i‡(
mode
 =
NULL
)

1563 
mode
 = "sync";

1564 i‡(!
	`°rcmp
(
mode
, "sync"))

1565 
fûe_io_mode
 = 
FILE_IO_MODE_SYNC
;

1566 i‡(!
	`°rcmp
(
mode
, "async"))

1568 #ifde‡
HAVE_LIBAIO


1569 
fûe_io_mode
 = 
FILE_IO_MODE_ASYNC
;

1571 
	`log_ãxt
(
LOG_FATAL
,

1576 i‡(!
	`°rcmp
(
mode
, "mmap"))

1578 #ifde‡
HAVE_MMAP


1579 
fûe_io_mode
 = 
FILE_IO_MODE_MMAP
;

1581 
	`log_ãxt
(
LOG_FATAL
,

1588 
	`log_ãxt
(
LOG_FATAL
, "unknow¿I/O mode: %s", 
mode
);

1592 
fûe_mîged_ªque°s
 = 
	`sb_gë_vÆue_öt
("file-merged-requests");

1593 i‡(
fûe_mîged_ªque°s
 < 0)

1595 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for file-merged-requests: %d.",

1596 
fûe_mîged_ªque°s
);

1600 
fûe_block_size
 = 
	`sb_gë_vÆue_size
("file-block-size");

1601 i‡(
fûe_block_size
 <= 0)

1603 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for file-block-size: %d.",

1604 
fûe_block_size
);

1608 i‡(
fûe_mîged_ªque°s
 > 0)

1609 
fûe_ªque°_size
 = 
fûe_block_size
 * 
fûe_mîged_ªque°s
;

1611 
fûe_ªque°_size
 = 
fûe_block_size
;

1613 
mode
 = 
	`sb_gë_vÆue_°rög
("file-extra-flags");

1615 
sb_li°_ôem_t
 *
pos
;

1616 
	`SB_LIST_FOR_EACH
(
pos
, 
	`sb_gë_vÆue_li°
("file-extra-flags"))

1618 c⁄° *
vÆ
 = 
	`SB_LIST_ENTRY
(
pos
, 
vÆue_t
, 
li°ôem
)->
d©a
;

1620 i‡(!
	`°rcmp
(
vÆ
, "sync"))

1621 
fûe_exåa_Êags
 |
SB_FILE_FLAG_SYNC
;

1622 i‡(!
	`°rcmp
(
vÆ
, "dsync"))

1623 
fûe_exåa_Êags
 |
SB_FILE_FLAG_DSYNC
;

1624 i‡(!
	`°rcmp
(
vÆ
, "direct"))

1625 
fûe_exåa_Êags
 |
SB_FILE_FLAG_DIRECTIO
;

1628 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ fûe-exåa-Êags: %s", 
mode
);

1633 
fûe_fsync_‰eq
 = 
	`sb_gë_vÆue_öt
("file-fsync-freq");

1634 i‡(
fûe_fsync_‰eq
 < 0)

1636 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for file-fsync-freq: %d.",

1637 
fûe_fsync_‰eq
);

1641 
fûe_fsync_íd
 = 
	`sb_gë_vÆue_Êag
("file-fsync-end");

1642 
fûe_fsync_Æl
 = 
	`sb_gë_vÆue_Êag
("file-fsync-all");

1644 i‡(
fûe_fsync_Æl
) {

1645 
fûe_fsync_íd
 = 0;

1646 
fûe_fsync_‰eq
 = 0;

1649 
mode
 = 
	`sb_gë_vÆue_°rög
("file-fsync-mode");

1650 i‡(!
	`°rcmp
(
mode
, "fsync"))

1651 
fûe_fsync_mode
 = 
FSYNC_ALL
;

1652 i‡(!
	`°rcmp
(
mode
, "fdatasync"))

1654 #ifde‡
HAVE_FDATASYNC


1655 
fûe_fsync_mode
 = 
FSYNC_DATA
;

1657 
	`log_ãxt
(
LOG_FATAL
, "fdatasync() is unavailable onÅhisÖlatform");

1663 
	`log_ãxt
(
LOG_FATAL
, "InvÆid fsyn¯mode: %s.", 
mode
);

1667 
fûe_rw_øtio
 = 
	`sb_gë_vÆue_doubÀ
("file-rw-ratio");

1668 i‡(
fûe_rw_øtio
 < 0)

1670 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ --fûe-rw-øtio: %f.", 
fûe_rw_øtio
);

1674 
≥r_thªad
 = 
	`mÆloc
((*≥r_thªadË* 
sb_globÆs
.
thªads
);

1675 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

1677 
≥r_thªad
[
i
].
buf„r
 = 
	`sb_memÆign
(
fûe_ªque°_size
, 
	`sb_gë∑gesize
());

1678 i‡(
≥r_thªad
[
i
].
buf„r
 =
NULL
)

1680 
	`log_ãxt
(
LOG_FATAL
, "FailedÅoállocateá memory buffer");

1683 
	`mem£t
(
≥r_thªad
[
i
].
buf„r
, 0, 
fûe_ªque°_size
);

1687 
	}
}

1693 
	$check_£q_ªq
(
sb_fûe_ªque°_t
 *
¥ev_ªq
, sb_fûe_ªque°_à*
r
)

1696 i‡(
r
->
›î©i⁄
 =
FILE_OP_TYPE_FSYNC
 ||Ñ->›î©i⁄ =
FILE_OP_TYPE_NULL
)

1699 i‡(
¥ev_ªq
->
›î©i⁄
 =
FILE_OP_TYPE_NULL
)

1702 i‡(
r
->
fûe_id
 - 
¥ev_ªq
->file_id>1 &&

1703 !(
r
->
fûe_id
 =0 && 
¥ev_ªq
->fûe_id =
num_fûes
-1))

1705 
	`log_ãxt
(
LOG_WARNING
,

1709 i‡(
r
->
fûe_id
 =
¥ev_ªq
->file_id)

1711 if(
r
->
pos
 - 
¥ev_ªq
->po†!¥ev_ªq->
size
)

1713 
	`log_ãxt
(
LOG_WARNING
,

1720 i‡((
¥ev_ªq
->
pos
 +Öªv_ªq->
size
 !
fûe_size
Ë|| (
r
->pos != 0))

1722 
	`log_ãxt
(
LOG_WARNING
, "Invalid file switch found!");

1723 
	`log_ãxt
(
LOG_WARNING
, "Old: file_id: %d,Öos: %d size: %d",

1724 
¥ev_ªq
->
fûe_id
, (Ìªv_ªq->
pos
, (Ìªv_ªq->
size
);

1725 
	`log_ãxt
(
LOG_WARNING
, "New: file_id: %d,Öos: %d size: %d",

1726 
r
->
fûe_id
, (Ï->
pos
, (Ï->
size
);

1731 
	}
}

1738 
size_t
 
	$sb_gë_Æloˇti⁄_gønuœrôy
()

1740  
	`sb_gë∑gesize
();

1741 
	}
}

1743 
	$sb_‰ì_memÆig√d
(*
buf
)

1745 
	`‰ì
(
buf
);

1746 
	}
}

1748 
FILE_DESCRIPTOR
 
	$sb_›í
(c⁄° *
«me
)

1750 
FILE_DESCRIPTOR
 
fûe
;

1751 
Êags
 = 0;

1753 i‡(
	`c⁄vît_exåa_Êags
(
fûe_exåa_Êags
, &
Êags
))

1754  
SB_INVALID_FILE
;

1756 
fûe
 = 
	`›í
(
«me
, 
O_RDWR
 | 
Êags
, 
S_IRUSR
 | 
S_IWUSR
);

1758 #ifde‡
HAVE_DIRECTIO


1759 i‡(
	`VALID_FILE
(
fûe
Ë&& 
fûe_exåa_Êags
 & 
SB_FILE_FLAG_DIRECTIO
 &&

1760 
	`dúe˘io
(
fûe
, 
DIRECTIO_ON
))

1762 
	`log_î∫o
(
LOG_FATAL
, "directio() failed");

1763  
SB_INVALID_FILE
;

1767  
fûe
;

1768 
	}
}

1775 
	$sb_¸óã
(c⁄° *
∑th
)

1777 
FILE_DESCRIPTOR
 
fûe
;

1778 
ªs
;

1780 
fûe
 = 
	`›í
(
∑th
, 
O_CREAT
 | 
O_EXCL
, 
S_IRUSR
 | 
S_IWUSR
);

1781 
ªs
 = !
	`VALID_FILE
(
fûe
);

1782 
	`˛o£
(
fûe
);

1784  
ªs
;

1785 
	}
}

1791 
	$fûe_fûl_buf„r
(*
buf
, 
Àn
,

1792 
size_t
 
off£t
)

1794 
i
;

1796 
i
 = 0; i < 
Àn
 - (
FILE_CHECKSUM_LENGTH
 + 
FILE_OFFSET_LENGTH
); i++)

1797 
buf
[
i
] = 
	`sb_ønd_unif‹m_uöt64
() & 0xFF;

1800 *(*)(*)(
buf
 + 
i
Ë()
	`¸c32
(0, (*)buf, 
Àn
 -

1801 (
FILE_CHECKSUM_LENGTH
 + 
FILE_OFFSET_LENGTH
));

1803 *(*)(*)(
buf
 + 
i
 + 
FILE_CHECKSUM_LENGTH
Ë
off£t
;

1804 
	}
}

1810 
	$fûe_vÆid©e_buf„r
(*
buf
, 
Àn
, 
size_t
 
off£t
)

1812 
checksum
;

1813 
cs_off£t
;

1815 
cs_off£t
 = 
Àn
 - (
FILE_CHECKSUM_LENGTH
 + 
FILE_OFFSET_LENGTH
);

1817 
checksum
 = ()
	`¸c32
(0, (*)
buf
, 
cs_off£t
);

1819 i‡(
checksum
 !*(*)(*)(
buf
 + 
cs_off£t
))

1821 
	`log_ãxt
(
LOG_FATAL
, "Checksum mismatch in block with offset: %lld",

1822 (Ë
off£t
);

1823 
	`log_ãxt
(
LOG_FATAL
, " Calculated value: 0x%x Stored value: 0x%x",

1824 
checksum
, *(*)(*)(
buf
 + 
cs_off£t
));

1828 i‡(
off£t
 !*(
size_t
 *)(*)(
buf
 + 
cs_off£t
 + 
FILE_CHECKSUM_LENGTH
))

1830 
	`log_ãxt
(
LOG_FATAL
, "Offset mismatch in block:");

1831 
	`log_ãxt
(
LOG_FATAL
, " Actual offset: %zu Stored offset: %zu",

1832 
off£t
, *(
size_t
 *)(*)(
buf
 + 
cs_off£t
 + 
FILE_CHECKSUM_LENGTH
));

1837 
	}
}

	@tests/memory/sb_memory.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 
	~"sysbích.h
"

24 
	~"sb_ønd.h
"

26 #ifde‡
HAVE_SYS_IPC_H


27 
	~<sys/ùc.h
>

30 #ifde‡
HAVE_SYS_SHM_H


31 
	~<sys/shm.h
>

34 
	~<öây≥s.h
>

36 
	#LARGE_PAGE_SIZE
 (4UL * 1024 * 1024)

	)

39 
sb_¨g_t
 
	gmem‹y_¨gs
[] =

41 
SB_OPT
("mem‹y-block-size", "sizêo‡mem‹y block f‹Åe°", "1K", 
SIZE
),

42 
SB_OPT
("mem‹y-tŸÆ-size", "tŸÆ sizêo‡d©®tÿå™s„r", "100G", 
SIZE
),

43 
SB_OPT
("memory-scope", "memoryáccess scope {global,local}", "global",

44 
STRING
),

45 #ifde‡
HAVE_LARGE_PAGES


46 
SB_OPT
("mem‹y-hugëlb", "Æloˇã mem‹y from HugeTLBÖoﬁ", "off", 
BOOL
),

48 
SB_OPT
("memory-oper", "type of memory operations {read, write,Çone}",

49 "wrôe", 
STRING
),

50 
SB_OPT
("mem‹y-ac˚ss-mode", "mem‹yác˚s†modê{£q,∫d}", "£q", 
STRING
),

52 
SB_OPT_END


56 
mem‹y_öô
();

57 
mem‹y_¥öt_mode
();

58 
sb_evít_t
 
mem‹y_√xt_evít
();

59 
evít_∫d_n⁄e
(
sb_evít_t
 *, );

60 
evít_∫d_ªad
(
sb_evít_t
 *, );

61 
evít_∫d_wrôe
(
sb_evít_t
 *, );

62 
evít_£q_n⁄e
(
sb_evít_t
 *, );

63 
evít_£q_ªad
(
sb_evít_t
 *, );

64 
evít_£q_wrôe
(
sb_evít_t
 *, );

65 
mem‹y_ªp‹t_öãrmedüã
(
sb_°©_t
 *);

66 
mem‹y_ªp‹t_cumuœtive
(
sb_°©_t
 *);

68 
sb_ã°_t
 
	gmem‹y_ã°
 =

70 .
¢ame
 = "memory",

71 .
	g ame
 = "Memory functions speedÅest",

72 .
	g›s
 = {

73 .
öô
 = 
mem‹y_öô
,

74 .
	g¥öt_mode
 = 
mem‹y_¥öt_mode
,

75 .
	g√xt_evít
 = 
mem‹y_√xt_evít
,

76 .
	gªp‹t_öãrmedüã
 = 
mem‹y_ªp‹t_öãrmedüã
,

77 .
	gªp‹t_cumuœtive
 = 
mem‹y_ªp‹t_cumuœtive


79 .
	g¨gs
 = 
mem‹y_¨gs


84 
ssize_t
 
	gmem‹y_block_size
;

85 
	gmem‹y_tŸÆ_size
;

86 
	gmem‹y_sc›e
;

87 
	gmem‹y_›î
;

88 
	gmem‹y_ac˚ss_∫d
;

89 #ifde‡
HAVE_LARGE_PAGES


90 
	gmem‹y_hugëlb
;

93 
ssize_t
 
	gmax_off£t
;

96 
size_t
 **
	gbuf„rs
;

97 
uöt64_t
 *
	gthªad_cou¡îs
;

99 #ifde‡
HAVE_LARGE_PAGES


100 * 
hugëlb_Æloc
(
size_t
 
size
);

103 
	$ªgi°î_ã°_mem‹y
(
sb_li°_t
 *
ã°s
)

105 
	`SB_LIST_ADD_TAIL
(&
mem‹y_ã°
.
li°ôem
, 
ã°s
);

108 
	}
}

111 
	$mem‹y_öô
()

113 
i
;

114 *
s
;

115 
size_t
 *
buf„r
;

117 
mem‹y_block_size
 = 
	`sb_gë_vÆue_size
("memory-block-size");

118 i‡(
mem‹y_block_size
 < 
SIZEOF_SIZE_T
 ||

120 (
mem‹y_block_size
 & (memory_block_size - 1)) != 0)

122 
	`log_ãxt
(
LOG_FATAL
, "Invalid value for memory-block-size: %s",

123 
	`sb_gë_vÆue_°rög
("memory-block-size"));

127 
max_off£t
 = 
mem‹y_block_size
 / 
SIZEOF_SIZE_T
 - 1;

129 
mem‹y_tŸÆ_size
 = 
	`sb_gë_vÆue_size
("memory-total-size");

131 
s
 = 
	`sb_gë_vÆue_°rög
("memory-scope");

132 i‡(!
	`°rcmp
(
s
, "global"))

133 
mem‹y_sc›e
 = 
SB_MEM_SCOPE_GLOBAL
;

134 i‡(!
	`°rcmp
(
s
, "local"))

135 
mem‹y_sc›e
 = 
SB_MEM_SCOPE_LOCAL
;

138 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ mem‹y-sc›e: %s", 
s
);

142 #ifde‡
HAVE_LARGE_PAGES


143 
mem‹y_hugëlb
 = 
	`sb_gë_vÆue_Êag
("memory-hugetlb");

146 
s
 = 
	`sb_gë_vÆue_°rög
("memory-oper");

147 i‡(!
	`°rcmp
(
s
, "write"))

148 
mem‹y_›î
 = 
SB_MEM_OP_WRITE
;

149 i‡(!
	`°rcmp
(
s
, "read"))

150 
mem‹y_›î
 = 
SB_MEM_OP_READ
;

151 i‡(!
	`°rcmp
(
s
, "none"))

152 
mem‹y_›î
 = 
SB_MEM_OP_NONE
;

155 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ mem‹y-›î: %s", 
s
);

159 
s
 = 
	`sb_gë_vÆue_°rög
("memory-access-mode");

160 i‡(!
	`°rcmp
(
s
, "seq"))

161 
mem‹y_ac˚ss_∫d
 = 0;

162 i‡(!
	`°rcmp
(
s
, "rnd"))

163 
mem‹y_ac˚ss_∫d
 = 1;

166 
	`log_ãxt
(
LOG_FATAL
, "InvÆid vÆuêf‹ mem‹y-ac˚ss-mode: %s", 
s
);

170 i‡(
mem‹y_sc›e
 =
SB_MEM_SCOPE_GLOBAL
)

172 #ifde‡
HAVE_LARGE_PAGES


173 i‡(
mem‹y_hugëlb
)

174 
buf„r
 = 
	`hugëlb_Æloc
(
mem‹y_block_size
);

177 
buf„r
 = 
	`sb_memÆign
(
mem‹y_block_size
, 
	`sb_gë∑gesize
());

179 i‡(
buf„r
 =
NULL
)

181 
	`log_ãxt
(
LOG_FATAL
, "FailedÅoállocate buffer!");

185 
	`mem£t
(
buf„r
, 0, 
mem‹y_block_size
);

188 
thªad_cou¡îs
 = 
	`mÆloc
(
sb_globÆs
.
thªads
 * (
uöt64_t
));

189 
buf„rs
 = 
	`mÆloc
(
sb_globÆs
.
thªads
 * (*));

190 i‡(
thªad_cou¡îs
 =
NULL
 || 
buf„rs
 == NULL)

192 
	`log_ãxt
(
LOG_FATAL
, "FailedÅoállocateÅhread-local memory!");

196 
i
 = 0; i < 
sb_globÆs
.
thªads
; i++)

198 i‡(
mem‹y_sc›e
 =
SB_MEM_SCOPE_GLOBAL
)

199 
buf„rs
[
i
] = 
buf„r
;

202 #ifde‡
HAVE_LARGE_PAGES


203 i‡(
mem‹y_hugëlb
)

204 
buf„rs
[
i
] = 
	`hugëlb_Æloc
(
mem‹y_block_size
);

207 
buf„rs
[
i
] = 
	`sb_memÆign
(
mem‹y_block_size
, 
	`sb_gë∑gesize
());

209 i‡(
buf„rs
[
i
] =
NULL
)

211 
	`log_ãxt
(
LOG_FATAL
, "FaûedÅÿÆloˇã buf„∏f‹Åhªad #%d!", 
i
);

215 
	`mem£t
(
buf„rs
[
i
], 0, 
mem‹y_block_size
);

218 
thªad_cou¡îs
[
i
] =

219 
mem‹y_tŸÆ_size
 / 
mem‹y_block_size
 / 
sb_globÆs
.
thªads
;

222 
mem‹y_›î
) {

223 
SB_MEM_OP_NONE
:

224 
mem‹y_ã°
.
›s
.
execuã_evít
 =

225 
mem‹y_ac˚ss_∫d
 ? 
evít_∫d_n⁄e
 : 
evít_£q_n⁄e
;

228 
SB_MEM_OP_READ
:

229 
mem‹y_ã°
.
›s
.
execuã_evít
 =

230 
mem‹y_ac˚ss_∫d
 ? 
evít_∫d_ªad
 : 
evít_£q_ªad
;

233 
SB_MEM_OP_WRITE
:

234 
mem‹y_ã°
.
›s
.
execuã_evít
 =

235 
mem‹y_ac˚ss_∫d
 ? 
evít_∫d_wrôe
 : 
evít_£q_wrôe
;

239 
	`log_ãxt
(
LOG_FATAL
, "Unknow¿mem‹yÑeque°Åy≥: %d\n", 
mem‹y_›î
);

244 
sb_globÆs
.
max_evíts
 = 0;

248 
	}
}

251 
sb_evít_t
 
	$mem‹y_√xt_evít
(
tid
)

253 
sb_evít_t
 
ªq
;

255 i‡(
mem‹y_tŸÆ_size
 > 0 && 
thªad_cou¡îs
[
tid
]-- == 0)

257 
ªq
.
ty≥
 = 
SB_REQ_TYPE_NULL
;

258  
ªq
;

261 
ªq
.
ty≥
 = 
SB_REQ_TYPE_MEMORY
;

263  
ªq
;

264 
	}
}

271 #i‡
SIZEOF_SIZE_T
 == 4

272 
	#SIZE_T_LOAD
(
±r
Ë
	`ck_¥_lﬂd_32
((
uöt32_t
 *)’å))

	)

273 
	#SIZE_T_STORE
(
±r
,
vÆ
Ë
	`ck_¥_°‹e_32
((
uöt32_t
 *)’å),(uöt32_t)(vÆ))

	)

274 #ñi‡
SIZEOF_SIZE_T
 == 8

275 
	#SIZE_T_LOAD
(
±r
Ë
	`ck_¥_lﬂd_64
((
uöt64_t
 *)’å))

	)

276 
	#SIZE_T_STORE
(
±r
,
vÆ
Ë
	`ck_¥_°‹e_64
((
uöt64_t
 *)’å),(uöt64_t)(vÆ))

	)

278 #îr‹ 
Unsuµ‹ãd
 
∂©f‹m
.

281 
	$evít_∫d_n⁄e
(
sb_evít_t
 *
ªq
, 
tid
)

283 (Ë
ªq
;

284 (Ë
tid
;

286 
ssize_t
 
i
 = 0; i <
max_off£t
; i++)

288 
size_t
 
off£t
 = (vﬁ©ûêsize_tË
	`sb_ønd_deÁu…
(0, 
max_off£t
);

289 (Ë
off£t
;

293 
	}
}

296 
	$evít_∫d_ªad
(
sb_evít_t
 *
ªq
, 
tid
)

298 (Ë
ªq
;

300 
ssize_t
 
i
 = 0; i <
max_off£t
; i++)

302 
size_t
 
off£t
 = (size_tË
	`sb_ønd_deÁu…
(0, 
max_off£t
);

303 
size_t
 
vÆ
 = 
	`SIZE_T_LOAD
(
buf„rs
[
tid
] + 
off£t
);

304 (Ë
vÆ
;

308 
	}
}

311 
	$evít_∫d_wrôe
(
sb_evít_t
 *
ªq
, 
tid
)

313 (Ë
ªq
;

315 
ssize_t
 
i
 = 0; i <
max_off£t
; i++)

317 
size_t
 
off£t
 = (size_tË
	`sb_ønd_deÁu…
(0, 
max_off£t
);

318 
	`SIZE_T_STORE
(
buf„rs
[
tid
] + 
off£t
, 
i
);

322 
	}
}

325 
	$evít_£q_n⁄e
(
sb_evít_t
 *
ªq
, 
tid
)

327 (Ë
ªq
;

329 
size_t
 *
buf
 = 
buf„rs
[
tid
], *
íd
 = bu‡+ 
max_off£t
; buf <=Énd; buf++)

331 
	`ck_¥_b¨rõr
();

336 
	}
}

339 
	$evít_£q_ªad
(
sb_evít_t
 *
ªq
, 
tid
)

341 (Ë
ªq
;

343 
size_t
 *
buf
 = 
buf„rs
[
tid
], *
íd
 = bu‡+ 
max_off£t
; buf <Énd; buf++)

345 
size_t
 
vÆ
 = 
	`SIZE_T_LOAD
(
buf
);

346 (Ë
vÆ
;

350 
	}
}

353 
	$evít_£q_wrôe
(
sb_evít_t
 *
ªq
, 
tid
)

355 (Ë
ªq
;

357 
size_t
 *
buf
 = 
buf„rs
[
tid
], *
íd
 = bu‡+ 
max_off£t
; buf <Énd; buf++)

359 
	`SIZE_T_STORE
(
buf
, (
size_t
Ë
tid
);

363 
	}
}

366 
	$mem‹y_¥öt_mode
()

368 *
°r
;

370 
	`log_ãxt
(
LOG_NOTICE
, "Running memory speedÅest withÅhe following options:");

371 
	`log_ãxt
(
LOG_NOTICE
, " block size: %ldKiB",

372 ()(
mem‹y_block_size
 / 1024));

373 
	`log_ãxt
(
LOG_NOTICE
, "Åotal size: %ldMiB",

374 ()(
mem‹y_tŸÆ_size
 / 1024 / 1024));

376 
mem‹y_›î
) {

377 
SB_MEM_OP_READ
:

378 
°r
 = "read";

380 
SB_MEM_OP_WRITE
:

381 
°r
 = "write";

383 
SB_MEM_OP_NONE
:

384 
°r
 = "none";

387 
°r
 = "(unknown)";

390 
	`log_ãxt
(
LOG_NOTICE
, " o≥øti⁄: %s", 
°r
);

392 
mem‹y_sc›e
) {

393 
SB_MEM_SCOPE_GLOBAL
:

394 
°r
 = "global";

396 
SB_MEM_SCOPE_LOCAL
:

397 
°r
 = "local";

400 
°r
 = "(unknown)";

403 
	`log_ãxt
(
LOG_NOTICE
, " sc›e: %s", 
°r
);

405 
	`log_ãxt
(
LOG_NOTICE
, "");

406 
	}
}

412 
	$mem‹y_ªp‹t_öãrmedüã
(
sb_°©_t
 *
°©
)

414 c⁄° 
megabyã
 = 1024.0 * 1024.0;

416 
	`log_time°amp
(
LOG_NOTICE
, 
°©
->
time_tŸÆ
, "%4.2f MiB/sec",

417 
°©
->
evíts
 * 
mem‹y_block_size
 / 
megabyã
 /

418 
°©
->
time_öãrvÆ
);

419 
	}
}

425 
	$mem‹y_ªp‹t_cumuœtive
(
sb_°©_t
 *
°©
)

427 c⁄° 
megabyã
 = 1024.0 * 1024.0;

429 
	`log_ãxt
(
LOG_NOTICE
, "TŸÆ o≥øti⁄s: %" 
PRIu64
 " (%8.2fÖer second)\n",

430 
°©
->
evíts
, sèt->evít†/ sèt->
time_öãrvÆ
);

432 i‡(
mem‹y_›î
 !
SB_MEM_OP_NONE
)

434 c⁄° 
mb
 = 
°©
->
evíts
 * 
mem‹y_block_size
 / 
megabyã
;

435 
	`log_ãxt
(
LOG_NOTICE
, "%4.2f MiBÅransferred (%4.2f MiB/sec)\n",

436 
mb
, mb / 
°©
->
time_öãrvÆ
);

439 
	`sb_ªp‹t_cumuœtive
(
°©
);

440 
	}
}

442 #ifde‡
HAVE_LARGE_PAGES


446 * 
	$hugëlb_Æloc
(
size_t
 
size
)

448 
shmid
;

449 *
±r
;

450 
shmid_ds
 
buf
;

453 
size
 = ((sizê- 1Ë& ~
LARGE_PAGE_SIZE
) + LARGE_PAGE_SIZE;

455 
shmid
 = 
	`shmgë
(
IPC_PRIVATE
, 
size
, 
SHM_HUGETLB
 | 
SHM_R
 | 
SHM_W
);

456 i‡(
shmid
 < 0)

458 
	`log_î∫o
(
LOG_FATAL
,

459 "FaûedÅÿÆloˇã %zd byã†‰om HugeTLB mem‹y.", 
size
);

461  
NULL
;

464 
±r
 = 
	`shm©
(
shmid
, 
NULL
, 0);

465 i‡(
±r
 == (*)-1)

467 
	`log_î∫o
(
LOG_FATAL
, "FailedÅoáttach shared memory segment,");

468 
	`shm˘l
(
shmid
, 
IPC_RMID
, &
buf
);

470  
NULL
;

477 
	`shm˘l
(
shmid
, 
IPC_RMID
, &
buf
);

479  
±r
;

480 
	}
}

	@tests/mutex/sb_mutex.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
HAVE_PTHREAD_H


24 
	~<±hªad.h
>

27 
	~"sysbích.h
"

28 
	~"sb_ck_¥.h
"

29 
	~"sb_ønd.h
"

33 
±hªad_muãx_t
 
	mmuãx
;

34 
	m∑d
[256];

35 } 
	tthªad_lock
;

39 
sb_¨g_t
 
	gmuãx_¨gs
[] =

41 
SB_OPT
("muãx-num", "tŸÆ sizêo‡muãxáºay", "4096", 
INT
),

42 
SB_OPT
("muãx-locks", "numbî o‡muãxÜock†tÿdÿ≥∏thªad", "50000", 
INT
),

43 
SB_OPT
("mutex-loops", "number ofÉmptyÜoopsÅo do outside mutexÜock",

44 "10000", 
INT
),

46 
SB_OPT_END


50 
muãx_öô
();

51 
muãx_¥öt_mode
();

52 
sb_evít_t
 
muãx_√xt_evít
();

53 
muãx_execuã_evít
(
sb_evít_t
 *, );

54 
muãx_d⁄e
();

56 
sb_ã°_t
 
	gmuãx_ã°
 =

58 .
¢ame
 = "mutex",

59 .
	g ame
 = "MutexÖerformanceÅest",

60 .
	g›s
 = {

61 .
öô
 = 
muãx_öô
,

62 .
	g¥öt_mode
 = 
muãx_¥öt_mode
,

63 .
	g√xt_evít
 = 
muãx_√xt_evít
,

64 .
	gexecuã_evít
 = 
muãx_execuã_evít
,

65 .
	gd⁄e
 = 
muãx_d⁄e


67 .
	g¨gs
 = 
muãx_¨gs


71 
thªad_lock
 *
	gthªad_locks
;

72 
	gmuãx_num
;

73 
	gmuãx_lo›s
;

74 
	gmuãx_locks
;

75 
	gglobÆ_v¨
;

77 
TLS
 
	gés_cou¡î
;

79 
	$ªgi°î_ã°_muãx
(
sb_li°_t
 *
ã°s
)

81 
	`SB_LIST_ADD_TAIL
(&
muãx_ã°
.
li°ôem
, 
ã°s
);

84 
	}
}

87 
	$muãx_öô
()

89 
i
;

91 
muãx_num
 = 
	`sb_gë_vÆue_öt
("mutex-num");

92 
muãx_lo›s
 = 
	`sb_gë_vÆue_öt
("mutex-loops");

93 
muãx_locks
 = 
	`sb_gë_vÆue_öt
("mutex-locks");

95 
thªad_locks
 = (
thªad_lock
 *)
	`mÆloc
(
muãx_num
 * (thread_lock));

96 i‡(
thªad_locks
 =
NULL
)

98 
	`log_ãxt
(
LOG_FATAL
, "Memoryállocation failure!");

102 
i
 = 0; i < 
muãx_num
; i++)

103 
	`±hªad_muãx_öô
(&
thªad_locks
[
i
].
muãx
, 
NULL
);

106 
	}
}

109 
	$muãx_d⁄e
()

111 
i
;

113 
i
=0; i < 
muãx_num
; i++)

114 
	`±hªad_muãx_de°roy
(&
thªad_locks
[
i
].
muãx
);

115 
	`‰ì
(
thªad_locks
);

118 
	}
}

121 
sb_evít_t
 
	$muãx_√xt_evít
(
thªad_id
)

123 
sb_evít_t
 
sb_ªq
;

124 
sb_muãx_ªque°_t
 *
muãx_ªq
 = &
sb_ªq
.
u
.
muãx_ªque°
;

126 (Ë
thªad_id
;

129 i‡(
és_cou¡î
++ > 0)

130 
sb_ªq
.
ty≥
 = 
SB_REQ_TYPE_NULL
;

133 
sb_ªq
.
ty≥
 = 
SB_REQ_TYPE_MUTEX
;

134 
muãx_ªq
->
∆ocks
 = 
muãx_locks
;

135 
muãx_ªq
->
∆o›s
 = 
muãx_lo›s
;

138  
sb_ªq
;

139 
	}
}

142 
	$muãx_execuã_evít
(
sb_evít_t
 *
sb_ªq
, 
thªad_id
)

144 
i
;

145 
cuºít_lock
;

146 
sb_muãx_ªque°_t
 *
muãx_ªq
 = &
sb_ªq
->
u
.
muãx_ªque°
;

148 (Ë
thªad_id
;

152 
cuºít_lock
 = 
	`sb_ønd_unif‹m
(0, 
muãx_num
 - 1);

154 
i
 = 0; i < 
muãx_ªq
->
∆o›s
; i++)

155 
	`ck_¥_b¨rõr
();

157 
	`±hªad_muãx_lock
(&
thªad_locks
[
cuºít_lock
].
muãx
);

158 
globÆ_v¨
++;

159 
	`±hªad_muãx_u∆ock
(&
thªad_locks
[
cuºít_lock
].
muãx
);

160 
muãx_ªq
->
∆ocks
--;

162 
muãx_ªq
->
∆ocks
 > 0);

165 
	}
}

168 
	$muãx_¥öt_mode
()

170 
	`log_ãxt
(
LOG_INFO
, "Doing mutexÖerformanceÅest");

171 
	}
}

	@tests/sb_cpu.h

19 #i‚de‡
SB_CPU_H


20 
	#SB_CPU_H


	)

22 
ªgi°î_ã°_˝u
(
sb_li°_t
 *
ã°s
);

	@tests/sb_fileio.h

19 #i‚de‡
SB_FILEIO_H


20 
	#SB_FILEIO_H


	)

25 
	mFILE_OP_TYPE_NULL
,

26 
	mFILE_OP_TYPE_READ
,

27 
	mFILE_OP_TYPE_WRITE
,

28 
	mFILE_OP_TYPE_FSYNC


29 } 
	tsb_fûe_›_t
;

35 
	mfûe_id
;

36 
	mpos
;

37 
ssize_t
 
	msize
;

38 
sb_fûe_›_t
 
	m›î©i⁄
;

39 } 
	tsb_fûe_ªque°_t
;

41 
ªgi°î_ã°_fûeio
(
sb_li°_t
 *
ã°s
);

	@tests/sb_memory.h

19 #i‚de‡
SB_MEMORY_H


20 
	#SB_MEMORY_H


	)

25 
	mSB_MEM_OP_NONE
,

26 
	mSB_MEM_OP_READ
,

27 
	mSB_MEM_OP_WRITE


28 } 
	tsb_mem_›_t
;

34 
	mSB_MEM_SCOPE_GLOBAL
,

35 
	mSB_MEM_SCOPE_LOCAL


36 } 
	tsb_mem_sc›e_t
;

39 
ªgi°î_ã°_mem‹y
(
sb_li°_t
 *
ã°s
);

	@tests/sb_mutex.h

19 #i‚de‡
SB_MUTEX_H


20 
	#SB_MUTEX_H


	)

26 
	m∆ocks
;

27 
	m∆o›s
;

28 } 
	tsb_muãx_ªque°_t
;

30 
ªgi°î_ã°_muãx
(
sb_li°_t
 *
ã°s
);

	@tests/sb_threads.h

19 #i‚de‡
SB_THREADS_H


20 
	#SB_THREADS_H


	)

26 
	mlock_num
;

27 } 
	tsb_thªads_ªque°_t
;

29 
ªgi°î_ã°_thªads
(
sb_li°_t
 *
ã°s
);

	@tests/threads/sb_threads.c

19 #ifde‡
HAVE_CONFIG_H


20 
	~"c⁄fig.h
"

23 #ifde‡
HAVE_PTHREAD_H


24 
	~<±hªad.h
>

27 
	~"sysbích.h
"

28 
	~"sb_ck_¥.h
"

31 #ifde‡
HAVE_PTHREAD_YIELD


32 
	#YIELD
 
±hªad_yõld


	)

34 
	#YIELD
 
sched_yõld


	)

38 
sb_¨g_t
 
	gthªads_¨gs
[] =

40 
SB_OPT
("thªad-yõlds", "numbî o‡yõld†tÿdÿ≥∏ªque°", "1000", 
INT
),

41 
SB_OPT
("thªad-locks", "numbî o‡lock†≥∏thªad", "8", 
INT
),

43 
SB_OPT_END


47 
thªads_öô
();

48 
thªads_¥ï¨e
();

49 
thªads_¥öt_mode
();

50 
sb_evít_t
 
thªads_√xt_evít
();

51 
thªads_execuã_evít
(
sb_evít_t
 *, );

52 
thªads_˛ónup
();

54 
sb_ã°_t
 
	gthªads_ã°
 =

56 .
¢ame
 = "threads",

57 .
	g ame
 = "Threads subsystemÖerformanceÅest",

58 .
	g›s
 = {

59 .
öô
 = 
thªads_öô
,

60 .
	g¥ï¨e
 = 
thªads_¥ï¨e
,

61 .
	g¥öt_mode
 = 
thªads_¥öt_mode
,

62 .
	g√xt_evít
 = 
thªads_√xt_evít
,

63 .
	gexecuã_evít
 = 
thªads_execuã_evít
,

64 .
	g˛ónup
 = 
thªads_˛ónup


66 .
	g¨gs
 = 
thªads_¨gs


69 
	gthªad_yõlds
;

70 
	gthªad_locks
;

71 
±hªad_muãx_t
 *
	gã°_muãxes
;

72 
	gªq_≥rf‹med
;

75 
	$ªgi°î_ã°_thªads
(
sb_li°_t
 *
ã°s
)

77 
	`SB_LIST_ADD_TAIL
(&
thªads_ã°
.
li°ôem
, 
ã°s
);

80 
	}
}

83 
	$thªads_öô
()

85 
thªad_yõlds
 = 
	`sb_gë_vÆue_öt
("thread-yields");

86 
thªad_locks
 = 
	`sb_gë_vÆue_öt
("thread-locks");

87 
ªq_≥rf‹med
 = 0;

90 
	}
}

93 
	$thªads_¥ï¨e
()

95 
i
;

97 
ã°_muãxes
 = (
±hªad_muãx_t
 *)
	`mÆloc
(
thªad_locks
 *

98 (
±hªad_muãx_t
));

99 i‡(
ã°_muãxes
 =
NULL
)

101 
	`log_ãxt
(
LOG_FATAL
, "Memoryállocation failure!");

105 
i
 = 0; i < 
thªad_locks
; i++)

106 
	`±hªad_muãx_öô
(
ã°_muãxes
 + 
i
, 
NULL
);

109 
	}
}

112 
	$thªads_˛ónup
()

114 
i
;

116 
i
=0; i < 
thªad_locks
; i++)

117 
	`±hªad_muãx_de°roy
(
ã°_muãxes
 + 
i
);

118 
	`‰ì
(
ã°_muãxes
);

121 
	}
}

124 
sb_evít_t
 
	$thªads_√xt_evít
(
thªad_id
)

126 
sb_evít_t
 
sb_ªq
;

127 
sb_thªads_ªque°_t
 *
thªads_ªq
 = &
sb_ªq
.
u
.
thªads_ªque°
;

129 (Ë
thªad_id
;

131 
sb_ªq
.
ty≥
 = 
SB_REQ_TYPE_THREADS
;

132 
thªads_ªq
->
lock_num
 = 
	`ck_¥_Áa_uöt
(&
ªq_≥rf‹med
, 1Ë% 
thªad_locks
;

134  
sb_ªq
;

135 
	}
}

138 
	$thªads_execuã_evít
(
sb_evít_t
 *
sb_ªq
, 
thªad_id
)

140 
i
;

141 
sb_thªads_ªque°_t
 *
thªads_ªq
 = &
sb_ªq
->
u
.
thªads_ªque°
;

143 (Ë
thªad_id
;

145 
i
 = 0; i < 
thªad_yõlds
; i++)

147 
	`±hªad_muãx_lock
(&
ã°_muãxes
[
thªads_ªq
->
lock_num
]);

148 
	`YIELD
();

149 
	`±hªad_muãx_u∆ock
(&
ã°_muãxes
[
thªads_ªq
->
lock_num
]);

153 
	}
}

156 
	$thªads_¥öt_mode
()

158 
	`log_ãxt
(
LOG_INFO
, "DoingÅhread subsystemÖerformanceÅest");

159 
	`log_ãxt
(
LOG_INFO
, "Thread yieldsÖerÅest: %d Locks used: %d",

160 
thªad_yõlds
, 
thªad_locks
);

161 
	}
}

	@xoroshiro128plus.h

13 
	~<°döt.h
>

34 
ölöe
 
uöt64_t
 
	$x‹oshúo_rŸl
(c⁄° 
uöt64_t
 
x
, 
k
) {

35  (
x
 << 
k
) | (x >> (64 - k));

36 
	}
}

38 
ölöe
 
uöt64_t
 
	$x‹oshúo_√xt
(
uöt64_t
 
s
[2]) {

39 c⁄° 
uöt64_t
 
s0
 = 
s
[0];

40 
uöt64_t
 
s1
 = 
s
[1];

41 c⁄° 
uöt64_t
 
ªsu…
 = 
s0
 + 
s1
;

43 
s1
 ^
s0
;

44 
s
[0] = 
	`x‹oshúo_rŸl
(
s0
, 55Ë^ 
s1
 ^ (s1 << 14);

45 
s
[1] = 
	`x‹oshúo_rŸl
(
s1
, 36);

47  
ªsu…
;

48 
	}
}

55 
ölöe
 
	$x‹oshúo_jump
(
uöt64_t
 
s
[2]) {

56 c⁄° 
uöt64_t
 
JUMP
[] = { 0xbeac0467eba5facb, 0xd86b048b86aa9922 };

58 
uöt64_t
 
s0
 = 0;

59 
uöt64_t
 
s1
 = 0;

60 
i
, 
b
;

61 
i
 = 0; i < (Ë( 
JUMP
 /  *JUMP); i++)

62 
b
 = 0; b < 64; b++) {

63 i‡(
JUMP
[
i
] & 1ULL << 
b
) {

64 
s0
 ^
s
[0];

65 
s1
 ^
s
[1];

67 
	`x‹oshúo_√xt
(
s
);

70 
s
[0] = 
s0
;

71 
s
[1] = 
s1
;

72 
	}
}

	@
1
.
0
67
1311
db_driver.c
db_driver.h
drivers/mysql/drv_mysql.c
drivers/pgsql/drv_pgsql.c
lua/bulk_insert.lua
lua/empty-test.lua
lua/internal/sysbench.cmdline.lua
lua/internal/sysbench.cmdline.lua.h
lua/internal/sysbench.histogram.lua
lua/internal/sysbench.histogram.lua.h
lua/internal/sysbench.lua
lua/internal/sysbench.lua.h
lua/internal/sysbench.rand.lua
lua/internal/sysbench.rand.lua.h
lua/internal/sysbench.sql.lua
lua/internal/sysbench.sql.lua.h
lua/oltp_common.lua
lua/oltp_delete.lua
lua/oltp_insert.lua
lua/oltp_point_select.lua
lua/oltp_read_only.lua
lua/oltp_read_write.lua
lua/oltp_update_index.lua
lua/oltp_update_non_index.lua
lua/oltp_write_only.lua
lua/prime-test.lua
lua/select_random_points.lua
lua/select_random_ranges.lua
sb_barrier.c
sb_barrier.h
sb_ck_pr.h
sb_counter.c
sb_counter.h
sb_global.h
sb_histogram.c
sb_histogram.h
sb_list.h
sb_logger.c
sb_logger.h
sb_lua.c
sb_lua.h
sb_options.c
sb_options.h
sb_rand.c
sb_rand.h
sb_thread.c
sb_thread.h
sb_timer.c
sb_timer.h
sb_util.c
sb_util.h
sysbench.c
sysbench.h
tests/cpu/sb_cpu.c
tests/fileio/crc32.c
tests/fileio/crc32.h
tests/fileio/crc32tbl.h
tests/fileio/sb_fileio.c
tests/memory/sb_memory.c
tests/mutex/sb_mutex.c
tests/sb_cpu.h
tests/sb_fileio.h
tests/sb_memory.h
tests/sb_mutex.h
tests/sb_threads.h
tests/threads/sb_threads.c
xoroshiro128plus.h
